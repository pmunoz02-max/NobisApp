<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geocercas (Nobis)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; display:flex; height:100vh; font-family:sans-serif; }
    #sidebar { width:280px; overflow-y:auto; padding:8px; background:#f8f8f8; border-right:1px solid #ccc; }
    #map { flex:1; }
    h3 { margin-top:12px; }
    button { margin:2px 0; display:block; width:100%; }
    ul { padding-left:18px; }
    .person-form { background:#eef; padding:6px; margin:4px 0; border-radius:6px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Acciones</h3>
    <button id="newBtn">Nueva</button>
    <button id="finishBtn" disabled>Finalizar</button>
    <button id="cancelBtn" disabled>Cancelar</button>
    <button id="editBtn" disabled>Editar</button>
    <button id="saveEditBtn" disabled>Guardar cambios</button>
    <button id="cancelEditBtn" disabled>Cancelar edición</button>
    <button id="renameBtn" disabled>Renombrar</button>
    <button id="deleteBtn" disabled>Eliminar</button>
    <button id="coordsBtn">Geocerca (Lat/Lng)</button>
    <button id="exportBtn">Exportar GeoJSON</button>
    <input type="file" id="importInput" />

    <h3>Geocercas</h3>
    <ul id="fenceList"></ul>

    <h3>Gestión de Personal</h3>
    <button id="addPersonalBtn" disabled>Añadir personal</button>
    <button id="viewPersonalBtn" disabled>Ver personal</button>
    <div id="personList"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === Storage ===
    function saveToStorage(){
      localStorage.setItem("geofences", JSON.stringify(fences));
    }
    function loadFromStorage(){
      return JSON.parse(localStorage.getItem("geofences")||"[]");
    }

    // === Estado ===
    let map, drawnLayer;
    let fences = loadFromStorage();
    let activeFence = null;

    function initMap(){
      map = L.map("map").setView([-1.73,-77.91], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
        attribution:"&copy; OpenStreetMap"
      }).addTo(map);
      renderFences();
    }

    // === Render geocercas ===
    function renderFences(){
      if(drawnLayer) drawnLayer.clearLayers();
      else drawnLayer=L.layerGroup().addTo(map);
      document.getElementById("fenceList").innerHTML="";
      fences.forEach((f,i)=>{
        let poly=L.polygon(f.latlngs,{color:"purple"}).addTo(drawnLayer);
        poly.bindTooltip(f.name,{permanent:true,direction:"center"});
        poly.on("click",()=>{activeFence=f; refreshButtons(); renderPersonal(f);});
        let li=document.createElement("li");
        li.textContent=f.name;
        li.onclick=()=>{activeFence=f; refreshButtons(); renderPersonal(f);};
        document.getElementById("fenceList").appendChild(li);
      });
      refreshButtons();
    }

    function refreshButtons(){
      let has=!!activeFence;
      document.getElementById("editBtn").disabled=!has;
      document.getElementById("renameBtn").disabled=!has;
      document.getElementById("deleteBtn").disabled=!has;
      document.getElementById("addPersonalBtn").disabled=!has;
      document.getElementById("viewPersonalBtn").disabled=!has;
    }

    // === Gestión de Personal ===
    document.getElementById("addPersonalBtn").onclick=()=>{
      if(!activeFence) return;
      let nombre=prompt("Nombre del personal:");
      if(!nombre) return;
      if(!activeFence.personal) activeFence.personal=[];
      activeFence.personal.push({nombre,estado:"Inactivo",desde:"",hasta:""});
      saveToStorage();
      renderPersonal(activeFence);
    };

    document.getElementById("viewPersonalBtn").onclick=()=>{
      if(activeFence) renderPersonal(activeFence);
    };

    function renderPersonal(f){
      let div=document.getElementById("personList");
      div.innerHTML="";
      if(!f.personal||!f.personal.length){
        div.innerHTML="<i>Sin personal asignado</i>";
        return;
      }
      f.personal.forEach((p,idx)=>{
        let row=document.createElement("div");
        row.textContent=`${p.nombre} (${p.estado||"sin estado"}) `;
        let btn=document.createElement("button");
        btn.textContent="Cambiar estado";
        btn.onclick=()=>showStatusForm(f,idx);
        row.appendChild(btn);
        div.appendChild(row);
      });
    }

    function showStatusForm(f, idx){
      let div=document.getElementById("personList");
      let form=document.createElement("div");
      form.className="person-form";

      // IDs únicos
      let estadoId=`estadoSel_${idx}`;
      let desdeId=`desdeInp_${idx}`;
      let hastaId=`hastaInp_${idx}`;
      let saveId=`saveStatusBtn_${idx}`;
      let cancelId=`cancelStatusBtn_${idx}`;

      form.innerHTML=`
        <strong>Editar: ${f.personal[idx].nombre}</strong><br>
        <label>Estado:
          <select id="${estadoId}">
            <option ${f.personal[idx].estado==="Activo"?"selected":""}>Activo</option>
            <option ${f.personal[idx].estado==="Inactivo"?"selected":""}>Inactivo</option>
          </select>
        </label><br>
        <label>Desde: <input type="date" id="${desdeId}" value="${f.personal[idx].desde||""}"></label><br>
        <label>Hasta: <input type="date" id="${hastaId}" value="${f.personal[idx].hasta||""}"></label><br>
        <button id="${saveId}">Guardar</button>
        <button id="${cancelId}">Cancelar</button>
      `;
      div.appendChild(form);

      document.getElementById(saveId).onclick=()=>{
        f.personal[idx].estado=document.getElementById(estadoId).value;
        f.personal[idx].desde=document.getElementById(desdeId).value;
        f.personal[idx].hasta=document.getElementById(hastaId).value;
        saveToStorage();
        renderPersonal(f);
      };
      document.getElementById(cancelId).onclick=()=>renderPersonal(f);
    }

    // === Inicializar ===
    initMap();
  </script>
</body>
</html>



