<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Geocercas</title>

  <!-- ======= AQUÍ VAN TUS <link> y <script> EXISTENTES (Leaflet, estilos, etc.) ======= -->
  <!-- No toqué nada arriba -->
</head>
<body>

  <!-- ======= AQUÍ VA TODO TU HTML EXISTENTE (UI, botones, mapa, módulos, etc.) ======= -->
  <!-- No toqué nada del contenido ni de los otros módulos -->

  <!-- =========================================================
       ÚNICO CAMBIO: PARCHE v3 PARA "Geocerca (Lat/Lng)"
       - Acepta coordenadas separadas por ';' o por líneas
       - Soporta coma o punto decimal
       - Auto-detecta lon,lat y corrige a lat,lng
       - Refresca selector/lista y dibuja sin romper tu render
       - Usa el botón con id="createFenceByCoordsBtn"
     ========================================================= -->
  <script id="patch-geofence-latlng-v3">
  (function(){
    "use strict";
    if (window.__PATCH_GEOFENCE_LATLNG_V3__) return;
    window.__PATCH_GEOFENCE_LATLNG_V3__ = true;

    function byId(id){ return document.getElementById(id); }
    function ensureBtnType(id){ const b=byId(id); if(b && b.type!=="button") b.type="button"; }
    function uid(){ return "f_"+Math.random().toString(36).slice(2,10); }
    function nowName(){ return "Geocerca "+(Date.now()%1000); }

    // Storage (mismas claves que tu app)
    const UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_';
    function currentUserId(){
      try{
        const cur = localStorage.getItem(CK);
        if (cur) return cur;
        const users = JSON.parse(localStorage.getItem(UK)||'[]');
        return (users && users[0] && users[0].id) ? users[0].id : 'default';
      }catch(e){ return 'default'; }
    }
    function fkey(){ return FPRE + currentUserId(); }
    function readFences(){
      try { const a = JSON.parse(localStorage.getItem(fkey()) || "[]"); return Array.isArray(a) ? a : []; }
      catch(e){ return []; }
    }
    function writeFences(arr){ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }

    // ===== Parser robusto (soporta ; y \n, coma/punto decimal, y lon,lat) =====
    function parseLatLngMultiline(text){
      const pts=[];
      if(!text) return pts;

      // Cortamos por ';' o saltos de línea (pueden mezclarse)
      const segments = text.split(/[;\r\n]+/).map(s=>s.trim()).filter(Boolean);

      for (const seg of segments){
        // Extrae los DOS primeros números (ignora texto/paréntesis)
        const nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
        if(!nums || nums.length < 2) continue;

        // Convierte coma → punto
        let a = parseFloat(nums[0].replace(',', '.'));
        let b = parseFloat(nums[1].replace(',', '.'));
        if(!Number.isFinite(a) || !Number.isFinite(b)) continue;

        // Heurística de orden:
        // Intento 1: a=lat, b=lng
        let lat=a, lng=b, ok=false;
        if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) {
          ok = true;
        } else {
          // Intento 2: a=lng, b=lat → invertimos
          lat=b; lng=a;
          if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) ok = true;
        }
        if(!ok) continue;

        pts.push({lat, lng});
      }
      return pts;
    }

    // ===== UI helpers (no interfieren) =====
    function refreshSelectorsAndList(activeId){
      const fences = readFences();
      const sel = byId('geofenceSelect');
      if (sel){
        sel.innerHTML = fences.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        if (activeId) sel.value = activeId;
      }
      const list = byId('fenceList');
      if (list){
        list.innerHTML = fences.length
          ? fences.map(f=>`<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="${f.id}">
              <div class="text-sm font-medium">${f.name}</div>
              <div class="text-xs text-gray-500">${f.latlngs.length} puntos</div>
            </li>`).join('')
          : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
      }
    }

    // Dibujo directo opcional (no interfiere si tu render ya repinta)
    function tryDrawOnMap(fence){
      try{
        const map=(window.nobisMap||window.map||null);
        if(!map || !window.L) return;
        const g=(window.NOBIS_FENCE_GROUP)||L.layerGroup().addTo(map);
        if(!window.NOBIS_FENCE_GROUP) window.NOBIS_FENCE_GROUP=g;
        const poly=L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(g);
        poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});
        try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(e){}
      }catch(_e){}
    }

    function createFenceByCoords(){
      const example = [
        "Pega coordenadas Lat,Lng (una por línea o separadas con ';'). Formatos válidos:",
        "-1.23456, -78.12345",
        "-1.23456 -78.12345",
        "-1,23456  -78,12345   (coma decimal)",
        "(-1.23456, -78.12345)",
        "-78.12345, -1.23456   (lon,lat; se detecta y corrige)",
        "",
        "También sirve en una sola línea separadas por ';':",
        "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092"
      ].join("\n");

      const raw = prompt(example);
      if (raw === null) return;

      const pts = parseLatLngMultiline(raw);
      if (pts.length < 3){
        alert("Se requieren al menos 3 coordenadas válidas (lat,lng).");
        return;
      }

      const name = (prompt("Nombre de la geocerca:", nowName()) || "").trim() || nowName();

      const arr = readFences();
      const id = uid();
      const fence = { id, name, latlngs: pts };
      arr.push(fence);
      writeFences(arr);

      refreshSelectorsAndList(id);
      try { window.dispatchEvent(new CustomEvent('nobis:fences-updated', { detail:{ id } })); } catch(_e){}
      tryDrawOnMap(fence);
    }

    function wire(){
      ensureBtnType('createFenceByCoordsBtn');
      const btn = byId('createFenceByCoordsBtn');
      if (btn){
        // Forzamos nuestro handler (si había otro, lo sobrescribimos)
        btn.onclick = function(ev){ ev.preventDefault(); createFenceByCoords(); };
      }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', wire, { once:true });
    } else {
      wire();
    }
  })();
  </script>
  <!-- ========================================================= -->

  <!-- ======= TUS SCRIPTS YA EXISTENTES (NO TOCADOS) ======= -->
<script id="patch-geofence-latlng-v4">
(function(){
  "use strict";
  if (window.__PATCH_GEOFENCE_LATLNG_V4__) return;
  window.__PATCH_GEOFENCE_LATLNG_V4__ = true;

  // ---------- Utils ----------
  function byId(id){ return document.getElementById(id); }
  function ensureBtnType(id){ const b=byId(id); if(b && b.type!=="button") b.type="button"; }
  function uid(){ return "f_"+Math.random().toString(36).slice(2,10); }
  function nowName(){ return "Geocerca "+(Date.now()%1000); }

  // ---------- Storage (mismas claves que viene usando tu app) ----------
  const UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_';
  const AK='NobisApp_active_fence'; // (por si tu app lo usa)

  function currentUserId(){
    try{
      const cur = localStorage.getItem(CK);
      if (cur) return cur;
      const users = JSON.parse(localStorage.getItem(UK)||'[]');
      return (users && users[0] && users[0].id) ? users[0].id : 'default';
    }catch(e){ return 'default'; }
  }
  function fkey(){ return FPRE + currentUserId(); }
  function readFences(){
    try { const a = JSON.parse(localStorage.getItem(fkey()) || "[]"); return Array.isArray(a) ? a : []; }
    catch(e){ return []; }
  }
  function writeFences(arr){ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }
  function setActiveFence(id){ try{ localStorage.setItem(AK, id||""); }catch(_e){} }

  // ---------- Parser robusto (acepta ; o saltos de línea, coma/punto decimal, lon,lat) ----------
  function parseLatLngMultiline(text){
    const pts=[];
    if(!text) return pts;
    const segments = text.split(/[;\r\n]+/).map(s=>s.trim()).filter(Boolean);
    for (const seg of segments){
      const nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
      if(!nums || nums.length < 2) continue;
      let a = parseFloat(nums[0].replace(',', '.'));
      let b = parseFloat(nums[1].replace(',', '.'));
      if(!Number.isFinite(a) || !Number.isFinite(b)) continue;

      // Heurística: intentamos lat=a, lng=b; si no cuadra, invertimos
      let lat=a, lng=b, ok=false;
      if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) ok = true;
      else {
        lat=b; lng=a;
        if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) ok = true;
      }
      if(!ok) continue;
      pts.push({lat, lng});
    }
    return pts;
  }

  // ---------- UI helpers: intenta refrescar selectores/listas de tu app si existen ----------
  function refreshSelectorsAndList(activeId){
    const fences = readFences();

    // Select principal (si existe con este id)
    const sel = byId('geofenceSelect');
    if (sel){
      sel.innerHTML = fences.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
      if (activeId) sel.value = activeId;
    }

    // Lista lateral (si existe con este id)
    const list = byId('fenceList');
    if (list){
      list.innerHTML = fences.length
        ? fences.map(f=>`<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="${f.id}">
            <div class="text-sm font-medium">${f.name}</div>
            <div class="text-xs text-gray-500">${f.latlngs.length} puntos</div>
          </li>`).join('')
        : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
    }
  }

  // ---------- Hooks: intenta llamar/avisar a tu lógica nativa si existe ----------
  function announceChange(newId){
    try {
      // Fire eventos que tu código podría estar escuchando
      window.dispatchEvent(new CustomEvent('nobis:fences-updated', { detail:{ id:newId } }));
      window.dispatchEvent(new CustomEvent('geofence:created', { detail:{ id:newId } }));
    } catch(_e){}

    // Llamar funciones globales si existen (no rompe si no existen)
    const fns = [
      'nobisRenderFences','renderGeofences','drawAllGeofences',
      'updateGeofencesUI','refreshGeofences','redrawGeofences',
      'paintFences','repaintFences'
    ];
    for(const fn of fns){
      try{ if (typeof window[fn] === 'function') { window[fn](); break; } }catch(_e){}
    }
  }

  // ---------- Dibujo de respaldo directo (si tu UI aún no repinta) ----------
  function drawFallbackOnMap(fence){
    try{
      const map=(window.nobisMap||window.map||null);
      if(!map || !window.L) return;
      const g=(window.NOBIS_FENCE_GROUP)||L.layerGroup().addTo(map);
      if(!window.NOBIS_FENCE_GROUP) window.NOBIS_FENCE_GROUP=g;
      const poly=L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(g);
      poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});
      try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(_e){}
    }catch(_e){}
  }

  // ---------- Crear y persistir geocerca desde puntos ----------
  function saveFenceFromPts(name, pts){
    const id = uid();

    // Guardamos en un formato súper compatible: ambos tipos de coords
    const fence = {
      id,
      name: name || nowName(),
      latlngs: pts.map(p=>({lat:p.lat, lng:p.lng})),       // objetos {lat,lng}
      coords:  pts.map(p=>[p.lat, p.lng]),                 // arrays [lat,lng]
      createdAt: Date.now()
    };

    const arr = readFences();
    arr.push(fence);
    writeFences(arr);
    setActiveFence(id);

    // Refrescar (si existen) selectores/listas
    refreshSelectorsAndList(id);

    // Avisar a tu app (si escucha algo) y forzar repintado
    announceChange(id);

    // Dibujo de respaldo directo (por si tu render aún no se activó)
    drawFallbackOnMap(fence);
  }

  // ---------- Flujo principal (botón) ----------
  function createFenceByCoords(){
    const example = [
      "Pega coordenadas Lat,Lng (una por línea o separadas con ';'). Formatos válidos:",
      "-1.23456, -78.12345",
      "-1.23456 -78.12345",
      "-1,23456  -78,12345   (coma decimal)",
      "(-1.23456, -78.12345)",
      "-78.12345, -1.23456   (lon,lat; se detecta y corrige)",
      "",
      "También sirve en una sola línea separadas por ';':",
      "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092"
    ].join("\n");

    const raw = prompt(example);
    if (raw === null) return;

    const pts = parseLatLngMultiline(raw);
    if (pts.length < 3){
      alert("Se requieren al menos 3 coordenadas válidas (lat,lng).");
      return;
    }

    // Pedimos nombre y LO GUARDAMOS
    const name = (prompt("Nombre de la geocerca:", nowName()) || "").trim() || nowName();
    saveFenceFromPts(name, pts);
  }

  function wire(){
    ensureBtnType('createFenceByCoordsBtn');
    const btn = byId('createFenceByCoordsBtn');
    if (btn){
      // Forzamos nuestro handler (si había otro, lo sobrescribimos)
      btn.onclick = function(ev){ ev.preventDefault(); createFenceByCoords(); };
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wire, { once:true });
  } else {
    wire();
  }
})();
</script>
<script id="patch-geofence-latlng-v5">
(function(){
  // Nunca bloquees el arranque si algo sale mal
  try{
    if (window.__PATCH_GEOFENCE_LATLNG_V5__) return;
    window.__PATCH_GEOFENCE_LATLNG_V5__ = true;

    // Utils seguros
    function byId(id){ return document.getElementById(id); }
    function ensureBtnType(id){ try{ const b=byId(id); if(b && b.type!=="button") b.type="button"; }catch(_){} }
    function uid(){ return "f_"+Math.random().toString(36).slice(2,10); }
    function nowName(){ return "Geocerca "+(Date.now()%1000); }

    // Storage con try/catch
    const UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_', AK='NobisApp_active_fence';
    function currentUserId(){
      try{
        const cur = localStorage.getItem(CK);
        if (cur) return cur;
        const users = JSON.parse(localStorage.getItem(UK)||'[]');
        return (users && users[0] && users[0].id) ? users[0].id : 'default';
      }catch(_){ return 'default'; }
    }
    function fkey(){ return FPRE + currentUserId(); }
    function readFences(){
      try{ const a = JSON.parse(localStorage.getItem(fkey()) || "[]"); return Array.isArray(a)?a:[]; }
      catch(_){ return []; }
    }
    function writeFences(arr){ try{ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }catch(_){} }
    function setActiveFence(id){ try{ localStorage.setItem(AK, id||""); }catch(_){} }

    // Parser robusto: soporta ';' y saltos de línea, coma/punto decimal y lon,lat
    function parseLatLngMultiline(text){
      const pts=[]; if(!text) return pts;
      const segments = text.split(/[;\r\n]+/).map(s=>s.trim()).filter(Boolean);
      for (const seg of segments){
        const nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
        if(!nums || nums.length<2) continue;
        let a = parseFloat(nums[0].replace(',', '.'));
        let b = parseFloat(nums[1].replace(',', '.'));
        if(!Number.isFinite(a) || !Number.isFinite(b)) continue;
        let lat=a, lng=b, ok=false;
        if (Math.abs(lat)<=90 && Math.abs(lng)<=180) ok=true;
        else { lat=b; lng=a; if (Math.abs(lat)<=90 && Math.abs(lng)<=180) ok=true; }
        if(ok) pts.push({lat,lng});
      }
      return pts;
    }

    // Refrescar UI si existen esos elementos en tu app (no rompe si no)
    function refreshSelectorsAndList(activeId){
      try{
        const fences = readFences();
        const sel = byId('geofenceSelect');
        if(sel){
          sel.innerHTML = fences.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
          if(activeId) sel.value = activeId;
        }
        const list = byId('fenceList');
        if(list){
          list.innerHTML = fences.length
            ? fences.map(f=>`<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="${f.id}">
                <div class="text-sm font-medium">${f.name}</div>
                <div class="text-xs text-gray-500">${f.latlngs.length} puntos</div>
              </li>`).join('')
            : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
        }
      }catch(_){}
    }

    // Hooks suaves: no fallan si no existen
    function announceChange(newId){
      try{ window.dispatchEvent(new CustomEvent('nobis:fences-updated', { detail:{ id:newId } })); }catch(_){}
      try{ window.dispatchEvent(new CustomEvent('geofence:created',   { detail:{ id:newId } })); }catch(_){}
      const candidates=[
        'nobisRenderFences','renderGeofences','drawAllGeofences',
        'updateGeofencesUI','refreshGeofences','redrawGeofences',
        'paintFences','repaintFences'
      ];
      for(const fn of candidates){
        try{ if(typeof window[fn]==='function'){ window[fn](); break; } }catch(_){}
      }
    }

    // Dibujo de respaldo (solo si hay Leaflet/map)
    function drawFallbackOnMap(fence){
      try{
        const map = window.nobisMap || window.map || null;
        if(!map || !window.L) return;
        const g = window.NOBIS_FENCE_GROUP || L.layerGroup().addTo(map);
        if(!window.NOBIS_FENCE_GROUP) window.NOBIS_FENCE_GROUP = g;
        const poly = L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(g);
        try{ poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'}); }catch(_){}
        try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(_){}
      }catch(_){}
    }

    function saveFenceFromPts(name, pts){
      const id = uid();
      const fence = {
        id,
        name: (name||nowName()),
        latlngs: pts.map(p=>({lat:p.lat,lng:p.lng})),
        coords:  pts.map(p=>[p.lat,p.lng]),
        createdAt: Date.now()
      };
      const arr = readFences(); arr.push(fence); writeFences(arr); setActiveFence(id);
      refreshSelectorsAndList(id);
      announceChange(id);
      drawFallbackOnMap(fence);
    }

    function createFenceByCoords(){
      try{
        const example = [
          "Pega coordenadas Lat,Lng (una por línea o separadas con ';'). Formatos válidos:",
          "-1.23456, -78.12345",
          "-1.23456 -78.12345",
          "-1,23456  -78,12345   (coma decimal)",
          "(-1.23456, -78.12345)",
          "-78.12345, -1.23456   (lon,lat; se detecta y corrige)",
          "",
          "También sirve en una sola línea separadas por ';':",
          "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092"
        ].join("\n");

        const raw = prompt(example);
        if (raw === null) return;
        const pts = parseLatLngMultiline(raw);
        if (pts.length < 3){ alert("Se requieren al menos 3 coordenadas válidas (lat,lng)."); return; }

        const name = (prompt("Nombre de la geocerca:", nowName()) || "").trim() || nowName();
        saveFenceFromPts(name, pts);
      }catch(_){}
    }

    function wire(){
      try{
        ensureBtnType('createFenceByCoordsBtn');
        const btn = byId('createFenceByCoordsBtn');
        if(btn){ btn.onclick = function(ev){ ev.preventDefault(); createFenceByCoords(); }; }
      }catch(_){}
    }

    // Espera a que TODO cargue, para no chocar con otros scripts
    window.addEventListener('load', function(){
      try{ setTimeout(wire, 0); }catch(_){}
    });

  }catch(_e){
    // Nunca hacemos throw: el objetivo es NO romper tu app
  }
})();
</script>
<script id="patch-geofence-latlng-v6">
(function(){
  try{
    if (window.__PATCH_GEOFENCE_LATLNG_V6__) return;
    window.__PATCH_GEOFENCE_LATLNG_V6__ = true;

    // ---- Utils sin globals ----
    function byId(id){ return document.getElementById(id); }
    function ensureBtnType(id){ try{ var b=byId(id); if(b && b.type!=='button') b.type='button'; }catch(_){} }
    function uid(){ return 'f_'+Math.random().toString(36).slice(2,10); }
    function nowName(){ return 'Geocerca '+(Date.now()%1000); }

    // ---- Storage defensivo ----
    var UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_', AK='NobisApp_active_fence';
    function currentUserId(){
      try{
        var cur = localStorage.getItem(CK);
        if(cur) return cur;
        var users = JSON.parse(localStorage.getItem(UK)||'[]');
        return (users && users[0] && users[0].id) ? users[0].id : 'default';
      }catch(_){ return 'default'; }
    }
    function fkey(){ return FPRE + currentUserId(); }
    function readFences(){ try{ var a=JSON.parse(localStorage.getItem(fkey())||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } }
    function writeFences(arr){ try{ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }catch(_){ } }
    function setActiveFence(id){ try{ localStorage.setItem(AK, id||''); }catch(_){} }

    // ---- Parser robusto (soporta ';' y saltos, coma/punto decimal, lon/lat) ----
    function parseLatLngMultiline(text){
      var pts=[]; if(!text) return pts;
      var segments = text.split(/[;\r\n]+/).map(function(s){ return s.trim(); }).filter(Boolean);
      for (var i=0;i<segments.length;i++){
        var seg = segments[i];
        var nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
        if(!nums || nums.length<2) continue;
        var a = parseFloat(nums[0].replace(',', '.'));
        var b = parseFloat(nums[1].replace(',', '.'));
        if(!isFinite(a)||!isFinite(b)) continue;
        var lat=a, lng=b, ok=false;
        if (Math.abs(lat)<=90 && Math.abs(lng)<=180) ok=true;
        else { lat=b; lng=a; if (Math.abs(lat)<=90 && Math.abs(lng)<=180) ok=true; }
        if(ok) pts.push({lat:lat,lng:lng});
      }
      return pts;
    }

    // ---- Refresco de UI si existen elementos ----
    function refreshSelectorsAndList(activeId){
      try{
        var fences = readFences();
        var sel = byId('geofenceSelect');
        if(sel){
          sel.innerHTML = fences.map(function(f){ return '<option value="'+f.id+'">'+f.name+'</option>'; }).join('');
          if(activeId) sel.value = activeId;
        }
        var list = byId('fenceList');
        if(list){
          list.innerHTML = fences.length
            ? fences.map(function(f){
                return '<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="'+f.id+'">'+
                       '<div class="text-sm font-medium">'+f.name+'</div>'+
                       '<div class="text-xs text-gray-500">'+f.latlngs.length+' puntos</div>'+
                       '</li>';
              }).join('')
            : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
        }
      }catch(_){}
    }

    // ---- Hooks suaves ----
    function announceChange(newId){
      try{ window.dispatchEvent(new CustomEvent('nobis:fences-updated', { detail:{ id:newId } })); }catch(_){}
      try{ window.dispatchEvent(new CustomEvent('geofence:created',   { detail:{ id:newId } })); }catch(_){}
      var fns=['nobisRenderFences','renderGeofences','drawAllGeofences','updateGeofencesUI','refreshGeofences','redrawGeofences','paintFences','repaintFences'];
      for(var i=0;i<fns.length;i++){ try{ if(typeof window[fns[i]]==='function'){ window[fns[i]](); break; } }catch(_){} }
    }

    // ---- Dibujo de respaldo (solo si L y mapa existen) ----
    function drawFallbackOnMap(fence){
      try{
        var map = window.nobisMap || window.map || null;
        if(!map || !window.L) return;
        var g = window.NOBIS_FENCE_GROUP || L.layerGroup().addTo(map);
        if(!window.NOBIS_FENCE_GROUP) window.NOBIS_FENCE_GROUP = g;
        var poly = L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(g);
        try{ poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'}); }catch(_){}
        try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(_){}
      }catch(_){}
    }

    function saveFenceFromPts(name, pts){
      try{
        var id = uid();
        var fence = {
          id:id,
          name: name||nowName(),
          latlngs: pts.map(function(p){ return {lat:p.lat,lng:p.lng}; }),
          coords:  pts.map(function(p){ return [p.lat,p.lng]; }),
          createdAt: Date.now()
        };
        var arr = readFences(); arr.push(fence); writeFences(arr); setActiveFence(id);
        refreshSelectorsAndList(id);
        announceChange(id);
        drawFallbackOnMap(fence);
      }catch(_){}
    }

    function createFenceByCoords(){
      try{
        var example = [
          "Pega coordenadas Lat,Lng (una por línea o separadas con ';'). Formatos válidos:",
          "-1.23456, -78.12345",
          "-1.23456 -78.12345",
          "-1,23456  -78,12345   (coma decimal)",
          "(-1.23456, -78.12345)",
          "-78.12345, -1.23456   (lon,lat; se detecta y corrige)",
          "",
          "También sirve en una sola línea separadas por ';':",
          "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092"
        ].join("\n");
        var raw = prompt(example);
        if (raw === null) return;
        var pts = parseLatLngMultiline(raw);
        if (pts.length < 3){ alert("Se requieren al menos 3 coordenadas válidas (lat,lng)."); return; }
        var name = (prompt("Nombre de la geocerca:", nowName()) || '').trim() || nowName();
        saveFenceFromPts(name, pts);
      }catch(_){}
    }

    function wire(){
      try{
        ensureBtnType('createFenceByCoordsBtn');
        var btn = byId('createFenceByCoordsBtn');
        if(btn){ btn.onclick = function(ev){ try{ ev && ev.preventDefault(); createFenceByCoords(); }catch(_){ } }; }
      }catch(_){}
    }

    // Espera a que TODO esté cargado, para no romper nada
    window.addEventListener('load', function(){ try{ setTimeout(wire, 0); }catch(_){} });
  }catch(_){}
})();
</script>
<script id="patch-geofence-latlng-v7">
(function(){
  try{
    if (window.__PATCH_GEOFENCE_LATLNG_V7__) return;
    window.__PATCH_GEOFENCE_LATLNG_V7__ = true;

    // ==== Utilidades (ES5) ====
    function byId(id){ return document.getElementById(id); }
    function uid(){ return 'f_' + Math.random().toString(36).slice(2,10); }
    function nowName(){ return 'Geocerca ' + (Date.now()%1000); }

    // ==== Storage defensivo (claves existentes) ====
    var UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_';
    function currentUserId(){
      try{
        var cur = localStorage.getItem(CK);
        if (cur) return cur;
        var users = JSON.parse(localStorage.getItem(UK)||'[]');
        if (users && users[0] && users[0].id) return users[0].id;
      }catch(_){}
      return 'default';
    }
    function fkey(){ return FPRE + currentUserId(); }
    function readFences(){
      try{
        var a = JSON.parse(localStorage.getItem(fkey()) || '[]');
        return Array.isArray(a) ? a : [];
      }catch(_){ return []; }
    }
    function writeFences(arr){
      try{ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }catch(_){}
    }

    // ==== Parser robusto (soporta ';' y saltos, coma/punto decimal, lon/lat) ====
    function parseLatLngMultiline(text){
      var pts=[]; if(!text) return pts;
      var segments = text.split(/[;\r\n]+/);
      for (var i=0;i<segments.length;i++){
        var seg = (segments[i]||'').trim();
        if(!seg) continue;
        // Toma los DOS primeros números (acepta -12.34 o -12,34)
        var nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
        if(!nums || nums.length<2) continue;
        var a = parseFloat(nums[0].replace(',', '.'));
        var b = parseFloat(nums[1].replace(',', '.'));
        if(!isFinite(a) || !isFinite(b)) continue;
        var lat=a, lng=b;
        // Si el primero luce como lon y el segundo como lat, invierte
        if (Math.abs(lat)>90 || Math.abs(lng)>180){ lat=b; lng=a; }
        if (Math.abs(lat)<=90 && Math.abs(lng)<=180){ pts.push({lat:lat,lng:lng}); }
      }
      return pts;
    }

    // ==== Refresco ligero de UI si existen esos elementos ====
    function refreshSelectorsAndList(activeId){
      try{
        var fences = readFences();
        var sel = byId('geofenceSelect');
        if(sel){
          var html='', i;
          for(i=0;i<fences.length;i++){
            html += '<option value="'+fences[i].id+'">'+fences[i].name+'</option>';
          }
          sel.innerHTML = html;
          if(activeId) sel.value = activeId;
        }
        var list = byId('fenceList');
        if(list){
          if(!fences.length){
            list.innerHTML = '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
          }else{
            var Lh='';
            for(i=0;i<fences.length;i++){
              Lh += '<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="'+fences[i].id+'">'+
                    '<div class="text-sm font-medium">'+fences[i].name+'</div>'+
                    '<div class="text-xs text-gray-500">'+fences[i].latlngs.length+' puntos</div>'+
                    '</li>';
            }
            list.innerHTML = Lh;
          }
        }
      }catch(_){}
    }

    // ==== Dibujo de respaldo (solo si hay Leaflet y mapa) ====
    function drawFallbackOnMap(fence){
      try{
        var map = window.nobisMap || window.map;
        if(!map || !window.L) return;
        if(!window.NOBIS_FENCE_GROUP){ window.NOBIS_FENCE_GROUP = L.layerGroup().addTo(map); }
        var poly = L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:0.2}).addTo(window.NOBIS_FENCE_GROUP);
        try{ poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'}); }catch(_){}
        try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(_){}
      }catch(_){}
    }

    // ==== Crear desde puntos y persistir ====
    function saveFenceFromPts(name, pts){
      try{
        var id = uid();
        var fence = {
          id: id,
          name: (name||nowName()),
          latlngs: pts,                   // [{lat,lng}]
          coords: (function(){
            var a=[],i; for(i=0;i<pts.length;i++){ a.push([pts[i].lat, pts[i].lng]); } return a;
          })(),
          createdAt: Date.now()
        };
        var arr = readFences(); arr.push(fence); writeFences(arr);
        refreshSelectorsAndList(id);
        // Si tu app tiene funciones de repintado, intenta llamarlas (no falla si no existen)
        try{
          if (typeof window.renderGeofences === 'function') window.renderGeofences();
          else if (typeof window.refreshGeofences === 'function') window.refreshGeofences();
          else if (typeof window.redrawGeofences === 'function') window.redrawGeofences();
        }catch(_){}
        // Dibujo de respaldo
        drawFallbackOnMap(fence);
      }catch(_){}
    }

    // ==== Interacción principal ====
    function createFenceByCoords(){
      try{
        var example = "Pega coordenadas Lat,Lng (una por línea o separadas con ';'):\n"+
                      "-1.23456, -78.12345\n-1.23400 -78.12000\n"+
                      "-1,23456  -78,12345   (coma decimal)\n"+
                      "-78.12, -1.23         (lon,lat; se corrige)\n\n"+
                      "También en una sola línea separadas por ';':\n"+
                      "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092";
        var raw = window.prompt(example);
        if (raw === null) return;
        var pts = parseLatLngMultiline(raw);
        if (pts.length < 3){ window.alert("Se requieren al menos 3 coordenadas válidas (lat,lng)."); return; }
        var name = (window.prompt("Nombre de la geocerca:", nowName()) || '').trim();
        if(!name) name = nowName();
        saveFenceFromPts(name, pts);
      }catch(_){}
    }

    function wire(){
      try{
        var btn = byId('createFenceByCoordsBtn');
        if (btn){
          if (btn.type !== 'button') btn.type = 'button';
          btn.onclick = function(ev){ try{ if(ev) ev.preventDefault(); createFenceByCoords(); }catch(_){ } };
        }
      }catch(_){}
    }

    // Arranque: esperar a que todo cargue
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){ try{ wire(); }catch(_){} }, false);
    } else {
      try{ wire(); }catch(_){}
    }
  }catch(_e){}
})();
</script>

</body>
</html>


