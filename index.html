<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Personal de Finca (Leaflet + Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f3f4f6;overflow-x:hidden}
    #map{height:55vh;border-radius:1rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    @media(max-width:768px){#map{height:45vh}}
    .farm-label{background:#fff;border:1px solid rgba(0,0,0,.2);padding:2px 6px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.15);font-size:12px}
    .mousepos-control{background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .error-message{color:#dc2626;font-size:14px;margin-top:6px;display:none}
    button,input,select{font-size:16px}
    .person-row:hover{background-color:#f9fafb;}
  </style>
</head>
<body class="p-4 sm:p-8">

  <!-- Modal admin -->
  <div id="adminModal" class="fixed inset-0 bg-gray-900/75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input id="adminCodeInput" type="password" placeholder="Código de acceso"
             class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2">
      <div id="errorMessage" class="error-message">Código incorrecto. Intenta con "admin123"</div>
      <button id="adminLoginBtn"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-3 rounded-lg">
        Acceder
      </button>
    </div>
  </div>

  <!-- Contenido -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">
    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Control de Personal y Geocercas</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Leaflet + Firestore (con caché local)</p>
    </header>

    <!-- Finca activa -->
    <div class="bg-white p-4 rounded-2xl shadow-lg">
      <label class="block text-sm font-medium text-gray-700">Finca activa</label>
      <select id="farmSelect" class="mt-1 w-full border rounded-md p-2"></select>
    </div>

    <!-- Mapa + barra -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa de Fincas</h2>
        <div class="ml-auto flex flex-wrap gap-2">
          <button id="startFenceBtn"  class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="hidden bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg">Finalizar geocerca</button>
          <button id="cancelFenceBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>

          <button id="createFenceByCoordsBtn" class="bg-sky-700 hover:bg-sky-800 text-white font-semibold px-4 py-2 rounded-lg">Geocerca (Lat/Lngs)</button>

          <button id="createFarmBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca</button>
          <button id="createByCoordsBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca (Lat/Lng)</button>
          <button id="deleteFarmBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar finca</button>

          <button id="deleteFenceBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar geocerca</button>
          <button id="editFenceBtn"   class="bg-violet-600 hover:bg-violet-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn"   class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar cambios</button>
          <button id="cancelFenceEditBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar edición</button>

          <button id="exportGeoJSONBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-4 py-2 rounded-lg">Exportar GeoJSON</button>
          <label class="inline-flex items-center gap-2 bg-teal-50 hover:bg-teal-100 text-teal-700 font-semibold px-4 py-2 rounded-lg cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJSONInput" type="file" accept=".geojson,application/geo+json,application/json" class="hidden">
          </label>
        </div>
      </div>

      <!-- Panel nombre finca (Lat/Lng) -->
      <div id="coordsNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la nueva finca</label>
          <div class="flex gap-2">
            <input id="coordsNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Finca Palora Norte" />
            <button id="coordsNameSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="coordsNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="coordsNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <!-- Panel nombre geocerca -->
      <div id="fenceNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex gap-2">
            <input id="fenceNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Geocerca Lote 1" />
            <button id="fenceNameSaveBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="fenceNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="fenceNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <div id="map"></div>

      <!-- Explorador -->
      <div id="indexPanel" class="mt-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800">Explorador de elementos</h3>
          <span class="text-xs text-gray-500">Doble clic en un nombre para centrar/ajustar el mapa</span>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-2">
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Fincas</div>
            <ul id="farmList" class="divide-y divide-gray-100"></ul>
          </div>
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Geocercas</div>
            <ul id="fenceList" class="divide-y divide-gray-100"></ul>
          </div>
        </div>
      </div>

      <p id="statusMessage" class="mt-3 text-sm text-gray-600">
        Para geocercas: Nueva geocerca → clics en el mapa → Finalizar geocerca → asigna nombre y guarda.
      </p>
    </div>

    <!-- ===== Gestión de Personal ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Gestión de Personal</h2>
        <span class="text-xs text-gray-500">Doble clic sobre una fila para ir a su asignación</span>
      </div>

      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre</label>
          <input id="pFirstName" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Apellido</label>
          <input id="pLastName" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Cédula</label>
          <input id="pIdNumber" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Asignación</label>
          <select id="pAssignSelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
      </div>

      <div class="mt-3">
        <button id="addPersonBtn" type="button"
                class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
          Agregar
        </button>
        <span id="pFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>

      <!-- Filtros -->
      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Buscar</label>
          <input id="pSearchInput" type="text" placeholder="Nombre, apellido o cédula" class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo asignación</label>
          <select id="pTypeFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
            <option value="farm">Fincas</option>
            <option value="fence">Geocercas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Finca/Geocerca</label>
          <select id="pEntityFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">NOMBRE</th>
              <th class="px-3 py-2">APELLIDO</th>
              <th class="px-3 py-2">CÉDULA</th>
              <th class="px-3 py-2">ASIGNADO A</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="personnelTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Scripts Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE",
      authDomain: "demo-finca-app.firebaseapp.com",
      projectId: "demo-finca-app",
      storageBucket: "demo-finca-app.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    try { db.settings({ experimentalForceLongPolling: true, experimentalAutoDetectLongPolling: true, useFetchStreams: false }); } catch {}
    let authReady = false;
    firebase.auth().signInAnonymously().catch(console.error);
    firebase.auth().onAuthStateChanged(u => authReady = !!u);

    /* ---------- Estado y caché ---------- */
    let map;
    const fincaMarkers = {}, geofenceLayers = {};
    const LS_KEY='fincas_cache_v1', LS_GF='geofences_cache_v1', LS_PE='personnel_cache_v1';
    const save = (k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load = (k)=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return []}};
    const saveFarms=(v)=>save(LS_KEY,v), loadFarms=()=>load(LS_KEY);
    const saveFences=(v)=>save(LS_GF,v), loadFences=()=>load(LS_GF);
    const savePeople=(v)=>save(LS_PE,v),  loadPeople=()=>load(LS_PE);

    let currentFarms=[], currentFences=[], currentPersonnel=[];
    const GEOFENCE_STYLE={weight:2,fillOpacity:.15}, GEOFENCE_SELECTED_STYLE={weight:3,color:'#ef4444',fillOpacity:.2};
    let isDrawingFence=false, drawingCoords=[], drawingPolyline=null, drawingMarkers=[], pendingFenceCoords=null;
    let selectedFenceId=null, editGroup=null, editToolbar=null, isEditingFence=false, editBackupCoords=null;

    function waitAuthThen(fn){ if(authReady) return fn(); const t=setInterval(()=>{ if(authReady){clearInterval(t); fn();}},120); }

    /* ---------- Mapa ---------- */
    function initMap(center){ center=center||{lat:-0.1807,lng:-78.4678};
      map=L.map('map',{center:[center.lat,center.lng],zoom:6});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      editGroup=new L.FeatureGroup(); map.addLayer(editGroup);
      addMousePositionControl();
      renderFarmsFromCache(); renderGeofencesFromCache();
      map.on('click', async e=>{
        if(isDrawingFence){ addFenceVertex(e.latlng); return; }
        const name=prompt('Nombre de la nueva finca:'); if(!name) return;
        try{ await db.collection('farms').add({name,fincaLocation:{lat:e.latlng.lat,lng:e.latlng.lng}}); }
        catch{ const farms=loadFarms(); farms.push({id:'local-'+Date.now(),name,fincaLocation:{lat:e.latlng.lat,lng:e.latlng.lng}}); saveFarms(farms); renderFarmsFromCache(); }
      });
      waitAuthThen(async()=>{ startSubscriptions(); await Promise.all([initialFetchFarms(),initialFetchGeofences(),initialFetchPersonnel()]); syncLocalPendingToFirestore(); });
    }
    function addMousePositionControl(){
      const MousePos=L.Control.extend({options:{position:'bottomleft'},onAdd:function(){const d=L.DomUtil.create('div','mousepos-control');d.innerHTML='Lat: — Lng: —';this._div=d;return d;},update:function(lat,lng){this._div.innerHTML=(lat!=null&&lng!=null)?`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`:'Lat: — Lng: —';}});
      const ctrl=new MousePos(); ctrl.addTo(map);
      map.on('mousemove',e=>ctrl.update(e.latlng.lat,e.latlng.lng));
      map.on('mouseout',()=>ctrl.update(null,null));
    }
    function renderFarmsFromCache(){
      const farms=loadFarms();
      Object.values(fincaMarkers).forEach(m=>map.removeLayer(m)); for(const k in fincaMarkers) delete fincaMarkers[k];
      farms.forEach(f=>{ if(!f?.id||!f?.fincaLocation) return; const m=L.marker([f.fincaLocation.lat,f.fincaLocation.lng]).addTo(map); m.bindTooltip(f.name||'Finca',{permanent:true,direction:'right',offset:[10,0],className:'farm-label'}); fincaMarkers[f.id]=m;});
      const sel=document.getElementById('farmSelect'); if(sel){ sel.innerHTML=''; farms.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o);}); }
      updateDeleteButtonState(); currentFarms=farms||[]; buildIndexList(); buildAssignOptions();
    }
    function renderGeofencesFromCache(){
      Object.values(geofenceLayers).forEach(p=>map.removeLayer(p)); for(const k in geofenceLayers) delete geofenceLayers[k];
      const fences=loadFences();
      fences.forEach(g=>{ if(!g?.id||!Array.isArray(g.path)||g.path.length<3) return; const latlngs=g.path.map(p=>[p.lat,p.lng]); const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map); poly.bindTooltip(g.name||'Geocerca',{permanent:true,direction:'center',className:'farm-label'}); geofenceLayers[g.id]=poly; poly.on('click',()=>selectFence(g.id)); if(selectedFenceId===g.id) poly.setStyle(GEOFENCE_SELECTED_STYLE); });
      if(selectedFenceId && !geofenceLayers[selectedFenceId]) selectedFenceId=null;
      updateDeleteFenceButtonState(); updateEditButtonsState(); currentFences=fences||[]; buildIndexList(); buildAssignOptions();
    }

    /* ---------- Firestore subs ---------- */
    let unsubFarms=null,unsubGeofences=null,unsubPersonnel=null,subsStarted=false;
    function startSubscriptions(){
      if(subsStarted) return; subsStarted=true;
      unsubFarms=db.collection('farms').onSnapshot(s=>{
        const farms=[]; Object.values(fincaMarkers).forEach(m=>map.removeLayer(m)); for(const k in fincaMarkers) delete fincaMarkers[k];
        s.forEach(doc=>{const d=doc.data(); farms.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation}); if(d.fincaLocation){const m=L.marker([d.fincaLocation.lat,d.fincaLocation.lng]).addTo(map); m.bindTooltip(d.name||'Finca',{permanent:true,direction:'right',offset:[10,0],className:'farm-label'}); fincaMarkers[doc.id]=m; }});
        currentFarms=farms.slice(); if(farms.length) saveFarms(farms);
        const sel=document.getElementById('farmSelect'); if(sel){ sel.innerHTML=''; farms.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o);}); }
        updateDeleteButtonState(); buildIndexList(); buildAssignOptions();
      },()=>renderFarmsFromCache());

      unsubGeofences=db.collection('geofences').onSnapshot(s=>{
        const fences=[]; Object.values(geofenceLayers).forEach(p=>map.removeLayer(p)); for(const k in geofenceLayers) delete geofenceLayers[k];
        s.forEach(doc=>{const d=doc.data(); const g={id:doc.id,name:d.name,path:d.path||[]}; fences.push(g);
          if(Array.isArray(g.path)&&g.path.length>=3){ const latlngs=g.path.map(p=>[p.lat,p.lng]); const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map); poly.bindTooltip(g.name||'Geocerca',{permanent:true,direction:'center',className:'farm-label'}); geofenceLayers[doc.id]=poly; poly.on('click',()=>selectFence(doc.id)); if(selectedFenceId===doc.id) poly.setStyle(GEOFENCE_SELECTED_STYLE); }
        });
        currentFences=fences.slice(); if(fences.length) saveFences(fences);
        if(selectedFenceId && !geofenceLayers[selectedFenceId]) selectedFenceId=null;
        updateDeleteFenceButtonState(); updateEditButtonsState(); buildIndexList(); buildAssignOptions();
      },()=>renderGeofencesFromCache());

      unsubPersonnel=db.collection('personnel').onSnapshot(s=>{
        const list=[]; s.forEach(doc=>{const d=doc.data(); list.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||''});});
        currentPersonnel=list.slice(); if(list.length) savePeople(list); renderPersonnelList();
      },()=>{ currentPersonnel=loadPeople(); renderPersonnelList(); });
    }
    async function initialFetchFarms(){ try{ const s=await db.collection('farms').get(); const arr=[]; s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation});}); if(arr.length){ currentFarms=arr.slice(); saveFarms(arr); renderFarmsFromCache(); } else { buildIndexList(); buildAssignOptions(); } }catch{} }
    async function initialFetchGeofences(){ try{ const s=await db.collection('geofences').get(); const arr=[]; s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,name:d.name,path:d.path||[]});}); if(arr.length){ currentFences=arr.slice(); saveFences(arr); renderGeofencesFromCache(); } else { buildIndexList(); buildAssignOptions(); } }catch{} }
    async function initialFetchPersonnel(){ try{ const s=await db.collection('personnel').get(); const arr=[]; s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||''});}); currentPersonnel=arr.length?arr.slice():loadPeople(); if(arr.length) savePeople(arr); renderPersonnelList(); }catch{ currentPersonnel=loadPeople(); renderPersonnelList(); } }
    async function syncLocalPendingToFirestore(){
      try{ const farms=loadFarms().filter(f=>String(f.id||'').startsWith('local-')); for(const f of farms){ try{await db.collection('farms').add({name:f.name||'Finca',fincaLocation:f.fincaLocation||null});}catch{} saveFarms(loadFarms().filter(x=>x.id!==f.id)); } }catch{}
      try{ const fences=loadFences().filter(g=>String(g.id||'').startsWith('localgf-')); for(const g of fences){ try{await db.collection('geofences').add({name:g.name||'Geocerca',path:Array.isArray(g.path)?g.path:[]});}catch{} saveFences(loadFences().filter(x=>x.id!==g.id)); } }catch{}
      try{ const ppl=loadPeople().filter(p=>String(p.id||'').startsWith('localp-')); for(const p of ppl){ try{await db.collection('personnel').add({firstName:p.firstName||'',lastName:p.lastName||'',idNumber:p.idNumber||'',assignType:p.assignType||'',assignId:p.assignId||''});}catch{} savePeople(loadPeople().filter(x=>x.id!==p.id)); } }catch{}
    }

    /* ---------- Geocercas ---------- */
    function selectFence(id){ if(isEditingFence){ alert('Estás editando una geocerca. Guarda o cancela antes.'); return; } if(selectedFenceId&&geofenceLayers[selectedFenceId]) geofenceLayers[selectedFenceId].setStyle(GEOFENCE_STYLE); selectedFenceId=id; if(geofenceLayers[id]) geofenceLayers[id].setStyle(GEOFENCE_SELECTED_STYLE); updateDeleteFenceButtonState(); updateEditButtonsState(); }
    function updateDeleteButtonState(){ const sel=document.getElementById('farmSelect'), btn=document.getElementById('deleteFarmBtn'); if(btn) btn.disabled=!(sel&&sel.value); }
    function updateDeleteFenceButtonState(){ const btn=document.getElementById('deleteFenceBtn'); if(btn) btn.disabled=!selectedFenceId; }
    function updateEditButtonsState(){ const btn=document.getElementById('editFenceBtn'); if(btn) btn.disabled=!(selectedFenceId&&geofenceLayers[selectedFenceId]&&!isEditingFence); document.getElementById('saveFenceEditBtn')?.classList.toggle('hidden',!isEditingFence); document.getElementById('cancelFenceEditBtn')?.classList.toggle('hidden',!isEditingFence); }
    function addFenceVertex(latlng){ drawingCoords.push({lat:latlng.lat,lng:latlng.lng}); const m=L.circleMarker(latlng,{radius:4,weight:2}).addTo(map); drawingMarkers.push(m); const latlngs=drawingCoords.map(p=>[p.lat,p.lng]); if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;} if(latlngs.length>=3) drawingPolyline=L.polygon(latlngs,{dashArray:'4,4',weight:2,fillOpacity:.1}).addTo(map); else if(latlngs.length>=2) drawingPolyline=L.polyline(latlngs,{dashArray:'4,4',weight:2}).addTo(map); }
    function startFenceDraw(){ if(isDrawingFence) return; isDrawingFence=true; drawingCoords=[]; drawingMarkers.forEach(m=>map.removeLayer(m)); drawingMarkers=[]; if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;} document.getElementById('startFenceBtn').classList.add('hidden'); document.getElementById('finishFenceBtn').classList.remove('hidden'); document.getElementById('cancelFenceBtn').classList.remove('hidden'); }
    function finishFenceDraw(){ if(!isDrawingFence) return; if(drawingCoords.length<3){alert('La geocerca necesita al menos 3 puntos.');return;} pendingFenceCoords=drawingCoords.slice(); document.getElementById('fenceNameHint').textContent=`Vértices: ${pendingFenceCoords.length} puntos`; const input=document.getElementById('fenceNameInput'); input.value=`Geocerca ${new Date().toLocaleDateString()}`; document.getElementById('fenceNamePanel').classList.remove('hidden'); input.focus(); input.select(); }
    function cancelFenceDraw(){ isDrawingFence=false; drawingCoords=[]; drawingMarkers.forEach(m=>map.removeLayer(m)); drawingMarkers=[]; if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;} document.getElementById('startFenceBtn').classList.remove('hidden'); document.getElementById('finishFenceBtn').classList.add('hidden'); document.getElementById('cancelFenceBtn').classList.add('hidden'); document.getElementById('fenceNamePanel').classList.add('hidden'); pendingFenceCoords=null; }
    async function saveFenceName(){ const input=document.getElementById('fenceNameInput'); const name=(input.value||'').trim()||'Geocerca'; if(!pendingFenceCoords||pendingFenceCoords.length<3){alert('No hay geocerca lista.');return;} try{ await db.collection('geofences').add({name,path:pendingFenceCoords}); }catch{ const fences=loadFences(); fences.push({id:'localgf-'+Date.now(),name,path:pendingFenceCoords}); saveFences(fences); renderGeofencesFromCache(); } input.value=''; pendingFenceCoords=null; document.getElementById('fenceNamePanel').classList.add('hidden'); cancelFenceDraw(); }

    /* ---------- Explorador ---------- */
    function buildIndexList(){
      const farmUl=document.getElementById('farmList'), fenceUl=document.getElementById('fenceList'); if(!farmUl||!fenceUl) return;
      const farms=(currentFarms?.length?currentFarms:loadFarms()).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      const fences=(currentFences?.length?currentFences:loadFences()).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      farmUl.innerHTML = farms.length? farms.map(f=>`<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-type="farm" data-id="${f.id}"><div class="text-sm font-medium text-gray-800">${f.name||'Finca'}</div><div class="text-xs text-gray-500">${f?.fincaLocation?`Lat ${(+f.fincaLocation.lat).toFixed(5)}, Lng ${(+f.fincaLocation.lng).toFixed(5)}`:'—'}</div></div></li>`).join('') : `<li class="py-2 text-sm text-gray-500">No hay fincas registradas.</li>`;
      fenceUl.innerHTML = fences.length? fences.map(g=>`<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-type="fence" data-id="${g.id}"><div class="text-sm font-medium text-gray-800">${g.name||'Geocerca'}</div><div class="text-xs text-gray-500">${Array.isArray(g.path)?`${g.path.length} puntos`:'—'}</div></div></li>`).join('') : `<li class="py-2 text-sm text-gray-500">No hay geocercas registradas.</li>`;
    }
    function zoomToFarm(id){ if(fincaMarkers[id]){ map.setView(fincaMarkers[id].getLatLng(),Math.max(map.getZoom(),16)); try{fincaMarkers[id].openTooltip();}catch{} return; } const f=loadFarms().find(x=>x.id===id); if(f?.fincaLocation) map.setView([f.fincaLocation.lat,f.fincaLocation.lng],Math.max(map.getZoom(),16)); else alert('No se pudo localizar esa finca.'); }
    function zoomToFence(id){ if(geofenceLayers[id]){ map.fitBounds(geofenceLayers[id].getBounds(),{padding:[20,20]}); selectFence(id); return; } const g=loadFences().find(x=>x.id===id); if(g?.path?.length>=3){ map.fitBounds(L.latLngBounds(g.path.map(p=>[p.lat,p.lng])),{padding:[20,20]}); selectFence(id); } else alert('No se pudo localizar esa geocerca.'); }

    /* ---------- Gestión de personal ---------- */
    function buildAssignOptions(){
      const sel=document.getElementById('pAssignSelect'); if(!sel) return;
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const opts=[];
      if(farms.length){ opts.push({value:'',label:'— Selecciona —'}); farms.forEach(f=>opts.push({value:`farm:${f.id}`,label:`Finca: ${f.name||'Finca'}`})); }
      if(fences.length){ if(!opts.length) opts.push({value:'',label:'— Selecciona —'}); fences.forEach(g=>opts.push({value:`fence:${g.id}`,label:`Geocerca: ${g.name||'Geocerca'}`})); }
      if(!opts.length) opts.push({value:'',label:'No hay fincas/geocercas'});
      sel.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');

      const filter=document.getElementById('pEntityFilter');
      if(filter){
        const items=[{value:'all',label:'Todas'}];
        farms.forEach(f=>items.push({value:`farm:${f.id}`,label:`Finca: ${f.name||'Finca'}`}));
        fences.forEach(g=>items.push({value:`fence:${g.id}`,label:`Geocerca: ${g.name||'Geocerca'}`}));
        filter.innerHTML = items.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
      }
    }
    function showPersonError(msg){ const e=document.getElementById('pFormError'); e.textContent=msg||''; e.classList.toggle('hidden',!msg); }

    // Función para agregar personal (corregida)
    async function addPerson(){
      try{
        const fn=(document.getElementById('pFirstName').value||'').trim();
        const ln=(document.getElementById('pLastName').value||'').trim();
        const idn=(document.getElementById('pIdNumber').value||'').trim();
        const asg=document.getElementById('pAssignSelect').value||'';
        showPersonError('');
        
        // Validaciones
        if(!fn || !ln) return showPersonError('Nombre y apellido son obligatorios.');
        if(!/^[0-9]{6,15}$/.test(idn)) return showPersonError('Cédula: usar solo dígitos (6–15).');
        if(!asg) return showPersonError('Selecciona una asignación.');
        
        const [assignType,assignId]=asg.split(':');

        const tempId = 'localp-'+Date.now();
        const newDoc = {id: tempId, firstName: fn, lastName: ln, idNumber: idn, assignType, assignId};

        // 1) Actualización optimista
        let cache = loadPeople(); 
        cache.push(newDoc); 
        savePeople(cache);
        currentPersonnel = cache.slice(); 
        renderPersonnelList();

        // 2) Intento en Firestore
        try{
          const ref = await db.collection('personnel').add({
            firstName: fn, lastName: ln, idNumber: idn, assignType, assignId
          });
          // Reemplazar tempId por id real
          cache = loadPeople().map(p => p.id === tempId ? ({...p, id: ref.id}) : p);
          savePeople(cache);
          currentPersonnel = cache.slice(); 
          renderPersonnelList();
        }catch(err){
          console.error("Error al guardar en Firestore:", err);
          // Si falla, se queda con tempId y luego se sincroniza
          waitAuthThen(syncLocalPendingToFirestore);
        }

        // Limpiar formulario
        document.getElementById('pFirstName').value='';
        document.getElementById('pLastName').value='';
        document.getElementById('pIdNumber').value='';
        document.getElementById('pAssignSelect').selectedIndex=0;
        
        showPersonError('Personal agregado correctamente');
        setTimeout(() => showPersonError(''), 2000);
      }catch(e){ 
        console.error(e); 
        showPersonError('Error al agregar personal'); 
      }
    }

    function renderPersonnelList(){
      const tbody=document.getElementById('personnelTableBody'); if(!tbody) return;
      const q=(document.getElementById('pSearchInput').value||'').trim().toLowerCase();
      const t=(document.getElementById('pTypeFilter').value||'all');
      const e=(document.getElementById('pEntityFilter').value||'all');
      let list=currentPersonnel?.length?currentPersonnel.slice():loadPeople();
      list=list.filter(p=>{
        let ok=true;
        if(q){ ok=(`${p.firstName||''} ${p.lastName||''} ${p.idNumber||''}`.toLowerCase().includes(q)); }
        if(ok&&t!=='all') ok=(p.assignType===t);
        if(ok&&e!=='all'){ const [kind,id]=e.split(':'); ok=(p.assignType===kind && p.assignId===id); }
        return ok;
      });
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const nameOf=p=> p.assignType==='farm' ? (farms.find(f=>f.id===p.assignId)?.name||'Finca') :
                        p.assignType==='fence' ? (fences.find(g=>g.id===p.assignId)?.name||'Geocerca') : '—';
      tbody.innerHTML='';
      if(!list.length){ tbody.innerHTML=`<tr><td colspan="5" class="px-3 py-4 text-center text-gray-500">No hay personal registrado.</td></tr>`; return; }
      list.forEach(p=>{
        const tr=document.createElement('tr'); 
        tr.className='border-t hover:bg-gray-50 person-row';
        tr.innerHTML=`<td class="px-3 py-2">${p.firstName||''}</td>
                      <td class="px-3 py-2">${p.lastName||''}</td>
                      <td class="px-3 py-2">${p.idNumber||''}</td>
                      <td class="px-3 py-2">${p.assignType==='farm'?'Finca':'Geocerca'}: ${nameOf(p)}</td>
                      <td class="px-3 py-2">
                        <button class="text-indigo-600 hover:underline edit-person" data-id="${p.id}">Editar</button>
                        <span class="mx-1 text-gray-300">|</span>
                        <button class="text-rose-600 hover:underline delete-person" data-id="${p.id}">Eliminar</button>
                      </td>`;
        tr.addEventListener('dblclick',()=>{ 
          if(p.assignType==='farm') zoomToFarm(p.assignId); 
          if(p.assignType==='fence') zoomToFence(p.assignId); 
        });
        tbody.appendChild(tr);
      });
      
      // Añadir event listeners para los botones de editar y eliminar
      document.querySelectorAll('.edit-person').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.getAttribute('data-id');
          openEditPerson(id);
        });
      });
      
      document.querySelectorAll('.delete-person').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.getAttribute('data-id');
          deletePerson(id);
        });
      });
    }
    
    async function deletePerson(id){
      if(!id) return; 
      let cache=loadPeople();
      const it=(currentPersonnel||[]).find(p=>p.id===id)||cache.find(p=>p.id===id);
      const label=it?`${it.firstName||''} ${it.lastName||''}`.trim():'esta persona';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{ 
        await db.collection('personnel').doc(id).delete(); 
      } catch(err){ 
        console.error("Error al eliminar de Firestore:", err);
        cache=cache.filter(p=>p.id!==id); 
        savePeople(cache); 
      }
      currentPersonnel=loadPeople(); 
      renderPersonnelList();
    }

    function openEditPerson(id){
      const src=currentPersonnel?.length?currentPersonnel:(loadPeople()||[]);
      const p=src.find(x=>x.id===id); if(!p){ alert('No se encontró el registro.'); return; }
      const fn=prompt('Nombre',p.firstName||''); if(fn===null) return;
      const ln=prompt('Apellido',p.lastName||''); if(ln===null) return;
      const idn=prompt('Cédula (solo dígitos 6–15)',p.idNumber||''); if(idn===null||!/^[0-9]{6,15}$/.test(idn)){ alert('Cédula inválida.'); return; }
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const choices=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
      let pick=prompt('Asigne escribiendo el número:\n'+choices.map((c,i)=>`${i+1}. ${c.l}`).join('\n'));
      if(pick===null) return; pick=(+pick)-1; if(pick<0||pick>=choices.length){ alert('Selección inválida.'); return; }
      const [assignType,assignId]=choices[pick].v.split(':');
      const doc={firstName:fn,lastName:ln,idNumber:idn,assignType,assignId};
      (async()=>{ 
        try{ 
          await db.collection('personnel').doc(id).update(doc); 
        } catch(err){ 
          console.error("Error al actualizar en Firestore:", err);
          const cache=loadPeople(); 
          const i=cache.findIndex(x=>x.id===id); 
          if(i>=0){ cache[i]={...cache[i],...doc}; savePeople(cache);} 
        }
        currentPersonnel=loadPeople(); 
        renderPersonnelList();
      })();
    }

    /* ---------- Listeners ---------- */
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('adminModal').classList.remove('hidden');
      document.getElementById('adminLoginBtn').addEventListener('click',()=>{
        const ok=(document.getElementById('adminCodeInput').value||'').trim().toLowerCase()==='admin123';
        if(!ok){ document.getElementById('errorMessage').style.display='block'; return; }
        document.getElementById('adminModal').classList.add('hidden');
        document.getElementById('appContent').classList.remove('hidden');
        setTimeout(()=>{ initMap(); setTimeout(()=>map&&map.invalidateSize(),80); },80);
      });

      // Mapa
      document.getElementById('farmSelect').addEventListener('change',updateDeleteButtonState);
      document.getElementById('startFenceBtn').addEventListener('click',startFenceDraw);
      document.getElementById('finishFenceBtn').addEventListener('click',finishFenceDraw);
      document.getElementById('cancelFenceBtn').addEventListener('click',cancelFenceDraw);
      document.getElementById('fenceNameSaveBtn').addEventListener('click',saveFenceName);
      document.getElementById('fenceNameCancelBtn').addEventListener('click',()=>document.getElementById('fenceNamePanel').classList.add('hidden'));
      document.getElementById('editFenceBtn').addEventListener('click',()=>{ /* enable edit si lo usas */ });
      document.getElementById('exportGeoJSONBtn').addEventListener('click',()=>{ /* export */ });

      // Listas dblclick
      document.getElementById('farmList').addEventListener('dblclick',e=>{const n=e.target.closest('[data-type="farm"][data-id]'); if(n) zoomToFarm(n.dataset.id);});
      document.getElementById('fenceList').addEventListener('dblclick',e=>{const n=e.target.closest('[data-type="fence"][data-id]'); if(n) zoomToFence(n.dataset.id);});

      // Botón Agregar + Enter en inputs
      document.getElementById('addPersonBtn').addEventListener('click', addPerson);
      ['pFirstName','pLastName','pIdNumber'].forEach(id=>{
        const el=document.getElementById(id);
        el.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ addPerson(); }});
      });

      // Filtros personas
      document.getElementById('pSearchInput').addEventListener('input',renderPersonnelList);
      document.getElementById('pTypeFilter').addEventListener('change',renderPersonnelList);
      document.getElementById('pEntityFilter').addEventListener('change',renderPersonnelList);

      // Primer pintado
      buildIndexList(); buildAssignOptions(); updateDeleteButtonState(); updateDeleteFenceButtonState(); updateEditButtonsState();
    });
  </script>
</body>
</html>
