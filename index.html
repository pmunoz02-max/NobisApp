<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NobisApp</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS con 2 CDNs (primario + fallback). Si uno falla, el otro carga. -->
  <link id="leafletCss1" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <link id="leafletCss2" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" onload="this.media='all'" media="print">

  <style>
    body{background:#f3f4f6}
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    #map{height:520px;min-height:380px;width:100%;background:#eef2f7;position:relative}
    .label-in-map{background:transparent;border:none;box-shadow:none;color:#1f2937;font-weight:600;text-shadow:0 0 3px #ffffffc7}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    #mapError{position:absolute;inset:auto 0 0 0;background:#fee2e2;color:#7f1d1d;font-size:.85rem;padding:.4rem .6rem;display:none}
  </style>
</head>
<body class="text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Gestión de Geocercas</h1>
      <div class="text-xs text-gray-600">Estado: <span id="statusDot" class="font-semibold">inicial</span></div>
    </div>

    <!-- Encabezado conservador (no toca tu lógica previa) -->
    <div class="grid md:grid-cols-3 gap-4">
      <div class="card p-4">
        <label class="block text-sm font-medium mb-1">Usuario</label>
        <div class="flex gap-2">
          <select id="userSelect" class="min-w-0 flex-1 border rounded-md p-2"></select>
          <button id="newUserBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Nuevo</button>
          <button id="renameUserBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Renombrar</button>
          <button id="deleteUserBtn" class="px-3 py-2 rounded-lg bg-rose-600 text-white">Eliminar</button>
        </div>

        <label class="block text-sm font-medium mt-4">Geocerca activa</label>
        <select id="geofenceSelect" class="w-full border rounded-md p-2 mt-1"></select>
      </div>

      <div class="card p-4">
        <div class="flex flex-wrap gap-2">
          <button id="newFenceBtn" class="btn px-3 py-2 bg-indigo-600 text-white rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="btn px-3 py-2 bg-green-600 text-white rounded-lg" disabled>Finalizar</button>
          <button id="cancelFenceBtn" class="btn px-3 py-2 bg-gray-600 text-white rounded-lg" disabled>Cancelar</button>
        </div>

        <div id="nameBar" class="hidden mt-3 p-3 border rounded-xl bg-indigo-50">
          <label class="text-sm font-medium">Nombre de la geocerca</label>
          <div class="mt-1 flex gap-2">
            <input id="nameField" class="flex-1 border rounded-md p-2" placeholder="Ej. Lote Norte" />
            <button id="saveNameBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Guardar nombre</button>
            <button id="cancelNameBtn" class="px-3 py-2 rounded-lg bg-gray-200">Seguir dibujando</button>
          </div>
          <p class="text-xs text-gray-600 mt-2">Tip: Enter también guarda.</p>
        </div>

        <div class="flex flex-wrap gap-2 mt-3">
          <button id="createFenceByCoordsBtn" class="btn px-3 py-2 bg-teal-600 text-white rounded-lg">Geocerca (Lat/Lng)</button>
          <button id="editFenceBtn" class="btn px-3 py-2 bg-amber-500 text-white rounded-lg" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn" class="btn px-3 py-2 bg-emerald-600 text-white rounded-lg" disabled>Guardar cambios</button>
          <button id="cancelFenceEditBtn" class="btn px-3 py-2 bg-stone-500 text-white rounded-lg" disabled>Cancelar edición</button>
          <button id="renameFenceBtn" class="btn px-3 py-2 bg-sky-600 text-white rounded-lg" disabled>Renombrar</button>
        </div>

        <div class="flex flex-wrap gap-2 mt-2">
          <button id="deleteFenceBtn" class="btn px-3 py-2 bg-rose-600 text-white rounded-lg" disabled>Eliminar geocerca</button>
          <button id="exportGeoJsonBtn" class="px-3 py-2 rounded-lg bg-cyan-700 text-white">Exportar GeoJSON</button>
          <label class="px-3 py-2 rounded-lg bg-slate-700 text-white cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJsonInput" type="file" accept=".json,.geojson,application/geo+json,application/json" class="hidden">
          </label>
        </div>
      </div>

      <div class="card p-4 text-sm">
        <p><b>Dibujo:</b> Nueva geocerca → clics/toques → <i>Finalizar</i> (o doble clic / clic en el 1º punto).</p>
        <p class="mt-1"><b>Edición:</b> Selecciona una geocerca → <b>Editar</b> → arrastra vértices → <b>Guardar cambios</b>.</p>
        <p class="mt-1">También puedes crear por <b>Lat/Lng</b> (una línea <code>lat,lng</code> por vértice).</p>
      </div>
    </div>

    <!-- MAPA -->
    <div class="mt-4 card overflow-hidden">
      <div class="px-4 py-3 border-b"><h2 class="text-lg font-semibold">Mapa</h2></div>
      <div id="map">
        <div id="mapError"></div>
      </div>
    </div>

    <!-- Módulos (resumen) -->
    <div class="mt-4 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Geocercas</h3></div>
      <ul id="fenceList" class="p-3 divide-y"></ul>
    </div>

    <div id="personnelModule" class="mt-6 card">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Gestión de personal</h3>
        <div class="flex items-center gap-2">
          <button id="addStaffFromPersonnel" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Añadir personal</button>
          <button id="refreshPersonnelBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white">Refrescar</button>
        </div>
      </div>
      <div class="p-4">
        <div id="staffTable" class="text-sm overflow-auto"></div>
        <div id="noStaffHint" class="hidden mt-3 text-sm text-gray-600">
          No hay personal creado. Usa <b>Añadir personal</b> o crea desde <b>Administración</b>.
        </div>
      </div>
    </div>

    <div id="activitiesModule" class="mt-6 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Actividades</h3></div>
      <div class="p-4 grid md:grid-cols-3 gap-4">
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Catálogo de actividades</div>
          <div class="flex gap-2 mb-3">
            <input id="actNewName" class="flex-1 border rounded-md p-2" placeholder="Ej. Siembra, Riego, Cosecha" />
            <button id="actAddBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Añadir</button>
          </div>
          <ul id="actList" class="text-sm space-y-1"></ul>
        </div>
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Registrar actividad</div>
          <div class="grid gap-2">
            <div><label class="text-sm">Personal</label><select id="actStaffSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Actividad</label><select id="actSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Nota</label><input id="actNote" class="w-full border rounded-md p-2" placeholder="Opcional" /></div>
            <div class="flex gap-2">
              <button id="actLogGpsBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Registrar (con GPS)</button>
              <button id="actLogManualBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white">Registrar (manual)</button>
            </div>
            <div id="actMsg" class="text-xs"></div>
          </div>
        </div>
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Registros</div>
          <div class="flex gap-2 mb-2">
            <select id="logStaffFilter" class="border rounded-md p-2 flex-1"></select>
            <button id="exportCsvBtn" class="px-3 py-2 rounded-lg bg-cyan-700 text-white">Exportar CSV</button>
          </div>
          <ul id="actLogs" class="text-sm space-y-1 max-h-60 overflow-auto"></ul>
        </div>
      </div>
    </div>

    <div id="reportsModule" class="mt-6 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Reportes</h3></div>
      <div class="p-4">
        <div id="repSummary" class="grid md:grid-cols-5 gap-3 mb-4"></div>
        <div class="flex gap-2">
          <button id="exportChecksBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Exportar Check-ins CSV</button>
          <button id="exportActsBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Exportar Actividades CSV</button>
        </div>
      </div>
    </div>

    <div id="adminModule" class="mt-6 card">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Administración de usuarios</h3>
        <div>
          <button id="createAdminBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white mr-2">Crear administrador</button>
          <button id="createStaffBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Crear personal</button>
        </div>
      </div>

      <div class="p-4 grid md:grid-cols-2 gap-4">
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Asignar geocerca a personal</div>
          <div class="grid grid-cols-1 gap-2">
            <div><label class="text-sm">Personal</label><select id="assignStaffSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Admin/Owner (fuente geocercas)</label><select id="assignAdminSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Geocerca</label><select id="assignFenceSelect" class="w-full border rounded-md p-2"></select></div>
            <button id="doAssignBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Asignar</button>
            <div id="assignMsg" class="text-xs mt-1"></div>
          </div>
        </div>

        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Check-ins de personal</div>
          <div class="flex gap-2 mb-2">
            <select id="checkStaffSelect" class="border rounded-md p-2 flex-1"></select>
            <button id="refreshChecksBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white">Actualizar</button>
          </div>
          <ul id="checksList" class="text-sm text-gray-700 space-y-1 max-h-56 overflow-auto"></ul>
        </div>
      </div>

      <div class="px-4 py-3 border-t"><div id="usersTable" class="text-sm"></div></div>
    </div>
  </div>

  <!-- Loader robusto de Leaflet + inicialización resistente -->
  <script>
    function $(id){return document.getElementById(id)}
    function S(t){const x=$('statusDot'); if(x) x.textContent=t}
    function showMapError(msg){ const b=$('mapError'); if(b){ b.textContent=msg; b.style.display='block'; } }

    // Carga secuencial con fallback de 3 CDNs
    (function loadLeaflet(cb){
      const srcs=[
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js',
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js'
      ];
      let i=0;
      function next(){
        if(window.L && L.map){ return cb(); }
        if(i>=srcs.length){ showMapError('No se pudo cargar Leaflet. Revisa tu conexión/CDN.'); return; }
        const s=document.createElement('script');
        s.src=srcs[i++]; s.async=false;
        s.onload=()=>cb();
        s.onerror=()=>next();
        document.head.appendChild(s);
      }
      next();
    })(function initMap(){
      const el=$('map');
      if(!el){ showMapError('Contenedor #map no encontrado.'); return; }
      if(!el.style.height) el.style.height='520px';

      let map;
      try{
        map=L.map('map',{preferCanvas:true}).setView([-1.5,-78.5],9);

        // Capa OSM principal
        const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
          maxZoom:19, attribution:'© OpenStreetMap'
        }).addTo(map);

        // Fallback: si hay errores de tiles, alterno a Carto
        let errors=0, switched=false;
        osm.on('tileerror',function(){
          errors++; 
          if(!switched && errors>=4){
            switched=true;
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
              maxZoom:19, attribution:'© OpenStreetMap, © CARTO'
            }).addTo(map);
            showMapError('Conmutado a servidor de tiles alternativo (Carto).');
          }
        });

        // Invalidates para evitar “canvas gris”
        const fix=()=>{ try{ map.invalidateSize(true); }catch(e){} };
        setTimeout(fix,0); setTimeout(fix,300);
        window.addEventListener('load',fix);
        if('ResizeObserver' in window) new ResizeObserver(fix).observe(el); else window.addEventListener('resize',fix);

        S('mapa listo');

      }catch(e){
        showMapError('Error iniciando el mapa: '+(e&&e.message?e.message:e));
      }
    });

    // Relleno mínimo de UI para que nada rompa mientras corriges lógica
    document.addEventListener('DOMContentLoaded', function(){
      const K='NobisApp_users', KC='NobisApp_current_user';
      let users=[]; try{users=JSON.parse(localStorage.getItem(K)||'[]')}catch(e){users=[]}
      if(!Array.isArray(users) || users.length===0){
        const id='u_'+Math.random().toString(36).slice(2,10);
        users=[{id,name:'Usuario 1',role:'owner'}];
        localStorage.setItem(K, JSON.stringify(users));
        localStorage.setItem(KC, id);
      }
      const cur=(localStorage.getItem(KC)||users[0].id);
      const usel=$('userSelect');
      if(usel){
        usel.innerHTML=users.map(u=>`<option value="${u.id}">${u.name} [${u.role||'admin'}]</option>`).join('');
        usel.value=cur;
      }

      const gf=$('geofenceSelect'); if(gf){ gf.innerHTML=''; }
      const ul=$('fenceList'); if(ul){ ul.innerHTML='<li class="py-6 text-center text-gray-500">No hay geocercas.</li>'; }

      const staffTable=$('staffTable'); const hint=$('noStaffHint');
      if(staffTable){ staffTable.innerHTML=''; if(hint) hint.classList.remove('hidden'); }

      const actList=$('actList'); if(actList) actList.innerHTML='<li class="text-gray-500">Sin actividades. Añade arriba.</li>';
      const actStaff=$('actStaffSelect'); if(actStaff) actStaff.innerHTML='';
      const actSel=$('actSelect'); if(actSel) actSel.innerHTML='';
      const actLogs=$('actLogs'); if(actLogs) actLogs.innerHTML='<li class="text-gray-500">Sin registros.</li>';

      const rep=$('repSummary'); if(rep){
        rep.innerHTML=['Geocercas','Personal','Asignaciones','Actividades','Check-ins']
          .map(t=>`<div class="p-4 rounded-xl bg-slate-50 border text-center"><div class="text-2xl font-bold">0</div><div class="text-xs text-slate-600">${t}</div></div>`).join('');
      }

      const as1=$('assignStaffSelect'); if(as1) as1.innerHTML='';
      const as2=$('assignAdminSelect'); if(as2) as2.innerHTML='';
      const as3=$('assignFenceSelect'); if(as3) as3.innerHTML='';
      const ckSel=$('checkStaffSelect'); if(ckSel) ckSel.innerHTML='';
      const usersTable=$('usersTable'); if(usersTable){
        usersTable.innerHTML='<div class="text-sm text-gray-600">La tabla se llenará cuando se creen usuarios.</div>';
      }
    });
  </script>

<script id="patch-geofence-latlng-v2">
(function(){
  "use strict";
  if (window.__PATCH_GEOFENCE_LATLNG_V2__) return;
  window.__PATCH_GEOFENCE_LATLNG_V2__ = true;

  function byId(id){ return document.getElementById(id); }
  function ensureBtnType(id){ const b=byId(id); if(b && b.type!=="button") b.type="button"; }
  function uid(){ return "f_"+Math.random().toString(36).slice(2,10); }
  function nowName(){ return "Geocerca "+(Date.now()%1000); }

  // Storage (mismas claves que tu app)
  const UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_';
  function currentUserId(){
    try{
      const cur = localStorage.getItem(CK);
      if (cur) return cur;
      const users = JSON.parse(localStorage.getItem(UK)||'[]');
      return (users && users[0] && users[0].id) ? users[0].id : 'default';
    }catch(e){ return 'default'; }
  }
  function fkey(){ return FPRE + currentUserId(); }
  function readFences(){
    try { const a = JSON.parse(localStorage.getItem(fkey()) || "[]"); return Array.isArray(a) ? a : []; }
    catch(e){ return []; }
  }
  function writeFences(arr){ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }

  // ===== Parser robusto =====
  // Extrae los primeros 2 números por línea (soporta punto o coma decimal, ignora paréntesis y texto).
  // También detecta e invierte lon/lat si hace falta.
  function parseLatLngMultiline(text){
    const pts=[];
    const lines=(text||"").split(/\r?\n/);
    for(let line of lines){
      line=line.trim();
      if(!line) continue;

      // toma tokens numéricos tipo -12.34 o -12,34
      const nums=line.match(/[-+]?\d+(?:[.,]\d+)?/g);
      if(!nums || nums.length<2) continue;

      let lat = parseFloat(nums[0].replace(',', '.'));
      let lng = parseFloat(nums[1].replace(',', '.'));

      if(!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      // Heurística de orden:
      // - Si "lat" está fuera de [-90,90] pero "lng" sí está en [-90,90], asumimos que viene lon,lat → invertimos.
      if ((Math.abs(lat) > 90 && Math.abs(lng) <= 90) ||
          (Math.abs(lng) <= 90 && Math.abs(lat) > 90)) {
        // probable lon,lat
        const tmp = lat; lat = lng; lng = tmp;
      }
      // Último filtro razonable
      if (Math.abs(lat) > 90 || Math.abs(lng) > 180) continue;

      pts.push({lat, lng});
    }
    return pts;
  }

  // ===== UI helpers (no interfieren) =====
  function refreshSelectorsAndList(activeId){
    const fences = readFences();
    const sel = byId('geofenceSelect');
    if (sel){
      sel.innerHTML = fences.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
      if (activeId) sel.value = activeId;
    }
    const list = byId('fenceList');
    if (list){
      list.innerHTML = fences.length
        ? fences.map(f=>`<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="${f.id}">
            <div class="text-sm font-medium">${f.name}</div>
            <div class="text-xs text-gray-500">${f.latlngs.length} puntos</div>
          </li>`).join('')
        : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
    }
  }

  function tryDrawOnMap(fence){
    try{
      const map=(window.nobisMap||window.map||null);
      if(!map || !window.L) return;
      const g=(window.NOBIS_FENCE_GROUP)||L.layerGroup().addTo(map);
      if(!window.NOBIS_FENCE_GROUP) window.NOBIS_FENCE_GROUP=g;
      const poly=L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(g);
      poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});
      try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(e){}
    }catch(_e){}
  }

  function createFenceByCoords(){
    const example = [
      "Pega una línea por vértice. Formatos válidos:",
      "-1.23456, -78.12345",
      "-1.23456 -78.12345",
      "-1,23456  -78,12345   (coma decimal)",
      "(-1.23456, -78.12345)",
      "-78.12345, -1.23456   (lon,lat; se detecta y corrige)"
    ].join("\n");

    const raw = prompt(example);
    if (raw === null) return;

    const pts = parseLatLngMultiline(raw);
    if (pts.length < 3){
      alert("Se requieren al menos 3 coordenadas válidas (lat,lng).");
      return;
    }

    const name = (prompt("Nombre de la geocerca:", nowName()) || "").trim() || nowName();

    const arr = readFences();
    const id = uid();
    const fence = { id, name, latlngs: pts };
    arr.push(fence);
    writeFences(arr);

    refreshSelectorsAndList(id);
    try { window.dispatchEvent(new CustomEvent('nobis:fences-updated', { detail:{ id } })); } catch(_e){}
    tryDrawOnMap(fence);
  }

  function wire(){
    ensureBtnType('createFenceByCoordsBtn');
    const btn = byId('createFenceByCoordsBtn');
    if (btn){
      // Forzamos nuestro handler (evitamos doble listeners previos)
      btn.onclick = function(ev){ ev.preventDefault(); createFenceByCoords(); };
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wire, { once:true });
  } else {
    wire();
  }
})();
</script>
<script id="patch-geofence-latlng-v3">
(function(){
  "use strict";
  if (window.__PATCH_GEOFENCE_LATLNG_V3__) return;
  window.__PATCH_GEOFENCE_LATLNG_V3__ = true;

  function byId(id){ return document.getElementById(id); }
  function ensureBtnType(id){ const b=byId(id); if(b && b.type!=="button") b.type="button"; }
  function uid(){ return "f_"+Math.random().toString(36).slice(2,10); }
  function nowName(){ return "Geocerca "+(Date.now()%1000); }

  // Storage (mismas claves que tu app)
  const UK='NobisApp_users', CK='NobisApp_current_user', FPRE='NobisApp_fences_';
  function currentUserId(){
    try{
      const cur = localStorage.getItem(CK);
      if (cur) return cur;
      const users = JSON.parse(localStorage.getItem(UK)||'[]');
      return (users && users[0] && users[0].id) ? users[0].id : 'default';
    }catch(e){ return 'default'; }
  }
  function fkey(){ return FPRE + currentUserId(); }
  function readFences(){
    try { const a = JSON.parse(localStorage.getItem(fkey()) || "[]"); return Array.isArray(a) ? a : []; }
    catch(e){ return []; }
  }
  function writeFences(arr){ localStorage.setItem(fkey(), JSON.stringify(arr||[])); }

  // ===== Parser robusto (soporta ; y \n, coma/punto decimal, y lon,lat) =====
  function parseLatLngMultiline(text){
    const pts=[];
    if(!text) return pts;

    // 1) Dividir por ; o saltos de línea (segmentos que deberían contener un par)
    const segments = text.split(/[;\r\n]+/).map(s=>s.trim()).filter(Boolean);

    for (const seg of segments){
      // Extraer los DOS primeros números de cada segmento (ignora paréntesis, texto, etc.)
      const nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
      if(!nums || nums.length < 2) continue;

      // Convertir a float (coma → punto)
      let a = parseFloat(nums[0].replace(',', '.'));
      let b = parseFloat(nums[1].replace(',', '.'));
      if(!Number.isFinite(a) || !Number.isFinite(b)) continue;

      // Heurística de orden:
      // Opción 1: a=lat, b=lng
      let lat=a, lng=b, ok=false;
      if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) {
        ok = true;
      } else {
        // Opción 2: a=lng, b=lat → invertimos
        lat=b; lng=a;
        if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) ok = true;
      }
      if(!ok) continue;

      pts.push({lat, lng});
    }
    return pts;
  }

  // ===== UI helpers (no interfieren) =====
  function refreshSelectorsAndList(activeId){
    const fences = readFences();
    const sel = byId('geofenceSelect');
    if (sel){
      sel.innerHTML = fences.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
      if (activeId) sel.value = activeId;
    }
    const list = byId('fenceList');
    if (list){
      list.innerHTML = fences.length
        ? fences.map(f=>`<li class="py-2 px-3 hover:bg-gray-50 cursor-pointer" data-id="${f.id}">
            <div class="text-sm font-medium">${f.name}</div>
            <div class="text-xs text-gray-500">${f.latlngs.length} puntos</div>
          </li>`).join('')
        : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';
    }
  }

  // Dibujo directo opcional (no interfiere si tu render ya repinta)
  function tryDrawOnMap(fence){
    try{
      const map=(window.nobisMap||window.map||null);
      if(!map || !window.L) return;
      const g=(window.NOBIS_FENCE_GROUP)||L.layerGroup().addTo(map);
      if(!window.NOBIS_FENCE_GROUP) window.NOBIS_FENCE_GROUP=g;
      const poly=L.polygon(fence.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(g);
      poly.bindTooltip(fence.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});
      try{ map.fitBounds(poly.getBounds(),{padding:[24,24]}); }catch(e){}
    }catch(_e){}
  }

  function createFenceByCoords(){
    const example = [
      "Pega coordenadas Lat,Lng (una por línea o separadas con ';'). Formatos válidos:",
      "-1.23456, -78.12345",
      "-1.23456 -78.12345",
      "-1,23456  -78,12345   (coma decimal)",
      "(-1.23456, -78.12345)",
      "-78.12345, -1.23456   (lon,lat; se detecta y corrige)",
      "",
      "También sirve en una sola línea separadas por ';':",
      "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092"
    ].join("\n");

    const raw = prompt(example);
    if (raw === null) return;

    const pts = parseLatLngMultiline(raw);
    if (pts.length < 3){
      alert("Se requieren al menos 3 coordenadas válidas (lat,lng).");
      return;
    }

    const name = (prompt("Nombre de la geocerca:", nowName()) || "").trim() || nowName();

    const arr = readFences();
    const id = uid();
    const fence = { id, name, latlngs: pts };
    arr.push(fence);
    writeFences(arr);

    refreshSelectorsAndList(id);
    try { window.dispatchEvent(new CustomEvent('nobis:fences-updated', { detail:{ id } })); } catch(_e){}
    tryDrawOnMap(fence);
  }

  function wire(){
    ensureBtnType('createFenceByCoordsBtn');
    const btn = byId('createFenceByCoordsBtn');
    if (btn){
      btn.onclick = function(ev){ ev.preventDefault(); createFenceByCoords(); };
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wire, { once:true });
  } else {
    wire();
  }
})();
</script>


</body>
</html>

