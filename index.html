<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geocercas (Nobis)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; }
    .app { display:grid; grid-template-columns:280px 1fr; height:100vh; }
    .sidebar { background:#f9fafb; border-right:1px solid #ddd; padding:8px; overflow-y:auto; }
    .sidebar h3 { margin-top:16px; margin-bottom:6px; font-size:14px; color:#111; }
    button { display:block; width:100%; margin:4px 0; padding:6px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #map { width:100%; height:100%; }
    #coords { font-size:12px; color:#333; padding:4px; }
    ul { margin:4px 0; padding-left:18px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h3>Acciones</h3>
      <button id="newBtn">Nueva</button>
      <button id="finishBtn" disabled>Finalizar</button>
      <button id="cancelBtn" disabled>Cancelar</button>
      <button id="editBtn" disabled>Editar</button>
      <button id="saveEditBtn" disabled>Guardar cambios</button>
      <button id="cancelEditBtn" disabled>Cancelar edición</button>
      <button id="renameBtn" disabled>Renombrar</button>
      <button id="deleteBtn" disabled>Eliminar</button>
      <button id="byCoordsBtn">Geocerca (Lat/Lng)</button>
      <button id="exportBtn">Exportar GeoJSON</button>
      <input type="file" id="importInput" accept=".geojson,.json"/>

      <h3>Geocercas</h3>
      <ul id="fenceList"></ul>

      <h3>Gestión de Personal</h3>
      <button id="addPersonBtn">Añadir personal</button>
      <button id="listPersonBtn">Ver personal</button>
      <div id="personList" style="margin-top:8px; font-size:13px; color:#374151;"></div>
    </div>

    <div>
      <div id="map"></div>
      <div id="coords">Lat: -, Lng: -</div>
    </div>
  </div>

<script>
let map, group;
let fences=[];
let activeId=null;

let drawing=false;
let tempPoints=[]; 
let tempLine=null, tempPoly=null;
let editMarkers = [];
let editBackup = null;

// === Persistencia en localStorage ===
function saveFence(fence) {
  let fences = JSON.parse(localStorage.getItem("geocercas")) || [];
  // Buscar si ya existe
  let index = fences.findIndex(f => f.id === fence.id);
  if (index >= 0) {
    fences[index] = fence; // actualiza existente
  } else {
    fences.push(fence); // añade nueva
  }
  localStorage.setItem("geocercas", JSON.stringify(fences));
}

function loadFences() {
  let fences = JSON.parse(localStorage.getItem("geocercas")) || [];
  fences.forEach(fence => {
    let polygon = L.polygon(fence.latlngs, { color: "purple" }).addTo(group);
    polygon.bindTooltip(fence.name, { permanent: true, direction: "center" });
    fence._layer = polygon;
    polygon.on("click", () => {
      activeFence = fence;
      renderList();
    });
  });
}


// === Helpers de estado ===
function setIdle(){
  document.getElementById("editBtn").disabled = !activeId;
  document.getElementById("saveEditBtn").disabled = true;
  document.getElementById("cancelEditBtn").disabled = true;
  document.getElementById("renameBtn").disabled = !activeId;
  document.getElementById("deleteBtn").disabled = !activeId;
}
function setEditing(){
  document.getElementById("editBtn").disabled = true;
  document.getElementById("saveEditBtn").disabled = false;
  document.getElementById("cancelEditBtn").disabled = false;
  document.getElementById("renameBtn").disabled = true;
  document.getElementById("deleteBtn").disabled = true;
}
function writeFences(arr){ fences=arr; saveToStorage(); }

// === Crear por Lat/Lng ===
document.getElementById("byCoordsBtn").onclick=()=>{
  let raw=prompt("Pega coordenadas Lat,Lng separadas por salto de línea o ';'");
  if(!raw) return;
  let pts=[]; raw.split(/[\n;]/).forEach(l=>{
    let p=l.trim().split(/[, ]+/);
    if(p.length>=2){
      let lat=parseFloat(p[0]); let lng=parseFloat(p[1]);
      if(Math.abs(lat)>90){ [lat,lng]=[lng,lat]; }
      if(!isNaN(lat)&&!isNaN(lng)) pts.push([lat,lng]);
    }
  });
  if(pts.length<3){ alert("Se requieren al menos 3 coordenadas"); return; }
  let name=prompt("Nombre de la geocerca:","Geocerca "+(fences.length+1));
  if(!name) return;
  let f={id:Date.now().toString(), name:name, latlngs:pts.map(p=>L.latLng(p[0],p[1]))};
  fences.push(f);
  saveToStorage();
  activeId=f.id;
  drawAll();
  map.fitBounds(f.__layer.getBounds());
};

// === Edición de Geocercas ===
function enterEdit() {
  if (!activeId) { alert("Selecciona una geocerca primero"); return; }
  let f = fences.find(ff=>ff.id===activeId);
  if (!f || !f.__layer) return;
  if (editMarkers) editMarkers.forEach(m=>map.removeLayer(m));
  editMarkers = [];
  let latlngs = f.__layer.getLatLngs()[0];
  editBackup = latlngs.map(p=>L.latLng(p.lat,p.lng));
  latlngs.forEach(pt=>{
    let m = L.marker(pt,{draggable:true});
    m.on("drag",()=>{
      let cur = editMarkers.map(mm=>mm.getLatLng());
      f.__layer.setLatLngs([cur]);
    });
    editMarkers.push(m);
    m.addTo(map);
  });
  setEditing();
}

function saveEdit() {
  if (!activeId) return;
  let f = fences.find(ff=>ff.id===activeId);
  if (!f || !f.__layer) return;
  let cur = editMarkers.map(m=>m.getLatLng());
  if (cur.length<3){ alert("Mínimo 3 vértices."); return; }
  f.latlngs = cur;
  writeFences(fences);
  exitEdit(true);
}

function exitEdit(redraw) {
  if (editMarkers) editMarkers.forEach(m=>map.removeLayer(m));
  editMarkers = [];
  editBackup = null;
  if (redraw) drawAll();
  setIdle();
}

// === Renombrar y Eliminar ===
document.getElementById("renameBtn").onclick=()=>{
  if(!activeId) return;
  let f=fences.find(x=>x.id===activeId);
  if(!f) return;
  let nuevo=prompt("Nuevo nombre para la geocerca:", f.name);
  if(nuevo && nuevo.trim()){
    f.name=nuevo.trim();
    saveToStorage();
    drawAll();
  }
};

document.getElementById("deleteBtn").onclick=()=>{
  if(!activeId) return;
  let f=fences.find(x=>x.id===activeId);
  if(!f) return;
  if(confirm("¿Eliminar geocerca '"+f.name+"'?")){
    fences=fences.filter(x=>x.id!==activeId);
    saveToStorage();
    activeId=null;
    drawAll();
  }
};

// inicializar mapa
function initMap(){
  map=L.map('map').setView([-1.73,-77.91],14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);
  group=L.layerGroup().addTo(map);
  map.on("mousemove",e=>{
    document.getElementById("coords").textContent=`Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`;
  });
  loadFromStorage();
  drawAll();
}

// dibujar todas
function drawAll(){
  group.clearLayers();
  fences.forEach(f=>{
    let poly=L.polygon(f.latlngs,{color:'#6b21a8',weight:2,fillOpacity:0.3}).addTo(group);
    poly.bindTooltip(f.name,{permanent:true,direction:"center"});
    poly.on("click",()=>{ activeId=f.id; renderList(); });
    f.__layer=poly;
  });
  renderList();
}

function renderList(){
  let ul=document.getElementById("fenceList");
  ul.innerHTML="";
  fences.forEach(f=>{
    let li=document.createElement("li");
    li.textContent=f.name;
    li.style.cursor="pointer";
    li.onclick=()=>{ activeId=f.id; drawAll(); setIdle(); };
    ul.appendChild(li);
  });
  setIdle();
}

// === Crear geocerca manual ===
document.getElementById("newBtn").onclick=()=>{
  drawing=true; tempPoints=[]; 
  if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
  map.on("click",addTempPoint);
  document.getElementById("finishBtn").disabled=false;
  document.getElementById("cancelBtn").disabled=false;
};

function addTempPoint(e){
  tempPoints.push(e.latlng);
  if(tempLine){ tempLine.setLatLngs(tempPoints); }
  else{ tempLine=L.polyline(tempPoints,{color:"blue",dashArray:"5,5"}).addTo(map); }
  if(tempPoints.length>=3){
    if(tempPoly){ tempPoly.setLatLngs(tempPoints); }
    else{ tempPoly=L.polygon(tempPoints,{color:"blue",weight:1,fillOpacity:0.1}).addTo(map); }
  }
}

document.getElementById("finishBtn").onclick=()=>{
  if(tempPoints.length<3){ alert("Se requieren al menos 3 puntos."); return; }
  let name=prompt("Nombre de la geocerca:","Geocerca "+(fences.length+1));
  if(!name) return;
  let f={id:Date.now().toString(), name:name, latlngs:tempPoints};
  fences.push(f);
  saveToStorage();
  map.off("click",addTempPoint);
  drawing=false; tempPoints=[]; 
  if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
  document.getElementById("finishBtn").disabled=true;
  document.getElementById("cancelBtn").disabled=true;
  drawAll();
};

document.getElementById("cancelBtn").onclick=()=>{
  drawing=false; tempPoints=[]; 
  if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
  map.off("click",addTempPoint);
  document.getElementById("finishBtn").disabled=true;
  document.getElementById("cancelBtn").disabled=true;
};

// === Gestión de personal ===
document.getElementById("addPersonBtn").onclick=()=>{
  let f=fences.find(x=>x.id===activeId);
  if(!f){ alert("Selecciona una geocerca activa."); return; }
  let p=prompt("Nombre del personal:");
  if(!p) return;
  if(!f.personal) f.personal=[];
  f.personal.push(p);
  saveToStorage();
  alert(`Añadido personal a: ${f.name}`);
};

document.getElementById("listPersonBtn").onclick=()=>{
  let f=fences.find(x=>x.id===activeId);
  if(!f){ alert("Selecciona una geocerca activa."); return; }
  renderPersonal(f);
};

function renderPersonal(f){
  let div=document.getElementById("personList");
  div.innerHTML="";
  if(!f.personal || !f.personal.length){
    div.textContent="(Sin personal registrado)";
    return;
  }
  let ul=document.createElement("ul");
  f.personal.forEach((p,i)=>{
    let li=document.createElement("li");
    li.textContent=`${i+1}. ${p}`;
    ul.appendChild(li);
  });
  div.appendChild(ul);
}

// enganchar botones edición
document.getElementById("editBtn").onclick = enterEdit;
document.getElementById("saveEditBtn").onclick = saveEdit;
document.getElementById("cancelEditBtn").onclick = ()=>exitEdit(false);

initMap();
</script>
</body>
</html>
