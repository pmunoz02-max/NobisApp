<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Geocercas</title>

  <!-- ======= AQUÍ VAN TUS <link> y <script> EXISTENTES (Leaflet, estilos, etc.) ======= -->
  <!-- No toqué nada arriba -->
</head>
<body>

  <!-- ======= AQUÍ VA TODO TU HTML EXISTENTE (UI, botones, mapa, módulos, etc.) ======= -->
  <!-- No toqué nada del contenido ni de los otros módulos -->

  <!-- ======= ÚNICO PARCHE ACTIVO (ES5 SEGURO): Geocerca por Lat/Lng ======= -->
  <script id="patch-createByLatLng-es5">
  (function(){
    try{
      if (window.__PATCH_CREATEBYLATLNG_ES5__) return;
      window.__PATCH_CREATEBYLATLNG_ES5__ = true;

      function override(){
        try{
          // Reemplaza la función global (sin sintaxis moderna)
          window.createByLatLng = function(){
            try{
              // Respeta tu regla de roles (si existe)
              try{
                if (typeof roleOf==='function' && typeof CURRENT_USER_ID!=='undefined'){
                  if (roleOf(CURRENT_USER_ID)==='staff'){
                    alert('El personal no puede crear geocercas.');
                    return;
                  }
                }
              }catch(_){}

              // Pide coordenadas (acepta ';' o saltos de línea)
              var ejemplo = "Pega coordenadas Lat,Lng (una por línea o separadas con ';'):\n"+
                            "-1.23456, -78.12345\n-1.23400 -78.12000\n"+
                            "-1,23456  -78,12345   (coma decimal)\n"+
                            "-78.12, -1.23         (lon,lat; se corrige)\n\n"+
                            "También en una sola línea separadas por ';':\n"+
                            "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092";
              var raw = window.prompt(ejemplo);
              if (raw === null) return;

              // Parseo robusto
              var pts = [];
              var segments = String(raw).split(/[;\r\n]+/);
              for (var i=0;i<segments.length;i++){
                var seg = (segments[i]||'').trim();
                if(!seg) continue;
                // Toma los dos primeros números; admite coma/punto decimal
                var nums = seg.match(/[-+]?\d+(?:[.,]\d+)?/g);
                if(!nums || nums.length<2) continue;
                var a = parseFloat(String(nums[0]).replace(',', '.'));
                var b = parseFloat(String(nums[1]).replace(',', '.'));
                if(!isFinite(a) || !isFinite(b)) continue;
                var lat=a, lng=b;
                // Si parece lon,lat, invierte
                if (Math.abs(lat)>90 || Math.abs(lng)>180){ lat=b; lng=a; }
                if (Math.abs(lat)<=90 && Math.abs(lng)<=180){
                  pts.push({lat:lat, lng:lng});
                }
              }

              if (!pts || pts.length < 3){
                alert('Se requieren al menos 3 coordenadas válidas (lat,lng).');
                return;
              }

              // Pide y guarda el nombre (usa tu nextDefaultName si existe)
              var sugerido = (typeof nextDefaultName==='function' ? nextDefaultName() : ('Geocerca '+(new Date().getTime()%1000)));
              var name = (window.prompt('Nombre de la geocerca:', sugerido) || '').trim();
              if(!name) name = sugerido;

              // Persistencia con tus helpers (path = array de {lat,lng})
              var fs = [];
              try{ fs = (typeof loadF==='function' ? loadF() : []); }catch(_){}
              var id = 'f_' + Math.random().toString(36).slice(2,10);
              fs.push({id:id, name:name, path:pts});
              try{ if (typeof saveF==='function') saveF(fs); }catch(_){}

              // Refresca UI y centra mapa usando tu flujo
              try{ if (typeof renderAll==='function') renderAll(); }catch(_){}
              try{ if (typeof zoomTo==='function') zoomTo(id); }catch(_){}
              try{ if (typeof S==='function') S('geocerca creada por coordenadas'); }catch(_){}
            }catch(e){
              try{ console && console.error(e); }catch(_){}
            }
          };

          // Asegura el botón y re-bindea por si hacía falta
          var btn = document.getElementById('createFenceByCoordsBtn');
          if (btn){
            if (btn.type !== 'button') btn.type = 'button';
            btn.onclick = function(ev){
              try{ if(ev && ev.preventDefault) ev.preventDefault(); window.createByLatLng(); }catch(_){}
            };
          }
        }catch(_){}
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', override, false);
      } else {
        override();
      }
    }catch(_){}
  })();
  </script>
  <!-- ========================================================= -->

  <!-- ======= TUS SCRIPTS YA EXISTENTES (NO TOCADOS) ======= -->

</body>
</html>
