<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nobis App Multiusuario</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2, h3 { color: #2c3e50; }
    input, select { margin: 5px; padding: 5px; }
    button { margin: 5px; padding: 6px 12px; cursor: pointer; }
    #map { height: 400px; margin-top: 20px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
</head>
<body>
  <h2>Administración</h2>

  <div>
    <label>Email de login:</label>
    <input type="email" id="loginEmail" placeholder="tuemail@dominio.com">
    <button onclick="login()">Ingresar</button>
  </div>

  <p><b>Nivel actual:</b> <span id="nivelActual">No autenticado</span></p>

  <h3>Crear nuevo Administrador</h3>
  <input type="email" id="newAdminEmail" placeholder="nuevoadmin@dominio.com">
  <button onclick="crearAdmin()">Crear Admin</button>

  <h3>Administradores activos</h3>
  <ul id="adminsActivos"></ul>

  <div id="map">[Aquí va el mapa con geocercas y módulos de tu app]</div>

  <script>
    // Inicializar EmailJS con tu Public Key
    (function(){
      emailjs.init("qSmyIiQYgJVnpllqS"); // <--- tu PUBLIC KEY
    })();

    const SERVICE_ID = "service_fuhd91q";   // <--- tu SERVICE ID
    const TEMPLATE_ID = "template_k4gnktv"; // <--- tu TEMPLATE ID

    // Mostrar lista de administradores
    function mostrarAdmins() {
      const admins = JSON.parse(localStorage.getItem("admins")) || [];
      const lista = document.getElementById("adminsActivos");
      lista.innerHTML = admins.length
        ? admins.map(a => `<li>${a}</li>`).join("")
        : "<li>No hay administradores activos</li>";
    }

    // Login
    function login() {
      const email = document.getElementById("loginEmail").value.trim();
      const owner = "fenice.ecuador@gmail.com"; // Dueño fijo
      const admins = JSON.parse(localStorage.getItem("admins")) || [];

      if (email === owner) {
        document.getElementById("nivelActual").innerText = "Dueño";
        alert("✅ Bienvenido Dueño");
      } else if (admins.includes(email)) {
        document.getElementById("nivelActual").innerText = "Administrador";
        alert("✅ Bienvenido Administrador");
      } else {
        document.getElementById("nivelActual").innerText = "Usuario";
        alert("⚠️ Acceso como usuario básico (Nivel 3)");
      }
    }

    // Crear nuevo admin
    function crearAdmin() {
      const email = document.getElementById("newAdminEmail").value.trim();
      if (!email) {
        alert("Por favor, ingresa un email válido.");
        return;
      }

      let admins = JSON.parse(localStorage.getItem("admins")) || [];
      if (!admins.includes(email)) {
        admins.push(email);
        localStorage.setItem("admins", JSON.stringify(admins));
        mostrarAdmins();
      }

      // Enviar correo de invitación
      const token = Math.random().toString(36).substring(2, 10);
      const activationLink = `${window.location.origin}${window.location.pathname}?activate=${encodeURIComponent(email)}&token=${token}`;

      const templateParams = {
        email: email,                  // debe coincidir con {{email}} en tu plantilla
        activation_link: activationLink
      };

      emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams)
        .then(() => {
          alert("✅ Invitación enviada a: " + email);
        })
        .catch(err => {
          console.error("EmailJS error:", err);
          alert("❌ Error al enviar invitación. Revisa la consola.");
        });
    }

    window.onload = mostrarAdmins;
  </script>
</body>
</html>
