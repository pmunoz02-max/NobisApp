<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Personal de Finca (Leaflet + Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; overflow-x: hidden; }
    #map { height: 55vh; width: 100%; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,.1); z-index: 1; }
    @media (max-width: 768px) { #map { height: 45vh; } body { padding: 12px; } }
    #adminModal { z-index: 10000; }
    button, input, select, textarea { font-size: 16px; }
    .error-message { color: #dc2626; font-size: 14px; margin-top: 6px; display: none; }
    .farm-label { background: #ffffff; border: 1px solid rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); font-size: 12px; }
    .mousepos-control { background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 overflow-x-hidden">

  <!-- Modal admin -->
  <div id="adminModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input type="password" id="adminCodeInput" placeholder="Código de acceso"
             class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2"
             autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="text">
      <div id="errorMessage" class="error-message">Código incorrecto. Intenta con "admin123"</div>
      <button id="adminLoginBtn"
              onclick="doAdminLogin()"
              class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 transition font-bold">
        Acceder
      </button>
    </div>
  </div>

  <!-- Contenido de la app -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">
    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Control de Personal y Geocercas</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Sincronizado con Firebase (Firestore) + respaldo local</p>
    </header>

    <!-- Selección de finca -->
    <div class="bg-white p-4 rounded-2xl shadow-lg">
      <div>
        <label class="block text-sm font-medium text-gray-700">Finca activa</label>
        <select id="farmSelect" class="mt-1 w-full border rounded-md p-2"></select>
      </div>
    </div>

    <!-- Mapa -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa de Fincas</h2>
        <div class="ml-auto flex flex-wrap gap-2">

          <!-- Geocerca (dibujo) -->
          <button id="startFenceBtn"
            class="inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Iniciar dibujo de geocerca">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6H4z"/>
            </svg>
            Nueva geocerca
          </button>
          <button id="finishFenceBtn"
            class="hidden inline-flex items-center gap-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Finalizar geocerca">
            Finalizar geocerca
          </button>
          <button id="cancelFenceBtn"
            class="hidden inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg"
            title="Cancelar dibujo">
            Cancelar
          </button>

          <!-- Geocerca por coordenadas -->
          <button id="createFenceByCoordsBtn"
            class="inline-flex items-center gap-2 bg-sky-700 hover:bg-sky-800 text-white font-semibold px-4 py-2 rounded-lg"
            title="Crear geocerca ingresando una lista de coordenadas">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/>
            </svg>
            Geocerca (Lat/Lngs)
          </button>

          <!-- Fincas -->
          <button id="createFarmBtn"
            class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Crear finca en el centro del mapa">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Crear finca
          </button>
          <button id="createByCoordsBtn"
            class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Crear finca ingresando Lat/Lng">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4l3-3 4 8 3-5H22M3 19h18"/></svg>
            Crear finca (Lat/Lng)
          </button>
          <button id="deleteFarmBtn"
            class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
            title="Eliminar la finca seleccionada">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Eliminar finca
          </button>

          <!-- Eliminar geocerca -->
          <button id="deleteFenceBtn"
            class="inline-flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
            title="Eliminar la geocerca seleccionada" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Eliminar geocerca
          </button>
        </div>
      </div>

      <!-- Panel nombre para Crear finca (Lat/Lng) -->
      <div id="coordsNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label for="coordsNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la nueva finca</label>
          <div class="flex gap-2">
            <input id="coordsNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Finca Palora Norte" />
            <button id="coordsNameSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="coordsNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="coordsNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <!-- Panel nombre para geocerca -->
      <div id="fenceNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label for="fenceNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex gap-2">
            <input id="fenceNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Geocerca Lote 1" />
            <button id="fenceNameSaveBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="fenceNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="fenceNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <div id="map"></div>
      <p id="statusMessage" class="mt-3 text-sm text-gray-600">
        Haz clic en el mapa para crear una nueva finca. También puedes usar <strong>Crear finca</strong> (centro del mapa) o <strong>Crear finca (Lat/Lng)</strong>.
        Para geocercas: <strong>Nueva geocerca</strong> → clics en el mapa para vértices → <strong>Finalizar geocerca</strong> → asigna nombre y guarda.
        Para borrar, primero haz <strong>click en la geocerca</strong> (se resalta) y luego pulsa <strong>Eliminar geocerca</strong>.
      </p>
    </div>
  </div>

  <!-- Leaflet & Firebase -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE",
      authDomain: "demo-finca-app.firebaseapp.com",
      projectId: "demo-finca-app",
      storageBucket: "demo-finca-app.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* Transporte compatible con móviles */
    try {
      db.settings({
        experimentalForceLongPolling: true,
        experimentalAutoDetectLongPolling: false,
        useFetchStreams: false
      });
    } catch (e) { console.warn('Firestore settings no soportados en este entorno:', e); }

    /* Persistencia solo desktop (evita problemas en Safari/iOS) */
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (!isMobile) {
      db.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
    }

    /* Auth anónima */
    firebase.auth().signInAnonymously().catch(console.error);

    /* ========= Estado ========= */
    let map;
    const fincaMarkers = {};
    const LS_KEY = 'fincas_cache_v1';

    const geofenceLayers = {}; // id -> L.Polygon
    const LS_GF = 'geofences_cache_v1';

    let isDrawingFence = false;
    let drawingCoords = [];
    let drawingPolyline = null;
    let drawingMarkers = [];
    let pendingFenceCoords = null;

    let previewFenceLayer = null;
    let selectedFenceId = null;

    let subsStarted = false;
    const GEOFENCE_STYLE = {weight:2, fillOpacity:0.15};
    const GEOFENCE_SELECTED_STYLE = {weight:3, color:'#ef4444', fillOpacity:0.2};

    /* ========= Helpers caché ========= */
    function saveCache(farms){ try{ localStorage.setItem(LS_KEY, JSON.stringify(farms)); }catch{} }
    function loadCache(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }

    function saveFenceCache(fences){ try{ localStorage.setItem(LS_GF, JSON.stringify(fences)); }catch{} }
    function loadFenceCache(){ try{ return JSON.parse(localStorage.getItem(LS_GF)||'[]'); }catch{ return []; } }

    /* ========= Render ========= */
    function renderFarmsFromCache(){
      const farms = loadCache();
      Object.values(fincaMarkers).forEach(m=> map.removeLayer(m));
      for(const k in fincaMarkers) delete fincaMarkers[k];

      farms.forEach(f=>{
        if(!f || !f.id || !f.fincaLocation) return;
        const marker = L.marker([f.fincaLocation.lat, f.fincaLocation.lng]).addTo(map);
        marker.bindTooltip(f.name || 'Finca',{permanent:true, direction:'right', offset:[10,0], className:'farm-label'});
        fincaMarkers[f.id] = marker;
      });

      const sel = document.getElementById('farmSelect');
      if (sel){
        sel.innerHTML = '';
        farms.forEach(f=>{
          const opt = document.createElement('option');
          opt.value = f.id; opt.textContent = f.name || 'Finca';
          sel.appendChild(opt);
        });
      }
      updateDeleteButtonState();
    }

    function renderGeofencesFromCache(){
      Object.values(geofenceLayers).forEach(p=> map.removeLayer(p));
      for(const k in geofenceLayers) delete geofenceLayers[k];

      const fences = loadFenceCache();
      fences.forEach(g=>{
        if(!g || !g.id || !Array.isArray(g.path) || g.path.length<3) return;
        const latlngs = g.path.map(pt=> [pt.lat, pt.lng]);
        const poly = L.polygon(latlngs, GEOFENCE_STYLE).addTo(map);
        poly.bindTooltip(g.name || 'Geocerca',{permanent:true, direction:'center', className:'farm-label'});
        geofenceLayers[g.id] = poly;
        poly.on('click', ()=> selectFence(g.id));
        if(selectedFenceId === g.id){ poly.setStyle(GEOFENCE_SELECTED_STYLE); }
      });

      if(selectedFenceId && !geofenceLayers[selectedFenceId]){
        selectedFenceId = null;
      }
      updateDeleteFenceButtonState();
    }

    /* ========= Mapa ========= */
    function initMap(center){ 
      center = center || {lat:-0.1807, lng:-78.4678};
      const zoom = 6;
      map = L.map('map',{center:[center.lat,center.lng],zoom});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

      addMousePositionControl();
      renderFarmsFromCache();
      renderGeofencesFromCache();

      map.on('click', async e=>{
        if(isDrawingFence){
          addFenceVertex(e.latlng);
          return;
        }
        const name = prompt("Nombre de la nueva finca:");
        if(!name) return;
        try{
          await db.collection('farms').add({ name, fincaLocation:{lat:e.latlng.lat, lng:e.latlng.lng} });
        }catch{
          const farms = loadCache();
          farms.push({ id: 'local-'+Date.now(), name, fincaLocation:{lat:e.latlng.lat, lng:e.latlng.lng} });
          saveCache(farms); renderFarmsFromCache();
        }
      });

      // Arrancar subs y carga inmediata
      startSubscriptions();
      initialFetchAll();
      setTimeout(initialFetchAll, 1200); // segundo intento suave
      // Fallback extra para móviles: REST si a los 3s seguimos sin datos
      setTimeout(tryRESTFallbackIfEmpty, 3000);
    }

    function startSubscriptions(){
      if (subsStarted) return;
      subsStarted = true;
      subscribeFarms();
      subscribeGeofences();
    }

    /* ========= Suscripciones Firestore ========= */
    function subscribeFarms(){
      db.collection('farms').onSnapshot(snap=>{
        const farms = [];
        Object.values(fincaMarkers).forEach(m=> map.removeLayer(m));
        for(const k in fincaMarkers) delete fincaMarkers[k];

        snap.forEach(doc=>{
          const d = doc.data();
          const farm = { id: doc.id, name: d.name, fincaLocation: d.fincaLocation };
          farms.push(farm);
          if(d.fincaLocation){
            const marker = L.marker([d.fincaLocation.lat, d.fincaLocation.lng]).addTo(map);
            marker.bindTooltip(d.name || 'Finca',{permanent:true, direction:'right', offset:[10,0], className:'farm-label'});
            fincaMarkers[doc.id]=marker;
          }
        });

        if (farms.length) { saveCache(farms); }
        const sel = document.getElementById('farmSelect');
        if (sel){
          sel.innerHTML = '';
          farms.forEach(f=>{
            const opt = document.createElement('option'); opt.value = f.id; opt.textContent = f.name || 'Finca'; sel.appendChild(opt);
          });
        }
        updateDeleteButtonState();
      }, err => { console.warn('onSnapshot farms error', err); renderFarmsFromCache(); });
    }

    function subscribeGeofences(){
      db.collection('geofences').onSnapshot(snap=>{
        const fences = [];
        Object.values(geofenceLayers).forEach(p=> map.removeLayer(p));
        for(const k in geofenceLayers) delete geofenceLayers[k];

        snap.forEach(doc=>{
          const d = doc.data();
          const g = { id: doc.id, name: d.name, path: d.path || [] };
          fences.push(g);
          if(Array.isArray(g.path) && g.path.length>=3){
            const latlngs = g.path.map(pt=> [pt.lat, pt.lng]);
            const poly = L.polygon(latlngs, GEOFENCE_STYLE).addTo(map);
            poly.bindTooltip(g.name || 'Geocerca',{permanent:true, direction:'center', className:'farm-label'});
            geofenceLayers[doc.id]=poly;
            poly.on('click', ()=> selectFence(doc.id));
            if(selectedFenceId === doc.id){ poly.setStyle(GEOFENCE_SELECTED_STYLE); }
          }
        });

        if (fences.length) { saveFenceCache(fences); }
        if(selectedFenceId && !geofenceLayers[selectedFenceId]){
          selectedFenceId = null;
        }
        updateDeleteFenceButtonState();
      }, err => { console.warn('onSnapshot geofences error', err); renderGeofencesFromCache(); });
    }

    /* ========= Carga inicial (SDK) ========= */
    async function initialFetchAll(){
      await Promise.all([initialFetchFarms(), initialFetchGeofences()]);
    }
    async function initialFetchFarms(){
      try{
        const snap = await db.collection('farms').get();
        const farms = [];
        snap.forEach(doc=>{
          const d = doc.data();
          farms.push({ id: doc.id, name: d.name, fincaLocation: d.fincaLocation });
        });
        if (farms.length) {
          saveCache(farms);
          renderFarmsFromCache();
        }
      }catch(e){ console.warn('Fallback get farms failed', e); }
    }
    async function initialFetchGeofences(){
      try{
        const snap = await db.collection('geofences').get();
        const fences = [];
        snap.forEach(doc=>{
          const d = doc.data();
          fences.push({ id: doc.id, name: d.name, path: d.path || [] });
        });
        if (fences.length) {
          saveFenceCache(fences);
          renderGeofencesFromCache();
        }
      }catch(e){ console.warn('Fallback get geofences failed', e); }
    }

    /* ========= Fallback REST para móviles (si SDK no trae nada) ========= */
    const REST_BASE = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents`;
    async function restList(collection){
      const url = `${REST_BASE}/${collection}?key=${firebaseConfig.apiKey}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`REST ${collection} ${res.status}`);
      const data = await res.json();
      return (data.documents||[]).map(doc=>{
        const id = doc.name.split('/').pop();
        const f = doc.fields || {};
        return { id, fields: f };
      });
    }
    function readString(field){ return field?.stringValue ?? ''; }
    function readNumber(field){
      if (field?.doubleValue != null) return Number(field.doubleValue);
      if (field?.integerValue != null) return Number(field.integerValue);
      return NaN;
    }
    function readLatLng(mapField){
      const m = mapField?.mapValue?.fields;
      if(!m) return null;
      const lat = readNumber(m.lat);
      const lng = readNumber(m.lng);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat, lng};
      return null;
    }
    async function fetchFarmsViaREST(){
      try{
        const docs = await restList('farms');
        const farms = [];
        docs.forEach(d=>{
          const name = readString(d.fields.name);
          const loc  = readLatLng(d.fields.fincaLocation);
          farms.push({ id:d.id, name, fincaLocation: loc });
        });
        if (farms.length){
          saveCache(farms);
          renderFarmsFromCache();
        }
      }catch(e){ console.warn('REST farms error:', e); }
    }
    async function fetchGeofencesViaREST(){
      try{
        const docs = await restList('geofences');
        const fences = [];
        docs.forEach(d=>{
          const name = readString(d.fields.name);
          // path es ArrayValue de map {lat,lng}
          const arr = d.fields.path?.arrayValue?.values || [];
          const path = arr.map(v => readLatLng(v.mapValue?.fields)).filter(Boolean);
          fences.push({ id:d.id, name, path });
        });
        if (fences.length){
          saveFenceCache(fences);
          renderGeofencesFromCache();
        }
      }catch(e){ console.warn('REST geofences error:', e); }
    }
    function tryRESTFallbackIfEmpty(){
      const farmsEmpty = (loadCache().length === 0);
      const fencesEmpty = (loadFenceCache().length === 0);
      if (farmsEmpty) fetchFarmsViaREST();
      if (fencesEmpty) fetchGeofencesViaREST();
    }

    /* ========= Interacción geocercas ========= */
    function selectFence(id){
      if(selectedFenceId && geofenceLayers[selectedFenceId]){
        geofenceLayers[selectedFenceId].setStyle(GEOFENCE_STYLE);
      }
      selectedFenceId = id;
      if(geofenceLayers[selectedFenceId]){
        geofenceLayers[selectedFenceId].setStyle(GEOFENCE_SELECTED_STYLE);
      }
      updateDeleteFenceButtonState();
    }

    /* ========= Helpers numéricos ========= */
    function normDec(s){ return String(s||'').trim().replace(',', '.'); }
    function parseCoord(s){ const v=parseFloat(normDec(s)); return Number.isFinite(v)?v:NaN; }
    function validLat(v){ return v>=-90 && v<=90; }
    function validLng(v){ return v>=-180 && v<=180; }

    /* ========= Crear fincas ========= */
    let pendingLat = null, pendingLng = null;
    async function createFarmAtCenter(){
      if(!map){ alert('Mapa no listo aún.'); return; }
      const name = prompt("Nombre de la nueva finca:"); if(!name) return;
      const c = map.getCenter();
      try{ await db.collection('farms').add({ name, fincaLocation:{lat:c.lat, lng:c.lng} }); }
      catch{ const farms=loadCache(); farms.push({ id:'local-'+Date.now(), name, fincaLocation:{lat:c.lat, lng:c.lng} }); saveCache(farms); renderFarmsFromCache(); }
    }
    async function createFarmByCoords(){
      const latStr = prompt("Latitud (decimal, -90 a 90). Puedes usar coma o punto:"); if(latStr===null) return;
      const lngStr = prompt("Longitud (decimal, -180 a 180). Puedes usar coma o punto:"); if(lngStr===null) return;
      const lat = parseCoord(latStr), lng = parseCoord(lngStr);
      if(!Number.isFinite(lat) || !validLat(lat)){ alert('Latitud inválida o fuera de rango (-90 a 90).'); return; }
      if(!Number.isFinite(lng) || !validLng(lng)){ alert('Longitud inválida o fuera de rango (-180 a 180).'); return; }
      pendingLat = lat; pendingLng = lng;

      const coordsNameHint = document.getElementById('coordsNameHint');
      if (coordsNameHint) coordsNameHint.textContent = `Coordenadas: Lat ${lat.toFixed(5)}, Lng ${lng.toFixed(5)}`;
      const input = document.getElementById('coordsNameInput');
      if (input) input.value = `Finca ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      const panel = document.getElementById('coordsNamePanel');
      if (panel) panel.classList.remove('hidden');
      if (input){ input.focus(); input.select(); }

      if(map){ map.setView([lat, lng], Math.max(map.getZoom(), 12)); }
    }
    async function saveCoordsName(){
      if(pendingLat==null || pendingLng==null) { cancelCoordsName(); return; }
      const input = document.getElementById('coordsNameInput');
      const name = (input && input.value ? input.value : '').trim() || `Finca ${pendingLat.toFixed(5)}, ${pendingLng.toFixed(5)}`;
      try{ await db.collection('farms').add({ name, fincaLocation:{lat: pendingLat, lng: pendingLng} }); }
      catch{ const farms=loadCache(); farms.push({ id:'local-'+Date.now(), name, fincaLocation:{lat:pendingLat, lng:pendingLng} }); saveCache(farms); renderFarmsFromCache(); }
      pendingLat=null; pendingLng=null; if(input){ input.value=''; }
      const panel = document.getElementById('coordsNamePanel'); if(panel){ panel.classList.add('hidden'); }
    }
    function cancelCoordsName(){
      pendingLat=null; pendingLng=null;
      const input = document.getElementById('coordsNameInput'); if(input){ input.value=''; }
      const panel = document.getElementById('coordsNamePanel'); if(panel){ panel.classList.add('hidden'); }
    }

    /* ========= Dibujo geocerca ========= */
    function addFenceVertex(latlng){
      drawingCoords.push({lat: latlng.lat, lng: latlng.lng});
      const m = L.circleMarker(latlng, {radius:4, weight:2}).addTo(map);
      drawingMarkers.push(m);
      updateFencePreview();
    }
    function updateFencePreview(){
      const latlngs = drawingCoords.map(p=> [p.lat, p.lng]);
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }
      if(latlngs.length>=3){
        drawingPolyline = L.polygon(latlngs, {dashArray:'4,4', weight:2, fillOpacity:0.1}).addTo(map);
      }else if(latlngs.length>=2){
        drawingPolyline = L.polyline(latlngs, {dashArray:'4,4', weight:2}).addTo(map);
      }
    }
    function startFenceDraw(){
      if(isDrawingFence) return;
      isDrawingFence = true;
      drawingCoords = [];
      drawingMarkers.forEach(m=> map.removeLayer(m)); drawingMarkers=[];
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }

      document.getElementById('startFenceBtn').classList.add('hidden');
      document.getElementById('finishFenceBtn').classList.remove('hidden');
      document.getElementById('cancelFenceBtn').classList.remove('hidden');
    }
    function finishFenceDraw(){
      if(!isDrawingFence) return;
      if(drawingCoords.length < 3){ alert('La geocerca necesita al menos 3 puntos.'); return; }
      pendingFenceCoords = drawingCoords.slice();
      const hint = document.getElementById('fenceNameHint');
      if(hint) hint.textContent = `Vértices: ${pendingFenceCoords.length} puntos`;
      const input = document.getElementById('fenceNameInput');
      if(input) {
        input.value = `Geocerca ${new Date().toLocaleDateString()}`;
        const panel=document.getElementById('fenceNamePanel'); if(panel){ panel.classList.remove('hidden'); }
        input.focus(); input.select();
      }
    }
    function cancelFenceDraw(){
      isDrawingFence = false;
      drawingCoords = [];
      drawingMarkers.forEach(m=> map.removeLayer(m)); drawingMarkers=[];
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }
      document.getElementById('startFenceBtn').classList.remove('hidden');
      document.getElementById('finishFenceBtn').classList.add('hidden');
      document.getElementById('cancelFenceBtn').classList.add('hidden');
      const panel=document.getElementById('fenceNamePanel'); if(panel){ panel.classList.add('hidden'); }
      pendingFenceCoords = null;
    }
    async function saveFenceName(){
      const input = document.getElementById('fenceNameInput');
      const name = (input && input.value ? input.value : '').trim() || 'Geocerca';
      if(!pendingFenceCoords || pendingFenceCoords.length<3){ alert('No hay geocerca lista para guardar.'); return; }

      try{
        await db.collection('geofences').add({ name, path: pendingFenceCoords });
      }catch(err){
        console.error('No se pudo guardar en Firestore. Guardando localmente:', err);
        const fences = loadFenceCache();
        fences.push({ id: 'localgf-'+Date.now(), name, path: pendingFenceCoords });
        saveFenceCache(fences);
        renderGeofencesFromCache();
      }

      if(input){ input.value=''; }
      pendingFenceCoords=null;
      const panel=document.getElementById('fenceNamePanel'); if(panel){ panel.classList.add('hidden'); }
      cancelFenceDraw();
      removePreviewFence();
    }
    function cancelFenceName(){
      const input=document.getElementById('fenceNameInput'); if(input){ input.value=''; }
      const panel=document.getElementById('fenceNamePanel'); if(panel){ panel.classList.add('hidden'); }
      removePreviewFence();
    }

    /* ========= Geocerca por coordenadas ========= */
    function parseLatLngList(texto){
      const items = String(texto || '')
        .split(/[\n;]+/)
        .map(s=> s.trim())
        .filter(Boolean);

      const puntos = [];
      items.forEach(it=>{
        const parts = it.split(/[,\s]+/).map(t=> t.trim()).filter(Boolean);
        if(parts.length < 2) return;
        const lat = parseCoord(parts[0]);
        const lng = parseCoord(parts[1]);
        if(Number.isFinite(lat) && Number.isFinite(lng) && validLat(lat) && validLng(lng)){
          puntos.push({lat, lng});
        }
      });
      return puntos;
    }
    function createFenceByCoords(){
      if (isDrawingFence){
        alert('Finaliza o cancela el dibujo de geocerca antes de crear por coordenadas.');
        return;
      }

      const ejemplo = "-1.2345,-78.5678; -1.2350,-78.5684; -1.2362,-78.5690";
      const raw = prompt(
        "Ingresa puntos en formato lat,lng separados por ';' o por saltos de línea.\n" +
        "Ejemplo:\n" + ejemplo
      );
      if(raw === null) return;

      const pts = parseLatLngList(raw);
      if(pts.length < 3){
        alert('Se requieren al menos 3 puntos válidos (lat,lng).');
        return;
      }

      pendingFenceCoords = pts;

      if(map){
        if(previewFenceLayer){ map.removeLayer(previewFenceLayer); previewFenceLayer = null; }
        previewFenceLayer = L.polygon(pts.map(p=> [p.lat, p.lng]), { dashArray: '4,4', weight: 2, fillOpacity: 0.1 }).addTo(map);
        try { map.fitBounds(previewFenceLayer.getBounds(), { padding: [20,20] }); } catch(e){}
      }

      const hint = document.getElementById('fenceNameHint');
      if (hint) hint.textContent = `Vértices: ${pts.length} puntos`;

      const input = document.getElementById('fenceNameInput');
      if (input) {
        input.value = `Geocerca ${new Date().toLocaleDateString()}`;
        const panel=document.getElementById('fenceNamePanel'); if(panel){ panel.classList.remove('hidden'); }
        input.focus(); input.select();
      }
    }
    function removePreviewFence(){
      if(previewFenceLayer){
        map.removeLayer(previewFenceLayer);
        previewFenceLayer = null;
      }
    }

    /* ========= Eliminar ========= */
    async function deleteSelectedFarm(){
      const sel=document.getElementById('farmSelect'); const id= sel ? sel.value : '';
      if(!id){ alert('No hay finca seleccionada.'); return; }
      const farmsCache = loadCache();
      const farm = farmsCache.find(f=> f.id===id); const name=(farm&&farm.name)||'Finca';
      if(!confirm(`¿Eliminar "${name}"? Esta acción no se puede deshacer.`)) return;

      if(id.indexOf('local-')===0){
        const updated=farmsCache.filter(f=> f.id!==id); saveCache(updated); renderFarmsFromCache(); return;
      }
      try{ await db.collection('farms').doc(id).delete(); }
      catch{ const updated=farmsCache.filter(f=> f.id!==id); saveCache(updated); renderFarmsFromCache(); }
    }

    function updateDeleteButtonState(){
      const sel=document.getElementById('farmSelect'); const btn=document.getElementById('deleteFarmBtn');
      if(!btn) return; btn.disabled = !(sel && sel.value);
    }

    async function deleteSelectedFence(){
      if(!selectedFenceId){
        alert('Primero selecciona una geocerca haciendo click sobre ella.');
        return;
      }

      const fencesCache = loadFenceCache();
      const gf = fencesCache.find(g=> g.id === selectedFenceId);
      const name = (gf && gf.name) ? gf.name : 'Geocerca';

      if(!confirm(`¿Eliminar "${name}"? Esta acción no se puede deshacer.`)) return;

      if(selectedFenceId.indexOf('localgf-')===0){
        const updated = fencesCache.filter(g=> g.id !== selectedFenceId);
        saveFenceCache(updated);
        if(geofenceLayers[selectedFenceId]){
          map.removeLayer(geofenceLayers[selectedFenceId]);
          delete geofenceLayers[selectedFenceId];
        }
        selectedFenceId = null;
        updateDeleteFenceButtonState();
        return;
      }

      try{
        await db.collection('geofences').doc(selectedFenceId).delete();
      }catch(err){
        console.warn('Fallo al eliminar en Firestore, limpiando localmente:', err);
        const updated = fencesCache.filter(g=> g.id !== selectedFenceId);
        saveFenceCache(updated);
        if(geofenceLayers[selectedFenceId]){
          map.removeLayer(geofenceLayers[selectedFenceId]);
          delete geofenceLayers[selectedFenceId];
        }
      }

      selectedFenceId = null;
      updateDeleteFenceButtonState();
    }

    function updateDeleteFenceButtonState(){
      const btn = document.getElementById('deleteFenceBtn');
      if(!btn) return;
      btn.disabled = !selectedFenceId;
    }

    /* ========= Control de coordenadas mouse ========= */
    function addMousePositionControl(){
      const MousePos=L.Control.extend({
        options:{position:'bottomleft'},
        onAdd:function(){ const d=L.DomUtil.create('div','mousepos-control'); d.innerHTML='Lat: — Lng: —'; this._div=d; return d; },
        update:function(lat,lng){ if(this._div){ this._div.innerHTML = (lat!=null&&lng!=null)?(`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`):'Lat: — Lng: —'; } }
      });
      const ctrl = new MousePos(); ctrl.addTo(map);
      map.on('mousemove', e=>ctrl.update(e.latlng.lat, e.latlng.lng));
      map.on('mouseout', ()=>ctrl.update(null,null));
    }

    /* ========= Acceso ========= */
    const ADMIN_CODE = "admin123";
    function doAdminLogin(){
      try{
        const inputEl = document.getElementById('adminCodeInput');
        const raw = inputEl ? String(inputEl.value || '') : '';
        const normalized = raw.trim().toLowerCase();
        if(normalized === ADMIN_CODE){
          const modal = document.getElementById('adminModal'); if(modal){ modal.classList.add("hidden"); }
          const app = document.getElementById('appContent'); if(app){ app.classList.remove("hidden"); }
          setTimeout(()=>{ initMap(); setTimeout(()=>{ if(map){ map.invalidateSize(); } }, 100); }, 100);
        }else{
          const em = document.getElementById('errorMessage'); if(em) em.style.display="block";
        }
      }catch(e){ console.error(e); }
    }

    /* ========= Listeners UI ========= */
    document.addEventListener("DOMContentLoaded",function(){
      const modal = document.getElementById('adminModal'); if(modal){ modal.classList.remove("hidden"); }

      const loginBtn = document.getElementById('adminLoginBtn'); if(loginBtn){ loginBtn.addEventListener("click", doAdminLogin); }
      const adminInput = document.getElementById('adminCodeInput');
      if(adminInput){
        adminInput.addEventListener("keypress", function(e){ if(e.key==="Enter") doAdminLogin(); });
        adminInput.addEventListener("keydown", function(e){ if(e.key==="Enter") doAdminLogin(); });
      }

      const sel=document.getElementById('farmSelect'); if(sel){ sel.addEventListener('change', updateDeleteButtonState); }

      const btnCreate=document.getElementById('createFarmBtn'); if(btnCreate){ btnCreate.addEventListener('click', createFarmAtCenter); }
      const btnDelete=document.getElementById('deleteFarmBtn'); if(btnDelete){ btnDelete.addEventListener('click', deleteSelectedFarm); }
      const btnCoords=document.getElementById('createByCoordsBtn'); if(btnCoords){ btnCoords.addEventListener('click', createFarmByCoords); }

      const b1=document.getElementById('startFenceBtn'); if(b1){ b1.addEventListener('click', startFenceDraw); }
      const b2=document.getElementById('finishFenceBtn'); if(b2){ b2.addEventListener('click', finishFenceDraw); }
      const b3=document.getElementById('cancelFenceBtn'); if(b3){ b3.addEventListener('click', cancelFenceDraw); }
      const fSave=document.getElementById('fenceNameSaveBtn'); if(fSave){ fSave.addEventListener('click', saveFenceName); }
      const fCancel=document.getElementById('fenceNameCancelBtn'); if(fCancel){ fCancel.addEventListener('click', cancelFenceName); }
      const fInput=document.getElementById('fenceNameInput'); if(fInput){ fInput.addEventListener('keypress', function(e){ if(e.key==='Enter'){ e.preventDefault(); saveFenceName(); } }); }

      const cBtn=document.getElementById('createFenceByCoordsBtn'); if(cBtn){ cBtn.addEventListener('click', createFenceByCoords); }
      if(fSave){ fSave.addEventListener('click', removePreviewFence); }
      if(fCancel){ fCancel.addEventListener('click', removePreviewFence); }

      const dFence=document.getElementById('deleteFenceBtn'); if(dFence){ dFence.addEventListener('click', deleteSelectedFence); }

      updateDeleteButtonState();
      updateDeleteFenceButtonState();
    });
  </script>
</body>
</html>

