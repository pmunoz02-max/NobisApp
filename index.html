<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NobisApp – Geocercas y Puntos</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f3f4f6;overflow-x:hidden}
    #map{height:60vh;border-radius:1rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    @media(max-width:768px){#map{height:50vh}}
    .tag{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .mousepos-control{background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .hidden{display:none !important}
  </style>
</head>
<body class="p-4 sm:p-8">

  <!-- ===== Acceso ===== -->
  <div id="adminModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input id="adminCodeInput" type="password" placeholder="Código de acceso" class="w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2">
      <p id="errorMessage" class="text-red-600 text-sm hidden">Código incorrecto. Usa <b>admin123</b>.</p>
      <button id="adminLoginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-3 rounded-lg">
        Acceder
      </button>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">

    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Geocercas y Puntos Geo-referenciados</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Leaflet + Firestore (caché local). <span class="tag">sin fincas</span></p>
    </header>

    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-3">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa</h2>
        <div class="ml-auto flex flex-wrap gap-2">
          <!-- Geocercas -->
          <button id="startFenceBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="hidden bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg">Finalizar geocerca</button>
          <button id="cancelFenceBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>

          <!-- Puntos -->
          <button id="newPointModeBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Nuevo punto</button>
          <button id="deletePointBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar punto</button>
        </div>
      </div>

      <!-- Panel de nombre para Puntos con datalist editable -->
      <div id="pointPanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3 bg-white">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del punto</label>
          <div class="flex gap-2 flex-wrap items-center">
            <input id="pointNameInput" list="pointNamesList" class="border rounded-md p-2 w-full sm:flex-1" placeholder="Ej.: Pozo N°1, Control 3, Oficina" />
            <datalist id="pointNamesList"></datalist>
            <button id="pointSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="pointCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">La lista es editable: escribe un nombre nuevo y quedará guardado para próximas veces.</p>
        </div>
      </div>

      <div id="map"></div>

      <!-- Explorador -->
      <div id="indexPanel" class="mt-4 grid md:grid-cols-2 gap-4">
        <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
          <div class="font-medium text-gray-700 mb-2">Puntos</div>
          <ul id="pointsList" class="divide-y divide-gray-100"></ul>
        </div>
        <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
          <div class="font-medium text-gray-700 mb-2">Geocercas</div>
          <ul id="fenceList" class="divide-y divide-gray-100"></ul>
        </div>
      </div>
    </div>

  </div>

  <!-- ===== Libs ===== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <script>
    /* ===== Acceso ===== */
    (function () {
      const ADMIN_CODE = "admin123";
      const $m = document.getElementById("adminModal");
      const $c = document.getElementById("appContent");
      const $i = document.getElementById("adminCodeInput");
      const $b = document.getElementById("adminLoginBtn");
      const $e = document.getElementById("errorMessage");
      function openApp(){ $m.classList.add("hidden"); $c.classList.remove("hidden"); if(!window.__map_initialized__) { window.__map_initialized__=true; setTimeout(()=>initMap(), 0);} }
      function check(){ if(($i.value||'').trim()===ADMIN_CODE){ sessionStorage.setItem('admin_ok','1'); openApp(); } else { $e.classList.remove('hidden'); $i.focus(); $i.select(); } }
      if(sessionStorage.getItem('admin_ok')==='1') openApp();
      $b.addEventListener('click', check); $i.addEventListener('keydown', ev=>{ if(ev.key==='Enter') check(); });
    })();

    /* ===== Firebase (demo) ===== */
    const firebaseConfig = { apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE", authDomain: "demo-finca-app.firebaseapp.com", projectId: "demo-finca-app", storageBucket: "demo-finca-app.appspot.com", messagingSenderId: "123456789012", appId: "1:123456789012:web:abcdef1234567890" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    firebase.auth().signInAnonymously();

    /* ===== Estado ===== */
    let map;
    const pointsMarkers={}, geofenceLayers={};
    let currentPoints=[], currentFences=[];
    let selectedPointId=null;

    const LS_POINTS='points_cache_v1';
    const LS_POINT_NAMES='point_names_v1';
    const LS_GF='geofences_cache_v1';
    const save=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
    const load=(k,def=[])=>{ try{ const v=JSON.parse(localStorage.getItem(k)||'null'); return v??def; }catch{ return def; } };

    /* ===== Mapa ===== */
    function initMap(){ 
      map=L.map('map',{center:[-1.83,-78.18],zoom:6});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

      addMousePos();
      currentPoints=load(LS_POINTS,[]);
      currentFences=load(LS_GF,[]);
      refreshPointNameOptions();
      renderPoints();
      renderGeofences();
      hookPointUI();
      hookFenceUI();
    }

    function addMousePos(){
      const MousePos=L.Control.extend({options:{position:'bottomleft'},onAdd:function(){const d=L.DomUtil.create('div','mousepos-control');d.innerHTML='Lat: — Lng: —';this._div=d;return d;},update:function(lat,lng){this._div.innerHTML=(lat!=null&&lng!=null)?`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`:'Lat: — Lng: —';}});
      const ctrl=new MousePos(); ctrl.addTo(map);
      map.on('mousemove',e=>ctrl.update(e.latlng.lat,e.latlng.lng));
      map.on('mouseout',()=>ctrl.update(null,null));
    }

    /* ===== Puntos ===== */
    function hookPointUI(){
      let newPointMode=false, pendingLatLng=null;
      const pointPanel=document.getElementById('pointPanel');
      const pointNameInput=document.getElementById('pointNameInput');

      document.getElementById('newPointModeBtn').addEventListener('click',()=>{ 
        newPointMode=true; pointPanel.classList.remove('hidden'); 
      });
      map.on('click',e=>{ if(newPointMode){ pendingLatLng=e.latlng; pointNameInput.focus(); }});
      document.getElementById('pointCancelBtn').addEventListener('click',()=>{ newPointMode=false; pendingLatLng=null; pointPanel.classList.add('hidden'); });
      document.getElementById('pointSaveBtn').addEventListener('click',()=>{ 
        const name=(pointNameInput.value||'').trim();
        if(!newPointMode||!pendingLatLng||!name) return alert('Selecciona ubicación (clic en el mapa) y escribe/elige un nombre.');
        const id='pt-'+Date.now();
        currentPoints.push({id,name,location:{lat:pendingLatLng.lat,lng:pendingLatLng.lng}});
        save(LS_POINTS,currentPoints);
        renderPoints();
        newPointMode=false; pendingLatLng=null; pointPanel.classList.add('hidden'); pointNameInput.value='';
      });

      document.getElementById('deletePointBtn').addEventListener('click',()=>{ 
        if(!selectedPointId) return;
        currentPoints=currentPoints.filter(p=>p.id!==selectedPointId);
        save(LS_POINTS,currentPoints);
        renderPoints(); selectedPointId=null;
        document.getElementById('deletePointBtn').disabled=true;
      });
    }

    function refreshPointNameOptions(){
      const list=document.getElementById('pointNamesList');
      const names=load(LS_POINT_NAMES,["Pozo","Bodega","Punto de Control","Toma de agua","Oficina"]);
      list.innerHTML = names.map(n=>`<option value="${n}"></option>`).join('');
    }

    function renderPoints(){
      Object.values(pointsMarkers).forEach(m=>map.removeLayer(m));
      for(const k in pointsMarkers) delete pointsMarkers[k];
      currentPoints.forEach(p=>{
        const m=L.marker([p.location.lat,p.location.lng]).addTo(map);
        m.bindTooltip(p.name||'Punto',{permanent:true,direction:'right'});
        m.on('click',()=>{ selectedPointId=p.id; document.getElementById('deletePointBtn').disabled=false; });
        pointsMarkers[p.id]=m;
      });
      const ul=document.getElementById('pointsList');
      ul.innerHTML=currentPoints.length
        ? currentPoints.map(p=>`<li class="py-2">${p.name} <span class="text-xs text-gray-500">(${p.location.lat.toFixed(3)}, ${p.location.lng.toFixed(3)})</span></li>`).join('')
        : '<li class="py-2 text-sm text-gray-500">No hay puntos.</li>';
    }

    /* ===== Geocercas ===== */
    const GEOFENCE_STYLE={weight:2,fillOpacity:.15};
    let isDrawingFence=false, drawingCoords=[], drawingPolyline=null, drawingMarkers=[];

    function hookFenceUI(){
      document.getElementById('startFenceBtn').addEventListener('click', startFenceDraw);
      document.getElementById('finishFenceBtn').addEventListener('click', finishFenceDraw);
      document.getElementById('cancelFenceBtn').addEventListener('click', cancelFenceDraw);
      map.on('click', e=>{ if(isDrawingFence) addFenceVertex(e.latlng); });
    }

    function startFenceDraw(){ if(isDrawingFence) return; isDrawingFence=true; drawingCoords=[]; drawingMarkers.forEach(m=>map.removeLayer(m)); drawingMarkers=[]; if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; } document.getElementById('startFenceBtn').classList.add('hidden'); document.getElementById('finishFenceBtn').classList.remove('hidden'); document.getElementById('cancelFenceBtn').classList.remove('hidden'); }
    function finishFenceDraw(){ if(!isDrawingFence) return; if(drawingCoords.length<3){ alert('La geocerca necesita al menos 3 puntos.'); return; } const name=prompt('Nombre de la geocerca:'); if(!name) return; const id='gf-'+Date.now(); const fences=load(LS_GF,[]); fences.push({id,name,path:drawingCoords.slice()}); save(LS_GF,fences); currentFences=fences; renderGeofences(); cancelFenceDraw(); }
    function cancelFenceDraw(){ isDrawingFence=false; drawingCoords=[]; drawingMarkers.forEach(m=>map.removeLayer(m)); drawingMarkers=[]; if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; } document.getElementById('startFenceBtn').classList.remove('hidden'); document.getElementById('finishFenceBtn').classList.add('hidden'); document.getElementById('cancelFenceBtn').classList.add('hidden'); }
    function addFenceVertex(latlng){ drawingCoords.push({lat:latlng.lat,lng:latlng.lng}); const m=L.circleMarker(latlng,{radius:4,weight:2}).addTo(map); drawingMarkers.push(m); const latlngs=drawingCoords.map(p=>[p.lat,p.lng]); if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; } if(latlngs.length>=3) drawingPolyline=L.polygon(latlngs,{dashArray:'4,4',weight:2,fillOpacity:.1}).addTo(map); else if(latlngs.length>=2) drawingPolyline=L.polyline(latlngs,{dashArray:'4,4',weight:2}).addTo(map); }

    function renderGeofences(){
      Object.values(geofenceLayers).forEach(p=>map.removeLayer(p)); for(const k in geofenceLayers) delete geofenceLayers[k];
      const fences=load(LS_GF,[]);
      const ul=document.getElementById('fenceList');
      ul.innerHTML = fences.length
        ? fences.map(g=>`<li class="py-2">${g.name||'Geocerca'} <span class="text-xs text-gray-500">(${(g.path||[]).length} pts)</span></li>`).join('')
        : '<li class="py-2 text-sm text-gray-500">No hay geocercas.</li>';
      fences.forEach(g=>{ if(!Array.isArray(g.path)||g.path.length<3) return; const latlngs=g.path.map(p=>[p.lat,p.lng]); const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map); geofenceLayers[g.id]=poly; });
    }
  </script>
</body>
</html>
