<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geocercas (Nobis)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js para reportes -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; }
    .app { display:grid; grid-template-columns:320px 1fr; height:100vh; }
    .sidebar { background:#f9fafb; border-right:1px solid #ddd; padding:8px; overflow-y:auto; }
    .sidebar h3 { margin-top:16px; margin-bottom:6px; font-size:14px; color:#111; }
    button { margin:2px 0; padding:4px 6px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; font-size:12px; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #map { width:100%; height:100%; }
    #coords { font-size:12px; color:#333; padding:4px; }
    ul { margin:4px 0; padding-left:18px; }
    .person-row, .activity-row, .cost-row { font-size:13px; margin:4px 0; padding:4px; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .person-form { background:#eef; padding:6px; margin:6px 0; border-radius:4px; }
    .person-form input, .person-form select { margin:2px 0; width:100%; padding:4px; font-size:12px; }
    table { border-collapse: collapse; width:100%; margin-top:10px; font-size:13px; }
    table, th, td { border:1px solid #ccc; padding:4px; }
    th { background:#eee; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h3>Acciones</h3>
      <button id="newBtn">Nueva geocerca</button>
      <button id="finishBtn" disabled>Finalizar</button>
      <button id="cancelBtn" disabled>Cancelar</button>
      <button id="renameBtn" disabled>Renombrar</button>
      <button id="deleteBtn" disabled>Eliminar</button>
      <button id="exportBtn">Exportar GeoJSON</button>
      <input type="file" id="importInput" accept=".geojson,.json"/>

      <h3>Geocercas</h3>
      <ul id="fenceList"></ul>

      <h3>Gestión de Personal</h3>
      <button id="newPersonBtn">Nuevo trabajador</button>
      <button id="assignPersonBtn">Asignar a geocerca</button>
      <button id="listPersonBtn">Ver personal asignado</button>
      <button id="globalPersonBtn">Ver todos los trabajadores</button>

      <h3>Gestión de Actividades</h3>
      <button id="activityBtn">Gestionar actividades</button>

      <h3>Gestión de Costos</h3>
      <button id="costBtn">Gestionar costos</button>

      <h3>Reportes</h3>
      <button id="reportBtn">Generar reportes</button>

      <div id="personList" style="margin-top:8px; font-size:13px; color:#374151;"></div>
    </div>

    <div>
      <div id="map"></div>
      <div id="coords">Lat: -, Lng: -</div>
    </div>
  </div>

<script>
let map, group;
let fences=[];
let personnel=[]; 
let activeId=null;
let drawing=false;
let tempPoints=[]; 
let tempLine=null, tempPoly=null;
let actividadesDisponibles=["Riego","Poda","Fertilización"];

// === Persistencia ===
function saveToStorage(){
  let cleanFences = fences.map(f=>({
    id: f.id,
    name: f.name,
    latlngs: f.latlngs.map(p=>({lat:p.lat, lng:p.lng})),
    asignaciones: f.asignaciones || [],
    actividades: f.actividades || [],
    costos: f.costos || []
  }));
  localStorage.setItem("geocercas", JSON.stringify(cleanFences));
  localStorage.setItem("personnel", JSON.stringify(personnel));
  localStorage.setItem("actividadesDisponibles", JSON.stringify(actividadesDisponibles));
}
function loadFromStorage(){
  let rawF=localStorage.getItem("geocercas");
  if(rawF){
    fences=JSON.parse(rawF).map(f=>({
      ...f,
      latlngs: f.latlngs.map(p=>({lat:p.lat, lng:p.lng})),
      asignaciones: f.asignaciones || [],
      actividades: f.actividades || [],
      costos: f.costos || []
    }));
  }
  let rawP=localStorage.getItem("personnel");
  if(rawP){ personnel=JSON.parse(rawP); }
  let rawA=localStorage.getItem("actividadesDisponibles");
  if(rawA){ actividadesDisponibles=JSON.parse(rawA); }
}

// === Inicializar mapa (igual que antes) ===
function initMap(){
  map=L.map('map').setView([-1.73,-77.91],14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);
  group=L.layerGroup().addTo(map);
  map.on("mousemove",e=>{
    document.getElementById("coords").textContent=`Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`;
  });
  loadFromStorage();
  drawAll();
}

// === Dibujar geocercas (igual que antes) ===
function drawAll(){
  group.clearLayers();
  fences.forEach(f=>{
    let poly=L.polygon(f.latlngs,{color:'#6b21a8',weight:2,fillOpacity:0.3}).addTo(group);
    poly.bindTooltip(f.name,{permanent:true,direction:"center"});
    poly.on("click",()=>{ activeId=f.id; renderList(); });
    f.__layer=poly;
  });
  renderList();
}
function renderList(){
  let ul=document.getElementById("fenceList");
  ul.innerHTML="";
  fences.forEach(f=>{
    let li=document.createElement("li");
    li.textContent=f.name;
    li.style.cursor="pointer";
    li.onclick=()=>{ activeId=f.id; drawAll(); };
    if(f.id===activeId) li.style.fontWeight="bold";
    ul.appendChild(li);
  });
}

// === Módulo de reportes ===
document.getElementById("reportBtn").onclick=()=>{
  renderReportes();
};

function renderReportes(){
  let div=document.getElementById("personList");
  div.innerHTML="<h4>Generador de Reportes</h4>";

  if(!fences.length){ div.innerHTML+="<p>(No hay datos)</p>"; return; }

  // Filtros
  let geocOpts=fences.map(f=>`<option value="${f.id}">${f.name}</option>`).join("");
  let persOpts=personnel.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
  let actOpts=actividadesDisponibles.map(a=>`<option value="${a}">${a}</option>`).join("");
  let form=document.createElement("div");
  form.className="person-form";
  form.innerHTML=`
    <label>Geocercas:<br><select id="repGeoc" multiple>${geocOpts}</select></label><br>
    <label>Personas:<br><select id="repPers" multiple>${persOpts}</select></label><br>
    <label>Actividades:<br><select id="repActs" multiple>${actOpts}</select></label><br>
    <label>Desde: <input type="date" id="repDesde"></label><br>
    <label>Hasta: <input type="date" id="repHasta"></label><br>
    <label>Salida:
      <select id="repTipo">
        <option value="tabla">Tabla</option>
        <option value="bar">Gráfico de barras</option>
        <option value="pie">Gráfico de torta</option>
        <option value="line">Gráfico de líneas</option>
      </select>
    </label><br>
    <button id="genRepBtn">Generar</button>
    <button id="expRepBtn">Exportar CSV</button>
  `;
  div.appendChild(form);

  // Contenedor resultados
  let cont=document.createElement("div");
  cont.id="repResultados";
  div.appendChild(cont);

  document.getElementById("genRepBtn").onclick=()=>{
    generarReporte();
  };
  document.getElementById("expRepBtn").onclick=()=>{
    exportarReporteCSV();
  };
}

function generarReporte(){
  let geocSel=Array.from(document.getElementById("repGeoc").selectedOptions).map(o=>o.value);
  let persSel=Array.from(document.getElementById("repPers").selectedOptions).map(o=>o.value);
  let actSel=Array.from(document.getElementById("repActs").selectedOptions).map(o=>o.value);
  let desde=document.getElementById("repDesde").value;
  let hasta=document.getElementById("repHasta").value;
  let tipo=document.getElementById("repTipo").value;

  // Filtrar datos
  let rows=[];
  fences.filter(f=>!geocSel.length || geocSel.includes(f.id)).forEach(f=>{
    (f.costos||[]).forEach(c=>{
      if(persSel.length && !persSel.includes(c.pid)) return;
      if(actSel.length && !actSel.includes(c.actividad)) return;
      if(desde && c.desde && c.desde<desde) return;
      if(hasta && c.hasta && c.hasta>hasta) return;
      let pers=personnel.find(p=>p.id===c.pid);
      rows.push({
        geocerca:f.name,
        persona:pers?pers.nombre:"[Desconocido]",
        actividad:c.actividad,
        costoDia:c.costoDia,
        desde:c.desde||"",
        hasta:c.hasta||""
      });
    });
  });

  let cont=document.getElementById("repResultados");
  cont.innerHTML="";

  if(!rows.length){ cont.innerHTML="<p>(Sin resultados)</p>"; return; }

  if(tipo==="tabla"){
    let table=document.createElement("table");
    table.innerHTML="<tr><th>Geocerca</th><th>Persona</th><th>Actividad</th><th>Costo/día</th><th>Desde</th><th>Hasta</th></tr>";
    rows.forEach(r=>{
      table.innerHTML+=`<tr><td>${r.geocerca}</td><td>${r.persona}</td><td>${r.actividad}</td><td>$${r.costoDia}</td><td>${r.desde}</td><td>${r.hasta}</td></tr>`;
    });
    cont.appendChild(table);
  } else {
    let canvas=document.createElement("canvas");
    cont.appendChild(canvas);
    let labels=rows.map(r=>r.persona+"-"+r.actividad);
    let data=rows.map(r=>r.costoDia);
    new Chart(canvas,{
      type:tipo,
      data:{ labels, datasets:[{label:"Costo/día", data}] },
      options:{ responsive:true, plugins:{legend:{display:true}} }
    });
  }

  // Guardar datos de último reporte
  window.__lastReport=rows;
}

function exportarReporteCSV(){
  let rows=window.__lastReport||[];
  if(!rows.length){ alert("Genera primero un reporte"); return; }
  let csv="Geocerca,Persona,Actividad,CostoDia,Desde,Hasta\n";
  rows.forEach(r=>{
    csv+=`${r.geocerca},${r.persona},${r.actividad},${r.costoDia},${r.desde},${r.hasta}\n`;
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="reporte.csv";
  a.click();
}

initMap();
</script>
</body>
</html>

