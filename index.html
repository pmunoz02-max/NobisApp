<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geocercas</title>

  <!-- Leaflet (CSS + JS) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-o9N1j7kG1G8zS2f6sQPFfCjPZQ+1QttYvVQ4JQ1gITk="
          crossorigin=""></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#f6f7fb;color:#111827;
      display:flex;flex-direction:column;
    }
    header{
      background:#111827;color:#fff;padding:12px 16px;font-weight:600;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .userbar{display:flex;align-items:center;gap:8px;font-weight:500}
    .userbar small{opacity:.85;font-weight:400}
    .userbar button{
      padding:6px 8px;border:1px solid #374151;background:#1f2937;color:#fff;
      border-radius:8px;font-size:12px;cursor:pointer
    }
    .userbar button:hover{background:#111827}

    .app{display:grid;grid-template-columns:320px 1fr;flex:1; height:calc(100vh - 56px)}
    main{height:100%}
    .sidebar{background:#fff;border-right:1px solid #e5e7eb;overflow:auto}
    .section{padding:12px;border-bottom:1px solid #eef0f3}
    .section h2{margin:0 0 8px;font-size:13px;color:#374151;text-transform:uppercase;letter-spacing:.04em}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    button{padding:8px 10px;border:1px solid #e5e7eb;background:#fff;border-radius:8px;font-size:12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{background:#4f46e5;border-color:#4338ca;color:#fff}
    .danger{background:#ef4444;border-color:#dc2626;color:#fff}
    .list{list-style:none;margin:0;padding:0;max-height:220px;overflow:auto;border:1px solid #eef0f3;border-radius:8px}
    .list li{padding:8px 10px;border-bottom:1px solid #f2f3f6;cursor:pointer}
    .list li:last-child{border-bottom:0}
    .hint{font-size:12px;color:#6b7280}
    .namebar{display:none;gap:6px}
    .namebar input{flex:1;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
    .map{height:100%;width:100%}
    .label-in-map{background:rgba(255,255,255,.7);border:0;box-shadow:none;color:#111827;font-weight:600}
  </style>
</head>
<body>
  <header>
    <div>Geocercas</div>
    <div id="userBar" class="userbar">
      <small>Usuario:</small>
      <span id="currentUserName">—</span>
      <button id="btnSwitchUser">Cambiar de usuario</button>
      <button id="btnLogout">Salir</button>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="section">
        <h2>Acciones</h2>
        <div class="controls">
          <button id="newFenceBtn">Nueva</button>
          <button id="finishFenceBtn" class="primary" disabled>Finalizar</button>
          <button id="cancelFenceBtn" disabled>Cancelar</button>
          <button id="editFenceBtn" disabled>Editar</button>
          <button id="saveFenceEditBtn" class="primary" disabled>Guardar cambios</button>
          <button id="cancelFenceEditBtn" disabled>Cancelar edición</button>
          <button id="renameFenceBtn" disabled>Renombrar</button>
          <button id="deleteFenceBtn" class="danger" disabled>Eliminar</button>
          <button id="createFenceByCoordsBtn">Geocerca (Lat/Lng)</button>
          <button id="exportGeoJsonBtn">Exportar GeoJSON</button>
          <label style="display:inline-block">
            <input id="importGeoJsonInput" type="file" accept=".geojson,.json,application/geo+json,application/json" />
          </label>
        </div>
      </div>

      <div class="section">
        <h2>Geocercas</h2>
        <ul id="fenceList" class="list"></ul>
        <p class="hint" style="margin-top:8px">
          • Dibujo: clics en el mapa → "Finalizar".<br>
          • Edición: selecciona → "Editar", arrastra vértices → "Guardar cambios".<br>
          • También puedes crear por coordenadas con "Geocerca (Lat/Lng)".
        </p>
      </div>

      <div id="nameBar" class="section namebar">
        <input id="nameField" type="text" placeholder="Nombre de la geocerca">
        <button id="saveNameBtn" class="primary">Guardar</button>
        <button id="cancelNameBtn">Cancelar</button>
      </div>
    </aside>

    <!-- Mapa -->
    <main>
      <div id="map" class="map"></div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    /* =======================
       MÓDULO DE ACCESO / USERS
       ======================= */
    var USERS_KEY = 'NobisApp_users';
    var CURR_KEY  = 'NobisApp_current_user';
    var STORAGE_BASE = 'NobisApp_fences_';

    function uid(){ return 'f_' + Math.random().toString(36).slice(2,10); }
    function nowName(){ return 'Geocerca ' + (new Date().getTime()%1000); }
    function $(id){ return document.getElementById(id); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];}); }

    function loadUsers(){
      try{ var a=JSON.parse(localStorage.getItem(USERS_KEY)||'[]'); return (a && typeof a.length==='number')?a:[]; }
      catch(_){ return []; }
    }
    function saveUsers(arr){ try{ localStorage.setItem(USERS_KEY, JSON.stringify(arr||[])); }catch(_){} }

    function ensureOwner(){
      var users = loadUsers();
      if (!users || !users.length) {
        users = [{ id:'owner', name:'Dueño', role:'owner' }];
        saveUsers(users);
      }
      if (!localStorage.getItem(CURR_KEY)) {
        localStorage.setItem(CURR_KEY, users[0].id);
      }
      return users;
    }

    function currentUserId(){ return localStorage.getItem(CURR_KEY) || 'owner'; }
    function findUser(id){
      var us = loadUsers();
      for (var i=0;i<us.length;i++) if (us[i].id===id) return us[i];
      return null;
    }

    function setCurrentUser(id){
      localStorage.setItem(CURR_KEY, id);
      // Recargar para reconfigurar STORAGE_KEY y UI
      location.reload();
    }

    function promptSwitchUser(){
      var users = loadUsers();
      var lines = ['Selecciona usuario existente o crea uno nuevo:',
                   ''];
      for (var i=0;i<users.length;i++){
        lines.push((i+1)+') '+users[i].name+'  ['+users[i].role+']');
      }
      lines.push('');
      lines.push('N) Nuevo admin');
      lines.push('P) Nuevo personal');
      lines.push('');
      lines.push('Ingresa el número, o N/P:');
      var ans = prompt(lines.join('\n'));
      if (ans===null) return;

      ans = String(ans).trim().toUpperCase();
      if (/^\d+$/.test(ans)) {
        var idx = parseInt(ans,10)-1;
        if (idx>=0 && idx<users.length) {
          setCurrentUser(users[idx].id);
        }
        return;
      }
      if (ans==='N' || ans==='P') {
        var name = prompt('Nombre del nuevo '+(ans==='N'?'admin':'personal')+':');
        if (name===null) return;
        name = (name||'').trim();
        if (!name) return;
        var id = name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '-' + Math.random().toString(36).slice(2,6);
        var role = (ans==='N' ? 'admin' : 'staff');
        users.push({id:id, name:name, role:role});
        saveUsers(users);
        // Arranca con base vacía por diseño (no hay que hacer nada más).
        setCurrentUser(id);
      }
    }

    function doLogout(){
      // Por simplicidad, "Salir" te lleva al selector (no dejamos sin usuario).
      promptSwitchUser();
    }

    // Inicializa usuarios
    ensureOwner();
    var CURRENT_USER_ID = currentUserId();
    var CURRENT_USER = findUser(CURRENT_USER_ID) || {id:'owner', name:'Dueño', role:'owner'};

    // Escribe user en header
    var userNameSpan = $('currentUserName');
    if (userNameSpan) userNameSpan.textContent = CURRENT_USER.name + ' ('+CURRENT_USER.role+')';
    $('btnSwitchUser').onclick = promptSwitchUser;
    $('btnLogout').onclick = doLogout;

    /* =======================
       STORAGE por USUARIO
       ======================= */
    var STORAGE_KEY = STORAGE_BASE + CURRENT_USER_ID; // <- per-user

    function readFences(){
      try{ var a=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); return (a && typeof a.length==='number')?a:[]; }
      catch(_){ return []; }
    }
    function writeFences(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr||[])); }catch(_){} }

    /* =======================
       APP DE GEOCERCAS (igual que antes)
       ======================= */
    var map, group, activeId=null;
    var drawing=false, editing=false;
    var tmpMarkers=[], tmpPolyline=null, tmpPoly=null;
    var editMarkers=[], editBackup=null;

    var UI = {
      newBtn: $('newFenceBtn'),
      finBtn: $('finishFenceBtn'),
      cancelBtn: $('cancelFenceBtn'),
      editBtn: $('editFenceBtn'),
      saveEditBtn: $('saveFenceEditBtn'),
      cancelEditBtn: $('cancelFenceEditBtn'),
      renameBtn: $('renameFenceBtn'),
      delBtn: $('deleteFenceBtn'),
      byCoordsBtn: $('createFenceByCoordsBtn'),
      exportBtn: $('exportGeoJsonBtn'),
      importInput: $('importGeoJsonInput'),
      list: $('fenceList'),
      nameBar: $('nameBar'),
      nameField: $('nameField'),
      saveNameBtn: $('saveNameBtn'),
      cancelNameBtn: $('cancelNameBtn')
    };

    function enable(n,on){ if(n) n.disabled=!on; }
    function showNameBar(on){ if(UI.nameBar) UI.nameBar.style.display = on ? 'flex' : 'none'; }

    function applyRolePermissions(){
      var isStaff = (CURRENT_USER.role === 'staff');
      // Staff: solo lectura
      var createBtns = [UI.newBtn, UI.finBtn, UI.cancelBtn, UI.byCoordsBtn];
      var editBtns   = [UI.editBtn, UI.saveEditBtn, UI.cancelEditBtn, UI.renameBtn, UI.delBtn];
      var ioBtns     = [UI.exportBtn, UI.importInput];

      for (var i=0;i<createBtns.length;i++){ if (createBtns[i]) createBtns[i].disabled = isStaff; }
      for (var j=0;j<editBtns.length;j++){ if (editBtns[j]) editBtns[j].disabled = isStaff; }
      for (var k=0;k<ioBtns.length;k++){
        if (ioBtns[k]){
          if (ioBtns[k].tagName==='INPUT') ioBtns[k].disabled = isStaff;
          else ioBtns[k].disabled = isStaff;
        }
      }
    }

    function setIdle(){
      drawing=false; editing=false;
      enable(UI.newBtn,true);
      enable(UI.finBtn,false);
      enable(UI.cancelBtn,false);
      enable(UI.editBtn, !!activeId);
      enable(UI.saveEditBtn,false);
      enable(UI.cancelEditBtn,false);
      enable(UI.renameBtn, !!activeId);
      enable(UI.delBtn, !!activeId);
      showNameBar(false);
      applyRolePermissions();
    }
    function setDrawing(){
      drawing=true; editing=false;
      enable(UI.newBtn,false);
      enable(UI.finBtn,false);
      enable(UI.cancelBtn,true);
      enable(UI.editBtn,false);
      enable(UI.saveEditBtn,false);
      enable(UI.cancelEditBtn,false);
      enable(UI.renameBtn,false);
      enable(UI.delBtn,false);
      showNameBar(false);
      applyRolePermissions();
    }
    function setEditing(){
      drawing=false; editing=true;
      enable(UI.newBtn,false);
      enable(UI.finBtn,false);
      enable(UI.cancelBtn,false);
      enable(UI.editBtn,false);
      enable(UI.saveEditBtn,true);
      enable(UI.cancelEditBtn,true);
      enable(UI.renameBtn,false);
      enable(UI.delBtn,false);
      showNameBar(false);
      applyRolePermissions();
    }

    // ===== Inicializar mapa =====
    function initMap(){
      map = L.map('map').setView([-1.7307, -77.9122], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      group = L.layerGroup().addTo(map);

      // Wiring UI
      UI.newBtn.onclick = startDrawing;
      UI.finBtn.onclick = finalizeDrawing;
      UI.cancelBtn.onclick = cancelDrawing;
      UI.editBtn.onclick = enterEdit;
      UI.saveEditBtn.onclick = saveEdit;
      UI.cancelEditBtn.onclick = function(){ exitEdit(false); };
      UI.renameBtn.onclick = renameFence;
      UI.delBtn.onclick = deleteFence;
      UI.byCoordsBtn.onclick = createByCoords;
      UI.exportBtn.onclick = exportGeo;
      UI.importInput.onchange = importGeo;

      drawAll();
      setIdle();
    }

    // ===== Dibujo temporal =====
    function clearTemp(){
      for(var i=0;i<tmpMarkers.length;i++){ map.removeLayer(tmpMarkers[i]); }
      tmpMarkers=[]; if(tmpPolyline){ map.removeLayer(tmpPolyline); tmpPolyline=null; }
      if(tmpPoly){ map.removeLayer(tmpPoly); tmpPoly=null; }
    }
    function onMapClickAdd(e){
      if(!drawing) return;
      var m=L.circleMarker(e.latlng,{radius:5,color:'#6366f1',fillColor:'#818cf8',fillOpacity:1}).addTo(map);
      tmpMarkers.push(m);
      var pts=[],i; for(i=0;i<tmpMarkers.length;i++){ pts.push(tmpMarkers[i].getLatLng()); }
      if(tmpPolyline) tmpPolyline.setLatLngs(pts); else tmpPolyline=L.polyline(pts,{color:'#6366f1',dashArray:'4 4'}).addTo(map);
      if(pts.length>=3){
        enable(UI.finBtn,true);
        if(tmpPoly) tmpPoly.setLatLngs(pts); else tmpPoly=L.polygon(pts,{color:'#a78bfa',weight:2,fillOpacity:.12}).addTo(map);
      }
    }
    function startDrawing(){
      if(editing){ alert('Termina/cancela la edición primero.'); return; }
      clearTemp(); setDrawing();
      map.on('click', onMapClickAdd);
    }
    function cancelDrawing(){ map.off('click',onMapClickAdd); clearTemp(); setIdle(); }
    function finalizeDrawing(){
      var pts=[],i; for(i=0;i<tmpMarkers.length;i++){ pts.push(tmpMarkers[i].getLatLng()); }
      if(pts.length<3){ alert('Agrega al menos 3 puntos.'); return; }
      showNameBar(true); UI.nameField.focus();

      function doSave(){
        var name=(UI.nameField.value||'').trim()||nowName();
        var arr=readFences(); var id=uid();
        var latlngs=[],k; for(k=0;k<pts.length;k++){ latlngs.push({lat:pts[k].lat,lng:pts[k].lng}); }
        arr.push({id:id,name:name,latlngs:latlngs}); writeFences(arr);
        map.off('click',onMapClickAdd); clearTemp(); showNameBar(false); UI.nameField.value='';
        activeId=id; drawAll(); zoomToActive(); setIdle();
      }
      UI.saveNameBtn.onclick=doSave;
      UI.nameField.onkeydown=function(ev){ if(ev.key==='Enter') doSave(); };
      UI.cancelNameBtn.onclick=function(){ showNameBar(false); };
    }

    // ===== Render geocercas =====
    function drawAll(){
      group.clearLayers();
      var arr=readFences();
      for(var i=0;i<arr.length;i++){
        (function(f){
          var poly=L.polygon(f.latlngs,{color:'#7c3aed',weight:3,fillOpacity:.2}).addTo(group);
          try{ poly.bindTooltip(f.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});}catch(_){}
          f.__layer=poly;
          poly.on('click',function(){ activeId=f.id; renderList(); zoomToActive(); setIdle(); });
        })(arr[i]);
      }
      renderList();
    }
    function renderList(){
      var arr=readFences(); if(!UI.list) return;
      if(!arr.length){ UI.list.innerHTML='<li style="text-align:center;color:#6b7280;padding:10px">No hay geocercas.</li>'; return; }
      var html='',i; for(i=0;i<arr.length;i++){
        html+='<li data-id="'+arr[i].id+'"><div style="font-weight:600;font-size:13px;">'+escapeHtml(arr[i].name)+'</div>'+
              '<div class="hint">'+arr[i].latlngs.length+' puntos</div></li>';
      }
      UI.list.innerHTML=html;
      var items=UI.list.querySelectorAll('[data-id]');
      for(i=0;i<items.length;i++){
        items[i].onclick=(function(id){return function(){ activeId=id; zoomToActive(); setIdle(); drawAll(); };})(items[i].getAttribute('data-id'));
      }
      // Permisos pueden deshabilitar botones aunque haya selección
      applyRolePermissions();
    }
    function zoomToActive(){
      var f=findActive(); if(f && f.__layer){ try{ map.fitBounds(f.__layer.getBounds(),{padding:[24,24]}); }catch(_){ } }
    }
    function findActive(){
      var arr=readFences(); for(var i=0;i<arr.length;i++){ if(arr[i].id===activeId) return arr[i]; } return null;
    }

    // ===== Edición =====
    function enterEdit(){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede editar.'); return; }
      if(!activeId){ alert('Selecciona una geocerca.'); return; }
      var f=findActive(); if(!f || !f.__layer) return;
      setEditing();
      var lls=f.__layer.getLatLngs(); lls=lls && lls[0]? lls[0] : lls;
      editBackup=[]; editMarkers=[];
      for(var i=0;i<lls.length;i++){
        editBackup.push(L.latLng(lls[i].lat,lls[i].lng));
        (function(idx){
          var m=L.marker(lls[idx],{draggable:true,title:'Arrastra'}).addTo(map);
          m.on('drag',function(){ 
            var cur=[],j; for(j=0;j<editMarkers.length;j++){ cur.push(editMarkers[j].getLatLng()); }
            f.__layer.setLatLngs([cur]);
          });
          editMarkers.push(m);
        })(i);
      }
    }
    function saveEdit(){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede editar.'); return; }
      if(!activeId) return;
      var f=findActive(); if(!f || !f.__layer) return;
      var cur=[],i; for(i=0;i<editMarkers.length;i++){ cur.push(editMarkers[i].getLatLng()); }
      if(cur.length<3){ alert('Mínimo 3 vértices.'); return; }
      var arr=readFences(); for(i=0;i<arr.length;i++){ if(arr[i].id===activeId){ 
        var pts=[],k; for(k=0;k<cur.length;k++){ pts.push({lat:cur[k].lat,lng:cur[k].lng}); }
        arr[i].latlngs=pts; break;
      }}
      writeFences(arr); exitEdit(true);
    }
    function exitEdit(redraw){
      for(var i=0;i<editMarkers.length;i++){ map.removeLayer(editMarkers[i]); }
      editMarkers=[]; editBackup=null; setIdle(); if(redraw) drawAll();
    }

    // ===== CRUD =====
    function renameFence(){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede renombrar.'); return; }
      if(!activeId) return;
      var arr=readFences(),i,f=null; for(i=0;i<arr.length;i++){ if(arr[i].id===activeId){ f=arr[i]; break; } }
      if(!f) return;
      var nn=prompt('Nuevo nombre:', f.name||''); if(nn===null) return; nn=(nn||'').trim(); if(!nn) return;
      f.name=nn; writeFences(arr); drawAll();
    }
    function deleteFence(){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede eliminar.'); return; }
      if(!activeId) return;
      var arr=readFences(),i,f=null; for(i=0;i<arr.length;i++){ if(arr[i].id===activeId){ f=arr[i]; break; } }
      if(!f) return;
      if(!confirm('Eliminar "'+(f.name||'Geocerca')+'"?')) return;
      var out=[]; for(i=0;i<arr.length;i++){ if(arr[i].id!==activeId) out.push(arr[i]); }
      writeFences(out); activeId=null; drawAll(); setIdle();
    }

    // ===== Crear por Lat/Lng =====
    function parseLatLngMultiline(text){
      var pts=[]; if(!text) return pts;
      var segments=String(text).split(/[;\r\n]+/);
      for(var i=0;i<segments.length;i++){
        var seg=(segments[i]||'').trim(); if(!seg) continue;
        var nums=seg.match(/[-+]?\d+(?:[.,]\d+)?/g); if(!nums || nums.length<2) continue;
        var a=parseFloat(String(nums[0]).replace(',', '.'));
        var b=parseFloat(String(nums[1]).replace(',', '.'));
        if(!isFinite(a)||!isFinite(b)) continue;
        var lat=a,lng=b; if(Math.abs(lat)>90||Math.abs(lng)>180){ lat=b; lng=a; }
        if(Math.abs(lat)<=90 && Math.abs(lng)<=180){ pts.push({lat:lat,lng:lng}); }
      }
      return pts;
    }
    function createByCoords(){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede crear geocercas.'); return; }
      var example="Pega coordenadas Lat,Lng (una por línea o separadas con ';'):\n"+
                  "-1.23456, -78.12345\n-1.23400 -78.12000\n"+
                  "-1,23456  -78,12345   (coma decimal)\n"+
                  "-78.12, -1.23         (lon,lat; se corrige)\n\n"+
                  "También en una sola línea separadas por ';':\n"+
                  "-1.7315,-77.9077; -1.7323,-77.9077; -1.7322,-77.9092";
      var raw=prompt(example); if(raw===null) return;
      var pts=parseLatLngMultiline(raw);
      if(!pts || pts.length<3){ alert('Se requieren al menos 3 coordenadas válidas (lat,lng).'); return; }
      var name=(prompt('Nombre de la geocerca:', nowName())||'').trim(); if(!name) name=nowName();
      var arr=readFences(); var id=uid(); arr.push({id:id,name:name,latlngs:pts}); writeFences(arr);
      activeId=id; drawAll(); zoomToActive(); setIdle();
    }

    // ===== Importar / Exportar =====
    function exportGeo(){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede exportar.'); return; }
      var fences=readFences(), fc={type:'FeatureCollection', features:[]};
      for(var i=0;i<fences.length;i++){
        var f=fences[i], coords=[],j;
        for(j=0;j<f.latlngs.length;j++){ coords.push([f.latlngs[j].lng,f.latlngs[j].lat]); }
        if(coords.length){ coords.push([coords[0][0],coords[0][1]]); }
        fc.features.push({type:'Feature',properties:{id:f.id,name:f.name},geometry:{type:'Polygon',coordinates:[coords]}});
      }
      var blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
      var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='geocercas.geojson'; a.click(); URL.revokeObjectURL(a.href);
    }
    function importGeo(e){
      if (CURRENT_USER.role==='staff'){ alert('El personal no puede importar.'); e.target.value=''; return; }
      var f=e.target.files && e.target.files[0]; if(!f) return;
      var reader=new FileReader();
      reader.onload=function(){
        try{
          var gj=JSON.parse(reader.result);
          var feats=gj.type==='FeatureCollection'?(gj.features||[]):(gj.type==='Feature'?[gj]:[]);
          var arr=readFences();
          for(var i=0;i<feats.length;i++){
            var ft=feats[i]; if(!ft.geometry || ft.geometry.type!=='Polygon') continue;
            var ring=(ft.geometry.coordinates && ft.geometry.coordinates[0])||[];
            var pts=[],k; for(k=0;k<ring.length-1;k++){ pts.push({lat:ring[k][1],lng:ring[k][0]}); }
            if(pts.length>=3) arr.push({id:uid(),name:(ft.properties&&ft.properties.name)||'Geocerca importada',latlngs:pts});
          }
          writeFences(arr); drawAll();
        }catch(_){ alert('GeoJSON inválido'); }
        e.target.value='';
      };
      reader.readAsText(f);
    }

    // Inicializar la aplicación
    initMap();
  });
  </script>
</body>
</html>
