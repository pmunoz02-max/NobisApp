<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geocercas (Nobis)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; }
    .app { display:grid; grid-template-columns:320px 1fr; height:100vh; }
    .sidebar { background:#f9fafb; border-right:1px solid #ddd; padding:8px; overflow-y:auto; }
    .sidebar h3 { margin-top:16px; margin-bottom:6px; font-size:14px; color:#111; }
    button { margin:2px 0; padding:4px 6px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; font-size:12px; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #map { width:100%; height:100%; }
    #coords { font-size:12px; color:#333; padding:4px; }
    ul { margin:4px 0; padding-left:18px; }
    .person-row { display:flex; justify-content:space-between; align-items:center; margin:2px 0; font-size:13px; }
    .person-form { background:#eef; padding:6px; margin:6px 0; border-radius:4px; }
    .person-form input, .person-form select { margin:2px 0; width:100%; padding:4px; font-size:12px; }
    .global-person { margin:6px 0; padding:6px; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .assignments { font-size:12px; margin-left:10px; color:#444; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h3>Acciones</h3>
      <button id="newBtn">Nueva geocerca</button>
      <button id="finishBtn" disabled>Finalizar</button>
      <button id="cancelBtn" disabled>Cancelar</button>
      <button id="renameBtn" disabled>Renombrar</button>
      <button id="deleteBtn" disabled>Eliminar</button>
      <button id="exportBtn">Exportar GeoJSON</button>
      <input type="file" id="importInput" accept=".geojson,.json"/>

      <h3>Geocercas</h3>
      <ul id="fenceList"></ul>

      <h3>Gestión de Personal</h3>
      <button id="newPersonBtn">Nuevo trabajador</button>
      <button id="assignPersonBtn">Asignar a geocerca</button>
      <button id="listPersonBtn">Ver personal asignado</button>
      <button id="globalPersonBtn">Ver todos los trabajadores</button>
      <div id="personList" style="margin-top:8px; font-size:13px; color:#374151;"></div>
    </div>

    <div>
      <div id="map"></div>
      <div id="coords">Lat: -, Lng: -</div>
    </div>
  </div>

<script>
let map, group;
let fences=[];
let personnel=[]; // lista global de trabajadores
let activeId=null;

let drawing=false;
let tempPoints=[]; 
let tempLine=null, tempPoly=null;

// === Persistencia ===
function saveToStorage(){
  let cleanFences = fences.map(f=>({
    id: f.id,
    name: f.name,
    latlngs: f.latlngs.map(p=>({lat:p.lat, lng:p.lng})),
    asignaciones: f.asignaciones || []
  }));
  localStorage.setItem("geocercas", JSON.stringify(cleanFences));
  localStorage.setItem("personnel", JSON.stringify(personnel));
}
function loadFromStorage(){
  let rawF=localStorage.getItem("geocercas");
  if(rawF){
    fences=JSON.parse(rawF).map(f=>({
      ...f,
      latlngs: f.latlngs.map(p=>({lat:p.lat, lng:p.lng})),
      asignaciones: f.asignaciones || []
    }));
  }
  let rawP=localStorage.getItem("personnel");
  if(rawP){ personnel=JSON.parse(rawP); }
}

// === Inicializar mapa ===
function initMap(){
  map=L.map('map').setView([-1.73,-77.91],14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);
  group=L.layerGroup().addTo(map);
  map.on("mousemove",e=>{
    document.getElementById("coords").textContent=`Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`;
  });
  loadFromStorage();
  drawAll();
}

// === Dibujar geocercas ===
function drawAll(){
  group.clearLayers();
  fences.forEach(f=>{
    let poly=L.polygon(f.latlngs,{color:'#6b21a8',weight:2,fillOpacity:0.3}).addTo(group);
    poly.bindTooltip(f.name,{permanent:true,direction:"center"});
    poly.on("click",()=>{ activeId=f.id; renderList(); });
    f.__layer=poly;
  });
  renderList();
}
function renderList(){
  let ul=document.getElementById("fenceList");
  ul.innerHTML="";
  fences.forEach(f=>{
    let li=document.createElement("li");
    li.textContent=f.name;
    li.style.cursor="pointer";
    li.onclick=()=>{ activeId=f.id; drawAll(); };
    if(f.id===activeId) li.style.fontWeight="bold";
    ul.appendChild(li);
  });
}

// === Crear geocercas manual ===
document.getElementById("newBtn").onclick=()=>{
  drawing=true; tempPoints=[]; 
  if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
  map.on("click",addTempPoint);
  document.getElementById("finishBtn").disabled=false;
  document.getElementById("cancelBtn").disabled=false;
};
function addTempPoint(e){
  tempPoints.push(e.latlng);
  if(tempLine){ tempLine.setLatLngs(tempPoints); }
  else{ tempLine=L.polyline(tempPoints,{color:"blue",dashArray:"5,5"}).addTo(map); }
  if(tempPoints.length>=3){
    if(tempPoly){ tempPoly.setLatLngs(tempPoints); }
    else{ tempPoly=L.polygon(tempPoints,{color:"blue",weight:1,fillOpacity:0.1}).addTo(map); }
  }
}
document.getElementById("finishBtn").onclick=()=>{
  if(tempPoints.length<3){ alert("Se requieren al menos 3 puntos."); return; }
  let name=prompt("Nombre de la geocerca:","Geocerca "+(fences.length+1));
  if(!name) return;
  let f={id:Date.now().toString(), name:name, latlngs:tempPoints, asignaciones:[]};
  fences.push(f);
  saveToStorage();
  map.off("click",addTempPoint);
  drawing=false; tempPoints=[]; 
  if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
  document.getElementById("finishBtn").disabled=true;
  document.getElementById("cancelBtn").disabled=true;
  drawAll();
};
document.getElementById("cancelBtn").onclick=()=>{
  drawing=false; tempPoints=[]; 
  if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
  map.off("click",addTempPoint);
  document.getElementById("finishBtn").disabled=true;
  document.getElementById("cancelBtn").disabled=true;
};

// === Gestión global de personal ===
document.getElementById("newPersonBtn").onclick=()=>{
  let nombre=prompt("Nombre del trabajador:");
  if(!nombre) return;
  let id=Date.now().toString();
  personnel.push({id, nombre});
  saveToStorage();
  alert("Trabajador creado: "+nombre);
};
document.getElementById("assignPersonBtn").onclick=()=>{
  let f=fences.find(x=>x.id===activeId);
  if(!f){ alert("Selecciona una geocerca activa."); return; }
  if(!personnel.length){ alert("No hay trabajadores registrados."); return; }
  let nombres=personnel.map((p,i)=>`${i+1}. ${p.nombre}`).join("\n");
  let idx=parseInt(prompt("Elige trabajador por número:\n"+nombres))-1;
  if(isNaN(idx) || idx<0 || idx>=personnel.length) return;
  let p=personnel[idx];
  f.asignaciones.push({pid:p.id, estado:"inactivo", desde:"", hasta:""});
  saveToStorage();
  renderAssigned(f);
};
document.getElementById("listPersonBtn").onclick=()=>{
  let f=fences.find(x=>x.id===activeId);
  if(!f){ alert("Selecciona una geocerca activa."); return; }
  renderAssigned(f);
};
document.getElementById("globalPersonBtn").onclick=()=>{
  renderGlobalPersonnel();
};

// === Renderizar asignaciones por geocerca ===
function renderAssigned(f){
  let div=document.getElementById("personList");
  div.innerHTML="";
  if(!f.asignaciones || !f.asignaciones.length){
    div.textContent="(Sin personal asignado)";
    return;
  }
  f.asignaciones.forEach((a,i)=>{
    let pers=personnel.find(pp=>pp.id===a.pid);
    let nombre=pers?pers.nombre:"[Desconocido]";
    let fechas = (a.desde && a.hasta) ? ` (${a.desde} → ${a.hasta})` : "";
    let row=document.createElement("div");
    row.className="person-row";
    row.innerHTML=`<span>${i+1}. ${nombre} → ${a.estado}${fechas}</span>`;
    let btn=document.createElement("button");
    btn.textContent="Editar";
    btn.onclick=()=>showStatusForm(f,i);
    row.appendChild(btn);
    div.appendChild(row);
  });
}

// === Formulario lateral para estado ===
function showStatusForm(f, idx){
  let div=document.getElementById("personList");
  let form=document.createElement("div");
  form.className="person-form";
  let a=f.asignaciones[idx];
  let pers=personnel.find(pp=>pp.id===a.pid);
  form.innerHTML=`
    <strong>${pers?pers.nombre:"[Desconocido]"}</strong><br>
    <label>Estado:
      <select id="estadoSel">
        <option value="activo" ${a.estado==="activo"?"selected":""}>Activo</option>
        <option value="inactivo" ${a.estado==="inactivo"?"selected":""}>Inactivo</option>
      </select>
    </label><br>
    <label>Desde: <input type="date" id="desdeInp" value="${a.desde||""}"></label><br>
    <label>Hasta: <input type="date" id="hastaInp" value="${a.hasta||""}"></label><br>
    <button id="saveStatusBtn">Guardar</button>
    <button id="cancelStatusBtn">Cancelar</button>
  `;
  div.appendChild(form);

  document.getElementById("saveStatusBtn").onclick=()=>{
    a.estado=document.getElementById("estadoSel").value;
    a.desde=document.getElementById("desdeInp").value;
    a.hasta=document.getElementById("hastaInp").value;
    saveToStorage();
    renderAssigned(f);
  };
  document.getElementById("cancelStatusBtn").onclick=()=>renderAssigned(f);
}

// === Vista global de personal ===
function renderGlobalPersonnel(){
  let div=document.getElementById("personList");
  div.innerHTML="<h4>Todo el personal registrado</h4>";
  if(!personnel.length){
    div.innerHTML+="<p>(No hay trabajadores registrados)</p>";
    return;
  }
  personnel.forEach(p=>{
    let cont=document.createElement("div");
    cont.className="global-person";
    cont.innerHTML=`<b>${p.nombre}</b>`;
    let asigns=[];
    fences.forEach(f=>{
      f.asignaciones.forEach(a=>{
        if(a.pid===p.id){
          asigns.push(`${f.name}: ${a.estado} (${a.desde||"-"} → ${a.hasta||"-"})`);
        }
      });
    });
    let list=document.createElement("div");
    list.className="assignments";
    list.innerHTML= asigns.length? asigns.join("<br>") : "(No asignado a ninguna geocerca)";
    cont.appendChild(list);
    div.appendChild(cont);
  });
}

initMap();
</script>
</body>
</html>



