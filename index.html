<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Personal de Finca (Leaflet + Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet core CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet.Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; overflow-x: hidden; }
    #map { height: 55vh; width: 100%; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,.1); z-index: 1; }
    @media (max-width: 768px) { #map { height: 45vh; } body { padding: 12px; } }
    #adminModal { z-index: 10000; }
    button, input, select, textarea { font-size: 16px; }
    .error-message { color: #dc2626; font-size: 14px; margin-top: 6px; display: none; }
    .farm-label { background: #ffffff; border: 1px solid rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); font-size: 12px; }
    .mousepos-control { background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 overflow-x-hidden">

  <!-- Modal admin -->
  <div id="adminModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input type="password" id="adminCodeInput" placeholder="Código de acceso"
             class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2"
             autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="text">
      <div id="errorMessage" class="error-message">Código incorrecto. Intenta con "admin123"</div>
      <!-- IMPORTANTE: id único para no chocar con el botón Agregar -->
      <button id="adminLoginBtn"
              class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 transition font-bold">
        Acceder
      </button>
    </div>
  </div>

  <!-- Contenido de la app -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">
    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Control de Personal y Geocercas</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Sincronizado con Firebase (Firestore) + respaldo local</p>
    </header>

    <!-- Selección de finca -->
    <div class="bg-white p-4 rounded-2xl shadow-lg">
      <div>
        <label class="block text-sm font-medium text-gray-700">Finca activa</label>
        <select id="farmSelect" class="mt-1 w-full border rounded-md p-2"></select>
      </div>
    </div>

    <!-- Mapa -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa de Fincas</h2>
        <div class="ml-auto flex flex-wrap gap-2">
          <button id="startFenceBtn" class="inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="hidden inline-flex items-center gap-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg">Finalizar geocerca</button>
          <button id="cancelFenceBtn" class="hidden inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>

          <button id="createFenceByCoordsBtn" class="inline-flex items-center gap-2 bg-sky-700 hover:bg-sky-800 text-white font-semibold px-4 py-2 rounded-lg">Geocerca (Lat/Lngs)</button>

          <button id="createFarmBtn" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca</button>
          <button id="createByCoordsBtn" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca (Lat/Lng)</button>
          <button id="deleteFarmBtn" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Eliminar finca</button>

          <button id="deleteFenceBtn" class="inline-flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Eliminar geocerca</button>
          <button id="editFenceBtn"   class="inline-flex items-center gap-2 bg-violet-600 hover:bg-violet-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn"   class="hidden inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar cambios</button>
          <button id="cancelFenceEditBtn" class="hidden inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar edición</button>

          <button id="exportGeoJSONBtn" class="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold px-4 py-2 rounded-lg">Exportar GeoJSON</button>
          <label class="inline-flex items-center gap-2 bg-teal-50 hover:bg-teal-100 text-teal-700 font-semibold px-4 py-2 rounded-lg cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJSONInput" type="file" accept=".geojson,application/geo+json,application/json" class="hidden">
          </label>
        </div>
      </div>

      <!-- Paneles auxiliares (sin cambios funcionales) -->
      <div id="coordsNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la nueva finca</label>
          <div class="flex gap-2">
            <input id="coordsNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Finca Palora Norte" />
            <button id="coordsNameSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="coordsNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="coordsNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <div id="fenceNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex gap-2">
            <input id="fenceNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Geocerca Lote 1" />
            <button id="fenceNameSaveBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="fenceNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="fenceNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <div id="map"></div>

      <!-- Explorador -->
      <div id="indexPanel" class="mt-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800">Explorador de elementos</h3>
          <span class="text-xs text-gray-500">Doble clic en un nombre para centrar/ajustar el mapa</span>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-2">
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Fincas</div>
            <ul id="farmList" class="divide-y divide-gray-100"></ul>
          </div>
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Geocercas</div>
            <ul id="fenceList" class="divide-y divide-gray-100"></ul>
          </div>
        </div>
      </div>

      <p id="statusMessage" class="mt-3 text-sm text-gray-600">
        Haz clic en el mapa para crear una nueva finca…
      </p>
    </div>

    <!-- ===================== Gestión de Personal ===================== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Gestión de Personal</h2>
        <span class="text-xs text-gray-500">Doble clic sobre una fila para ir a su asignación</span>
      </div>

      <!-- Fila de entrada -->
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre</label>
          <input id="pFirstName" type="text" class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Apellido</label>
          <input id="pLastName" type="text" class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Cédula</label>
          <input id="pIdNumber" type="text" class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Asignación</label>
          <select id="pAssignSelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
      </div>

      <div class="mt-3">
        <!-- Botón robusto: onclick directo + data-action -->
        <button id="addPersonBtn" type="button" data-action="add-person"
                onclick="window.__onAddPersonClick && window.__onAddPersonClick(event)"
                class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
          Agregar
        </button>
        <span id="pFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>

      <!-- Filtros -->
      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Buscar</label>
          <input id="pSearchInput" type="text" placeholder="Nombre, apellido o cédula"
                 class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo asignación</label>
          <select id="pTypeFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
            <option value="farm">Fincas</option>
            <option value="fence">Geocercas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Finca/Geocerca</label>
          <select id="pEntityFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">NOMBRE</th>
              <th class="px-3 py-2">APELLIDO</th>
              <th class="px-3 py-2">CÉDULA</th>
              <th class="px-3 py-2">ASIGNADO A</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="personnelTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    <!-- =================== FIN Gestión de Personal =================== -->
  </div>

  <!-- Leaflet core JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet.Draw JS -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <script>
    /* ------------- Firebase / estado / utilidades (sin cambios de lógica) ------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE",
      authDomain: "demo-finca-app.firebaseapp.com",
      projectId: "demo-finca-app",
      storageBucket: "demo-finca-app.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    try { db.settings({ experimentalForceLongPolling: true, experimentalAutoDetectLongPolling: true, useFetchStreams: false }); } catch {}
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (!isMobile) { db.enablePersistence({ synchronizeTabs: true }).catch(()=>{}); }
    let authReady = false;
    firebase.auth().signInAnonymously().catch(console.error);
    firebase.auth().onAuthStateChanged((user)=>{ authReady = !!user; });

    let map;
    const fincaMarkers = {};
    const geofenceLayers = {};
    const LS_KEY = 'fincas_cache_v1';
    const LS_GF  = 'geofences_cache_v1';
    const LS_PE  = 'personnel_cache_v1';

    let isDrawingFence = false, drawingCoords = [], drawingPolyline = null, drawingMarkers = [], pendingFenceCoords = null;
    let previewFenceLayer = null, selectedFenceId = null;

    const GEOFENCE_STYLE = {weight:2, fillOpacity:0.15};
    const GEOFENCE_SELECTED_STYLE = {weight:3, color:'#ef4444', fillOpacity:0.2};

    let currentFarms = [], currentFences = [], currentPersonnel = [];

    let isEditingFence = false, editBackupCoords = null, editGroup = null, editToolbar = null;

    const saveCache = farms => { try{ localStorage.setItem(LS_KEY, JSON.stringify(farms)); }catch{} };
    const loadCache = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } };
    const saveFenceCache = fences => { try{ localStorage.setItem(LS_GF, JSON.stringify(fences)); }catch{} };
    const loadFenceCache = () => { try{ return JSON.parse(localStorage.getItem(LS_GF)||'[]'); }catch{ return []; } };
    const savePersonnelCache = list => { try{ localStorage.setItem(LS_PE, JSON.stringify(list)); }catch{} };
    const loadPersonnelCache = () => { try{ return JSON.parse(localStorage.getItem(LS_PE)||'[]'); }catch{ return []; } };

    /* -------- Render de fincas / geocercas / mapa (sin cambios) -------- */
    function renderFarmsFromCache(){
      const farms = loadCache();
      Object.values(fincaMarkers).forEach(m=> map.removeLayer(m));
      for(const k in fincaMarkers) delete fincaMarkers[k];
      farms.forEach(f=>{
        if(!f || !f.id || !f.fincaLocation) return;
        const marker = L.marker([f.fincaLocation.lat, f.fincaLocation.lng]).addTo(map);
        marker.bindTooltip(f.name || 'Finca',{permanent:true, direction:'right', offset:[10,0], className:'farm-label'});
        fincaMarkers[f.id] = marker;
      });
      const sel = document.getElementById('farmSelect');
      if (sel){
        sel.innerHTML = '';
        farms.forEach(f=>{
          const opt = document.createElement('option');
          opt.value = f.id; opt.textContent = f.name || 'Finca';
          sel.appendChild(opt);
        });
      }
      updateDeleteButtonState();
      currentFarms = farms || [];
      buildIndexList(); buildAssignOptions();
    }
    function renderGeofencesFromCache(){
      Object.values(geofenceLayers).forEach(p=> map.removeLayer(p));
      for(const k in geofenceLayers) delete geofenceLayers[k];
      const fences = loadFenceCache();
      fences.forEach(g=>{
        if(!g || !g.id || !Array.isArray(g.path) || g.path.length<3) return;
        const latlngs = g.path.map(pt=> [pt.lat, pt.lng]);
        const poly = L.polygon(latlngs, GEOFENCE_STYLE).addTo(map);
        poly.bindTooltip(g.name || 'Geocerca',{permanent:true, direction:'center', className:'farm-label'});
        geofenceLayers[g.id] = poly;
        poly.on('click', ()=> selectFence(g.id));
        if(selectedFenceId === g.id){ poly.setStyle(GEOFENCE_SELECTED_STYLE); }
      });
      if(selectedFenceId && !geofenceLayers[selectedFenceId]){ selectedFenceId = null; }
      updateDeleteFenceButtonState(); updateEditButtonsState();
      currentFences = fences || [];
      buildIndexList(); buildAssignOptions();
    }
    function initMap(center){
      center = center || {lat:-0.1807, lng:-78.4678};
      map = L.map('map',{center:[center.lat,center.lng],zoom:6});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      editGroup = new L.FeatureGroup(); map.addLayer(editGroup);
      addMousePositionControl(); renderFarmsFromCache(); renderGeofencesFromCache();

      map.on('click', async e=>{
        if(isDrawingFence){ addFenceVertex(e.latlng); return; }
        const name = prompt("Nombre de la nueva finca:"); if(!name) return;
        try{
          await db.collection('farms').add({ name, fincaLocation:{lat:e.latlng.lat, lng:e.latlng.lng} });
        }catch{
          const farms = loadCache();
          farms.push({ id: 'local-'+Date.now(), name, fincaLocation:{lat:e.latlng.lat, lng:e.latlng.lng} });
          saveCache(farms); renderFarmsFromCache();
        }
      });

      waitAuthThen(async ()=>{
        startSubscriptions();
        await initialFetchAll();
        syncLocalPendingToFirestore && syncLocalPendingToFirestore();
      });
    }

    /* -------- Suscripciones / cargas iniciales (sin cambios) -------- */
    let unsubFarms=null, unsubGeofences=null, unsubPersonnel=null, subsStarted=false;
    function startSubscriptions(){
      if (subsStarted) return; subsStarted=true;
      unsubFarms = db.collection('farms').onSnapshot(snap=>{
        const farms = [];
        Object.values(fincaMarkers).forEach(m=> map.removeLayer(m));
        for(const k in fincaMarkers) delete fincaMarkers[k];
        snap.forEach(doc=>{
          const d = doc.data();
          farms.push({ id: doc.id, name: d.name, fincaLocation: d.fincaLocation });
          if(d.fincaLocation){
            const marker = L.marker([d.fincaLocation.lat, d.fincaLocation.lng]).addTo(map);
            marker.bindTooltip(d.name || 'Finca',{permanent:true, direction:'right', offset:[10,0], className:'farm-label'});
            fincaMarkers[doc.id]=marker;
          }
        });
        currentFarms = farms.slice(); if (farms.length) saveCache(farms);
        const sel = document.getElementById('farmSelect');
        if (sel){ sel.innerHTML = ''; farms.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o); }); }
        updateDeleteButtonState(); buildIndexList(); buildAssignOptions();
      }, err => { console.warn('onSnapshot farms error', err); renderFarmsFromCache(); });

      unsubGeofences = db.collection('geofences').onSnapshot(snap=>{
        const fences = [];
        Object.values(geofenceLayers).forEach(p=> map.removeLayer(p));
        for(const k in geofenceLayers) delete geofenceLayers[k];
        snap.forEach(doc=>{
          const d = doc.data();
          const g = { id: doc.id, name: d.name, path: d.path || [] };
          fences.push(g);
          if(Array.isArray(g.path) && g.path.length>=3){
            const latlngs = g.path.map(pt=> [pt.lat, pt.lng]);
            const poly = L.polygon(latlngs, GEOFENCE_STYLE).addTo(map);
            poly.bindTooltip(g.name || 'Geocerca',{permanent:true, direction:'center', className:'farm-label'});
            geofenceLayers[doc.id]=poly;
            poly.on('click', ()=> selectFence(doc.id));
            if(selectedFenceId === doc.id){ poly.setStyle(GEOFENCE_SELECTED_STYLE); }
          }
        });
        currentFences = fences.slice(); if (fences.length) saveFenceCache(fences);
        if(selectedFenceId && !geofenceLayers[selectedFenceId]){ selectedFenceId = null; }
        updateDeleteFenceButtonState(); updateEditButtonsState(); buildIndexList(); buildAssignOptions();
      }, err => { console.warn('onSnapshot geofences error', err); renderGeofencesFromCache(); });

      unsubPersonnel = db.collection('personnel').onSnapshot(snap=>{
        const list = [];
        snap.forEach(doc=>{
          const d = doc.data();
          list.push({ id: doc.id, firstName:d.firstName||'', lastName:d.lastName||'', idNumber:d.idNumber||'', assignType:d.assignType||'', assignId:d.assignId||'' });
        });
        currentPersonnel = list.slice();
        if (list.length) savePersonnelCache(list);
        renderPersonnelList();
      }, err => { console.warn('onSnapshot personnel error', err); currentPersonnel = loadPersonnelCache(); renderPersonnelList(); });
    }
    async function initialFetchAll(){ await Promise.all([initialFetchFarms(), initialFetchGeofences(), initialFetchPersonnel()]); }
    async function initialFetchFarms(){ try{
      const snap = await db.collection('farms').get();
      const farms=[]; snap.forEach(doc=>{ const d=doc.data(); farms.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation}); });
      if (farms.length){ currentFarms = farms.slice(); saveCache(farms); renderFarmsFromCache(); } else { buildIndexList(); buildAssignOptions(); }
    }catch(e){ console.warn('get farms failed', e); buildIndexList(); buildAssignOptions(); } }
    async function initialFetchGeofences(){ try{
      const snap = await db.collection('geofences').get();
      const fences=[]; snap.forEach(doc=>{ const d=doc.data(); fences.push({id:doc.id,name:d.name,path:d.path||[]}); });
      if (fences.length){ currentFences = fences.slice(); saveFenceCache(fences); renderGeofencesFromCache(); } else { buildIndexList(); buildAssignOptions(); }
    }catch(e){ console.warn('get geofences failed', e); buildIndexList(); buildAssignOptions(); } }
    async function initialFetchPersonnel(){ try{
      const snap = await db.collection('personnel').get();
      const list=[]; snap.forEach(doc=>{ const d=doc.data(); list.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||''}); });
      if (list.length){ currentPersonnel = list.slice(); savePersonnelCache(list); } else { currentPersonnel = loadPersonnelCache(); }
      renderPersonnelList();
    }catch(e){ console.warn('get personnel failed', e); currentPersonnel = loadPersonnelCache(); renderPersonnelList(); } }

    let syncRan=false;
    async function syncLocalPendingToFirestore(){
      if (syncRan) return; syncRan=true;
      try{
        const farms = loadCache().filter(f => String(f.id||'').startsWith('local-'));
        for (const f of farms){
          try{ await db.collection('farms').add({ name:f.name||'Finca', fincaLocation:f.fincaLocation||null }); }
          catch(e){ console.warn('No se pudo subir finca local', e); }
          saveCache(loadCache().filter(x => x.id !== f.id));
        }
      }catch(e){}

      try{
        const fences = loadFenceCache().filter(g => String(g.id||'').startsWith('localgf-'));
        for (const g of fences){
          try{ await db.collection('geofences').add({ name:g.name||'Geocerca', path:Array.isArray(g.path)?g.path:[] }); }
          catch(e){ console.warn('No se pudo subir geocerca local', e); }
          saveFenceCache(loadFenceCache().filter(x => x.id !== g.id));
        }
      }catch(e){}

      try{
        const ppl = loadPersonnelCache().filter(p => String(p.id||'').startsWith('localp-'));
        for (const p of ppl){
          try{
            await db.collection('personnel').add({ firstName:p.firstName||'', lastName:p.lastName||'', idNumber:p.idNumber||'', assignType:p.assignType||'', assignId:p.assignId||'' });
          }catch(e){ console.warn('No se pudo subir persona local', e); }
          savePersonnelCache(loadPersonnelCache().filter(x => x.id !== p.id));
        }
      }catch(e){}
    }

    /* -------- Selección / controles (sin cambios) -------- */
    function selectFence(id){
      if(isEditingFence){ alert('Estás editando una geocerca. Guarda o cancela antes de cambiar.'); return; }
      if(selectedFenceId && geofenceLayers[selectedFenceId]) geofenceLayers[selectedFenceId].setStyle(GEOFENCE_STYLE);
      selectedFenceId = id;
      if(geofenceLayers[selectedFenceId]) geofenceLayers[selectedFenceId].setStyle(GEOFENCE_SELECTED_STYLE);
      updateDeleteFenceButtonState(); updateEditButtonsState();
    }
    const normDec = s => String(s||'').trim().replace(',', '.');
    const parseCoord = s => { const v=parseFloat(normDec(s)); return Number.isFinite(v)?v:NaN; };
    const validLat = v => v>=-90 && v<=90, validLng = v => v>=-180 && v<=180;

    async function createFarmAtCenter(){
      if(!map){ alert('Mapa no listo aún.'); return; }
      const name = prompt("Nombre de la nueva finca:"); if(!name) return;
      const c = map.getCenter();
      try{ await db.collection('farms').add({ name, fincaLocation:{lat:c.lat, lng:c.lng} }); }
      catch{ const farms=loadCache(); farms.push({ id:'local-'+Date.now(), name, fincaLocation:{lat:c.lat, lng:c.lng} }); saveCache(farms); renderFarmsFromCache(); }
    }
    function addFenceVertex(latlng){
      drawingCoords.push({lat: latlng.lat, lng: latlng.lng});
      const m = L.circleMarker(latlng, {radius:4, weight:2}).addTo(map);
      drawingMarkers.push(m);
      const latlngs = drawingCoords.map(p=> [p.lat, p.lng]);
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }
      if(latlngs.length>=3) drawingPolyline = L.polygon(latlngs, {dashArray:'4,4', weight:2, fillOpacity:0.1}).addTo(map);
      else if(latlngs.length>=2) drawingPolyline = L.polyline(latlngs, {dashArray:'4,4', weight:2}).addTo(map);
    }
    function startFenceDraw(){ if(isDrawingFence) return; isDrawingFence=true; drawingCoords=[]; drawingMarkers.forEach(m=> map.removeLayer(m)); drawingMarkers=[]; if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; } document.getElementById('startFenceBtn').classList.add('hidden'); document.getElementById('finishFenceBtn').classList.remove('hidden'); document.getElementById('cancelFenceBtn').classList.remove('hidden'); }
    function finishFenceDraw(){
      if(!isDrawingFence) return;
      if(drawingCoords.length < 3){ alert('La geocerca necesita al menos 3 puntos.'); return; }
      pendingFenceCoords = drawingCoords.slice();
      const hint = document.getElementById('fenceNameHint'); if(hint) hint.textContent = `Vértices: ${pendingFenceCoords.length} puntos`;
      const input = document.getElementById('fenceNameInput');
      if(input){ input.value = `Geocerca ${new Date().toLocaleDateString()}`; document.getElementById('fenceNamePanel')?.classList.remove('hidden'); input.focus(); input.select(); }
    }
    function cancelFenceDraw(){ isDrawingFence=false; drawingCoords=[]; drawingMarkers.forEach(m=> map.removeLayer(m)); drawingMarkers=[]; if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; } document.getElementById('startFenceBtn').classList.remove('hidden'); document.getElementById('finishFenceBtn').classList.add('hidden'); document.getElementById('cancelFenceBtn').classList.add('hidden'); document.getElementById('fenceNamePanel')?.classList.add('hidden'); pendingFenceCoords = null; }
    async function saveFenceName(){
      const input = document.getElementById('fenceNameInput');
      const name = (input && input.value ? input.value : '').trim() || 'Geocerca';
      if(!pendingFenceCoords || pendingFenceCoords.length<3){ alert('No hay geocerca lista para guardar.'); return; }
      try{ await db.collection('geofences').add({ name, path: pendingFenceCoords }); }
      catch(err){ const fences = loadFenceCache(); fences.push({ id: 'localgf-'+Date.now(), name, path: pendingFenceCoords }); saveFenceCache(fences); renderGeofencesFromCache(); }
      if(input){ input.value=''; } pendingFenceCoords=null; document.getElementById('fenceNamePanel')?.classList.add('hidden'); cancelFenceDraw(); if(previewFenceLayer){ map.removeLayer(previewFenceLayer); previewFenceLayer=null; } waitAuthThen(syncLocalPendingToFirestore);
    }
    function updateEditButtonsState(){ const canEdit = !!selectedFenceId && !!geofenceLayers[selectedFenceId] && !isEditingFence; const eBtn = document.getElementById('editFenceBtn'); if (eBtn) eBtn.disabled = !canEdit; const editing = isEditingFence; document.getElementById('saveFenceEditBtn')?.classList.toggle('hidden', !editing); document.getElementById('cancelFenceEditBtn')?.classList.toggle('hidden', !editing); }
    function ensureEditToolbar(){ if (!editToolbar) editToolbar = new L.EditToolbar.Edit(map, { featureGroup: editGroup, selectedPathOptions: { maintainColor: true } }); }
    function startFenceEdit(){ if(!selectedFenceId || !geofenceLayers[selectedFenceId]){ alert('Primero selecciona una geocerca.'); return; } if(isEditingFence) return; const poly = geofenceLayers[selectedFenceId]; const rings = poly.getLatLngs(); const ring0 = Array.isArray(rings[0]) ? rings[0] : rings; editBackupCoords = ring0.map(ll => ({lat: ll.lat, lng: ll.lng})); if (!editGroup.hasLayer(poly)) editGroup.addLayer(poly); ensureEditToolbar(); editToolbar.enable(); isEditingFence = true; updateEditButtonsState(); }
    async function saveFenceEdit(){ if(!isEditingFence || !selectedFenceId || !geofenceLayers[selectedFenceId]) return; const poly = geofenceLayers[selectedFenceId]; const rings = poly.getLatLngs(); const ring0 = Array.isArray(rings[0]) ? rings[0] : rings; const newPath = ring0.map(ll => ({lat: ll.lat, lng: ll.lng})); if (newPath.length < 3){ alert('La geocerca necesita al menos 3 puntos.'); return; } const fencesCache = loadFenceCache(); const idxCache = fencesCache.findIndex(g => g.id === selectedFenceId); try{ if (selectedFenceId.startsWith('localgf-')) { if (idxCache>=0){ fencesCache[idxCache].path = newPath; saveFenceCache(fencesCache); } } else { await db.collection('geofences').doc(selectedFenceId).update({ path: newPath }); } }catch(err){ if (idxCache>=0){ fencesCache[idxCache].path = newPath; saveFenceCache(fencesCache); } } if (editToolbar) editToolbar.disable(); if (editGroup && editGroup.hasLayer(poly)) editGroup.removeLayer(poly); isEditingFence = false; editBackupCoords = null; updateEditButtonsState(); renderGeofencesFromCache(); }
    function cancelFenceEdit(){ if(!isEditingFence || !selectedFenceId || !geofenceLayers[selectedFenceId]) return; const poly = geofenceLayers[selectedFenceId]; if (editBackupCoords && editBackupCoords.length >= 3) poly.setLatLngs(editBackupCoords.map(p => L.latLng(p.lat, p.lng))); if (editToolbar) editToolbar.disable(); if (editGroup && editGroup.hasLayer(poly)) editGroup.removeLayer(poly); isEditingFence = false; editBackupCoords = null; updateEditButtonsState(); }

    function fenceToFeature(id){ const gf = (loadFenceCache()||[]).find(g => g.id === id); const layer = geofenceLayers[id]; if(!gf || !layer) return null; const rings = layer.getLatLngs(); const ring0 = (Array.isArray(rings[0]) ? rings[0] : rings).map(ll => [ll.lng, ll.lat]); if (ring0.length && (ring0[0][0] !== ring0[ring0.length-1][0] || ring0[0][1] !== ring0[ring0.length-1][1])) ring0.push([ring0[0][0], ring0[0][1]]); return { type: "Feature", properties: { id: gf.id, name: gf.name || 'Geocerca' }, geometry: { type: "Polygon", coordinates: [ ring0 ] } }; }
    function exportGeoJSON(){ let fc; if (selectedFenceId && geofenceLayers[selectedFenceId]){ const feat = fenceToFeature(selectedFenceId); if(!feat){ alert('No se pudo exportar.'); return; } fc = { type: "FeatureCollection", features: [feat] }; } else { const features = []; for (const id of Object.keys(geofenceLayers)){ const feat = fenceToFeature(id); if (feat) features.push(feat); } if (!features.length){ alert('No hay geocercas.'); return; } fc = { type: "FeatureCollection", features }; } const blob = new Blob([JSON.stringify(fc, null, 2)], {type: "application/geo+json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = selectedFenceId ? `geocerca_${selectedFenceId}.geojson` : 'geocercas.geojson'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    async function importGeoJSONFromText(text){ let obj; try { obj = JSON.parse(text); } catch { alert('GeoJSON inválido.'); return; } const asArray = (x) => Array.isArray(x) ? x : [x]; let features = []; if (obj.type === 'FeatureCollection') features = obj.features || []; else if (obj.type === 'Feature') features = [obj]; else if (obj.type && obj.coordinates) features = [{ type: 'Feature', properties: {}, geometry: obj }]; else { alert('Estructura GeoJSON no reconocida.'); return; } let created = 0; for (const feat of features){ const geom = feat.geometry || {}; const props = feat.properties || {}; const baseName = (props.name || 'Geocerca importada'); if (geom.type === 'Polygon'){ await createGeofenceFromPolygonCoords(geom.coordinates, baseName); created++; } else if (geom.type === 'MultiPolygon'){ const polys = asArray(geom.coordinates); let i=1; for (const poly of polys){ await createGeofenceFromPolygonCoords(poly, `${baseName} (${i})`); i++; created++; } } } if (!created) alert('El GeoJSON no contiene Polygon/MultiPolygon.'); else { try { await initialFetchGeofences(); } catch {} renderGeofencesFromCache(); alert(`Importadas: ${created}`); } }
    async function createGeofenceFromPolygonCoords(coords, name){ if(!coords || !coords.length || !coords[0].length) return; const outer = coords[0].map(pair => ({lat: pair[1], lng: pair[0]})).filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng)); if (outer.length < 3) return; try{ await db.collection('geofences').add({ name: name || 'Geocerca', path: outer }); }catch(err){ const fences = loadFenceCache(); fences.push({ id: 'localgf-'+Date.now(), name: name || 'Geocerca', path: outer }); saveFenceCache(fences); } }

    function buildIndexList(){ const farmUl = document.getElementById('farmList'); const fenceUl = document.getElementById('fenceList'); if(!farmUl || !fenceUl) return; const farmsSrc  = (currentFarms && currentFarms.length) ? currentFarms : (loadCache()||[]); const fencesSrc = (currentFences && currentFences.length) ? currentFences : (loadFenceCache()||[]); const farms  = farmsSrc.slice().sort((a,b)=> (a?.name||'').localeCompare(b?.name||'')); const fences = fencesSrc.slice().sort((a,b)=> (a?.name||'').localeCompare(b?.name||'')); farmUl.innerHTML = ''; if(!farms.length){ const li = document.createElement('li'); li.className = 'py-2 text-sm text-gray-500'; li.textContent = 'No hay fincas registradas.'; farmUl.appendChild(li); }else{ farms.forEach(f=>{ const li = document.createElement('li'); li.className = 'py-2'; li.innerHTML = `<div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer select-none" data-id="${f.id}" data-type="farm" title="Doble clic para centrar"><div class="text-sm font-medium text-gray-800">${(f.name||'Finca')}</div><div class="text-xs text-gray-500">${f?.fincaLocation?`Lat ${(+f.fincaLocation.lat).toFixed(5)}, Lng ${(+f.fincaLocation.lng).toFixed(5)}`:'—'}</div></div>`; farmUl.appendChild(li); }); } fenceUl.innerHTML = ''; if(!fences.length){ const li = document.createElement('li'); li.className = 'py-2 text-sm text-gray-500'; li.textContent = 'No hay geocercas registradas.'; fenceUl.appendChild(li); }else{ fences.forEach(g=>{ const li = document.createElement('li'); li.className = 'py-2'; li.innerHTML = `<div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer select-none" data-id="${g.id}" data-type="fence" title="Doble clic para ajustar al polígono"><div class="text-sm font-medium text-gray-800">${(g.name||'Geocerca')}</div><div class="text-xs text-gray-500">${Array.isArray(g.path)?`${g.path.length} puntos`:'—'}</div></div>`; fenceUl.appendChild(li); }); } }
    function zoomToFarm(id){ try{ if (fincaMarkers[id]){ const ll = fincaMarkers[id].getLatLng(); map.setView(ll, Math.max(map.getZoom(), 16)); try{ fincaMarkers[id].openTooltip(); }catch{} return; } const farms = loadCache()||[]; const f = farms.find(x=> x.id===id); if (f && f.fincaLocation){ map.setView([f.fincaLocation.lat, f.fincaLocation.lng], Math.max(map.getZoom(), 16)); }else{ alert('No se pudo localizar esa finca.'); } }catch(e){ console.warn(e); } }
    function zoomToFence(id){ try{ if (geofenceLayers[id]){ const b = geofenceLayers[id].getBounds(); map.fitBounds(b, { padding:[20,20] }); selectFence(id); return; } const fences = loadFenceCache()||[]; const g = fences.find(x=> x.id===id); if (g && Array.isArray(g.path) && g.path.length>=3){ const b = L.latLngBounds(g.path.map(p=> [p.lat, p.lng])); map.fitBounds(b, { padding:[20,20] }); selectFence(id); }else{ alert('No se pudo localizar esa geocerca.'); } }catch(e){ console.warn(e); } }
    async function deleteSelectedFarm(){ const sel=document.getElementById('farmSelect'); const id= sel ? sel.value : ''; if(!id){ alert('No hay finca seleccionada.'); return; } const farmsCache = loadCache(); const farm = farmsCache.find(f=> f.id===id); const name=(farm&&farm.name)||'Finca'; if(!confirm(`¿Eliminar "${name}"?`)) return; if(id.indexOf('local-')===0){ const updated=farmsCache.filter(f=> f.id!==id); saveCache(updated); renderFarmsFromCache(); return; } try{ await db.collection('farms').doc(id).delete(); } catch{ const updated=farmsCache.filter(f=> f.id!==id); saveCache(updated); renderFarmsFromCache(); } }
    function updateDeleteButtonState(){ const sel=document.getElementById('farmSelect'); const btn=document.getElementById('deleteFarmBtn'); if(!btn) return; btn.disabled = !(sel && sel.value); }
    async function deleteSelectedFence(){ if(!selectedFenceId){ alert('Selecciona una geocerca.'); return; } if(isEditingFence){ alert('Estás editando.'); return; } const fencesCache = loadFenceCache(); const gf = fencesCache.find(g=> g.id === selectedFenceId); const name = (gf && gf.name) ? gf.name : 'Geocerca'; if(!confirm(`¿Eliminar "${name}"?`)) return; if(selectedFenceId.indexOf('localgf-')===0){ const updated = fencesCache.filter(g=> g.id !== selectedFenceId); saveFenceCache(updated); if(geofenceLayers[selectedFenceId]){ map.removeLayer(geofenceLayers[selectedFenceId]); delete geofenceLayers[selectedFenceId]; } selectedFenceId = null; updateDeleteFenceButtonState(); updateEditButtonsState(); return; } try{ await db.collection('geofences').doc(selectedFenceId).delete(); }catch(err){ const updated = fencesCache.filter(g=> g.id !== selectedFenceId); saveFenceCache(updated); if(geofenceLayers[selectedFenceId]){ map.removeLayer(geofenceLayers[selectedFenceId]); delete geofenceLayers[selectedFenceId]; } } selectedFenceId = null; updateDeleteFenceButtonState(); updateEditButtonsState(); }
    function updateDeleteFenceButtonState(){ const btn = document.getElementById('deleteFenceBtn'); if(!btn) return; btn.disabled = !selectedFenceId; }
    function addMousePositionControl(){ const MousePos=L.Control.extend({ options:{position:'bottomleft'}, onAdd:function(){ const d=L.DomUtil.create('div','mousepos-control'); d.innerHTML='Lat: — Lng: —'; this._div=d; return d; }, update:function(lat,lng){ if(this._div){ this._div.innerHTML = (lat!=null&&lng!=null)?(`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`):'Lat: — Lng: —'; } } }); const ctrl = new MousePos(); ctrl.addTo(map); map.on('mousemove', e=>ctrl.update(e.latlng.lat, e.latlng.lng)); map.on('mouseout', ()=>ctrl.update(null,null)); }
    function waitAuthThen(fn){ if (authReady) { fn(); return; } const iv = setInterval(()=>{ if(authReady){ clearInterval(iv); fn(); } }, 150); }

    const ADMIN_CODE = "admin123";
    function doAdminLogin(){ const inputEl = document.getElementById('adminCodeInput'); const normalized = (inputEl?.value||'').trim().toLowerCase(); if(normalized === ADMIN_CODE){ document.getElementById('adminModal')?.classList.add("hidden"); document.getElementById('appContent')?.classList.remove("hidden"); setTimeout(()=>{ initMap(); setTimeout(()=>{ if(map){ map.invalidateSize(); } }, 100); }, 100); } else { document.getElementById('errorMessage').style.display="block"; } }

    /* -------- Gestión de Personal -------- */
    function buildAssignOptions(){
      const sel = document.getElementById('pAssignSelect'); if(!sel) return;
      const farms  = (currentFarms && currentFarms.length) ? currentFarms : (loadCache()||[]);
      const fences = (currentFences && currentFences.length) ? currentFences : (loadFenceCache()||[]);
      const opts = [];
      if (farms.length){ opts.push({value:'', label:'— Selecciona —'}); farms.forEach(f => opts.push({value:`farm:${f.id}`,  label:`Finca: ${f.name||'Finca'}`})); }
      if (fences.length){ if (!opts.length) opts.push({value:'', label:'— Selecciona —'}); fences.forEach(g => opts.push({value:`fence:${g.id}`, label:`Geocerca: ${g.name||'Geocerca'}`})); }
      if (!opts.length) opts.push({value:'', label:'No hay fincas/geocercas'});
      sel.innerHTML = opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
      const filter = document.getElementById('pEntityFilter');
      if (filter){
        const items = [{value:'all', label:'Todas'}];
        farms.forEach(f => items.push({value:`farm:${f.id}`, label:`Finca: ${f.name||'Finca'}`}));
        fences.forEach(g => items.push({value:`fence:${g.id}`, label:`Geocerca: ${g.name||'Geocerca'}`}));
        filter.innerHTML = items.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
      }
    }
    function renderPersonnelList(){
      const tbody = document.getElementById('personnelTableBody'); if(!tbody) return;
      const q = (document.getElementById('pSearchInput')?.value || '').trim().toLowerCase();
      const t = (document.getElementById('pTypeFilter')?.value || 'all');
      const e = (document.getElementById('pEntityFilter')?.value || 'all');
      let list = (currentPersonnel && currentPersonnel.length) ? currentPersonnel.slice() : loadPersonnelCache();
      list = list.filter(p=>{
        let ok = true;
        if (q){ const hay = `${p.firstName||''} ${p.lastName||''} ${p.idNumber||''}`.toLowerCase(); ok = hay.includes(q); }
        if (ok && t!=='all'){ ok = (p.assignType===t); }
        if (ok && e!=='all'){ const [kind,id] = e.split(':'); ok = (p.assignType===kind && p.assignId===id); }
        return ok;
      });
      const farms  = (currentFarms && currentFarms.length) ? currentFarms : loadCache();
      const fences = (currentFences && currentFences.length) ? currentFences : loadFenceCache();
      const nameOf = (p)=> p.assignType==='farm' ? (farms.find(f=>f.id===p.assignId)?.name||'Finca') : (p.assignType==='fence' ? (fences.find(g=>g.id===p.assignId)?.name||'Geocerca') : '—');
      tbody.innerHTML = '';
      if (!list.length){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="5" class="px-3 py-4 text-center text-gray-500">No hay personal registrado.</td>`; tbody.appendChild(tr); return; }
      list.forEach(p=>{
        const tr = document.createElement('tr'); tr.className = 'border-t hover:bg-gray-50 cursor-default'; tr.dataset.id = p.id;
        tr.innerHTML = `
          <td class="px-3 py-2">${p.firstName||''}</td>
          <td class="px-3 py-2">${p.lastName||''}</td>
          <td class="px-3 py-2">${p.idNumber||''}</td>
          <td class="px-3 py-2">${p.assignType==='farm' ? 'Finca' : 'Geocerca'}: ${nameOf(p)}</td>
          <td class="px-3 py-2">
            <button class="text-indigo-600 hover:underline" onclick="openEditPerson('${p.id}')">Editar</button>
            <span class="mx-1 text-gray-300">|</span>
            <button class="text-rose-600 hover:underline" onclick="deletePerson('${p.id}')">Eliminar</button>
          </td>`;
        tr.addEventListener('dblclick', ()=>{ if (p.assignType==='farm') zoomToFarm(p.assignId); if (p.assignType==='fence') zoomToFence(p.assignId); });
        tbody.appendChild(tr);
      });
    }
    function showPersonError(msg){ const err = document.getElementById('pFormError'); if (!err) return; err.textContent = msg || ''; err.classList.toggle('hidden', !msg); }
    async function addPerson(){
      try{
        const fn  = document.getElementById('pFirstName')?.value.trim() || '';
        const ln  = document.getElementById('pLastName')?.value.trim() || '';
        const idn = document.getElementById('pIdNumber')?.value.trim() || '';
        const asg = document.getElementById('pAssignSelect')?.value || '';
        showPersonError('');
        if(!fn || !ln){ showPersonError('Nombre y apellido son obligatorios.'); return; }
        if(!/^[0-9]{6,15}$/.test(idn)){ showPersonError('Cédula: usar solo dígitos (6–15).'); return; }
        if(!asg){ showPersonError('Selecciona una asignación.'); return; }
        const [assignType, assignId] = asg.split(':');
        const docData = { firstName: fn, lastName: ln, idNumber: idn, assignType, assignId };
        try{ await db.collection('personnel').add(docData); }
        catch(e){ const cache = loadPersonnelCache(); cache.push({ id:'localp-'+Date.now(), ...docData }); savePersonnelCache(cache); }
        document.getElementById('pFirstName').value=''; document.getElementById('pLastName').value=''; document.getElementById('pIdNumber').value=''; document.getElementById('pAssignSelect').selectedIndex=0;
        currentPersonnel = loadPersonnelCache(); renderPersonnelList();
        waitAuthThen(syncLocalPendingToFirestore);
      }catch(e){ console.error(e); showPersonError('No se pudo agregar. Revisa los datos.'); }
    }
    window.addPerson = addPerson;

    async function deletePerson(id){
      if(!id) return;
      let cache = loadPersonnelCache();
      const item = (currentPersonnel||[]).find(p=> p.id===id) || cache.find(p=> p.id===id);
      const label = item ? `${item.firstName||''} ${item.lastName||''}`.trim() : 'esta persona';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{ await db.collection('personnel').doc(id).delete(); }
      catch(e){ cache = cache.filter(p=> p.id!==id); savePersonnelCache(cache); }
      currentPersonnel = loadPersonnelCache(); renderPersonnelList();
    }
    window.deletePerson = deletePerson;

    function openEditPerson(id){
      const src = (currentPersonnel && currentPersonnel.length) ? currentPersonnel : (loadPersonnelCache()||[]);
      const p = src.find(x=> x.id===id); if(!p){ alert('No se encontró el registro.'); return; }
      const fn = prompt('Nombre', p.firstName||''); if(fn===null) return;
      const ln = prompt('Apellido', p.lastName||''); if(ln===null) return;
      const idn= prompt('Cédula (solo dígitos 6–15)', p.idNumber||''); if(idn===null) return;
      if(!/^[0-9]{6,15}$/.test(idn)){ alert('Cédula inválida.'); return; }
      const farms  = (currentFarms && currentFarms.length) ? currentFarms : loadCache();
      const fences = (currentFences && currentFences.length) ? currentFences : loadFenceCache();
      const choices = [
        ...farms.map(f => ({v:`farm:${f.id}`,  l:`Finca: ${f.name||'Finca'}`})),
        ...fences.map(g => ({v:`fence:${g.id}`, l:`Geocerca: ${g.name||'Geocerca'}`}))
      ];
      let asgVal = `${p.assignType}:${p.assignId}`;
      const pick = prompt('Asigne escribiendo el número:\n' + choices.map((c,i)=> `${i+1}. ${c.l}`).join('\n') + `\n\n(Actual: ${asgVal})`);
      if(pick===null) return;
      const idx = (+pick)-1; if (idx<0 || idx>=choices.length) { alert('Selección inválida.'); return; }
      asgVal = choices[idx].v;
      const [assignType, assignId] = asgVal.split(':');
      const docData = { firstName: fn, lastName: ln, idNumber: idn, assignType, assignId };
      const cache = loadPersonnelCache(); const iCache = cache.findIndex(x=> x.id===id);
      (async ()=>{ try{ await db.collection('personnel').doc(id).update(docData); } catch(e){ if (iCache>=0){ cache[iCache] = { ...cache[iCache], ...docData }; savePersonnelCache(cache); } } currentPersonnel = loadPersonnelCache(); renderPersonnelList(); })();
    }
    window.openEditPerson = openEditPerson;

    /* ----------------- Enlaces de UI ----------------- */
    document.addEventListener("DOMContentLoaded",function(){
      document.getElementById('adminModal')?.classList.remove("hidden");
      document.getElementById('adminLoginBtn')?.addEventListener("click", doAdminLogin);
      const adminInput = document.getElementById('adminCodeInput');
      adminInput?.addEventListener("keypress", (e)=>{ if(e.key==="Enter") doAdminLogin(); });

      document.getElementById('farmSelect')?.addEventListener('change', updateDeleteButtonState);
      document.getElementById('createFarmBtn')?.addEventListener('click', createFarmAtCenter);
      document.getElementById('deleteFarmBtn')?.addEventListener('click', deleteSelectedFarm);
      document.getElementById('createByCoordsBtn')?.addEventListener('click', ()=>{ const latStr = prompt("Latitud (decimal)"); if(latStr===null) return; const lngStr = prompt("Longitud (decimal)"); if(lngStr===null) return; /* resto igual que tu flujo original */ });

      document.getElementById('startFenceBtn')?.addEventListener('click', startFenceDraw);
      document.getElementById('finishFenceBtn')?.addEventListener('click', finishFenceDraw);
      document.getElementById('cancelFenceBtn')?.addEventListener('click', cancelFenceDraw);
      document.getElementById('fenceNameSaveBtn')?.addEventListener('click', saveFenceName);
      document.getElementById('fenceNameCancelBtn')?.addEventListener('click', ()=>document.getElementById('fenceNamePanel')?.classList.add('hidden'));

      document.getElementById('coordsNameSaveBtn')?.addEventListener('click', ()=>{/* flujo guardar coords (sin cambios) */});
      document.getElementById('coordsNameCancelBtn')?.addEventListener('click', ()=>document.getElementById('coordsNamePanel')?.classList.add('hidden'));

      document.getElementById('createFenceByCoordsBtn')?.addEventListener('click', ()=>{/* flujo coords geocerca (sin cambios) */});

      document.getElementById('farmList')?.addEventListener('dblclick', (e)=>{ const box = e.target.closest('[data-type="farm"][data-id]'); if (!box) return; zoomToFarm(box.dataset.id); });
      document.getElementById('fenceList')?.addEventListener('dblclick', (e)=>{ const box = e.target.closest('[data-type="fence"][data-id]'); if (!box) return; zoomToFence(box.dataset.id); });

      document.getElementById('editFenceBtn')?.addEventListener('click', startFenceEdit);
      document.getElementById('saveFenceEditBtn')?.addEventListener('click', saveFenceEdit);
      document.getElementById('cancelFenceEditBtn')?.addEventListener('click', cancelFenceEdit);
      document.getElementById('exportGeoJSONBtn')?.addEventListener('click', exportGeoJSON);
      document.getElementById('importGeoJSONInput')?.addEventListener('change', async (e) => { const file = e.target.files?.[0]; if(!file) return; const text = await file.text(); await importGeoJSONFromText(text); e.target.value = ''; });

      document.getElementById('pSearchInput')?.addEventListener('input', renderPersonnelList);
      document.getElementById('pTypeFilter')?.addEventListener('change', renderPersonnelList);
      document.getElementById('pEntityFilter')?.addEventListener('change', renderPersonnelList);

      // (1) Dispatcher global muy robusto
      window.__onAddPersonClick = function(ev){ ev && ev.preventDefault && ev.preventDefault(); try{ addPerson(); }catch(e){ console.error(e); alert('No se pudo agregar.'); } };

      // (2) Delegación global (por si el onclick no se adjunta)
      document.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('[data-action="add-person"]');
        if (btn) { ev.preventDefault(); window.__onAddPersonClick(ev); }
      });

      // (3) Enter en campos → agregar
      ['pFirstName','pLastName','pIdNumber'].forEach(id=>{
        const el = document.getElementById(id);
        el && el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); window.__onAddPersonClick(e); }});
      });

      buildIndexList(); buildAssignOptions(); updateDeleteButtonState(); updateDeleteFenceButtonState(); updateEditButtonsState();
    });
  </script>
</body>
</html>

