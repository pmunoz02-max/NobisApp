<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MVP Geocercas & Envío — Simple</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0c0d10;color:#eaeef7}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#12151f;border-bottom:1px solid #222}
  .tag{font-size:12px;background:#1b2130;color:#cfe3ff;border:1px solid #263149;border-radius:999px;padding:4px 8px}
  #wrap{display:grid;grid-template-columns:320px 1fr;height:calc(100vh - 52px)}
  #left{border-right:1px solid #222;padding:10px;overflow:auto}
  #map{height:100%}
  .card{background:#10131c;border:1px solid #222;border-radius:12px;padding:10px;margin-bottom:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{background:#0f131c;border:1px solid #2a3245;color:#eaeef7;border-radius:10px;padding:8px}
  button.primary{background:#1b2a3b}
  .tiny{font-size:12px;color:#9fb3c8}
  .hide{display:none!important}
  .crosshair .leaflet-container{cursor:crosshair!important}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #232734;padding:6px;text-align:left;font-size:13px}
  #senderMap{height:48vh;border:1px solid #222;border-radius:12px}
</style>
</head>
<body>
<header>
  <div><b>MVP Geocercas & Envío</b></div>
  <div id="modeTag" class="tag">Cargando…</div>
</header>

<!-- ADMIN -->
<div id="wrap" class="hide">
  <aside id="left">
    <div class="card">
      <div class="row">
        <button id="btnDraw" class="primary">Dibujar geocerca</button>
        <button id="btnClose" class="">Cerrar polígono</button>
        <button id="btnCancel" class="">Cancelar</button>
      </div>
      <div class="row" style="margin-top:6px">
        <input id="gfName" placeholder="Nombre de geocerca"/>
        <button id="btnSave" class="primary">Guardar</button>
      </div>
      <div class="tiny" id="hint">Estado: listo.</div>
    </div>

    <div class="card">
      <b>Geocercas</b>
      <table><thead><tr><th>Nombre</th><th>Vértices</th></tr></thead>
        <tbody id="gfTable"></tbody>
      </table>
    </div>

    <div class="card">
      <b>Personal</b>
      <div class="row" style="margin-top:6px">
        <input id="pName" placeholder="Nombre"/>
        <input id="pPhone" placeholder="Teléfono (5939...)"/>
        <button id="btnAddPerson" class="primary">Añadir</button>
      </div>
      <table style="margin-top:8px"><thead><tr><th>Usuario</th><th>Teléfono</th><th>Geocercas</th><th>Link</th></tr></thead>
        <tbody id="peopleTable"></tbody>
      </table>
    </div>

    <div class="card">
      <b>Exportar</b><br/>
      <button id="btnExport" class="primary" style="margin-top:6px">Exportar envíos (CSV)</button>
    </div>
  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<!-- SENDER -->
<div id="sender" class="hide" style="padding:12px;max-width:900px;margin:0 auto">
  <div class="card" style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div id="senderUser" class="tiny">Usuario: —</div>
      <div id="senderGfs" class="tiny">Geocercas: —</div>
      <div id="senderInfo" class="tiny">Estado: detenido</div>
    </div>
    <div class="row">
      <button id="start" class="primary">Iniciar envío</button>
      <button id="stop">Detener</button>
    </div>
  </div>
  <div id="senderMap"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ====== util ======
const qs=(s,r=document)=>r.querySelector(s);
const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const params=Object.fromEntries(new URLSearchParams(location.search).entries());
const LS='mvp.app.v1';
function loadDB(){
  const raw=localStorage.getItem(LS);
  if(raw){ try{return JSON.parse(raw);}catch{} }
  const seed={geofences:[],people:[],submissions:[]};
  localStorage.setItem(LS, JSON.stringify(seed)); return seed;
}
function saveDB(){ localStorage.setItem(LS, JSON.stringify(DB)); }
let DB=loadDB();

// punto en polígono (lng,lat)
function pointInPoly([x,y], poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const [xi,yi]=poly[i], [xj,yj]=poly[j];
    const intersect=((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi+1e-12)+xi);
    if(intersect) inside=!inside;
  }
  return inside;
}

// ====== modo ======
const isSender=(params.mode||'').toLowerCase()==='sender' && !!params.phone;
qs('#modeTag').textContent=isSender?'Modo Emisor':'Modo Admin';
qs(isSender?'#sender':'#wrap').classList.remove('hide');

// ====== ADMIN ======
let map=null, drawn=null, manual={active:false, latlngs:[], temp:null};

function initAdmin(){
  map=L.map('map').setView([ -1.0639, -77.8125 ], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
  drawn=L.featureGroup().addTo(map);

  // render existentes
  renderGeofences();

  // dibujo manual
  qs('#btnDraw').onclick=()=>{
    manual.active=true; manual.latlngs=[];
    qs('#hint').textContent='Dibujo: clic para vértices, doble clic para cerrar.';
    document.body.classList.add('crosshair');
    map.doubleClickZoom.disable();
  };
  qs('#btnClose').onclick=()=>{ if(manual.active) closeManual(true); };
  qs('#btnCancel').onclick=()=>{ if(manual.active) closeManual(false); };

  map.on('click', (e)=>{
    if(!manual.active) return;
    manual.latlngs.push([e.latlng.lat, e.latlng.lng]);
    if(manual.temp) map.removeLayer(manual.temp);
    if(manual.latlngs.length>=3) manual.temp=L.polygon(manual.latlngs,{dashArray:'4'}).addTo(map);
    else manual.temp=L.polyline(manual.latlngs,{dashArray:'4'}).addTo(map);
  });
  map.on('dblclick', ()=>{ if(manual.active) closeManual(true); });

  function closeManual(commit){
    document.body.classList.remove('crosshair');
    map.doubleClickZoom.enable();
    if(manual.temp) { map.removeLayer(manual.temp); manual.temp=null; }
    if(commit && manual.latlngs.length>=3){
      drawn.addLayer(L.polygon(manual.latlngs,{color:'#41d39e'}));
      qs('#hint').textContent='Polígono listo. Pon un nombre y pulsa Guardar.';
    }else{
      qs('#hint').textContent='Cancelado.';
    }
    manual.active=false; manual.latlngs=[];
  }

  qs('#btnSave').onclick=()=>{
    const layers=drawn.getLayers();
    if(!layers.length) return alert('No hay polígonos que guardar.');
    const name=qs('#gfName').value.trim() || ('Geocerca '+(DB.geofences.length+1));
    const layer=layers[layers.length-1];
    const latlngs=(layer.getLatLngs()[0]||layer.getLatLngs()).map(p=>[p.lng,p.lat]); // (lng,lat)
    DB.geofences.push({id:'gf'+Math.random().toString(36).slice(2,8), name, coords:latlngs});
    saveDB(); qs('#gfName').value=''; renderGeofences(); alert('Geocerca guardada.');
  };

  // personas
  qs('#btnAddPerson').onclick=()=>{
    const name=qs('#pName').value.trim(), phone=qs('#pPhone').value.trim();
    if(!name||!phone) return alert('Nombre y teléfono obligatorios');
    DB.people.push({id:'u'+Math.random().toString(36).slice(2,8), name, phone, geofences:[]});
    saveDB(); qs('#pName').value=''; qs('#pPhone').value=''; renderPeople(); alert('Usuario añadido');
  };

  qs('#btnExport').onclick=exportCSV;

  renderPeople();
}

function renderGeofences(){
  drawn.clearLayers();
  DB.geofences.forEach(g=>{
    const ll=g.coords.map(([lng,lat])=>[lat,lng]);
    drawn.addLayer(L.polygon(ll,{color:'#41d39e'}).bindTooltip(g.name));
  });
  if(drawn.getLayers().length) map.fitBounds(drawn.getBounds());

  const tb=qs('#gfTable'); tb.innerHTML='';
  DB.geofences.forEach(g=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${g.name}</td><td>${g.coords.length}</td>`;
    tb.appendChild(tr);
  });
}

function renderPeople(){
  const tb=qs('#peopleTable'); tb.innerHTML='';
  DB.people.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${u.name}</td>
      <td>${u.phone}</td>
      <td>
        <select multiple size="3" data-id="${u.id}">
          ${DB.geofences.map(g=>`<option value="${g.id}" ${u.geofences?.includes(g.id)?'selected':''}>${g.name}</option>`).join('')}
        </select>
      </td>
      <td><button data-link="${u.id}">Generar</button></td>`;
    tb.appendChild(tr);
  });

  // guardar asignación cuando cambia
  qsa('#peopleTable select').forEach(sel=>{
    sel.onchange=()=>{
      const id=sel.getAttribute('data-id');
      const vals=Array.from(sel.selectedOptions).map(o=>o.value);
      const i=DB.people.findIndex(p=>p.id===id); if(i>=0){ DB.people[i].geofences=vals; saveDB(); }
    };
  });
  // generar enlace
  qsa('#peopleTable button[data-link]').forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute('data-link');
      const u=DB.people.find(p=>p.id===id); if(!u) return;
      const url=`${location.origin}${location.pathname}?mode=sender&phone=${encodeURIComponent(u.phone)}`;
      navigator.clipboard?.writeText(url);
      alert('Enlace copiado:\n'+url);
    };
  });
}

function exportCSV(){
  const head=['fecha','usuario','telefono','geocerca','lat','lng','precision_m'];
  const rows=[head.join(',')];
  DB.submissions.forEach(r=>{
    const u=DB.people.find(x=>x.id===r.userId);
    const g=DB.geofences.find(x=>x.id===r.geofenceId);
    rows.push([new Date(r.ts).toISOString(), u?.name||'', r.phone, g?.name||r.geofenceId, r.lat, r.lng, Math.round(r.acc||0)].join(','));
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='envios.csv'; a.click();
}

// ====== SENDER ======
let sMap=null, sLayer=null, watchId=null, sUser=null;
function initSender(){
  sUser=DB.people.find(u=>u.phone===params.phone);
  if(!sUser){ alert('Teléfono no registrado.'); return;}
  qs('#senderUser').textContent=`Usuario: ${sUser.name} (${sUser.phone})`;
  const gnames=sUser.geofences.map(id=>DB.geofences.find(g=>g.id===id)?.name||id).join(', ');
  qs('#senderGfs').textContent='Geocercas: '+(gnames||'—');

  sMap=L.map('senderMap').setView([-1.0639,-77.8125],16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(sMap);
  sLayer=L.layerGroup().addTo(sMap);

  // pintar geocercas del usuario
  const bounds=[];
  sUser.geofences.forEach(id=>{
    const gf=DB.geofences.find(g=>g.id===id); if(!gf) return;
    const ll=gf.coords.map(([lng,lat])=>[lat,lng]);
    L.polygon(ll,{color:'#41d39e'}).addTo(sLayer);
    bounds.push(...ll);
  });
  if(bounds.length) sMap.fitBounds(L.polygon(bounds).getBounds());

  qs('#start').onclick=()=>{
    if(!navigator.geolocation) return alert('Sin geolocalización');
    if(watchId!=null) return;
    qs('#senderInfo').textContent='Estado: iniciando…';
    watchId=navigator.geolocation.watchPosition(onPos, e=>qs('#senderInfo').textContent='Error: '+e.message, {enableHighAccuracy:true,maximumAge:5000,timeout:15000});
  };
  qs('#stop').onclick=()=>{
    if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    qs('#senderInfo').textContent='Estado: detenido';
  };
}

function onPos(pos){
  const {latitude:lat, longitude:lng, accuracy}=pos.coords;
  sLayer.clearLayers();
  // redibujar geocercas
  sUser.geofences.forEach(id=>{
    const gf=DB.geofences.find(g=>g.id===id); if(!gf) return;
    const ll=gf.coords.map(([lng2,lat2])=>[lat2,lng2]);
    L.polygon(ll,{color:'#41d39e'}).addTo(sLayer);
  });
  L.marker([lat,lng]).addTo(sLayer);
  L.circle([lat,lng],{radius:Math.max(15,accuracy||15)}).addTo(sLayer);
  sMap.setView([lat,lng], sMap.getZoom());

  // validación
  let inside=null;
  for(const id of sUser.geofences){
    const gf=DB.geofences.find(g=>g.id===id); if(!gf) continue;
    if(pointInPoly([lng,lat], gf.coords)){ inside=id; break; }
  }
  if(inside){
    DB.submissions.push({ts:Date.now(), phone:sUser.phone, userId:sUser.id, lat, lng, acc:accuracy||0, geofenceId:inside});
    saveDB();
    qs('#senderInfo').textContent='Dentro de geocerca: punto registrado.';
  }else{
    qs('#senderInfo').textContent='Fuera de geocerca: no se registra.';
  }
}

// ====== iniciar ======
if(isSender) initSender(); else initAdmin();
</script>
</body>
</html>
