<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Geocercas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    .label-in-map{background:transparent;border:none;box-shadow:none;color:#1f2937;font-weight:600;text-shadow:0 0 3px #ffffffc7}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .controls-layer{position:relative; z-index:1000; pointer-events:auto;}
    #map{touch-action:none;}
    .vertex-handle{width:12px;height:12px;background:#fff;border:2px solid #2563eb;border-radius:50%;box-shadow:0 0 0 2px #ffffffa8}
    .role-badge{font-size:.72rem;padding:.15rem .4rem;border-radius:.5rem}
    .role-owner{background:#1e293b;color:#fff}
    .role-admin{background:#0ea5e9;color:#fff}
    .role-staff{background:#10b981;color:#0b3b2e}
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px rgba(15,23,42,.06)}
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <div class="flex items-center justify-between mb-2">
      <h1 class="text-2xl font-bold">Gestión de Geocercas</h1>
      <div class="text-xs text-gray-600">Estado: <span id="statusDot" class="font-semibold">inicial</span></div>
    </div>

    <div class="grid md:grid-cols-3 gap-4 controls-layer">
      <!-- Columna izquierda: USUARIO + Geocerca activa -->
      <div class="card p-4">
        <!-- Usuario actual -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Usuario</label>
          <div class="mt-1 flex gap-2 items-stretch">
            <select id="userSelect" class="min-w-0 flex-1 border rounded-md p-2"></select>
            <button id="newUserBtn"    class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Nuevo</button>
            <button id="renameUserBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">Renombrar</button>
            <button id="deleteUserBtn" class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Eliminar</button>
          </div>
          <p class="text-xs text-gray-500 mt-1">El primer usuario está marcado como <span class="role-badge role-owner">owner</span>.</p>
        </div>
        <!-- Geocerca activa -->
        <label class="block text-sm font-medium text-gray-700">Geocerca activa</label>
        <select id="geofenceSelect" class="mt-1 w-full border rounded-md p-2"></select>
      </div>

      <!-- Acciones geocercas -->
      <div class="card p-4 relative">
        <div class="flex flex-wrap gap-2">
          <button id="newFenceBtn"    type="button" class="btn px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Nueva geocerca</button>
          <button id="finishFenceBtn" type="button" class="btn px-3 py-2 bg-green-600  text-white rounded-lg hover:bg-green-700" disabled>Finalizar</button>
          <button id="cancelFenceBtn" type="button" class="btn px-3 py-2 bg-gray-600   text-white rounded-lg hover:bg-gray-700" disabled>Cancelar</button>
        </div>

        <!-- Panel nombre -->
        <div id="nameBar" class="hidden mt-3 p-3 border rounded-xl bg-indigo-50 z-10">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex flex-wrap gap-2 items-stretch">
            <input id="nameField" class="min-w-0 flex-1 border rounded-md p-2" placeholder="Ej. Lote Norte" />
            <button id="saveNameBtn"   type="button" class="shrink-0 whitespace-nowrap px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Guardar nombre</button>
            <button id="cancelNameBtn" type="button" class="shrink-0 whitespace-nowrap px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Seguir dibujando</button>
          </div>
          <p class="text-xs text-gray-600 mt-2">Tip: Enter también guarda.</p>
        </div>

        <div class="flex flex-wrap gap-2 mt-3">
          <button id="createFenceByCoordsBtn" type="button" class="btn px-3 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Geocerca (Lat/Lng)</button>

          <button id="editFenceBtn"           type="button" class="btn px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn"       type="button" class="btn px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700" disabled>Guardar cambios</button>
          <button id="cancelFenceEditBtn"     type="button" class="btn px-3 py-2 bg-stone-500 text-white rounded-lg hover:bg-stone-600" disabled>Cancelar edición</button>

          <button id="renameFenceBtn"         type="button" class="btn px-3 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700" disabled>Renombrar</button>
        </div>

        <div class="flex flex-wrap gap-2 mt-2">
          <button id="deleteFenceBtn"   type="button" class="btn px-3 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700" disabled>Eliminar geocerca</button>
          <button id="exportGeoJsonBtn" type="button" class="btn px-3 py-2 bg-cyan-700 text-white rounded-lg hover:bg-cyan-800">Exportar GeoJSON</button>
          <label class="btn px-3 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJsonInput" type="file" accept=".json,.geojson,application/geo+json,application/json" class="hidden"/>
          </label>
        </div>
      </div>

      <!-- Ayuda -->
      <div class="card p-4 text-sm text-gray-700">
        <p><b>Dibujo:</b> Nueva geocerca → clics/toques para vértices → <i>Finalizar</i> (o doble clic / clic en el 1º punto).</p>
        <p class="mt-1"><b>Edición:</b> Selecciona una geocerca → <b>Editar</b> → arrastra vértices → <b>Guardar cambios</b> o <b>Cancelar edición</b>.</p>
        <p class="mt-1">También puedes crear por <b>Lat/Lng</b> (una línea <code>lat,lng</code> por vértice).</p>
        <div id="staffPanel" class="hidden mt-3 p-3 rounded-lg bg-emerald-50 border border-emerald-200">
          <div class="font-semibold mb-1">Modo Personal (staff)</div>
          <div class="text-xs text-gray-700 mb-2" id="staffAssignInfo">Geocerca asignada: —</div>
          <button id="sendPositionBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Enviar mi posición</button>
          <div id="staffMsg" class="text-xs mt-2"></div>
        </div>
      </div>
    </div>

    <!-- Mapa -->
    <div class="mt-4 card overflow-hidden">
      <div class="px-4 py-3 border-b"><h2 class="text-lg font-semibold">Mapa</h2></div>
      <div id="map" style="height:460px; position:relative; z-index:0;"></div>
    </div>

    <!-- Explorador -->
    <div class="mt-4 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Geocercas</h3></div>
      <ul id="fenceList" class="p-3 divide-y"></ul>
    </div>

    <!-- ADMINISTRACIÓN DE USUARIOS -->
    <div class="mt-6 card">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Administración de usuarios</h3>
        <div>
          <button id="createAdminBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 mr-2">Crear administrador</button>
          <button id="createStaffBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Crear personal</button>
        </div>
      </div>

      <div class="p-4 grid md:grid-cols-2 gap-4">
        <!-- Asignar geocerca a personal -->
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Asignar geocerca a personal</div>
          <div class="grid grid-cols-1 gap-2">
            <div>
              <label class="text-sm">Personal</label>
              <select id="assignStaffSelect" class="w-full border rounded-md p-2"></select>
            </div>
            <div>
              <label class="text-sm">Admin/Owner (fuente de geocercas)</label>
              <select id="assignAdminSelect" class="w-full border rounded-md p-2"></select>
            </div>
            <div>
              <label class="text-sm">Geocerca</label>
              <select id="assignFenceSelect" class="w-full border rounded-md p-2"></select>
            </div>
            <button id="doAssignBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Asignar</button>
            <div id="assignMsg" class="text-xs mt-1"></div>
          </div>
        </div>

        <!-- Ver check-ins -->
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Check-ins de personal</div>
          <div class="flex gap-2 mb-2">
            <select id="checkStaffSelect" class="border rounded-md p-2 flex-1"></select>
            <button id="refreshChecksBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white hover:bg-slate-800">Actualizar</button>
          </div>
          <ul id="checksList" class="text-sm text-gray-700 space-y-1 max-h-56 overflow-auto"></ul>
        </div>
      </div>

      <div class="px-4 py-3 border-t">
        <div id="usersTable" class="text-sm"></div>
      </div>
    </div>
  </div>

  <script>
    /* ========= MÓDULO DE USUARIOS / ROLES ========= */
    const APP = 'NobisApp';
    const USERS_KEY = APP + '_users';
    const CURR_USER_KEY = APP + '_current_user';
    const GEOFENCE_PREFIX = APP + '_geofences_';
    const ASSIGN_PREFIX = APP + '_staff_assign_';   // por staffId -> {adminId,fenceId}
    const CHECKS_PREFIX = APP + '_checkins_';       // por staffId -> [{ts,lat,lng,ok}]

    function getLegacyRaw(){
      try{
        var r = localStorage.getItem('geofences');
        if (r) return r;
        r = localStorage.getItem('geocercas');
        if (r) return r;
      }catch(e){}
      return null;
    }
    function uid(){ return 'u_' + Math.random().toString(36).slice(2,10); }
    function userKey(id){ return GEOFENCE_PREFIX + id; }

    function getUsers(){
      try{
        var raw = localStorage.getItem(USERS_KEY);
        var arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveUsers(arr){ localStorage.setItem(USERS_KEY, JSON.stringify(arr || [])); }
    function getCurrentUser(){ return localStorage.getItem(CURR_USER_KEY) || ''; }
    function setCurrentUser(id){ localStorage.setItem(CURR_USER_KEY, id || ''); }

    // Asegura usuarios + roles (primero = owner)
    function ensureUsersBootstrap(){
      var users = getUsers();
      var changed = false;

      if (users.length === 0){
        var firstId = uid();
        users = [{ id:firstId, name:'Usuario 1', role:'owner' }];
        saveUsers(users);
        setCurrentUser(firstId);

        var legacy = getLegacyRaw();
        if (legacy){ localStorage.setItem(userKey(firstId), legacy); }
        else{ localStorage.setItem(userKey(firstId), JSON.stringify([])); }
        return;
      }

      // Rellenar roles faltantes (primero owner, resto admin)
      for (var i=0;i<users.length;i++){
        if (!users[i].role){ users[i].role = (i===0)?'owner':'admin'; changed = true; }
      }
      if (changed) saveUsers(users);

      var curr = getCurrentUser();
      if (!curr) setCurrentUser(users[0].id);

      curr = getCurrentUser();
      if (!localStorage.getItem(userKey(curr))){
        localStorage.setItem(userKey(curr), JSON.stringify([]));
      }
    }

    function createUserWithRole(name, role){
      var users = getUsers();
      var id = uid();
      var clean = String(name || '').trim() || (role==='staff'?'Personal '+(users.length+1): 'Usuario '+(users.length+1));
      users.push({ id:id, name:clean, role:role||'admin' });
      saveUsers(users);
      // Para admins/owner, siempre BD de geocercas; para staff también, pero quedará vacía y no se usará
      localStorage.setItem(userKey(id), JSON.stringify([]));
      setCurrentUser(id);
      return id;
    }
    function createUser(name){ return createUserWithRole(name,'admin'); } // compatibilidad
    function renameUser(id, newName){
      var users = getUsers();
      for (var i=0;i<users.length;i++){
        if (users[i].id===id){
          users[i].name = String(newName||'').trim() || users[i].name;
          saveUsers(users); return;
        }
      }
    }
    function deleteUser(id){
      var users = getUsers();
      var idx = -1, role = 'admin';
      for (var i=0;i<users.length;i++){ if(users[i].id===id){ idx=i; role=users[i].role||'admin'; break; } }
      if (idx<0) return;
      if (role==='owner'){ alert('El dueño (owner) no se puede eliminar.'); return; }

      // borra su base y asignaciones/checadas si fuera staff
      localStorage.removeItem(userKey(id));
      localStorage.removeItem(ASSIGN_PREFIX+id);
      localStorage.removeItem(CHECKS_PREFIX+id);

      users.splice(idx,1); saveUsers(users);

      // Selección
      var newCurr = getCurrentUser();
      if (newCurr===id){
        if (users.length>0) setCurrentUser(users[0].id);
        else{
          var nid = createUserWithRole('Usuario 1','owner');
          setCurrentUser(nid);
        }
      }
    }

    /* ========= Persistencia de geocercas por usuario ========= */
    var CURRENT_USER_ID = "";
    function loadF(){
      var key = userKey(CURRENT_USER_ID);
      try{
        var t = localStorage.getItem(key);
        if (!t) return [];
        var a = JSON.parse(t);
        return Array.isArray(a) ? a : [];
      }catch(e){ return []; }
    }
    function saveF(arr){
      var key = userKey(CURRENT_USER_ID);
      localStorage.setItem(key, JSON.stringify(arr || []));
    }
    function nextDefaultName(){
      var fs = loadF(); var maxN = 0;
      for (var i=0;i<fs.length;i++){
        var nm = String((fs[i] && fs[i].name) || '');
        var m = nm.match(/geocerca\s+(\d+)/i);
        var n = m ? parseInt(m[1],10) : 0;
        if (n>maxN) maxN=n;
      }
      return 'Geocerca ' + (maxN ? maxN+1 : fs.length+1);
    }
    function roleOf(id){
      var users = getUsers();
      for (var i=0;i<users.length;i++){ if(users[i].id===id) return users[i].role||'admin'; }
      return 'admin';
    }
    function userById(id){
      var users = getUsers();
      for (var i=0;i<users.length;i++){ if(users[i].id===id) return users[i]; }
      return null;
    }

    /* ========= APP (mapa + geocercas) ========= */
    function $(id){ return document.getElementById(id); }
    function S(t){ var s=$('statusDot'); if(s) s.textContent=t; }
    var map, selectedId=null; var layers={};
    var STYLE={color:'#6d28d9',weight:3,fillColor:'#a78bfa',fillOpacity:.20};
    var STYLESEL={color:'#7c3aed',weight:4,fillColor:'#c4b5fd',fillOpacity:.26};
    var STYLEEDIT={color:'#0ea5e9',weight:3,fillColor:'#7dd3fc',fillOpacity:.18};

    // Dibujo temporal
    var drawing=false, temp=[], tempPoly=null, firstPt=null, onClick=null, onDbl=null, pendingCoords=null;
    // Edición manual
    var editing=false, backup=null, editHandles=[];
    var handleIcon = L.divIcon({className:'vertex-handle',iconSize:[12,12]});

    function init(){
      ensureUsersBootstrap();
      CURRENT_USER_ID = getCurrentUser();

      renderUserUI();

      map=L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
      map.setView([-1.5,-78.5],9);

      // Botones geocercas
      $('newFenceBtn').onclick=startDraw;
      $('finishFenceBtn').onclick=finishDraw;
      $('cancelFenceBtn').onclick=cancelDraw;

      $('saveNameBtn').onclick=saveNameFromBar;
      $('cancelNameBtn').onclick=function(){ hideNameBar(); pendingCoords=null; S('sigues dibujando'); $('finishFenceBtn').disabled = (temp.length<3); };
      $('nameField').addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); saveNameFromBar(); } });

      $('createFenceByCoordsBtn').onclick=createByLatLng;
      $('editFenceBtn').onclick=beginEdit;
      $('saveFenceEditBtn').onclick=saveEdit;
      $('cancelFenceEditBtn').onclick=cancelEdit;
      $('deleteFenceBtn').onclick=removeFence;
      $('exportGeoJsonBtn').onclick=exportGeoJSON;
      $('importGeoJsonInput').onchange=function(e){
        var f = e.target && e.target.files && e.target.files[0];
        if (f) importGeoJSON(f);
      };

      $('renameFenceBtn').onclick=showRenameBar;
      $('renameSaveBtn').onclick=commitRename;
      $('renameCancelBtn').onclick=function(){ $('renameBar').classList.add('hidden'); };

      // Admin Module
      $('createAdminBtn').onclick=function(){
        createUserWithRole(prompt('Nombre del administrador')||'', 'admin');
        renderAll(); renderUserUI(); renderAdminPanel();
        S('administrador creado (DB vacía)');
      };
      $('createStaffBtn').onclick=function(){
        createUserWithRole(prompt('Nombre del personal')||'', 'staff');
        renderAll(); renderUserUI(); renderAdminPanel();
        S('personal creado');
      };
      $('doAssignBtn').onclick=assignFenceToStaff;
      $('refreshChecksBtn').onclick=renderChecksList;
      $('assignAdminSelect').onchange=populateAssignFences;

      // Staff panel
      $('sendPositionBtn').onclick=staffSendPosition;

      renderAll();
      renderAdminPanel();
      applyRoleUI();
      S('mapa listo');
    }

    /* ======= UI de roles/usuarios ======= */
    function roleChip(role){
      var cls = role==='owner'?'role-owner':(role==='staff'?'role-staff':'role-admin');
      return '<span class="role-badge '+cls+'">'+role+'</span>';
    }
    function renderUserUI(){
      var users = getUsers();
      var sel = $('userSelect');
      var cur = getCurrentUser();
      var html='';
      for (var i=0;i<users.length;i++){
        var u=users[i];
        html+='<option value="'+u.id+'">'+u.name+' ['+(u.role||'admin')+']</option>';
      }
      sel.innerHTML = html;
      if (users.length) sel.value = cur || users[0].id;

      $('newUserBtn').onclick = function(){
        var r = prompt('Rol (admin/staff)? Escribe admin o staff','admin');
        if (!r) return;
        r=r.toLowerCase();
        if (r!=='admin' && r!=='staff'){ alert('Rol inválido'); return; }
        var name = prompt('Nombre del usuario:') || '';
        var id = createUserWithRole(name, r);
        CURRENT_USER_ID = id;
        selectedId = null;
        clearHandles();
        renderUserUI();
        renderAll();
        renderAdminPanel();
        applyRoleUI();
        S('usuario creado');
      };

      $('renameUserBtn').onclick = function(){
        var id = sel.value;
        var u = userById(id);
        if (!u) return;
        var name = prompt('Nuevo nombre del usuario:', u.name);
        if (name===null) return;
        renameUser(id, name);
        renderUserUI();
        renderAdminPanel();
        S('usuario renombrado');
      };

      $('deleteUserBtn').onclick = function(){
        var id = sel.value;
        var u = userById(id);
        if (!u) return;
        if (u.role==='owner'){ alert('No puedes eliminar al dueño.'); return; }
        if (!confirm('Eliminar usuario "'+u.name+'" y sus datos?')) return;
        deleteUser(id);
        CURRENT_USER_ID = getCurrentUser();
        selectedId = null;
        clearHandles();
        renderUserUI();
        renderAll();
        renderAdminPanel();
        applyRoleUI();
        S('usuario eliminado');
      };

      sel.onchange = function(e){
        setCurrentUser(e.target.value);
        CURRENT_USER_ID = e.target.value;
        selectedId = null;
        clearHandles();
        renderAll();
        renderAdminPanel();
        applyRoleUI();
        S('usuario cambiado');
      };
    }

    function applyRoleUI(){
      var role = roleOf(CURRENT_USER_ID);
      var isStaff = (role==='staff');

      // Habilita/Deshabilita edición de geocercas para staff
      $('newFenceBtn').disabled = isStaff;
      $('finishFenceBtn').disabled = true;
      $('cancelFenceBtn').disabled = true;
      $('createFenceByCoordsBtn').disabled = isStaff;
      $('editFenceBtn').disabled = isStaff || !selectedId || editing;
      $('saveFenceEditBtn').disabled = isStaff || !editing;
      $('cancelFenceEditBtn').disabled = isStaff || !editing;
      $('renameFenceBtn').disabled = isStaff || !selectedId || editing;
      $('deleteFenceBtn').disabled = isStaff || !selectedId || editing;

      // Panel staff visible solo para staff
      var sp = $('staffPanel');
      if (isStaff){ sp.classList.remove('hidden'); updateStaffAssignInfo(); }
      else{ sp.classList.add('hidden'); }
    }

    /* ======= Dibujo ======= */
    function disableMap(){ map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable(); map.boxZoom.disable(); map.touchZoom.disable(); map.keyboard.disable(); }
    function enableMap(){ map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable(); map.boxZoom.enable(); map.touchZoom.enable(); map.keyboard.enable(); }

    function startDraw(){
      if(editing){ alert('Termina/cancela la edición.'); return; }
      if (roleOf(CURRENT_USER_ID)==='staff'){ alert('El personal no puede dibujar geocercas.'); return; }
      clearTemp(); drawing=true; temp=[]; disableMap();
      onClick=function(e){ if(!drawing) return; var ll=e.latlng || (e.originalEvent ? map.mouseEventToLatLng(e.originalEvent) : null); if(!ll) return; addVertex(ll); };
      onDbl=function(){ if(drawing && temp.length>=3) finishDraw(); };
      map.on('mousedown',onClick); map.on('touchstart',onClick,{passive:false}); map.on('dblclick',onDbl);
      $('newFenceBtn').disabled=true; $('cancelFenceBtn').disabled=false; $('finishFenceBtn').disabled=true; S('modo dibujo');
    }
    function addVertex(ll){
      temp.push(ll);
      var ring = temp.length>1 ? temp.concat([temp[0]]) : temp.slice();
      if (tempPoly) map.removeLayer(tempPoly);
      tempPoly = L.polygon(ring,{color:'#059669',weight:2,fillColor:'#34d399',fillOpacity:.15,dashArray:'4 6'}).addTo(map);
      if(!firstPt){
        firstPt = L.circleMarker(ll,{radius:6,color:'#111827',weight:2,fillColor:'#f59e0b',fillOpacity:.9}).addTo(map).bindTooltip('Cerrar');
        firstPt.on('click',function(){ if(drawing && temp.length>=3) finishDraw(); });
      }
      $('finishFenceBtn').disabled = (temp.length<3);
      S('vértices: '+temp.length);
    }
    function finishDraw(){
      if(temp.length<3){ alert('Agrega al menos 3 puntos.'); return; }
      pendingCoords = temp.slice();
      showNameBar(nextDefaultName());
      S('ingresa el nombre y guarda');
    }
    function cancelDraw(){ clearTemp(); enableMap(); S('dibujo cancelado'); }
    function clearTemp(){
      drawing=false; temp=[]; pendingCoords=null;
      if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null; }
      if(firstPt){ map.removeLayer(firstPt); firstPt=null; }
      if(onClick){ map.off('mousedown',onClick); map.off('touchstart',onClick); onClick=null; }
      if(onDbl){ map.off('dblclick',onDbl); onDbl=null; }
      $('newFenceBtn').disabled=false; $('finishFenceBtn').disabled=true; $('cancelFenceBtn').disabled=true;
      hideNameBar();
    }

    function showNameBar(def){ $('nameBar').classList.remove('hidden'); $('nameField').value = String(def||'').trim() || nextDefaultName(); $('nameField').focus(); }
    function hideNameBar(){ $('nameBar').classList.add('hidden'); }
    function saveNameFromBar(){
      var name = String($('nameField').value || '').trim(); if(!name) name=nextDefaultName();
      var coords = pendingCoords || temp.slice(); if(!coords || coords.length<3){ alert('No hay coordenadas para guardar.'); return; }
      var id = 'f_' + Math.random().toString(36).slice(2,10);
      var path = coords.map(function(p){ return {lat:p.lat, lng:p.lng}; });
      var fences = loadF(); fences.push({id:id, name:name, path:path}); saveF(fences);
      clearTemp(); enableMap(); renderAll(); zoomTo(id); S('geocerca creada: '+name);
    }

    /* ======= Renombrar geocerca ======= */
    function showRenameBar(){
      if(!selectedId){
        var sel = $('geofenceSelect');
        var v = sel ? sel.value : '';
        if (v) selectFence(v);
      }
      if(!selectedId){ alert('Selecciona una geocerca.'); return; }
      if(editing){ alert('Termina/cancela la edición antes de renombrar.'); return; }
      var f=null, fs=loadF();
      for (var i=0;i<fs.length;i++){ if(fs[i].id===selectedId){ f=fs[i]; break; } }
      $('renameField').value = (f && f.name) ? f.name : '';
      $('renameBar').classList.remove('hidden');
      $('renameField').focus();
    }
    function commitRename(){
      if(!selectedId) return;
      var name = String($('renameField').value||'').trim() || nextDefaultName();
      var fences=loadF(); var i=-1;
      for (var k=0;k<fences.length;k++){ if(fences[k].id===selectedId){ i=k; break; } }
      if (i<0) return;
      fences[i].name = name; saveF(fences);
      $('renameBar').classList.add('hidden');
      renderAll(); selectFence(selectedId);
      S('nombre actualizado');
    }

    /* ======= Render / selección ======= */
    function renderAll(){
      for (var k in layers){ if(layers.hasOwnProperty(k)){ map.removeLayer(layers[k]); } }
      layers={};
      var fences=loadF();
      for (var i=0;i<fences.length;i++){
        var f=fences[i];
        if(!f.path || f.path.length<3) continue;
        var latlngs=f.path.map(function(p){ return [p.lat,p.lng]; });
        var poly=L.polygon(latlngs,STYLE).addTo(map);
        poly.bindTooltip((f.name||'Geocerca'),{permanent:true,direction:'center',className:'label-in-map'});
        (function(fid){ poly.on('click',function(){ selectFence(fid); }); })(f.id);
        layers[f.id]=poly;
      }
      if(!selectedId && fences.length){
        selectedId = fences[0].id;
        var s=$('geofenceSelect'); if(s) s.value=selectedId;
      }
      paintSel(); rebuildList(); fillSelect(); updateEditBtns();
    }
    function selectFence(id){ selectedId=id; paintSel(); updateEditBtns(); var s=$('geofenceSelect'); if(s) s.value=id||''; S('geocerca seleccionada'); }
    function paintSel(){ for (var id in layers){ if(layers.hasOwnProperty(id)){ layers[id].setStyle(id===selectedId?STYLESEL:STYLE); } } }
    function zoomTo(id){
      var fences=loadF(), f=null;
      for (var i=0;i<fences.length;i++){ if(fences[i].id===id){ f=fences[i]; break; } }
      if(!f) return;
      var p=L.polygon(f.path.map(function(pp){return [pp.lat,pp.lng];}));
      map.fitBounds(p.getBounds(),{padding:[20,20]});
      selectFence(id);
    }

    function rebuildList(){
      var ul=$('fenceList'); var fences=loadF().slice().sort(function(a,b){
        var na=(a && a.name)||'', nb=(b && b.name)||''; return na.localeCompare(nb);
      });
      if (!fences.length){ ul.innerHTML='<li class="py-6 text-center text-gray-500">No hay geocercas.</li>'; return; }
      var html='';
      for (var i=0;i<fences.length;i++){
        var f=fences[i];
        html+= '<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-id="'+f.id+'">'
             + '<div class="text-sm font-medium">'+((f && f.name)||'Geocerca')+'</div>'
             + '<div class="text-xs text-gray-500">'+((f && f.path && f.path.length)||0)+' puntos</div>'
             + '</div></li>';
      }
      ul.innerHTML=html;
      var nodes=ul.querySelectorAll('[data-id]');
      for (var j=0;j<nodes.length;j++){
        nodes[j].addEventListener('click',function(ev){ selectFence(ev.currentTarget.getAttribute('data-id')); });
        nodes[j].addEventListener('dblclick',function(ev){ zoomTo(ev.currentTarget.getAttribute('data-id')); });
      }
    }
    function fillSelect(){
      var fences=loadF(); var s=$('geofenceSelect'); var cur=s.value;
      var html=''; for (var i=0;i<fences.length;i++){ var f=fences[i]; html+='<option value="'+f.id+'">'+((f && f.name)||'Geocerca')+'</option>'; }
      s.innerHTML=html;
      if(!cur && fences.length){ s.value = selectedId || fences[0].id; }
      else{
        var ok=false; for (var k=0;k<fences.length;k++){ if(fences[k].id===cur){ ok=true; break; } }
        if (ok) s.value=cur;
      }
      s.onchange=function(e){ zoomTo(e.target.value); };
    }

    /* ======= Edición manual de vértices ======= */
    function getRing(layer){
      var ll=layer.getLatLngs();
      return Array.isArray(ll[0]) ? ll[0] : ll;
    }
    function createHandles(layer){
      clearHandles();
      var ring=getRing(layer);
      for (var i=0;i<ring.length;i++){
        (function(idx){
          var m=L.marker(ring[idx],{draggable:true,icon:handleIcon,zIndexOffset:1000}).addTo(map);
          m.on('drag',function(){
            var p=m.getLatLng();
            var r=getRing(layer).slice();
            r[idx]=p;
            layer.setLatLngs([r]);
          });
          editHandles.push(m);
        })(i);
      }
    }
    function clearHandles(){ for (var i=0;i<editHandles.length;i++){ map.removeLayer(editHandles[i]); } editHandles=[]; }

    function beginEdit(){
      if(roleOf(CURRENT_USER_ID)==='staff'){ alert('El personal no puede editar.'); return; }
      if(!selectedId){
        var sel = $('geofenceSelect'); var v = sel ? sel.value : '';
        if (v) selectFence(v);
      }
      if(!selectedId){ alert('Selecciona una geocerca.'); return; }
      if(drawing){ alert('Termina/cancela el dibujo.'); return; }

      var layer=layers[selectedId];
      if(!layer){ alert('No se encontró la capa.'); return; }

      var r = getRing(layer);
      backup = r.map(function(p){ return L.latLng(p.lat,p.lng); });
      layer.setStyle(STYLEEDIT);
      createHandles(layer);

      editing=true; updateEditBtns();
      S('modo edición — arrastra los puntos');
    }
    function saveEdit(){
      if(!selectedId) return;
      var layer=layers[selectedId]; if(!layer) return;
      var ring=getRing(layer);
      if(ring.length<3){ alert('Mínimo 3 puntos'); return; }
      var fences=loadF(); var i=-1;
      for (var k=0;k<fences.length;k++){ if(fences[k].id===selectedId){ i=k; break; } }
      if (i<0) return;
      fences[i].path = ring.map(function(p){ return {lat:p.lat,lng:p.lng}; });
      saveF(fences);
      clearHandles(); editing=false; backup=null; renderAll(); selectFence(selectedId); S('edición guardada');
    }
    function cancelEdit(){
      if(!selectedId) return;
      var layer=layers[selectedId]; if(!layer) return;
      if(backup) layer.setLatLngs([backup]);
      clearHandles(); editing=false; backup=null; paintSel(); updateEditBtns(); S('edición cancelada');
    }
    function updateEditBtns(){
      var isStaff = (roleOf(CURRENT_USER_ID)==='staff');
      $('editFenceBtn').disabled   = isStaff || (!selectedId || editing);
      $('deleteFenceBtn').disabled = isStaff || (!selectedId || editing);
      $('saveFenceEditBtn').disabled   = isStaff || (!editing);
      $('cancelFenceEditBtn').disabled = isStaff || (!editing);
      $('renameFenceBtn').disabled = isStaff || (!selectedId || editing);
    }

    /* ======= Import/Export ======= */
    function removeFence(){
      if(!selectedId) return;
      if(!confirm('¿Eliminar esta geocerca?')) return;
      var fs=loadF().filter(function(f){ return f.id!==selectedId; });
      saveF(fs); selectedId=null; renderAll(); S('geocerca eliminada');
    }
    function exportGeoJSON(){
      var fences=loadF();
      var features=[];
      for (var i=0;i<fences.length;i++){
        var f=fences[i];
        var coords=f.path.map(function(p){ return [p.lng,p.lat]; });
        coords.push([f.path[0].lng,f.path[0].lat]);
        features.push({type:'Feature',properties:{id:f.id,name:f.name},geometry:{type:'Polygon',coordinates:[coords]}});
      }
      var fc={type:'FeatureCollection',features:features};
      var blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
      var url=URL.createObjectURL(blob); var a=document.createElement('a');
      a.href=url; a.download='geocercas.geojson'; a.click(); URL.revokeObjectURL(url);
    }
    function importGeoJSON(file){
      var r=new FileReader();
      r.onload=function(){
        try{
          var fc=JSON.parse(r.result);
          if(fc.type!=='FeatureCollection') throw new Error('No es FeatureCollection');
          var fences=loadF();
          var feats = fc.features || [];
          for (var i=0;i<feats.length;i++){
            var ft=feats[i];
            var name = (ft.properties && ft.properties.name) ? ft.properties.name : nextDefaultName();
            var id   = (ft.properties && ft.properties.id)   ? ft.properties.id   : ('f_'+Math.random().toString(36).slice(2,10));
            var ring = (ft.geometry && ft.geometry.coordinates && ft.geometry.coordinates[0]) ? ft.geometry.coordinates[0] : [];
            var path=[];
            for (var j=0;j<ring.length-1;j++){ path.push({lat:ring[j][1],lng:ring[j][0]}); }
            if(path.length>=3) fences.push({id:id,name:name,path:path});
          }
          saveF(fences); renderAll(); S('geojson importado');
        }catch(e){ alert('Archivo inválido: '+e.message); }
      };
      r.readAsText(file);
    }

    /* ========= ADMINISTRACIÓN (asignaciones y check-ins) ========= */
    function loadUserFences(adminId){
      try{
        var t = localStorage.getItem(userKey(adminId));
        var a = t ? JSON.parse(t) : [];
        return Array.isArray(a) ? a : [];
      }catch(e){ return []; }
    }
    function setAssign(staffId, data){ localStorage.setItem(ASSIGN_PREFIX+staffId, JSON.stringify(data||null)); }
    function getAssign(staffId){
      try{
        var t = localStorage.getItem(ASSIGN_PREFIX+staffId);
        return t ? JSON.parse(t) : null;
      }catch(e){ return null; }
    }
    function pushCheck(staffId, rec){
      var key = CHECKS_PREFIX+staffId;
      var arr=[];
      try{ var t=localStorage.getItem(key); arr=t?JSON.parse(t):[]; if(!Array.isArray(arr)) arr=[]; }catch(e){}
      arr.unshift(rec);
      localStorage.setItem(key, JSON.stringify(arr));
    }
    function getChecks(staffId){
      var key=CHECKS_PREFIX+staffId;
      try{ var t=localStorage.getItem(key); var a=t?JSON.parse(t):[]; return Array.isArray(a)?a:[]; }catch(e){ return []; }
    }

    function renderAdminPanel(){
      // Tabla simple de usuarios
      var users = getUsers();
      var html = '<div class="overflow-auto"><table class="min-w-full text-left text-sm">'
        + '<thead><tr class="text-slate-500"><th class="px-2 py-1">Nombre</th><th class="px-2 py-1">Rol</th><th class="px-2 py-1">Acciones</th></tr></thead><tbody>';
      for (var i=0;i<users.length;i++){
        var u=users[i];
        html += '<tr class="border-t"><td class="px-2 py-1">'+u.name+'</td>'
              + '<td class="px-2 py-1">'+roleChip(u.role||'admin')+'</td>'
              + '<td class="px-2 py-1 text-slate-600">'+(u.role==='owner'?'—':'<span class="italic">Usa los botones de la parte superior</span>')+'</td></tr>';
      }
      html += '</tbody></table></div>';
      $('usersTable').innerHTML = html;

      // Selects de asignación
      var staffSel=$('assignStaffSelect'), adminSel=$('assignAdminSelect'), fenceSel=$('assignFenceSelect');
      var staffList=users.filter(function(u){return (u.role==='staff');});
      var admins=users.filter(function(u){return (u.role==='admin' || u.role==='owner');});

      var shtml=''; for (var s=0;s<staffList.length;s++){ shtml+='<option value="'+staffList[s].id+'">'+staffList[s].name+'</option>'; }
      staffSel.innerHTML=shtml;

      var ahtml=''; for (var a=0;a<admins.length;a++){ ahtml+='<option value="'+admins[a].id+'">'+admins[a].name+' ['+(admins[a].role||'admin')+']</option>'; }
      adminSel.innerHTML=ahtml;

      populateAssignFences(); // llena geocercas según adminSel

      // Select de checkins
      var csel=$('checkStaffSelect'); csel.innerHTML=shtml;
      renderChecksList();

      updateStaffAssignInfo();
    }
    function populateAssignFences(){
      var adminId = $('assignAdminSelect').value;
      var fences = loadUserFences(adminId);
      var fsel = $('assignFenceSelect');
      var html = '';
      for (var i=0;i<fences.length;i++){ html+='<option value="'+fences[i].id+'">'+(fences[i].name||'Geocerca')+'</option>'; }
      fsel.innerHTML = html;
    }
    function assignFenceToStaff(){
      var staffId = $('assignStaffSelect').value;
      var adminId = $('assignAdminSelect').value;
      var fenceId = $('assignFenceSelect').value;
      if (!staffId || !adminId || !fenceId){ $('assignMsg').textContent='Selecciona personal, admin y geocerca.'; return; }
      setAssign(staffId,{adminId:adminId,fenceId:fenceId});
      $('assignMsg').textContent='Asignación guardada ✔';
      updateStaffAssignInfo();
    }
    function renderChecksList(){
      var staffId = $('checkStaffSelect').value;
      var ul = $('checksList');
      var arr = staffId ? getChecks(staffId) : [];
      if (!arr.length){ ul.innerHTML='<li class="text-gray-500">Sin registros.</li>'; return; }
      var html='';
      for (var i=0;i<Math.min(arr.length,50);i++){
        var r=arr[i];
        html += '<li>['+(new Date(r.ts).toLocaleString())+'] '
             +  (r.ok?'<span class="text-emerald-700">DENTRO</span>':'<span class="text-rose-700">FUERA</span>')
             +  ' ('+r.lat.toFixed(5)+', '+r.lng.toFixed(5)+')</li>';
      }
      ul.innerHTML=html;
    }

    /* ========= STAFF: Enviar posición ========= */
    function updateStaffAssignInfo(){
      if (roleOf(CURRENT_USER_ID)!=='staff') return;
      var a = getAssign(CURRENT_USER_ID);
      var info = (a ? ('Geocerca asignada: '+((userById(a.adminId)||{}).name || '—')+' → '+(getFenceName(a.adminId,a.fenceId)||'—')) : 'Geocerca asignada: —');
      $('staffAssignInfo').textContent = info;
    }
    function getFenceName(adminId, fenceId){
      var fs = loadUserFences(adminId);
      for (var i=0;i<fs.length;i++){ if(fs[i].id===fenceId) return fs[i].name||'Geocerca'; }
      return null;
    }
    function getFencePath(adminId, fenceId){
      var fs = loadUserFences(adminId);
      for (var i=0;i<fs.length;i++){ if(fs[i].id===fenceId) return fs[i].path||[]; }
      return [];
    }
    // Punto en polígono (ray casting)
    function pointInPolygon(lat,lng, ring){
      var inside=false;
      for (var i=0,j=ring.length-1;i<ring.length;j=i++){
        var xi=ring[i].lat, yi=ring[i].lng;
        var xj=ring[j].lat, yj=ring[j].lng;
        var intersect = ((yi>lng)!=(yj>lng)) && (lat < (xj - xi)*(lng - yi)/(yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }
    function staffSendPosition(){
      var a = getAssign(CURRENT_USER_ID);
      var msg = $('staffMsg');
      if (!a){ msg.textContent='No tienes geocerca asignada.'; return; }
      if (!navigator.geolocation){
        msg.textContent='Geolocalización no disponible en este navegador.';
        return;
      }
      navigator.geolocation.getCurrentPosition(function(pos){
        var lat = pos.coords.latitude, lng = pos.coords.longitude;
        var ring = getFencePath(a.adminId, a.fenceId);
        var ok = ring.length>=3 ? pointInPolygon(lat,lng, ring) : false;
        pushCheck(CURRENT_USER_ID,{ts:Date.now(),lat:lat,lng:lng,ok:ok});
        msg.textContent = ok ? '✓ Posición enviada (DENTRO de la geocerca).' : '× Estás FUERA de la geocerca asignada.';
        renderChecksList();
      }, function(err){
        msg.textContent='Error/permiso de geolocalización: '+err.message;
      }, {enableHighAccuracy:true, timeout:10000});
    }

    /* ---------- GO ---------- */
    window.addEventListener('load', init);
  </script>
</body>
</html>

