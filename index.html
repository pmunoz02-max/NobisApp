<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>App Fincas · Geocercas + Trackers</title>

<!-- CSS Leaflet/Draw (si falla, hay fallback interno) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

<style>
:root{--c1:#0b5;--c2:#095;--danger:#d33}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#fafafa;color:#222}
header{position:sticky;top:0;z-index:10;display:flex;gap:.5rem;align-items:center;padding:.75rem 1rem;background:#fff;border-bottom:1px solid #ddd}
header h1{font-size:1rem;margin:0 0 0 .25rem;font-weight:700}
.wrap{max-width:1200px;margin:0 auto;padding:1rem}
.btn{border:1px solid #ccc;background:#fff;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
.btn.primary{background:var(--c1);border-color:var(--c2);color:#fff}
.btn.danger{background:var(--danger);border-color:#b12;color:#fff}
.badge{width:.75rem;height:.75rem;border-radius:50%;display:inline-block}.ok{background:#2ecc71}.idle{background:#bdc3c7}.no{background:#e74c3c}
nav.tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
nav.tabs button{border:1px solid #ddd;background:#fff;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
nav.tabs button.active{background:#222;color:#fff;border-color:#222}
section.panel{display:none;background:#fff;border:1px solid #e5e5e5;border-radius:.75rem;margin-top:1rem;padding:1rem}
section.panel.show{display:block}
.grid{display:grid;gap:1rem}.grid-2{grid-template-columns:1fr 1fr}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:.75rem;padding:1rem}
input,select,textarea{width:100%;padding:.5rem;border:1px solid #ddd;border-radius:.5rem}
.small{font-size:.86rem}.muted{color:#666}.hidden{display:none}
.map{height:520px;border-radius:.75rem;border:1px solid #e5e5e5}
.mini-map{height:360px;border-radius:.75rem;border:1px solid #e5e5e5}
.coords{position:absolute;right:.75rem;bottom:.75rem;background:rgba(255,255,255,.92);border:1px solid #ddd;border-radius:.5rem;padding:.25rem .5rem;font-size:.85rem}
/* Fallback esencial si no carga leaflet.css */
.leaflet-container{position:relative;overflow:hidden;outline:0}
.leaflet-pane,.leaflet-map-pane,.leaflet-tile-pane,.leaflet-overlay-pane,.leaflet-shadow-pane,.leaflet-marker-pane,.leaflet-tooltip-pane,.leaflet-popup-pane{position:absolute;left:0;top:0}
.leaflet-zoom-animated{transform-origin:0 0}
.leaflet-tile{position:absolute;width:256px;height:256px;border:0}
.leaflet-top,.leaflet-bottom{position:absolute;z-index:1000;pointer-events:none}.leaflet-top{top:10px}.leaflet-bottom{bottom:10px}
.leaflet-left{left:10px}.leaflet-right{right:10px}
.leaflet-bar{box-shadow:0 1px 5px rgba(0,0,0,.4);border-radius:4px}
.leaflet-bar a{background:#fff;border-bottom:1px solid #ccc;width:28px;height:28px;line-height:28px;text-align:center;display:block;color:#000;text-decoration:none;pointer-events:auto}
.leaflet-bar a:last-child{border-bottom:none}
.leaflet-control-zoom-in,.leaflet-control-zoom-out{font:bold 18px/28px Arial,Helvetica,sans-serif}
</style>

<!-- Loader multi‑CDN: garantiza Leaflet/Draw y después llama a __leafletReady() -->
<script>
(function(){
  function loadJS(src,cb){var s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>cb();s.onerror=()=>cb(new Error('x'));document.head.appendChild(s)}
  function chain(urls,test,done){(function nx(){if(!urls.length)return done(new Error('no cdn'));let u=urls.shift();loadJS(u,e=>{if(e||!test())nx();else done();});})();}
  const LJS=['https://unpkg.com/leaflet@1.9.4/dist/leaflet.js','https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js','https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js'];
  const DRAW=['https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js','https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js','https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js'];
  if(window.L){window.__leafletReady&&window.__leafletReady();return;}
  chain(LJS.slice(),()=>!!window.L,()=>chain(DRAW.slice(),()=>!!(L&&L.Control&&L.Control.Draw),()=>window.__leafletReady&&window.__leafletReady()));
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <div class="badge ok" title="App OK"></div>
  <h1>App Fincas · Geocercas + Trackers</h1>
  <div style="flex:1"></div>
  <label class="small muted" for="farmSelect" style="margin-right:.5rem">Finca:</label>
  <select id="farmSelect"></select>
  <button class="btn" id="btnNuevaFinca">Crear</button>
  <button class="btn danger" id="btnEliminarFinca">Eliminar Finca</button>
</header>

<!-- TRACKER (interfaz mínima) -->
<div id="trackerShell" class="wrap hidden">
  <div class="grid grid-2">
    <div class="card">
      <h2 style="margin:0 0 .5rem">Modo TRACKER</h2>
      <div id="trackerUserInfo" class="small muted">Cargando…</div>
      <div class="small muted" style="margin-top:.25rem">Frecuencia: <span id="freqSec">15</span> s</div>
      <div class="small" style="margin-top:.5rem">Asignado a geocerca: <span id="trackerFenceName" class="badge" style="background:#eee;width:auto;height:auto;border-radius:999px;padding:.1rem .5rem">—</span></div>
      <div class="small" style="margin-top:.75rem">
        <label><input type="checkbox" id="toggleSend"> Activar envío (solo dentro de la geocerca)</label>
      </div>
      <div class="small" style="margin-top:.5rem">
        Estado: <span id="trackerStateDot" class="badge idle"></span> <span id="trackerStateText">Inactivo</span><br>
        Último evento: <span id="lastEvent">—</span><br>
        Último envío: <span id="lastSend">—</span>
      </div>
    </div>
    <div class="card">
      <div id="miniMap" class="mini-map"></div>
      <div class="coords" id="miniCoords">—</div>
    </div>
  </div>
</div>

<!-- ADMIN (completo) -->
<div id="adminShell" class="wrap">
  <nav class="tabs" id="tabs">
    <button data-tab="geocercas" class="active">Geocercas</button>
    <button data-tab="personal">Personal</button>
    <button data-tab="reportes">Reportes</button>
    <button data-tab="config">Config</button>
  </nav>

  <section id="tab-geocercas" class="panel show">
    <div class="grid grid-2">
      <div>
        <div class="card">
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn" id="btnNuevaGeocerca">Nueva Geocerca</button>
            <button class="btn" id="btnEditarGeocerca">Editar Geocercas</button>
            <button class="btn primary" id="btnGuardarGeocercas">Guardar Cambios</button>
          </div>
          <div style="margin-top:.75rem">
            <label class="small">Crear desde Lat,Lng (una por línea)</label>
            <textarea id="coordsInput" placeholder="-0.12345,-78.56789&#10;-0.12300,-78.56850"></textarea>
            <div style="display:flex;gap:.5rem;margin-top:.5rem">
              <input id="newFenceName" placeholder="Nombre geocerca (ej. Lote A)"/>
              <button class="btn" id="btnCrearDesdeLista">Crear desde Lat/Lng</button>
            </div>
          </div>
        </div>
        <div style="position:relative;margin-top:1rem">
          <div id="map" class="map"><div id="mapDebug" style="position:absolute;left:.75rem;bottom:.75rem;background:rgba(255,255,255,.9);border:1px solid #ddd;border-radius:.5rem;padding:.25rem .5rem;font-size:.8rem;display:none"></div></div>
          <div class="coords" id="mapCoords">Lat: — Lng: —</div>
        </div>
      </div>
      <div>
        <div class="card">
          <h3 style="margin:0 0 .5rem">Listado de Geocercas</h3>
          <table id="fencesTable" style="width:100%;border-collapse:collapse">
            <thead><tr><th>Nombre</th><th>Vértices</th><th>Asignados</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="small muted" style="margin-top:.5rem">• Recuerda <b>Guardar Cambios</b> luego de editar.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-personal" class="panel">
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 .5rem">Nuevo Personal</h3>
        <div class="grid grid-2">
          <div><label>Nombre</label><input id="pNombre" placeholder="Nombre y Apellido"></div>
          <div><label>Teléfono (E.164)</label><input id="pTelefono" placeholder="+5939XXXXXXX"></div>
          <div><label>Rol</label><select id="pRol"><option>TRACKER</option><option>ADMIN</option></select></div>
          <div><label>Activo</label><select id="pActivo"><option value="true">Sí</option><option value="false">No</option></select></div>
          <div><label>Geocerca</label><select id="pGeocerca"></select></div>
          <div style="display:flex;align-items:flex-end;gap:.5rem"><button class="btn primary" id="btnAddPersonal">Añadir</button><span class="small muted">Se genera enlace.</span></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 .5rem">Personal</h3>
        <table id="personalTable" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Nombre</th><th>Teléfono</th><th>Rol</th><th>Activo</th><th>Geocerca</th><th>Enlace</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-reportes" class="panel">
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 .5rem">Registros de posiciones</h3>
        <div class="small muted">Solo se guardan cuando el TRACKER está dentro de su geocerca.</div>
        <div style="max-height:360px;overflow:auto;margin-top:.5rem">
          <table id="logsTable" style="width:100%;border-collapse:collapse">
            <thead><tr><th>Fecha/Hora</th><th>Teléfono</th><th>Geocerca</th><th>Lat</th><th>Lng</th><th>Accuracy</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:.5rem;display:flex;gap:.5rem">
          <button class="btn" id="btnExportCSV">Exportar CSV</button>
          <button class="btn" id="btnBorrarLogs">Borrar registros</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 .5rem">Gráfico: posiciones por día</h3>
        <canvas id="chartPos"></canvas>
      </div>
    </div>
  </section>

  <section id="tab-config" class="panel">
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 .5rem">Parámetros</h3>
        <label>Webhook (POST JSON opcional)</label>
        <input id="cfgWebhook" placeholder="https://mi-servidor/endpoint">
        <label style="margin-top:.5rem">Frecuencia (segundos)</label>
        <input id="cfgFreq" type="number" min="5" value="15">
        <div style="margin-top:.5rem"><button class="btn primary" id="btnGuardarCfg">Guardar Config</button></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 .5rem">Acceso rápido (TRACKER)</h3>
        <div style="display:flex;gap:.5rem;align-items:flex-end">
          <select id="quickUser"></select>
          <button class="btn" id="btnCopiarEnlace">Copiar enlace</button>
          <span id="copiedMsg" class="small muted"></span>
        </div>
        <div class="small muted" style="margin-top:.5rem">Formato: <code>?mode=tracker&phone=+593…&farm=ID&state=…</code></div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  // ===== Helpers
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=n=>(typeof n==='number')?Math.round(n*1e6)/1e6:n; const nowISO=()=>new Date().toISOString();
  const param=k=>new URL(location.href).searchParams.get(k);
  const escapeHtml=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  function encodeStateForShare(obj){const json=JSON.stringify(obj);return btoa(unescape(encodeURIComponent(json)));}
  function decodeStateFromShare(b64){try{const json=decodeURIComponent(escape(atob(b64)));return JSON.parse(json);}catch(_){return null;}}

  // ===== Estado
  const LS_PREFIX='app_geo_v2';
  const ctx={ farmId:null, data:{ fences:[], personal:[], logs:[], config:{webhook:'',freqSec:15} } };
  function storageKey(section){ return `${LS_PREFIX}_${ctx.farmId||'default'}_${section}`; }
  function loadAll(){ for(const k of Object.keys(ctx.data)){ try{ const raw=localStorage.getItem(storageKey(k)); if(raw) ctx.data[k]=JSON.parse(raw);}catch(e){} } }
  function saveAll(){ for(const k of Object.keys(ctx.data)){ localStorage.setItem(storageKey(k), JSON.stringify(ctx.data[k])); } refreshBindings(); }
  function ensureFarmList(){ const key=`${LS_PREFIX}_farms`; let arr=JSON.parse(localStorage.getItem(key)||'[]'); return {get:()=>arr,set:a=>{arr=a;localStorage.setItem(key,JSON.stringify(a));}}}
  const farmsState=ensureFarmList();

  function renderFarms(){ const arr=farmsState.get(); if(!ctx.farmId&&arr[0]) ctx.farmId=arr[0].id; $('#farmSelect').innerHTML=arr.map(f=>`<option value="${f.id}">${escapeHtml(f.nombre)}</option>`).join(''); if(ctx.farmId) $('#farmSelect').value=ctx.farmId; }
  function chooseFarm(id){ ctx.farmId=id; loadAll(); refreshBindings(); mapRenderFences(); renderLogs(); drawChart(); }

  $('#btnNuevaFinca').onclick=()=>{ const nombre=prompt('Nombre de la finca:'); if(!nombre) return; const id='f'+Date.now(); const arr=farmsState.get(); arr.push({id,nombre}); farmsState.set(arr); renderFarms(); chooseFarm(id); };
  $('#btnEliminarFinca').onclick=()=>{ if(!ctx.farmId) return; if(!confirm('¿Eliminar finca y todos sus datos?')) return; Object.keys(ctx.data).forEach(k=>localStorage.removeItem(storageKey(k))); const arr=farmsState.get().filter(f=>f.id!==ctx.farmId); farmsState.set(arr); ctx.farmId=arr[0]?.id||null; renderFarms(); if(ctx.farmId) chooseFarm(ctx.farmId); else location.reload(); };
  $('#farmSelect').onchange=()=>chooseFarm($('#farmSelect').value);

  // ===== Tabs (solo ADMIN)
  $('#tabs').addEventListener('click',e=>{
    if(e.target.tagName!=='BUTTON') return; const tab=e.target.dataset.tab;
    $$('#tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $$('section.panel').forEach(p=>p.classList.remove('show')); $(`#tab-${tab}`).classList.add('show');
    if(tab==='geocercas'){ try{ initMap(); map.invalidateSize(true); mapRenderFences(); }catch(_){ } }
    if(tab==='reportes'){ drawChart(); }
  });

  // ===== Leaflet (ADMIN)
  let map, drawnItems, drawControl;
  function initMap(){
    if(typeof L==='undefined'){ alert('Leaflet no cargó'); return; }
    const cont=$('#map'); if(!cont) return; if(map){ setTimeout(()=>{ try{map.invalidateSize(true)}catch(_){}} ,100); return; }
    if(cont.clientHeight<100) cont.style.height='520px';
    map=L.map('map');
    function addTiles(url){ const t=L.tileLayer(url,{maxZoom:19,attribution:'&copy; OpenStreetMap/Esri'}); t.addTo(map); return t; }
    let base=addTiles('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    base.on('tileerror',()=>{ try{map.removeLayer(base)}catch(_){ } base=addTiles('https://tile.openstreetmap.org/{z}/{x}/{y}.png'); base.on('tileerror',()=>{ try{map.removeLayer(base)}catch(_){ } base=addTiles('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'); base.on('tileerror',()=>{ try{map.removeLayer(base)}catch(_){ } addTiles('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');}); }); });
    drawnItems=new L.FeatureGroup(); map.addLayer(drawnItems);
    if(L.Control && L.Control.Draw){
      drawControl=new L.Control.Draw({ draw:{ polyline:false,rectangle:false,circle:false,circlemarker:false,marker:false, polygon:{allowIntersection:false,showArea:true}}, edit:{ featureGroup: drawnItems }});
      map.addControl(drawControl);
      map.on(L.Draw.Event.CREATED, e=>{ drawnItems.addLayer(e.layer); updateFencesFromLayers(); });
      map.on(L.Draw.Event.EDITED, ()=> updateFencesFromLayers());
    }
    map.on('mousemove',ev=> $('#mapCoords').textContent=`Lat: ${fmt(ev.latlng.lat)} Lng: ${fmt(ev.latlng.lng)}`);
    try{ L.control.zoom({position:'topleft'}).addTo(map); }catch(_){ }
    map.setView([-1.8312,-78.1834],6);
    setTimeout(()=>{ try{map.invalidateSize(true)}catch(_){}} ,250);
    window.addEventListener('resize',()=>{ try{map.invalidateSize(true)}catch(_){}} );
  }
  function layerToCoords(layer){ const latlngs=layer.getLatLngs(); const first=Array.isArray(latlngs[0])?latlngs[0]:latlngs; return first.map(ll=>[ll.lat,ll.lng]); }
  function coordsToLayer(coords){ return L.polygon(coords,{color:'#0b5',weight:2,fillOpacity:.1}); }
  function centroid(coords){ let x=0,y=0; coords.forEach(c=>{x+=c[0];y+=c[1]}); return [x/coords.length,y/coords.length]; }
  function updateFencesFromLayers(){ const out=[]; drawnItems.eachLayer(ly=>{ const coords=layerToCoords(ly); let name='Geocerca '+(ctx.data.fences.length+out.length+1); let id='g'+Date.now()+Math.random().toString(36).slice(2,6); const c=centroid(coords); const m=ctx.data.fences.find(f=>{const cc=centroid(f.coords); return Math.hypot(c[0]-cc[0],c[1]-cc[1])<0.0008;}); if(m){name=m.name; id=m.id;} out.push({id,name,coords,color:'#0b5'}); }); ctx.data.fences=out; saveAll(); renderFencesTable(); refreshFenceSelects(); }
  function mapRenderFences(){ if(!map||!drawnItems) return; drawnItems.clearLayers(); if(ctx.data.fences.length===0){ try{ map.setView([-1.8312,-78.1834],6);}catch(_){ } return; } const layers=ctx.data.fences.map(f=>coordsToLayer(f.coords).bindTooltip(f.name)); layers.forEach(l=>drawnItems.addLayer(l)); try{ map.fitBounds(L.featureGroup(layers).getBounds().pad(.2)); }catch(_){ } }
  function renderFencesTable(){ const tb=$('#fencesTable tbody'); tb.innerHTML=''; const assigned=Object.fromEntries(ctx.data.fences.map(f=>[f.id,0])); ctx.data.personal.forEach(p=>{ if(p.geocercaId) assigned[p.geocercaId]=(assigned[p.geocercaId]||0)+1; }); for(const f of ctx.data.fences){ const tr=document.createElement('tr'); tr.innerHTML=`<td contenteditable onblur="window._renameFence('${f.id}',this.textContent)">${escapeHtml(f.name)}</td><td>${f.coords.length}</td><td>${assigned[f.id]||0}</td><td><button class="btn" onclick="window._zoomFence('${f.id}')">Zoom</button><button class="btn danger" onclick="window._deleteFence('${f.id}')">Borrar</button></td>`; tb.appendChild(tr);} }
  window._zoomFence=id=>{ const f=ctx.data.fences.find(x=>x.id===id); if(!f||!map) return; try{ map.fitBounds(coordsToLayer(f.coords).getBounds().pad(.2)); }catch(_){ } }
  window._deleteFence=id=>{ if(!confirm('¿Eliminar geocerca?')) return; ctx.data.fences=ctx.data.fences.filter(f=>f.id!==id); saveAll(); mapRenderFences(); renderFencesTable(); }
  window._renameFence=(id,name)=>{ const f=ctx.data.fences.find(x=>x.id===id); if(!f) return; f.name=(name||'').trim()||f.name; saveAll(); renderFencesTable(); refreshFenceSelects(); }
  $('#btnNuevaGeocerca').onclick=()=>{ try{ new L.Draw.Polygon(map).enable(); }catch(e){ alert('Leaflet.draw no disponible'); } };
  let editing=false; $('#btnEditarGeocerca').onclick=()=>{ editing=!editing; try{ new L.EditToolbar.Edit(map,{featureGroup:drawnItems})[editing?'enable':'disable'](); $('#btnEditarGeocerca').textContent= editing?'Salir de Edición':'Editar Geocercas'; }catch(e){ alert('Leaflet.draw no disponible'); } };
  $('#btnGuardarGeocercas').onclick=()=>{ updateFencesFromLayers(); alert('Cambios guardados.'); };
  $('#btnCrearDesdeLista').onclick=()=>{ const name=$('#newFenceName').value.trim(); const txt=$('#coordsInput').value.trim(); if(!txt) return alert('Pega coordenadas'); const coords=txt.split(/\n+/).map(l=>{ const [a,b]=l.split(',').map(s=>parseFloat(s.trim())); return (Number.isFinite(a)&&Number.isFinite(b))?[a,b]:null; }).filter(Boolean); if(coords.length<3) return alert('Se requieren ≥3 puntos'); const layer=coordsToLayer(coords).bindTooltip(name||('Geocerca '+(ctx.data.fences.length+1))); drawnItems.addLayer(layer); updateFencesFromLayers(); $('#coordsInput').value=''; $('#newFenceName').value=''; };

  // ===== Personal
  function refreshFenceSelects(){ $('#pGeocerca').innerHTML=['<option value="">(sin asignar)</option>'].concat(ctx.data.fences.map(f=>`<option value="${f.id}">${escapeHtml(f.name)}</option>`)).join(''); }
  function refreshActivePersonalSelects(){ const trackers=ctx.data.personal.filter(p=>p.rol==='TRACKER'); $('#quickUser').innerHTML=trackers.map(p=>`<option value="${p.id}">${escapeHtml(p.nombre)} (${escapeHtml(p.telefono)})</option>`).join(''); }
  $('#btnAddPersonal').onclick=()=>{ const nombre=$('#pNombre').value.trim(); const telefono=$('#pTelefono').value.trim(); if(!nombre||!telefono) return alert('Completa nombre y teléfono'); const rol=$('#pRol').value; const activo=$('#pActivo').value==='true'; const geocercaId=$('#pGeocerca').value||''; ctx.data.personal.push({id:'p'+Date.now(),nombre,telefono,rol,activo,geocercaId}); saveAll(); renderPersonalTable(); refreshActivePersonalSelects(); $('#pNombre').value=''; $('#pTelefono').value=''; };
  function trackerLinkFor(p){ const fence = ctx.data.fences.find(f=>f.id===p.geocercaId) || null; const snapshot={ farmId: ctx.farmId, personal:{ id:p.id,nombre:p.nombre,telefono:p.telefono,activo:p.activo,rol:p.rol,geocercaId:p.geocercaId }, fences: fence? [{id:fence.id,name:fence.name,coords:fence.coords,color:'#0b5'}] : [], config:{freqSec:ctx.data.config.freqSec||15} }; const u=new URL(location.href); u.search=''; u.hash=''; u.searchParams.set('mode','tracker'); u.searchParams.set('phone',p.telefono); if(ctx.farmId) u.searchParams.set('farm',ctx.farmId); u.searchParams.set('state', encodeStateForShare(snapshot)); return u.toString(); }
  function renderPersonalTable(){ const tb=$('#personalTable tbody'); if(!tb) return; tb.innerHTML=''; for(const p of ctx.data.personal){ const tr=document.createElement('tr'); tr.innerHTML=`<td contenteditable onblur=\"window._pf('${p.id}','nombre',this.textContent)\">${escapeHtml(p.nombre)}</td><td contenteditable onblur=\"window._pf('${p.id}','telefono',this.textContent)\">${escapeHtml(p.telefono)}</td><td><select onchange=\"window._pf('${p.id}','rol',this.value)\"><option ${p.rol==='TRACKER'?'selected':''}>TRACKER</option><option ${p.rol==='ADMIN'?'selected':''}>ADMIN</option></select></td><td><select onchange=\"window._pf('${p.id}','activo',this.value)\"><option value=\"true\" ${p.activo?'selected':''}>Sí</option><option value=\"false\" ${!p.activo?'selected':''}>No</option></select></td><td><select onchange=\"window._pf('${p.id}','geocercaId',this.value)\"><option value=\"\">(sin)</option>${ctx.data.fences.map(f=>`<option value=\"${f.id}\" ${p.geocercaId===f.id?'selected':''}>${escapeHtml(f.name)}</option>`).join('')}</select></td><td><input readonly value=\"${trackerLinkFor(p)}\" style=\"width:260px\"/></td><td><button class=\"btn\" onclick=\"window.open('${trackerLinkFor(p)}','_blank')\">Abrir</button></td>`; tb.appendChild(tr);} }
  window._pf=(id,field,value)=>{ const p=ctx.data.personal.find(x=>x.id===id); if(!p) return; if(field==='activo') value=(value==='true'); p[field]=value; saveAll(); renderPersonalTable(); refreshActivePersonalSelects(); };

  // ===== Reportes
  function renderLogs(){ const tb=$('#logsTable tbody'); if(!tb) return; tb.innerHTML=''; for(const Lg of ctx.data.logs.slice().reverse()){ const f=ctx.data.fences.find(x=>x.id===Lg.geocercaId)?.name||Lg.geocercaId||''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(Lg.ts)}</td><td>${escapeHtml(Lg.telefono)}</td><td>${escapeHtml(f)}</td><td>${fmt(Lg.lat)}</td><td>${fmt(Lg.lng)}</td><td>${Lg.acc??''}</td>`; tb.appendChild(tr);} }
  $('#btnExportCSV').onclick=()=>{ const rows=[["ts","telefono","geocerca","lat","lng","accuracy"]].concat(ctx.data.logs.map(l=>[l.ts,l.telefono,l.geocercaId,l.lat,l.lng,l.acc])); const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'\\"')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`logs_${ctx.farmId||'finca'}.csv`; a.click(); };
  $('#btnBorrarLogs').onclick=()=>{ if(!confirm('¿Borrar todos los registros?')) return; ctx.data.logs=[]; saveAll(); renderLogs(); };
  let chart; function drawChart(){ const data={}; for(const l of ctx.data.logs){ const d=l.ts.slice(0,10); data[d]=(data[d]||0)+1; } const labels=Object.keys(data).sort(); const values=labels.map(k=>data[k]); const el=document.getElementById('chartPos'); if(!el) return; if(chart) chart.destroy(); chart=new Chart(el,{type:'bar',data:{labels,datasets:[{label:'Posiciones/día',data:values}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}}); }

  // ===== Config
  function renderConfig(){ $('#cfgWebhook').value=ctx.data.config.webhook||''; $('#cfgFreq').value=ctx.data.config.freqSec||15; $('#freqSec').textContent=ctx.data.config.freqSec||15; }
  $('#btnGuardarCfg').onclick=()=>{ ctx.data.config.webhook=$('#cfgWebhook').value.trim(); const f=parseInt($('#cfgFreq').value,10); ctx.data.config.freqSec=Number.isFinite(f)&&f>0?f:15; saveAll(); alert('Configuración guardada.'); };

  // ===== Utilidades multi-finca
  function loadSectionForFarm(farmId, section){ try{ return JSON.parse(localStorage.getItem(`${LS_PREFIX}_${farmId}_${section}`)||'[]'); }catch(_){ return []; } }
  function resolveFarmByPhone(phone){ if(!phone) return null; const farms=ensureFarmList().get(); for(const f of farms){ const people=loadSectionForFarm(f.id,'personal'); const hit=people.find(p=>p.telefono===phone && p.activo); if(hit) return f.id; } return null; }

  // ===== TRACKER
  let miniMap, miniFenceLayer, watchId=null, sendTimer=null, trackerUser=null, trackerFence=null, lastPos=null, lastInside=false;
  function initTracker(){
    const phone=param('phone'); let farm=param('farm');
    // Cargar snapshot del enlace si viene
    const rawState=param('state'); if(rawState){ const snap=decodeStateFromShare(rawState); if(snap&&snap.farmId){ ctx.farmId=snap.farmId; ctx.data.fences=snap.fences||[]; ctx.data.personal=snap.personal?[snap.personal]:[]; ctx.data.config.freqSec=(snap.config&&snap.config.freqSec)||ctx.data.config.freqSec; }}
    if(!farm){ const guess=resolveFarmByPhone(phone); if(guess) farm=guess; }
    if(farm){ ctx.farmId=farm; renderFarms(); chooseFarm(farm); }
    trackerUser=ctx.data.personal.find(p=>p.telefono===phone)||null; const ok=!!(trackerUser && trackerUser.activo);
    $('#trackerUserInfo').textContent= ok? `${trackerUser.nombre} · ${trackerUser.telefono}` : `Teléfono ${phone||'(no provisto)'} · Usuario no encontrado o inactivo`;
    trackerFence=ctx.data.fences.find(f=>f.id===trackerUser?.geocercaId); $('#trackerFenceName').textContent = trackerFence? trackerFence.name : '(sin asignar)';
    // Mini-mapa
    miniMap=L.map('miniMap'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(miniMap);
    if(trackerFence){ miniFenceLayer=coordsToLayer(trackerFence.coords).addTo(miniMap); miniMap.fitBounds(miniFenceLayer.getBounds().pad(.3)); } else { miniMap.setView([-1.8312,-78.1834],6); }
    miniMap.on('mousemove',ev=> $('#miniCoords').textContent=`Lat: ${fmt(ev.latlng.lat)} Lng: ${fmt(ev.latlng.lng)}`);
    $('#toggleSend').onchange=e=>toggleSending(e.target.checked);
  }
  function pointInPolygon(point, vs){ const x=point[1], y=point[0]; let inside=false; for(let i=0,j=vs.length-1;i<vs.length;j=i++){ const xi=vs[i][1], yi=vs[i][0], xj=vs[j][1], yj=vs[j][0]; const intersect=((yi>y)!=(yj>y))&&(x< (xj-xi)*(y-yi)/((yj-yi)||1e-12)+xi); if(intersect) inside=!inside; } return inside; }
  function setState(kind,text){ const dot=$('#trackerStateDot'); const tx=$('#trackerStateText'); dot.classList.remove('ok','no','idle'); dot.classList.add(kind); tx.textContent=text; }
  function toggleSending(on){ setState(on?'ok':'idle', on?'Envío activo':'Inactivo'); if(on){ if(!('geolocation' in navigator)){ alert('Geolocalización no disponible'); $('#toggleSend').checked=false; setState('no','Error'); return; } if(!trackerFence){ alert('No tienes geocerca asignada.'); $('#toggleSend').checked=false; setState('idle','Sin geocerca'); return; } if(watchId===null){ watchId=navigator.geolocation.watchPosition(onPos,onGeoErr,{enableHighAccuracy:true,maximumAge:10000,timeout:20000}); } const freq=ctx.data.config.freqSec||15; if(sendTimer) clearInterval(sendTimer); sendTimer=setInterval(trySend,freq*1000); trySend(); }else{ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } if(sendTimer){ clearInterval(sendTimer); sendTimer=null; } } }
  function onPos(pos){ const {latitude,longitude,accuracy}=pos.coords; lastPos={lat:latitude,lng:longitude,acc:accuracy,ts:nowISO()}; $('#miniCoords').textContent=`Lat: ${fmt(latitude)} Lng: ${fmt(longitude)} (±${Math.round(accuracy)}m)`; if(window._myM) _myM.setLatLng([latitude,longitude]); else window._myM=L.marker([latitude,longitude]).addTo(miniMap); if(trackerFence&&miniFenceLayer){ const b=miniFenceLayer.getBounds(); if(!b.contains([latitude,longitude])) miniMap.fitBounds(b.pad(.3)); } lastInside= trackerFence? pointInPolygon([latitude,longitude], trackerFence.coords) : false; setState(lastInside?'ok':'no', lastInside?'Dentro de geocerca':'Fuera de geocerca'); $('#lastEvent').textContent=`${lastPos.ts} · ${lastInside?'Dentro':'Fuera'} (${Math.round(accuracy)}m)`; }
  function onGeoErr(err){ $('#lastEvent').textContent=`Error GPS: ${err.message}`; setState('no','GPS error'); }
  function trySend(){ if(!$('#toggleSend').checked||!lastPos||!lastInside) return; const payload={ ts:lastPos.ts, telefono:trackerUser?.telefono||param('phone')||'desconocido', geocercaId:trackerUser?.geocercaId||(trackerFence?.id||''), lat:lastPos.lat, lng:lastPos.lng, acc:lastPos.acc, farmId:ctx.farmId }; ctx.data.logs.push(payload); saveAll(); renderLogs(); const url=(ctx.data.config.webhook||'').trim(); if(url){ const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); const ok=(navigator.sendBeacon && navigator.sendBeacon(url,blob)); if(!ok){ fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{}); } } $('#lastSend').textContent=nowISO(); }

  // ===== Binding general
  function refreshBindings(){ renderConfig(); refreshFenceSelects(); refreshActivePersonalSelects(); renderFencesTable(); renderPersonalTable(); renderLogs(); }

  // ===== Arranque con control de rol/mode =====
  function start(){
    const mode=(param('mode')||'').toLowerCase();
    // Si llega snapshot en la URL y el usuario NO es admin, forzamos tracker
    const rawState=param('state'); if(rawState && mode!=='admin'){ $('#adminShell').classList.add('hidden'); $('#trackerShell').classList.remove('hidden'); initTracker(); return; }

    renderFarms(); if(!ctx.farmId){ const id='f'+Date.now(); const arr=farmsState.get(); arr.push({id,nombre:'Mi Finca'}); farmsState.set(arr); ctx.farmId=id; renderFarms(); }
    chooseFarm(ctx.farmId);

    // Gate: si ?mode=tracker o hay ?phone válido y su rol=TRACKER => SOLO tracker
    const phone=param('phone'); const person=ctx.data.personal.find(p=>p.telefono===phone);
    if(mode==='tracker' || (phone && person && person.rol==='TRACKER')){
      $('#adminShell').classList.add('hidden'); $('#trackerShell').classList.remove('hidden'); initTracker(); return;
    }

    // Caso normal: ADMIN
    $('#trackerShell').classList.add('hidden'); $('#adminShell').classList.remove('hidden'); initMap(); mapRenderFences();
  }

  if(typeof window.L==='undefined'){ window.__leafletReady=start; } else { start(); }
})();
</script>
</body>
</html>
