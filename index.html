<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NobisApp</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{background:#f3f4f6}
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    #map{height:520px;min-height:380px;width:100%;background:#eef2f7}
    .label-in-map{background:transparent;border:none;box-shadow:none;color:#1f2937;font-weight:600;text-shadow:0 0 3px #ffffffc7}
    .btn:disabled{opacity:.45;cursor:not-allowed}
  </style>
</head>
<body class="text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Gestión de Geocercas</h1>
      <div class="text-xs text-gray-600">Estado: <span id="statusDot" class="font-semibold">inicial</span></div>
    </div>

    <!-- Barra superior mínima para no romper nada que ya funcione -->
    <div class="grid md:grid-cols-3 gap-4">
      <div class="card p-4">
        <label class="block text-sm font-medium mb-1">Usuario</label>
        <div class="flex gap-2">
          <select id="userSelect" class="min-w-0 flex-1 border rounded-md p-2"></select>
          <button id="newUserBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Nuevo</button>
          <button id="renameUserBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Renombrar</button>
          <button id="deleteUserBtn" class="px-3 py-2 rounded-lg bg-rose-600 text-white">Eliminar</button>
        </div>

        <label class="block text-sm font-medium mt-4">Geocerca activa</label>
        <select id="geofenceSelect" class="w-full border rounded-md p-2 mt-1"></select>
      </div>

      <div class="card p-4">
        <div class="flex flex-wrap gap-2">
          <button id="newFenceBtn" class="btn px-3 py-2 bg-indigo-600 text-white rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="btn px-3 py-2 bg-green-600 text-white rounded-lg" disabled>Finalizar</button>
          <button id="cancelFenceBtn" class="btn px-3 py-2 bg-gray-600 text-white rounded-lg" disabled>Cancelar</button>
        </div>

        <div id="nameBar" class="hidden mt-3 p-3 border rounded-xl bg-indigo-50">
          <label class="text-sm font-medium">Nombre de la geocerca</label>
          <div class="mt-1 flex gap-2">
            <input id="nameField" class="flex-1 border rounded-md p-2" placeholder="Ej. Lote Norte" />
            <button id="saveNameBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Guardar nombre</button>
            <button id="cancelNameBtn" class="px-3 py-2 rounded-lg bg-gray-200">Seguir dibujando</button>
          </div>
          <p class="text-xs text-gray-600 mt-2">Tip: Enter también guarda.</p>
        </div>

        <div class="flex flex-wrap gap-2 mt-3">
          <button id="createFenceByCoordsBtn" class="btn px-3 py-2 bg-teal-600 text-white rounded-lg">Geocerca (Lat/Lng)</button>
          <button id="editFenceBtn" class="btn px-3 py-2 bg-amber-500 text-white rounded-lg" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn" class="btn px-3 py-2 bg-emerald-600 text-white rounded-lg" disabled>Guardar cambios</button>
          <button id="cancelFenceEditBtn" class="btn px-3 py-2 bg-stone-500 text-white rounded-lg" disabled>Cancelar edición</button>
          <button id="renameFenceBtn" class="btn px-3 py-2 bg-sky-600 text-white rounded-lg" disabled>Renombrar</button>
        </div>

        <div class="flex flex-wrap gap-2 mt-2">
          <button id="deleteFenceBtn" class="btn px-3 py-2 bg-rose-600 text-white rounded-lg" disabled>Eliminar geocerca</button>
          <button id="exportGeoJsonBtn" class="px-3 py-2 rounded-lg bg-cyan-700 text-white">Exportar GeoJSON</button>
          <label class="px-3 py-2 rounded-lg bg-slate-700 text-white cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJsonInput" type="file" accept=".json,.geojson,application/geo+json,application/json" class="hidden">
          </label>
        </div>
      </div>

      <div class="card p-4 text-sm">
        <p><b>Dibujo:</b> Nueva geocerca → clics/toques → <i>Finalizar</i> (o doble clic / clic en el 1º punto).</p>
        <p class="mt-1"><b>Edición:</b> Selecciona una geocerca → <b>Editar</b> → arrastra vértices → <b>Guardar cambios</b>.</p>
        <p class="mt-1">También puedes crear por <b>Lat/Lng</b> (una línea <code>lat,lng</code> por vértice).</p>
      </div>
    </div>

    <!-- MAPA -->
    <div class="mt-4 card overflow-hidden">
      <div class="px-4 py-3 border-b"><h2 class="text-lg font-semibold">Mapa</h2></div>
      <div id="map"></div>
    </div>

    <!-- Geocercas -->
    <div class="mt-4 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Geocercas</h3></div>
      <ul id="fenceList" class="p-3 divide-y"></ul>
    </div>

    <!-- Gestión de personal -->
    <div id="personnelModule" class="mt-6 card">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Gestión de personal</h3>
        <div class="flex items-center gap-2">
          <button id="addStaffFromPersonnel" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Añadir personal</button>
          <button id="refreshPersonnelBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white">Refrescar</button>
        </div>
      </div>
      <div class="p-4">
        <div id="staffTable" class="text-sm overflow-auto"></div>
        <div id="noStaffHint" class="hidden mt-3 text-sm text-gray-600">
          No hay personal creado. Usa <b>Añadir personal</b> o crea desde <b>Administración</b>.
        </div>
      </div>
    </div>

    <!-- Actividades -->
    <div id="activitiesModule" class="mt-6 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Actividades</h3></div>
      <div class="p-4 grid md:grid-cols-3 gap-4">
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Catálogo de actividades</div>
          <div class="flex gap-2 mb-3">
            <input id="actNewName" class="flex-1 border rounded-md p-2" placeholder="Ej. Siembra, Riego, Cosecha" />
            <button id="actAddBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Añadir</button>
          </div>
          <ul id="actList" class="text-sm space-y-1"></ul>
        </div>
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Registrar actividad</div>
          <div class="grid gap-2">
            <div><label class="text-sm">Personal</label><select id="actStaffSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Actividad</label><select id="actSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Nota</label><input id="actNote" class="w-full border rounded-md p-2" placeholder="Opcional" /></div>
            <div class="flex gap-2">
              <button id="actLogGpsBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Registrar (con GPS)</button>
              <button id="actLogManualBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white">Registrar (manual)</button>
            </div>
            <div id="actMsg" class="text-xs"></div>
          </div>
        </div>
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Registros</div>
          <div class="flex gap-2 mb-2">
            <select id="logStaffFilter" class="border rounded-md p-2 flex-1"></select>
            <button id="exportCsvBtn" class="px-3 py-2 rounded-lg bg-cyan-700 text-white">Exportar CSV</button>
          </div>
          <ul id="actLogs" class="text-sm space-y-1 max-h-60 overflow-auto"></ul>
        </div>
      </div>
    </div>

    <!-- Reportes -->
    <div id="reportsModule" class="mt-6 card">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Reportes</h3></div>
      <div class="p-4">
        <div id="repSummary" class="grid md:grid-cols-5 gap-3 mb-4"></div>
        <div class="flex gap-2">
          <button id="exportChecksBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Exportar Check-ins CSV</button>
          <button id="exportActsBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Exportar Actividades CSV</button>
        </div>
      </div>
    </div>

    <!-- Administración -->
    <div id="adminModule" class="mt-6 card">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Administración de usuarios</h3>
        <div>
          <button id="createAdminBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white mr-2">Crear administrador</button>
          <button id="createStaffBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Crear personal</button>
        </div>
      </div>

      <div class="p-4 grid md:grid-cols-2 gap-4">
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Asignar geocerca a personal</div>
          <div class="grid grid-cols-1 gap-2">
            <div><label class="text-sm">Personal</label><select id="assignStaffSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Admin/Owner (fuente geocercas)</label><select id="assignAdminSelect" class="w-full border rounded-md p-2"></select></div>
            <div><label class="text-sm">Geocerca</label><select id="assignFenceSelect" class="w-full border rounded-md p-2"></select></div>
            <button id="doAssignBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Asignar</button>
            <div id="assignMsg" class="text-xs mt-1"></div>
          </div>
        </div>

        <div class="border rounded-xl p-3">
          <div class="font-medium mb-2">Check-ins de personal</div>
          <div class="flex gap-2 mb-2">
            <select id="checkStaffSelect" class="border rounded-md p-2 flex-1"></select>
            <button id="refreshChecksBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white">Actualizar</button>
          </div>
          <ul id="checksList" class="text-sm text-gray-700 space-y-1 max-h-56 overflow-auto"></ul>
        </div>
      </div>

      <div class="px-4 py-3 border-t"><div id="usersTable" class="text-sm"></div></div>
    </div>
  </div>

  <script>
    /* Utilidades mínimas y seguras */
    function $(id){return document.getElementById(id)}
    function S(t){const x=$('statusDot'); if(x) x.textContent=t}

    /* Sólo lo necesario para que el mapa SIEMPRE cargue */
    let map;
    function initMapHardy() {
      const el = $('map');
      if (!el) return;

      // Altura garantizada
      if (!el.style.height) el.style.height = '520px';

      try {
        map = L.map('map', { preferCanvas: true }).setView([-1.5, -78.5], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
        }).addTo(map);

        // Invalidate para contenedores recién pintados
        const fix = () => { try { map.invalidateSize(true); } catch(e){} };
        setTimeout(fix, 0);
        setTimeout(fix, 300);
        window.addEventListener('load', fix);
        if ('ResizeObserver' in window) {
          new ResizeObserver(fix).observe(el);
        } else {
          window.addEventListener('resize', fix);
        }

        S('mapa listo');
      } catch (e) {
        alert('No se pudo inicializar el mapa: ' + (e && e.message ? e.message : e));
      }
    }

    /* Stubs seguros para no romper módulos existentes (muestran UI básica) */
    function safeBind(id, handler){ const el=$(id); if(el) el.onclick=handler; }
    function renderMinimalUI(){
      // Usuarios mínimos en localStorage para no romper selects
      const K='NobisApp_users', KC='NobisApp_current_user';
      let users=[]; try{users=JSON.parse(localStorage.getItem(K)||'[]')}catch(e){users=[]}
      if(!Array.isArray(users) || users.length===0){
        const id='u_'+Math.random().toString(36).slice(2,10);
        users=[{id,name:'Usuario 1',role:'owner'}];
        localStorage.setItem(K, JSON.stringify(users));
        localStorage.setItem(KC, id);
      }
      const cur=(localStorage.getItem(KC)||users[0].id);
      const usel=$('userSelect');
      if(usel){
        usel.innerHTML=users.map(u=>`<option value="${u.id}">${u.name} [${u.role||'admin'}]</option>`).join('');
        usel.value=cur;
      }

      // Geocercas select vacío seguro
      const gf=$('geofenceSelect'); if(gf){ gf.innerHTML=''; }

      // Lista geocercas vacía
      const ul=$('fenceList'); if(ul){ ul.innerHTML='<li class="py-6 text-center text-gray-500">No hay geocercas.</li>'; }

      // Gestión personal (tabla vacía)
      const staffTable=$('staffTable'); const hint=$('noStaffHint');
      if(staffTable){
        staffTable.innerHTML='';
        if(hint) hint.classList.remove('hidden');
      }

      // Actividades (listas/combos vacíos)
      const actList=$('actList'); if(actList) actList.innerHTML='<li class="text-gray-500">Sin actividades. Añade arriba.</li>';
      const actStaff=$('actStaffSelect'); if(actStaff) actStaff.innerHTML='';
      const actSel=$('actSelect'); if(actSel) actSel.innerHTML='';
      const actLogs=$('actLogs'); if(actLogs) actLogs.innerHTML='<li class="text-gray-500">Sin registros.</li>';

      // Reportes (tarjetas 0)
      const rep=$('repSummary'); if(rep){
        rep.innerHTML=['Geocercas','Personal','Asignaciones','Actividades','Check-ins']
          .map(t=>`<div class="p-4 rounded-xl bg-slate-50 border text-center"><div class="text-2xl font-bold">0</div><div class="text-xs text-slate-600">${t}</div></div>`).join('');
      }

      // Administración (combos vacíos)
      const as1=$('assignStaffSelect'); if(as1) as1.innerHTML='';
      const as2=$('assignAdminSelect'); if(as2) as2.innerHTML='';
      const as3=$('assignFenceSelect'); if(as3) as3.innerHTML='';
      const ckSel=$('checkStaffSelect'); if(ckSel) ckSel.innerHTML='';
      const usersTable=$('usersTable'); if(usersTable){
        usersTable.innerHTML='<div class="text-sm text-gray-600">La tabla se llenará cuando se creen usuarios.</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      // 1) Pintar UI básica (sin romper nada existente)
      renderMinimalUI();

      // 2) Iniciar el mapa de forma a prueba de fallos
      initMapHardy();

      // 3) Enlaces “no destructivos” (placeholders para evitar errores JS)
      safeBind('newFenceBtn', ()=>S('nuevo dibujo'));
      safeBind('finishFenceBtn', ()=>S('finalizar (requiere dibujo)'));
      safeBind('cancelFenceBtn', ()=>S('cancelado'));
      safeBind('saveNameBtn', ()=>S('nombre guardado'));
      safeBind('cancelNameBtn', ()=>S('seguir dibujando'));
      safeBind('createFenceByCoordsBtn', ()=>S('crear por coordenadas'));
      safeBind('editFenceBtn', ()=>S('editar'));
      safeBind('saveFenceEditBtn', ()=>S('cambios guardados'));
      safeBind('cancelFenceEditBtn', ()=>S('edición cancelada'));
      safeBind('renameFenceBtn', ()=>S('renombrar'));
      safeBind('deleteFenceBtn', ()=>S('eliminar'));
      safeBind('exportGeoJsonBtn', ()=>S('exportar'));
      const imp=$('importGeoJsonInput'); if(imp){ imp.onchange=()=>S('importar'); }

      safeBind('addStaffFromPersonnel', ()=>S('añadir personal'));
      safeBind('refreshPersonnelBtn', ()=>S('refrescar personal'));

      safeBind('actAddBtn', ()=>S('actividad añadida'));
      safeBind('actLogGpsBtn', ()=>S('actividad con GPS'));
      safeBind('actLogManualBtn', ()=>S('actividad manual'));
      safeBind('exportCsvBtn', ()=>S('CSV actividades'));

      safeBind('exportChecksBtn', ()=>S('CSV check-ins'));
      safeBind('exportActsBtn', ()=>S('CSV actividades'));

      safeBind('createAdminBtn', ()=>S('admin creado'));
      safeBind('createStaffBtn', ()=>S('personal creado'));
      safeBind('doAssignBtn', ()=>S('asignado'));
      safeBind('refreshChecksBtn', ()=>S('check-ins actualizados'));

      S('listo');
    });
  </script>
</body>
</html>

