<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>App Fincas · Geocercas + Trackers</title>

<!-- 1) CSS esencial de Leaflet embebido (por si el CDN de estilos no carga) -->
<style>
/* Leaflet core (compact) */
.leaflet-container{position:relative;overflow:hidden;outline:0}
.leaflet-pane,.leaflet-map-pane,.leaflet-tile-pane,.leaflet-overlay-pane,.leaflet-shadow-pane,.leaflet-marker-pane,.leaflet-tooltip-pane,.leaflet-popup-pane{position:absolute;left:0;top:0}
.leaflet-pane{z-index:400}.leaflet-tile-pane{z-index:200}.leaflet-overlay-pane{z-index:400}.leaflet-shadow-pane{z-index:500}.leaflet-marker-pane{z-index:600}.leaflet-tooltip-pane{z-index:650}.leaflet-popup-pane{z-index:700}
.leaflet-zoom-animated{transform-origin:0 0}
.leaflet-container img{max-width:none!important}
.leaflet-tile{position:absolute;width:256px;height:256px;border:0}
.leaflet-control{position:relative;z-index:800}
.leaflet-control-container{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
.leaflet-top,.leaflet-bottom{position:absolute;z-index:1000;pointer-events:none}
.leaflet-top{top:10px}.leaflet-bottom{bottom:10px}
.leaflet-left{left:10px}.leaflet-right{right:10px}
.leaflet-bar{box-shadow:0 1px 5px rgba(0,0,0,.4);border-radius:4px;pointer-events:auto}
.leaflet-bar a{background:#fff;border-bottom:1px solid #ccc;width:28px;height:28px;line-height:28px;text-align:center;display:block;color:#000;text-decoration:none}
.leaflet-bar a:last-child{border-bottom:none}
.leaflet-bar a:hover{background:#f4f4f4}
.leaflet-control-zoom-in,.leaflet-control-zoom-out{font:bold 18px/28px Arial,Helvetica,sans-serif}

/* App UI */
:root{--c1:#0b5;--c2:#095;--danger:#d33;--warn:#e9b300}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#fafafa;color:#222}
header{position:sticky;top:0;z-index:10;display:flex;gap:.5rem;align-items:center;padding:.75rem 1rem;background:#fff;border-bottom:1px solid #ddd}
header h1{font-size:1rem;margin:0 0 0 .25rem;font-weight:700}
.wrap{max-width:1200px;margin:0 auto;padding:1rem}
.btn{border:1px solid #ccc;background:#fff;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
.btn.primary{background:var(--c1);border-color:var(--c2);color:#fff}
.btn.danger{background:var(--danger);border-color:#b12;color:#fff}
.btn.warn{background:var(--warn)}
nav.tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
nav.tabs button{border:1px solid #ddd;background:#fff;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
nav.tabs button.active{background:#222;color:#fff;border-color:#222}
section.panel{display:none;background:#fff;border:1px solid #e5e5e5;border-radius:.75rem;margin-top:1rem;padding:1rem}
section.panel.show{display:block}
.grid{display:grid;gap:1rem}
.grid-2{grid-template-columns:1fr 1fr}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:.75rem;padding:1rem}
input,select,textarea{width:100%;padding:.5rem;border:1px solid #ddd;border-radius:.5rem}
.map{height:520px;border-radius:.75rem;border:1px solid #e5e5e5;background:#f3f6f9;position:relative}
.coords{position:absolute;right:.75rem;bottom:.75rem;background:rgba(255,255,255,.92);border:1px solid #ddd;border-radius:.5rem;padding:.25rem .5rem;font-size:.85rem}
.small{font-size:.86rem}.muted{color:#666}.hidden{display:none}
.badge{width:.75rem;height:.75rem;border-radius:50%;display:inline-block}.ok{background:#2ecc71}
</style>

<!-- 2) Leaflet + Leaflet.draw desde CDN (JS y CSS). Si el CSS no carga, el fallback arriba ya pinta controles. -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
</head>

<body>
<header>
  <div class="badge ok"></div>
  <h1>App Fincas · Geocercas + Trackers</h1>
  <div style="flex:1"></div>
  <label class="small muted" for="farmSelect" style="margin-right:.5rem">Finca:</label>
  <select id="farmSelect"></select>
  <button class="btn" id="btnNuevaFinca">Crear</button>
  <button class="btn danger" id="btnEliminarFinca">Eliminar Finca</button>
</header>

<!-- TRACKER -->
<div id="trackerShell" class="wrap hidden">
  <div class="grid grid-2">
    <div class="card">
      <h2 style="margin:0 0 .5rem">Modo TRACKER</h2>
      <div id="trackerUserInfo" class="small muted">Cargando…</div>
      <div class="small muted" style="margin-top:.5rem">Frecuencia: <span id="freqSec">15</span> s</div>
      <div style="margin-top:.5rem">
        <label><input type="checkbox" id="toggleSend"> Activar envío (solo dentro de la geocerca)</label>
      </div>
      <div class="small" style="margin-top:.5rem">
        Último evento: <span id="lastEvent">—</span><br>
        Último envío: <span id="lastSend">—</span>
      </div>
    </div>
    <div class="card">
      <div id="miniMap" class="map"></div>
      <div class="coords" id="miniCoords">—</div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminShell" class="wrap">
  <nav class="tabs" id="tabs">
    <button data-tab="geocercas" class="active">Geocercas</button>
    <button data-tab="personal">Personal</button>
    <button data-tab="actividades">Costos</button>
    <button data-tab="reportes">Reportes</button>
    <button data-tab="config">Config</button>
  </nav>

  <section id="tab-geocercas" class="panel show">
    <div class="grid grid-2">
      <div>
        <div class="card">
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn" id="btnNuevaGeocerca">Nueva Geocerca</button>
            <button class="btn warn" id="btnEditarGeocerca">Editar Geocercas</button>
            <button class="btn primary" id="btnGuardarGeocercas">Guardar Cambios</button>
          </div>
          <div style="margin-top:.75rem">
            <label class="small">Crear desde Lat,Lng (una por línea)</label>
            <textarea id="coordsInput" placeholder="-0.12345,-78.56789&#10;-0.12300,-78.56850"></textarea>
            <div style="display:flex;gap:.5rem;margin-top:.5rem">
              <input id="newFenceName" placeholder="Nombre geocerca (ej. Lote A)"/>
              <button class="btn" id="btnCrearDesdeLista">Crear desde Lat/Lng</button>
            </div>
          </div>
        </div>
        <div style="position:relative;margin-top:1rem">
          <div id="map" class="map">
            <div id="mapDebug" style="position:absolute;left:.75rem;bottom:.75rem;background:rgba(255,255,255,.9);border:1px solid #ddd;border-radius:.5rem;padding:.25rem .5rem;font-size:.8rem;display:none"></div>
          </div>
          <div class="coords" id="mapCoords">Lat: — Lng: —</div>
        </div>
      </div>
      <div>
        <div class="card">
          <h3 style="margin:0 0 .5rem">Listado de Geocercas</h3>
          <table id="fencesTable" style="width:100%;border-collapse:collapse">
            <thead><tr><th>Nombre</th><th>Vértices</th><th>Asignados</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="small muted" style="margin-top:.5rem">• Recuerda <b>Guardar Cambios</b> luego de editar el polígono.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-personal" class="panel">
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 .5rem">Nuevo Personal</h3>
        <div class="grid grid-2">
          <div><label>Nombre</label><input id="pNombre" placeholder="Nombre y Apellido"></div>
          <div><label>Teléfono (E.164)</label><input id="pTelefono" placeholder="+5939XXXXXXX"></div>
          <div><label>Rol</label><select id="pRol"><option>TRACKER</option><option>ADMIN</option></select></div>
          <div><label>Activo</label><select id="pActivo"><option value="true">Sí</option><option value="false">No</option></select></div>
          <div><label>Geocerca asignada</label><select id="pGeocerca"></select></div>
          <div style="display:flex;align-items:flex-end;gap:.5rem"><button class="btn primary" id="btnAddPersonal">Añadir</button><span class="small muted">Se genera enlace de acceso.</span></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 .5rem">Personal</h3>
        <table id="personalTable" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Nombre</th><th>Teléfono</th><th>Rol</th><th>Activo</th><th>Geocerca</th><th>Enlace</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-reportes" class="panel">
    <div class="card">
      <h3 style="margin:0 0 .5rem">Registros de posiciones</h3>
      <div style="max-height:360px;overflow:auto">
        <table id="logsTable" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Fecha/Hora</th><th>Teléfono</th><th>Geocerca</th><th>Lat</th><th>Lng</th><th>Accuracy</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:.5rem;display:flex;gap:.5rem">
        <button class="btn" id="btnExportCSV">Exportar CSV</button>
        <button class="btn" id="btnBorrarLogs">Borrar registros</button>
      </div>
    </div>
  </section>

  <section id="tab-config" class="panel">
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 .5rem">Parámetros</h3>
        <label>Webhook (POST JSON opcional)</label>
        <input id="cfgWebhook" placeholder="https://mi-servidor/endpoint">
        <label style="margin-top:.5rem">Frecuencia (segundos)</label>
        <input id="cfgFreq" type="number" min="5" value="15">
        <div style="margin-top:.5rem"><button class="btn primary" id="btnGuardarCfg">Guardar Config</button></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 .5rem">Acceso rápido (TRACKER)</h3>
        <div style="display:flex;gap:.5rem;align-items:flex-end">
          <select id="quickUser"></select>
          <button class="btn" id="btnCopiarEnlace">Copiar enlace</button>
          <span id="copiedMsg" class="small muted"></span>
        </div>
        <div class="small muted" style="margin-top:.5rem">Formato: <code>?mode=tracker&phone=+593XXXXXXXXX&farm=ID_Finca</code></div>
      </div>
    </div>
  </section>
</div>

<!-- 3) Nuestro script al final del body (ya existe el DOM) -->
<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt = n => (typeof n==='number')? Math.round(n*1e6)/1e6 : n;
  const nowISO = () => new Date().toISOString();
  const LS_PREFIX='app_geo_v2';
  const ctx={ farmId:null, data:{
    fences:[], personal:[], actividades:[], costos:[],
    logs:[], config:{ webhook:'', freqSec:15 }
  }};

  function storageKey(section){ return `${LS_PREFIX}_${ctx.farmId||'default'}_${section}`; }
  function loadAll(){ for(const k of Object.keys(ctx.data)){ try{ const raw=localStorage.getItem(storageKey(k)); if(raw) ctx.data[k]=JSON.parse(raw);}catch(e){} } }
  function refreshBindings(){ try{ renderConfig(); refreshFenceSelects(); refreshActivePersonalSelects(); renderFencesTable(); renderPersonalTable(); renderLogs(); }catch(e){ console.warn(e); } }
  function saveAll(){ for(const k of Object.keys(ctx.data)){ localStorage.setItem(storageKey(k), JSON.stringify(ctx.data[k])); } refreshBindings(); }

  // Fincas
  const farmsKey = `${LS_PREFIX}_farms`;
  function farmsGet(){ return JSON.parse(localStorage.getItem(farmsKey)||'[]'); }
  function farmsSet(a){ localStorage.setItem(farmsKey, JSON.stringify(a)); }
  function renderFarms(){ const arr=farmsGet(); if(!ctx.farmId&&arr[0]) ctx.farmId=arr[0].id; $('#farmSelect').innerHTML=arr.map(f=>`<option value="${f.id}">${f.nombre}</option>`).join(''); if(ctx.farmId) $('#farmSelect').value=ctx.farmId; }
  function chooseFarm(id){ ctx.farmId=id; loadAll(); refreshBindings(); mapRenderFences(); }

  $('#btnNuevaFinca').onclick=()=>{ const nombre=prompt('Nombre de la finca:'); if(!nombre) return; const id='f'+Date.now(); const arr=farmsGet(); arr.push({id,nombre}); farmsSet(arr); renderFarms(); chooseFarm(id); };
  $('#btnEliminarFinca').onclick=()=>{ if(!ctx.farmId) return; if(!confirm('¿Eliminar finca y todos sus datos?')) return; Object.keys(ctx.data).forEach(k=>localStorage.removeItem(storageKey(k))); const arr=farmsGet().filter(f=>f.id!==ctx.farmId); farmsSet(arr); ctx.farmId=arr[0]?.id||null; renderFarms(); if(ctx.farmId) chooseFarm(ctx.farmId); else location.reload(); };
  $('#farmSelect').onchange=()=> chooseFarm($('#farmSelect').value);

  // Tabs
  $('#tabs').addEventListener('click',e=>{
    if(e.target.tagName!=='BUTTON') return;
    const tab=e.target.dataset.tab;
    $$('#tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $$('section.panel').forEach(p=>p.classList.remove('show'));
    $(`#tab-${tab}`).classList.add('show');
    if(tab==='geocercas'){ try{ initMap(); map.invalidateSize(true); }catch(e){} }
  });

  // MAPA
  let map, drawnItems, drawControl, editing=false;
  function dbg(m){ const el=$('#mapDebug'); if(!el) return; el.style.display='block'; el.textContent=(el.textContent?el.textContent+' | ':'')+m; }
  function initMap(){
    if(typeof L==='undefined'){ alert('Leaflet no cargó'); return; }
    const cont = $('#map'); if(!cont) return;
    if(!map){
      if(cont.clientHeight<100) cont.style.height='520px';
      map=L.map('map'); dbg('map-created');
      // tiles con fallback
      const addTiles=(url)=>{ const t=L.tileLayer(url,{maxZoom:19,attribution:'&copy; OpenStreetMap'}); t.on('load',()=>dbg('tiles-ok')); t.on('tileerror',()=>dbg('tileerror')); t.addTo(map); return t; };
      let base = addTiles('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
      base.on('tileerror',()=>{ try{map.removeLayer(base);}catch(_){ } base=addTiles('https://tile.openstreetmap.org/{z}/{x}/{y}.png'); });
      drawnItems=new L.FeatureGroup(); map.addLayer(drawnItems);
      // draw seguro
      if(L.Control && L.Control.Draw){
        drawControl=new L.Control.Draw({ draw:{ polyline:false,rectangle:false,circle:false,circlemarker:false,marker:false, polygon:{allowIntersection:false,showArea:true}}, edit:{featureGroup:drawnItems} });
        map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, e=>{ drawnItems.addLayer(e.layer); updateFencesFromLayers(); });
        map.on(L.Draw.Event.EDITED, ()=> updateFencesFromLayers());
      }else{
        const w=document.createElement('div'); w.className='coords'; w.style.left='.75rem'; w.style.right='auto'; w.textContent='⚠ No se cargó Leaflet.draw; modo visual.'; cont.appendChild(w);
      }
      map.on('mousemove',ev=> $('#mapCoords').textContent=`Lat: ${fmt(ev.latlng.lat)} Lng: ${fmt(ev.latlng.lng)}`);
      try{ L.control.zoom({position:'topleft'}).addTo(map); }catch(_){}
      map.setView([-1.8312,-78.1834],6);
      setTimeout(()=>{ try{ map.invalidateSize(true);}catch(_){ } },200);
      window.addEventListener('resize',()=>{ try{ map.invalidateSize(true);}catch(_){ } });
    }else{
      setTimeout(()=>{ try{ map.invalidateSize(true);}catch(_){ } },0);
    }
  }
  function layerToCoords(layer){ const latlngs=layer.getLatLngs(); const first=Array.isArray(latlngs[0])?latlngs[0]:latlngs; return first.map(ll=>[ll.lat,ll.lng]); }
  function coordsToLayer(coords){ return L.polygon(coords,{color:'#0b5',weight:2,fillOpacity:.1}); }
  function centroid(coords){ let x=0,y=0; coords.forEach(c=>{x+=c[0];y+=c[1]}); return [x/coords.length,y/coords.length]; }
  function updateFencesFromLayers(){
    const out=[]; drawnItems.eachLayer(layer=>{
      const coords=layerToCoords(layer); let name='Geocerca '+(ctx.data.fences.length+out.length+1); let id='g'+Date.now()+Math.random().toString(36).slice(2,6);
      const c=centroid(coords); const m=ctx.data.fences.find(f=>{const cc=centroid(f.coords); return Math.hypot(c[0]-cc[0],c[1]-cc[1])<0.0008;}); if(m){name=m.name; id=m.id;}
      out.push({id,name,coords,color:'#0b5'});
    });
    ctx.data.fences=out; saveAll(); renderFencesTable(); refreshFenceSelects();
  }
  function mapRenderFences(){
    if(!map) return; if(!drawnItems) return;
    drawnItems.clearLayers();
    if(ctx.data.fences.length===0){ try{ map.setView([-1.8312,-78.1834],6); }catch(_){ } return; }
    const layers=ctx.data.fences.map(f=> coordsToLayer(f.coords).bindTooltip(f.name));
    layers.forEach(l=> drawnItems.addLayer(l));
    try{ map.fitBounds(L.featureGroup(layers).getBounds().pad(.2)); }catch(_){ }
    renderFencesTable(); refreshFenceSelects();
  }

  // Geocercas UI
  $('#btnNuevaGeocerca').onclick=()=>{ try{ new L.Draw.Polygon(map).enable(); }catch(e){ alert('Leaflet.draw no disponible'); } };
  $('#btnEditarGeocerca').onclick=()=>{ editing=!editing; try{ new L.EditToolbar.Edit(map,{featureGroup:drawnItems})[editing?'enable':'disable'](); $('#btnEditarGeocerca').textContent= editing?'Salir de Edición':'Editar Geocercas'; }catch(e){ alert('Leaflet.draw no disponible'); } };
  $('#btnGuardarGeocercas').onclick=()=>{ updateFencesFromLayers(); alert('Cambios de geocercas guardados.'); };
  $('#btnCrearDesdeLista').onclick=()=>{ const name=$('#newFenceName').value.trim(); const txt=$('#coordsInput').value.trim(); if(!txt) return alert('Pega coordenadas'); const coords=txt.split(/\n+/).map(l=>{ const [a,b]=l.split(',').map(s=>parseFloat(s.trim())); return (Number.isFinite(a)&&Number.isFinite(b))?[a,b]:null; }).filter(Boolean); if(coords.length<3) return alert('Se requieren ≥3 puntos'); const layer=coordsToLayer(coords).bindTooltip(name||('Geocerca '+(ctx.data.fences.length+1))); drawnItems.addLayer(layer); updateFencesFromLayers(); $('#coordsInput').value=''; $('#newFenceName').value=''; };

  // Personal
  function refreshFenceSelects(){ const opts=['<option value="">(sin asignar)</option>'].concat(ctx.data.fences.map(f=>`<option value="${f.id}">${f.name}</option>`)); $('#pGeocerca').innerHTML=opts.join(''); }
  function refreshActivePersonalSelects(){ const trackers=ctx.data.personal.filter(p=>p.rol==='TRACKER'); $('#quickUser').innerHTML=trackers.map(p=>`<option value="${p.id}">${p.nombre} (${p.telefono})</option>`).join(''); }
  $('#btnAddPersonal').onclick=()=>{ const nombre=$('#pNombre').value.trim(); const telefono=$('#pTelefono').value.trim(); if(!nombre||!telefono) return alert('Completa nombre y teléfono'); const rol=$('#pRol').value; const activo=$('#pActivo').value==='true'; const geocercaId=$('#pGeocerca').value||''; ctx.data.personal.push({id:'p'+Date.now(),nombre,telefono,rol,activo,geocercaId}); saveAll(); renderPersonalTable(); refreshActivePersonalSelects(); $('#pNombre').value=''; $('#pTelefono').value=''; };
  function trackerLinkFor(p){ const u=new URL(location.href); u.search=''; u.hash=''; u.searchParams.set('mode','tracker'); u.searchParams.set('phone',p.telefono); if(ctx.farmId) u.searchParams.set('farm',ctx.farmId); return u.toString(); }
  function renderPersonalTable(){ const tb=$('#personalTable tbody'); if(!tb) return; tb.innerHTML=''; for(const p of ctx.data.personal){ const tr=document.createElement('tr'); tr.innerHTML=`<td contenteditable onblur="window._pf('${p.id}','nombre',this.textContent)">${p.nombre}</td><td contenteditable onblur="window._pf('${p.id}','telefono',this.textContent)">${p.telefono}</td><td><select onchange="window._pf('${p.id}','rol',this.value)"><option ${p.rol==='TRACKER'?'selected':''}>TRACKER</option><option ${p.rol==='ADMIN'?'selected':''}>ADMIN</option></select></td><td><select onchange="window._pf('${p.id}','activo',this.value)"><option value="true" ${p.activo?'selected':''}>Sí</option><option value="false" ${!p.activo?'selected':''}>No</option></select></td><td><select onchange="window._pf('${p.id}','geocercaId',this.value)"><option value="">(sin)</option>${ctx.data.fences.map(f=>`<option value="${f.id}" ${p.geocercaId===f.id?'selected':''}>${f.name}</option>`).join('')}</select></td><td><input readonly value="${trackerLinkFor(p)}" style="width:260px"/></td><td><button class="btn" onclick="window.open('${trackerLinkFor(p)}','_blank')">Abrir</button></td>`; tb.appendChild(tr); } }
  window._pf=(id,field,value)=>{ const p=ctx.data.personal.find(x=>x.id===id); if(!p) return; if(field==='activo') value=(value==='true'); p[field]=value; saveAll(); renderPersonalTable(); refreshActivePersonalSelects(); };

  // Reportes
  function renderLogs(){ const tb=$('#logsTable tbody'); if(!tb) return; tb.innerHTML=''; for(const Lg of ctx.data.logs.slice().reverse()){ const f=ctx.data.fences.find(x=>x.id===Lg.geocercaId)?.name||Lg.geocercaId||''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${Lg.ts}</td><td>${Lg.telefono}</td><td>${f}</td><td>${fmt(Lg.lat)}</td><td>${fmt(Lg.lng)}</td><td>${Lg.acc??''}</td>`; tb.appendChild(tr);} }
  $('#btnExportCSV').onclick=()=>{ const rows=[['ts','telefono','geocerca','lat','lng','accuracy']].concat(ctx.data.logs.map(l=>[l.ts,l.telefono,l.geocercaId,l.lat,l.lng,l.acc])); const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'\\"')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`logs_${ctx.farmId||'finca'}.csv`; a.click(); };
  $('#btnBorrarLogs').onclick=()=>{ if(!confirm('¿Borrar todos los registros?')) return; ctx.data.logs=[]; saveAll(); renderLogs(); };

  // Config
  function renderConfig(){ $('#cfgWebhook').value=ctx.data.config.webhook||''; $('#cfgFreq').value=ctx.data.config.freqSec||15; $('#freqSec').textContent=ctx.data.config.freqSec||15; }
  $('#btnGuardarCfg').onclick=()=>{ ctx.data.config.webhook=$('#cfgWebhook').value.trim(); const f=parseInt($('#cfgFreq').value,10); ctx.data.config.freqSec=Number.isFinite(f)&&f>0?f:15; saveAll(); alert('Configuración guardada.'); };

  // TRACKER
  let miniMap, miniFenceLayer, watchId=null, sendTimer=null, trackerUser=null, trackerFence=null, lastPos=null, lastInside=false;
  function param(k){ return new URL(location.href).searchParams.get(k); }
  function pointInPolygon(point, vs){ const x=point[1], y=point[0]; let inside=false; for(let i=0,j=vs.length-1;i<vs.length;j=i++){ const xi=vs[i][1], yi=vs[i][0], xj=vs[j][1], yj=vs[j][0]; const intersect=((yi>y)!=(yj>y))&&(x< (xj-xi)*(y-yi)/((yj-yi)||1e-12)+xi); if(intersect) inside=!inside; } return inside; }
  function initTracker(){
    const phone=param('phone'); const farm=param('farm'); if(farm){ ctx.farmId=farm; renderFarms(); chooseFarm(farm); }
    trackerUser=ctx.data.personal.find(p=>p.telefono===phone)||null;
    $('#trackerUserInfo').textContent= trackerUser? `${trackerUser.nombre} · ${trackerUser.telefono}` : `Teléfono ${phone||'(no provisto)'} · Usuario no encontrado`;
    trackerFence=ctx.data.fences.find(f=>f.id===trackerUser?.geocercaId);
    $('#miniMap') && (miniMap=L.map('miniMap')); if(miniMap){ L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(miniMap); if(trackerFence){ miniFenceLayer=coordsToLayer(trackerFence.coords).addTo(miniMap); miniMap.fitBounds(miniFenceLayer.getBounds().pad(.3)); } else { miniMap.setView([-1.8312,-78.1834],6);} miniMap.on('mousemove',ev=> $('#miniCoords').textContent=`Lat: ${fmt(ev.latlng.lat)} Lng: ${fmt(ev.latlng.lng)}`); }
    $('#toggleSend').onchange=(e)=> toggleSending(e.target.checked);
  }
  function toggleSending(on){
    if(on){
      if(!('geolocation' in navigator)){ alert('Geolocalización no disponible'); $('#toggleSend').checked=false; return; }
      if(!trackerFence){ alert('No tienes geocerca asignada.'); $('#toggleSend').checked=false; return; }
      if(watchId===null){ watchId=navigator.geolocation.watchPosition(onPos,onGeoErr,{enableHighAccuracy:true,maximumAge:10000,timeout:20000}); }
      const freq=ctx.data.config.freqSec||15; if(sendTimer) clearInterval(sendTimer); sendTimer=setInterval(trySend,freq*1000); trySend();
    }else{
      if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      if(sendTimer){ clearInterval(sendTimer); sendTimer=null; }
    }
  }
  function onPos(pos){ const {latitude,longitude,accuracy}=pos.coords; lastPos={lat:latitude,lng:longitude,acc:accuracy,ts:nowISO()}; $('#miniCoords').textContent=`Lat: ${fmt(latitude)} Lng: ${fmt(longitude)} (±${Math.round(accuracy)}m)`; if(window._myM) _myM.setLatLng([latitude,longitude]); else window._myM=L.marker([latitude,longitude]).addTo(miniMap); lastInside= trackerFence? pointInPolygon([latitude,longitude], trackerFence.coords) : false; $('#lastEvent').textContent=`${lastPos.ts} · ${lastInside?'Dentro':'Fuera'} (${Math.round(accuracy)}m)`; }
  function onGeoErr(err){ $('#lastEvent').textContent=`Error GPS: ${err.message}`; }
  function trySend(){ if(!$('#toggleSend').checked||!lastPos||!lastInside) return; const payload={ ts:lastPos.ts, telefono:trackerUser?.telefono||param('phone')||'desconocido', geocercaId:trackerUser?.geocercaId||(trackerFence?.id||''), lat:lastPos.lat, lng:lastPos.lng, acc:lastPos.acc, farmId:ctx.farmId }; ctx.data.logs.push(payload); saveAll(); const url=(ctx.data.config.webhook||'').trim(); if(url){ const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); const ok=(navigator.sendBeacon && navigator.sendBeacon(url,blob)); if(!ok){ fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{}); } } $('#lastSend').textContent=nowISO(); }

  // Render tablas
  function renderFencesTable(){ const tb=$('#fencesTable tbody'); if(!tb) return; tb.innerHTML=''; const assigned=Object.fromEntries(ctx.data.fences.map(f=>[f.id,0])); ctx.data.personal.forEach(p=>{ if(p.geocercaId) assigned[p.geocercaId]=(assigned[p.geocercaId]||0)+1; }); for(const f of ctx.data.fences){ const tr=document.createElement('tr'); tr.innerHTML=`<td contenteditable onblur="window._renameFence('${f.id}',this.textContent)">${f.name}</td><td>${f.coords.length}</td><td>${assigned[f.id]||0}</td><td><button class="btn" onclick="window._zoomFence('${f.id}')">Zoom</button> <button class="btn danger" onclick="window._deleteFence('${f.id}')">Borrar</button></td>`; tb.appendChild(tr); } }
  window._zoomFence=(id)=>{ const f=ctx.data.fences.find(x=>x.id===id); if(!f||!map) return; try{ map.fitBounds(coordsToLayer(f.coords).getBounds().pad(.2)); }catch(_){ } }
  window._deleteFence=(id)=>{ if(!confirm('¿Eliminar geocerca?')) return; ctx.data.fences=ctx.data.fences.filter(f=>f.id!==id); saveAll(); mapRenderFences(); }
  window._renameFence=(id,name)=>{ const f=ctx.data.fences.find(x=>x.id===id); if(!f) return; f.name=(name||'').trim()||f.name; saveAll(); renderFencesTable(); refreshFenceSelects(); }

  // START
  function start(){
    // Crear finca por defecto
    renderFarms();
    if(!ctx.farmId){ const id='f'+Date.now(); const arr=farmsGet(); arr.push({id,nombre:'Mi Finca'}); farmsSet(arr); ctx.farmId=id; renderFarms(); }
    chooseFarm(ctx.farmId);
    const mode=(new URL(location.href).searchParams.get('mode')||'').toLowerCase();
    if(mode==='tracker' || new URL(location.href).searchParams.get('phone')){
      $('#adminShell').classList.add('hidden');
      $('#trackerShell').classList.remove('hidden');
      initTracker();
    }else{
      $('#trackerShell').classList.add('hidden');
      $('#adminShell').classList.remove('hidden');
      initMap(); mapRenderFences();
    }
  }
  // ya estamos al final del body → el DOM existe
  start();
})();
</script>
</body>
</html>
