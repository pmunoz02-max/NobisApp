<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Geocercas</title>

  <!-- Tailwind (estilos) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Leaflet-Geoman (Leaflet.PM) para edición interactiva -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geoman-free@2.13.0/dist/leaflet-geoman.css" />
  <script src="https://unpkg.com/leaflet-geoman-free@2.13.0/dist/leaflet-geoman.min.js"></script>

  <style>
    .label-in-map{background:transparent;border:none;box-shadow:none;color:#1f2937;font-weight:600;text-shadow:0 0 3px #ffffffc7}
    .btn:disabled{opacity:.4;cursor:not-allowed}
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Gestión de Geocercas</h1>

    <div class="grid md:grid-cols-3 gap-4">
      <!-- Geocerca activa -->
      <div class="bg-white p-4 rounded-2xl shadow">
        <label class="block text-sm font-medium text-gray-700">Geocerca activa</label>
        <select id="geofenceSelect" class="mt-1 w-full border rounded-md p-2"></select>
      </div>

      <!-- Acciones -->
      <div class="bg-white p-4 rounded-2xl shadow">
        <div class="flex flex-wrap gap-2">
          <button id="newFenceBtn"    class="btn px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Nueva geocerca</button>
          <button id="finishFenceBtn" class="btn px-3 py-2 bg-green-600  text-white rounded-lg hover:bg-green-700" disabled>Finalizar</button>
          <button id="cancelFenceBtn" class="btn px-3 py-2 bg-gray-600   text-white rounded-lg hover:bg-gray-700" disabled>Cancelar</button>
        </div>
        <div class="flex flex-wrap gap-2 mt-2">
          <button id="createFenceByCoordsBtn" class="btn px-3 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Geocerca (Lat/Lng)</button>
          <button id="editFenceBtn"           class="btn px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn"       class="btn px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700" disabled>Guardar cambios</button>
          <button id="cancelFenceEditBtn"     class="btn px-3 py-2 bg-stone-500 text-white rounded-lg hover:bg-stone-600" disabled>Cancelar edición</button>
        </div>
        <div class="flex flex-wrap gap-2 mt-2">
          <button id="deleteFenceBtn" class="btn px-3 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700" disabled>Eliminar geocerca</button>
          <button id="exportGeoJsonBtn" class="btn px-3 py-2 bg-cyan-700 text-white rounded-lg hover:bg-cyan-800">Exportar GeoJSON</button>
          <label class="btn px-3 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJsonInput" type="file" accept=".json,.geojson,application/geo+json,application/json" class="hidden" />
          </label>
        </div>
      </div>

      <!-- Ayuda -->
      <div class="bg-white p-4 rounded-2xl shadow text-sm text-gray-700">
        <p><b>Flujo (dibujo manual):</b> Nueva geocerca → clics en el mapa para vértices → Finalizar.</p>
        <p class="mt-1"><b>Edición:</b> Selecciona una geocerca → Editar geocerca → mueve/añade/elimina vértices → Guardar cambios.</p>
        <p class="mt-1">Para crear por coordenadas usa <b>Geocerca (Lat/Lng)</b> con líneas <code>lat,lng</code>.</p>
      </div>
    </div>

    <!-- Mapa -->
    <div class="mt-4 bg-white rounded-2xl shadow overflow-hidden">
      <div class="px-4 py-3 border-b"><h2 class="text-lg font-semibold">Mapa</h2></div>
      <div id="map" style="height:480px"></div>
    </div>

    <!-- Explorador -->
    <div class="mt-4 bg-white rounded-2xl shadow">
      <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Geocercas</h3></div>
      <ul id="fenceList" class="p-3 divide-y"></ul>
    </div>
  </div>

  <script>
    /* ===================== Storage ===================== */
    const KEY_FENCES = 'geofences';
    const loadFences = () => { try { return JSON.parse(localStorage.getItem(KEY_FENCES) || '[]'); } catch { return []; } };
    const saveFences = (v) => localStorage.setItem(KEY_FENCES, JSON.stringify(v || []));

    /* ===================== Estado ===================== */
    let map, selectedFenceId = null;
    const layers = {}; // id -> L.Polygon
    const STYLE     = { color:'#2563eb', weight:2, fillColor:'#60a5fa', fillOpacity:0.2 };
    const STYLE_SEL = { color:'#7c3aed', weight:3, fillColor:'#a78bfa', fillOpacity:0.25 };

    // Dibujo manual
    let isDrawing = false;
    let tempLine = null;
    let tempCoords = [];

    // Edición (Geoman)
    let editing = false;
    let backupCoords = null;

    /* ===================== Mapa ===================== */
    function initMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
      map.setView([0, -78], 5);

      // Ocultamos barra Geoman; control con botones
      if (map.pm && map.pm.addControls) {
        map.pm.addControls({
          position:'topleft', drawPolygon:false, drawMarker:false, drawPolyline:false,
          drawRectangle:false, drawCircle:false, drawCircleMarker:false, cutPolygon:false,
          editMode:false, dragMode:false, removalMode:false
        });
      }

      // Solo agregar vértices cuando estamos dibujando
      map.on('click', (e)=>{ if(isDrawing) addVertex(e.latlng); });

      renderFences();
    }

    /* ===================== Dibujo por clics ===================== */
    function addVertex(latlng){
      tempCoords.push(latlng);
      if (tempLine) map.removeLayer(tempLine);
      tempLine = L.polyline(tempCoords,{color:'#10b981',weight:3,dashArray:'4 4'}).addTo(map);
    }
    function startDraw(){
      if (editing) { alert('Termina o cancela la edición actual.'); return; }
      isDrawing = true;
      tempCoords = [];
      if (tempLine) { map.removeLayer(tempLine); tempLine = null; }
      updateDrawButtons();
    }
    function finishDraw(){
      if (!isDrawing || tempCoords.length < 3) { alert('Agrega al menos 3 puntos.'); return; }
      const name = prompt('Nombre de la geocerca:'); if(!name) return;
      const id = 'f_' + Math.random().toString(36).slice(2,10);
      const path = tempCoords.map(p=>({lat:p.lat,lng:p.lng}));
      const fences = loadFences(); fences.push({id,name,path}); saveFences(fences);

      isDrawing=false; tempCoords=[]; if (tempLine){map.removeLayer(tempLine); tempLine=null;}
      renderFences(); zoomTo(id); updateDrawButtons();
    }
    function cancelDraw(){
      isDrawing=false; tempCoords=[]; if (tempLine){map.removeLayer(tempLine); tempLine=null;}
      updateDrawButtons();
    }
    function updateDrawButtons(){
      byId('newFenceBtn').disabled    = isDrawing;
      byId('finishFenceBtn').disabled = !isDrawing;
      byId('cancelFenceBtn').disabled = !isDrawing;
    }

    /* ===================== Render / Selección ===================== */
    function renderFences(){
      // limpiar
      Object.values(layers).forEach(l=>map.removeLayer(l)); for (const k in layers) delete layers[k];

      const fences = loadFences();
      fences.forEach(f=>{
        if (!Array.isArray(f.path) || f.path.length<3) return;
        const latlngs = f.path.map(p=>[p.lat,p.lng]);
        const poly = L.polygon(latlngs, STYLE).addTo(map);
        poly.bindTooltip(f.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});
        poly.on('click', ()=>selectFence(f.id));
        layers[f.id] = poly;
      });

      if (selectedFenceId && !layers[selectedFenceId]) selectedFenceId = null;
      refreshSelectionStyle();
      rebuildUILists();
      fillSelect();
      updateEditButtons();
    }

    function selectFence(id){
      selectedFenceId = id;
      refreshSelectionStyle();
      updateEditButtons();
      const sel = byId('geofenceSelect'); if (sel) sel.value = id || '';
    }
    function refreshSelectionStyle(){
      Object.entries(layers).forEach(([id,poly])=>{
        poly.setStyle(id===selectedFenceId ? STYLE_SEL : STYLE);
      });
    }
    function zoomTo(id){
      const f = loadFences().find(x=>x.id===id); if(!f) return;
      const poly = L.polygon(f.path.map(p=>[p.lat,p.lng])); map.fitBounds(poly.getBounds(),{padding:[20,20]});
      selectFence(id);
    }

    /* ===================== Edición (Geoman) ===================== */
    function beginEdit(){
      if (!selectedFenceId) return;
      if (isDrawing) { alert('Termina o cancela el dibujo actual.'); return; }
      const layer = layers[selectedFenceId]; if (!layer || !layer.pm) return;

      backupCoords = layer.getLatLngs().map(ring=> ring.map(p=> L.latLng(p.lat,p.lng)));
      layer.pm.enable({ allowSelfIntersection:false, snappable:true, snapDistance:20 });

      editing = true; updateEditButtons();
    }
    function saveEdit(){
      if (!selectedFenceId) return;
      const layer = layers[selectedFenceId]; if (!layer || !layer.pm) return;
      const latlngs = layer.getLatLngs()[0] || [];
      if (latlngs.length < 3) { alert('La geocerca debe tener al menos 3 puntos'); return; }

      const fences = loadFences();
      const i = fences.findIndex(x=>x.id===selectedFenceId); if (i<0) return;
      fences[i].path = latlngs.map(p=>({lat:p.lat,lng:p.lng}));
      saveFences(fences);

      layer.pm.disable(); editing=false; backupCoords=null;
      renderFences(); selectFence(selectedFenceId);
    }
    function cancelEdit(){
      const layer = layers[selectedFenceId]; if (!layer || !layer.pm) return;
      if (backupCoords) layer.setLatLngs(backupCoords);
      layer.pm.disable(); editing=false; backupCoords=null;
      updateEditButtons();
    }
    function updateEditButtons(){
      byId('editFenceBtn').disabled       = !selectedFenceId || editing;
      byId('deleteFenceBtn').disabled     = !selectedFenceId || editing;
      byId('saveFenceEditBtn').disabled   = !editing;
      byId('cancelFenceEditBtn').disabled = !editing;
    }

    /* ===================== Listas / Select ===================== */
    function rebuildUILists(){
      const ul = byId('fenceList');
      const fences = loadFences().slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      ul.innerHTML = fences.length ? fences.map(f=>`
        <li class="py-2">
          <div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-id="${f.id}">
            <div class="text-sm font-medium">${f.name||'Geocerca'}</div>
            <div class="text-xs text-gray-500">${f.path?.length||0} puntos</div>
          </div>
        </li>`).join('') : '<li class="py-6 text-center text-gray-500">No hay geocercas.</li>';

      ul.querySelectorAll('[data-id]').forEach(n=>{
        n.addEventListener('click', ()=>selectFence(n.dataset.id));
        n.addEventListener('dblclick',()=>zoomTo(n.dataset.id));
      });
    }
    function fillSelect(){
      const fences = loadFences();
      const s = byId('geofenceSelect');
      const cur = s.value;
      s.innerHTML = fences.map(f=>`<option value="${f.id}">${f.name||'Geocerca'}</option>`).join('');
      if (cur && fences.some(f=>f.id===cur)) s.value = cur;
      s.onchange = e => zoomTo(e.target.value);
    }

    /* ===================== Eliminar / Importar / Exportar / LatLng ===================== */
    function removeFence(){
      if (!selectedFenceId) return;
      if (!confirm('¿Eliminar esta geocerca?')) return;
      saveFences(loadFences().filter(f=>f.id!==selectedFenceId));
      selectedFenceId = null; renderFences();
    }
    function exportGeoJSON(){
      const fences = loadFences();
      const fc = {
        type:'FeatureCollection',
        features: fences.map(f=>({
          type:'Feature',
          properties:{ id:f.id, name:f.name },
          geometry:{ type:'Polygon', coordinates:[[...f.path.map(p=>[p.lng,p.lat]), [f.path[0].lng,f.path[0].lat]]] }
        }))
      };
      const blob = new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='geocercas.geojson'; a.click(); URL.revokeObjectURL(url);
    }
    function importGeoJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const fc = JSON.parse(reader.result);
          if (fc.type!=='FeatureCollection') throw new Error('No es FeatureCollection');
          const fences = loadFences();
          (fc.features||[]).forEach(ft=>{
            const name = ft.properties?.name || 'Geocerca';
            const id   = ft.properties?.id   || ('f_'+Math.random().toString(36).slice(2,10));
            const ring = ft.geometry?.coordinates?.[0] || [];
            const path = ring.slice(0, -1).map(([lng,lat])=>({lat,lng}));
            if (path.length >= 3) fences.push({id,name,path});
          });
          saveFences(fences); renderFences();
        }catch(e){ alert('Archivo inválido: '+e.message); }
      };
      reader.readAsText(file);
    }
    function createByLatLng(){
      const name = prompt('Nombre de la geocerca:'); if(!name) return;
      const raw = prompt('Ingresa coordenadas en formato lat,lng (una por línea o separadas con ;)\\n\\nEjemplo:\\n-2.1500,-79.8800\\n-2.1600,-79.8700\\n-2.1400,-79.8600');
      if (!raw) return;
      const lines = raw.split(/\\n|;/).map(s=>s.trim()).filter(Boolean);
      const pts = [];
      for (const line of lines){
        const m = line.match(/(-?\\d+(?:\\.\\d+)?)[,\\s]+(-?\\d+(?:\\.\\d+)?)/);
        if (!m) continue;
        const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
        if (Number.isFinite(lat) && Number.isFinite(lng)) pts.push({lat,lng});
      }
      if (pts.length < 3){ alert('Se requieren al menos 3 puntos.'); return; }
      const fences = loadFences();
      const id = 'f_'+Math.random().toString(36).slice(2,10);
      fences.push({ id, name, path: pts });
      saveFences(fences); renderFences(); zoomTo(id);
    }

    /* ===================== Util ===================== */
    const byId = (id)=>document.getElementById(id);

    /* ===================== Bindings (después de cargar DOM) ===================== */
    window.addEventListener('load', () => {
      initMap();

      byId('newFenceBtn').addEventListener('click', startDraw);
      byId('finishFenceBtn').addEventListener('click', finishDraw);
      byId('cancelFenceBtn').addEventListener('click', cancelDraw);

      byId('editFenceBtn').addEventListener('click', beginEdit);
      byId('saveFenceEditBtn').addEventListener('click', saveEdit);
      byId('cancelFenceEditBtn').addEventListener('click', cancelEdit);

      byId('deleteFenceBtn').addEventListener('click', removeFence);
      byId('exportGeoJsonBtn').addEventListener('click', exportGeoJSON);
      byId('importGeoJsonInput').addEventListener('change', (e)=>{ if(e.target.files?.[0]) importGeoJSON(e.target.files[0]); });

      byId('createFenceByCoordsBtn').addEventListener('click', createByLatLng);
    });
  </script>
</body>
</html>