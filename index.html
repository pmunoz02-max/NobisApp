<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nobis App • Administración</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Geoman (edición de vértices) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-geoman-free@2.14.0/dist/leaflet-geoman.css">
<script src="https://unpkg.com/leaflet-geoman-free@2.14.0/dist/leaflet-geoman.min.js"></script>

<!-- Turf -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
  :root{--b:#0f172a;--m:#64748b;--bd:#e5e7eb;--bg:#f8fafc;--a:#0ea5e9;--ok:#059669;--err:#b91c1c}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;color:var(--b);background:var(--bg)}
  .app{display:grid;grid-template-columns:360px 1fr;min-height:100vh}
  .left{background:#fff;border-right:1px solid var(--bd);padding:12px;overflow:auto}
  .right{overflow:auto}
  h1{margin:.2rem 0 .6rem;font-size:18px}
  h2{margin:.6rem 0 .4rem}
  h3{margin:.6rem 0 .2rem}
  .muted{color:var(--m)}
  label{display:block;font-size:12px;margin:.5rem 0 .2rem}
  input,select,button,textarea{width:100%;font:12px inherit;padding:.45rem .55rem;border:1px solid var(--bd);border-radius:8px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  button{cursor:pointer}
  .primary{background:var(--a);border-color:var(--a);color:#fff}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  .row>*{flex:1}
  .card{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:10px;margin:.6rem 0}
  .pill{display:inline-block;padding:.1rem .5rem;border:1px solid var(--bd);border-radius:999px;font-size:11px}
  .disabled{opacity:.45;pointer-events:none}

  /* Mapa y overlays */
  #map{position:relative;width:100%;height:420px;border:1px solid var(--bd);border-radius:10px}
  #map.crosshair{cursor:crosshair}
  #mouse{position:absolute;background:rgba(255,255,255,.96);border:1px solid var(--bd);padding:2px 6px;
    font-size:11px;border-radius:4px;display:none;pointer-events:none;z-index:20000}
  #coordBox{position:absolute;right:8px;top:8px;background:#ffffffd9;border:1px solid var(--bd);
    border-radius:6px;padding:4px 8px;font-size:12px;z-index:19999;pointer-events:none}
  ul{margin:.3rem 0 .2rem;padding-left:1.1rem}
  li{margin:.2rem 0}
  .kbd{font-family:ui-monospace,monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-bottom-width:2px;padding:.1rem .3rem;border-radius:4px;font-size:11px}
  table{border-collapse:collapse}
  th,td{border:1px solid var(--bd);padding:.3rem .4rem;font-size:12px}
  th{background:#f3f4f6;text-align:left}
  .hl{outline:3px solid #f59e0b;outline-offset:2px;border-radius:6px}
</style>
</head>
<body>
<div class="app">
  <!-- IZQUIERDA -->
  <aside class="left">
    <h1>Administración</h1>

    <div class="card">
      <label>Email de login</label>
      <div class="row">
        <input id="loginEmail" placeholder="tu@correo.com">
        <button id="btnLogin" class="primary" style="flex:0 0 120px">Ingresar</button>
      </div>
      <div class="muted" style="margin-top:.35rem">Nivel actual: <b id="nivelLbl">Invitado</b></div>
    </div>

    <div id="ownerPanel" class="card" style="display:none">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Dueño</h3><span class="pill">fenice.ecuador@gmail.com</span>
      </div>
      <label>Nuevo administrador</label>
      <div class="row">
        <input id="newAdminEmail" placeholder="nuevo@dominio.com">
        <button id="btnCrearAdmin" class="primary" style="flex:0 0 130px">Crear Admin</button>
      </div>
      <div id="inviteBox" class="muted" style="margin-top:.35rem;display:none"></div>
      <h3>Administradores activos</h3>
      <ul id="adminsList" class="muted"></ul>
    </div>

    <div id="multiuser" class="card">
      <h3>Usuarios</h3>
      <div class="row">
        <select id="userSel"></select>
        <button id="btnCambiarUsuario" style="flex:0 0 120px">Cambiar</button>
      </div>
      <div class="row">
        <input id="newUserName" placeholder="Nuevo usuario">
        <button id="btnCrearUsuario" class="primary" style="flex:0 0 120px">Crear</button>
      </div>
      <div class="muted">Usuario activo: <b id="userLbl">Ninguno</b></div>
    </div>

    <div id="geoCard" class="card">
      <h3>Geocercas</h3>
      <div class="row">
        <button id="btnFenceNew" class="primary">Nueva (clic en mapa)</button>
        <button id="btnFenceFinish" disabled>Finalizar</button>
        <button id="btnFenceCancel" disabled>Cancelar</button>
      </div>

      <details style="margin-top:.5rem">
        <summary class="kbd">Crear desde coordenadas (lat,lng)</summary>
        <label>Coordenadas por línea (<span class="muted">-1.2345,-77.9876</span>)</label>
        <textarea id="txtCoords" placeholder="-1.23,-77.98
-1.24,-77.97
-1.25,-77.99"></textarea>
        <div class="row">
          <input id="nameCoords" placeholder="Nombre de geocerca (opcional)">
          <button id="btnFromCoords" class="primary" style="flex:0 0 180px">Crear por coordenadas</button>
        </div>
      </details>

      <div class="row" style="margin-top:.4rem">
        <button id="btnFenceEdit">Editar vértices</button>
        <button id="btnFenceSave" class="primary" disabled>Guardar</button>
        <button id="btnFenceAbort" disabled>Cancelar edición</button>
      </div>

      <div class="row" style="margin-top:.4rem">
        <button id="btnFenceRename">Renombrar</button>
        <button id="btnFenceDelete">Eliminar</button>
      </div>

      <div class="row" style="margin-top:.4rem">
        <button id="btnFenceExport">Exportar JSON</button>
        <label class="kbd">Importar
          <input type="file" id="fileImport" accept=".json" style="display:none">
        </label>
      </div>

      <label style="margin-top:.6rem">Lista (clic para seleccionar)</label>
      <ul id="fenceList"></ul>
      <div class="muted">Seleccionada: <b id="fenceSelLbl">Ninguna</b></div>
    </div>

    <div id="peopleCard" class="card">
      <h3>Personal</h3>
      <div class="muted">Geocerca actual: <b id="personalFenceLbl">Ninguna</b></div>
      <form onsubmit="return false" class="row" style="margin-top:.4rem">
        <input id="pNombre" placeholder="Nombre" required>
        <input id="pRol" placeholder="Rol" required>
        <input id="pTel" placeholder="+593..." pattern="^\\+?[0-9]{7,15}$" required>
        <input id="pTarifa" type="number" step="0.01" min="0" placeholder="Tarifa/hora" required>
        <select id="pEstado"><option>Activo</option><option>Inactivo</option></select>
        <button id="btnAddP" class="primary" style="flex:0 0 120px">Agregar</button>
      </form>
      <ul id="peopleList"></ul>
    </div>

    <div id="actCard" class="card">
      <h3>Actividades</h3>
      <label>Geocerca</label>
      <select id="actFenceSel"></select>
      <div class="row" style="margin-top:.4rem">
        <input id="actNombre" placeholder="Nombre de actividad">
      </div>
      <div class="row">
        <select id="actRespSel"></select>
        <input id="actPres" type="number" step="0.01" min="0" placeholder="Presupuesto (opcional)">
      </div>
      <div class="row">
        <select id="actEstado">
          <option value="pendiente">Pendiente</option>
          <option value="progreso">En progreso</option>
          <option value="cerrada">Cerrada</option>
        </select>
        <button id="btnAddAct" class="primary" style="flex:0 0 150px">Crear</button>
      </div>
      <ul id="actList"></ul>
    </div>

    <div id="workerCard" class="card">
      <h3>Modo Trabajador</h3>
      <label>Trabajador</label><input id="wNombre" placeholder="Juan P.">
      <label>Geocerca</label><select id="wFence"></select>
      <label>Actividad (opcional)</label><select id="wAct"></select>
      <label>Intervalo (minutos)</label><input id="wMin" type="number" value="5" min="1">
      <div class="row" style="margin-top:.4rem">
        <button id="btnStart" class="primary">Iniciar</button>
        <button id="btnStop">Detener</button>
      </div>
      <div id="trackInfo" class="muted" style="margin-top:.3rem"></div>
    </div>

    <div id="repCard" class="card">
      <h3>Reportes y Costos</h3>
      <label>Geocerca</label><select id="repFenceSel"></select>
      <div class="row">
        <input id="repDesde" type="date"><input id="repHasta" type="date">
      </div>
      <div class="row" style="margin-top:.4rem">
        <button id="btnCalc" class="primary">Calcular</button>
        <button id="btnCsvPers">CSV personas</button>
        <button id="btnCsvAct">CSV actividades</button>
      </div>
      <div id="repInfo" class="muted" style="margin-top:.3rem"></div>
    </div>
  </aside>

  <!-- DERECHA -->
  <main class="right">
    <div style="padding:12px;border-bottom:1px solid var(--bd);background:#fff">
      <h2 style="margin:.2rem 0 .6rem">Mapa de Geocercas</h2>
      <div id="map">
        <div id="mouse"></div>
        <div id="coordBox">Lat: –, Lng: –</div>
      </div>
    </div>

    <div style="padding:12px;border-bottom:1px solid var(--bd);background:#fff">
      <h2 style="margin:.2rem 0 .4rem">Histórico de ubicaciones</h2>
      <table id="tblUbic" style="width:100%">
        <thead><tr><th>Fecha</th><th>Trabajador</th><th>Geocerca</th><th>Actividad</th><th>Lat</th><th>Lng</th><th>mins</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="repTables" style="padding:12px;display:none;background:#fff">
      <h2>Resultados</h2>
      <h3>Costos por persona</h3>
      <table id="tblPers" style="width:100%">
        <thead><tr><th>Persona</th><th>Horas</th><th>Tarifa</th><th>Costo</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" style="text-align:right">Total</th><th id="totPers">$0.00</th></tr></tfoot>
      </table>

      <h3 style="margin-top:1rem">Costos por actividad</h3>
      <table id="tblAct" style="width:100%">
        <thead><tr><th>Actividad</th><th>Horas</th><th>Costo</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="2" style="text-align:right">Total</th><th id="totAct">$0.00</th></tr></tfoot>
      </table>
    </div>
  </main>
</div>

<script>
/* ===== CONFIG ===== */
const OWNER_EMAIL = "fenice.ecuador@gmail.com";

/* ===== STATE/STORAGE ===== */
let nivel=0, loginEmail="", currentUser=null;
let db = { geocercas:[], personal:[], actividades:[], ubicaciones:[] };

function admins(){ return JSON.parse(localStorage.getItem("admins")||"[]"); }
function setAdmins(a){ localStorage.setItem("admins", JSON.stringify(a)); }
function pend(){ return JSON.parse(localStorage.getItem("pendingInvites")||"{}"); }
function setPend(o){ localStorage.setItem("pendingInvites", JSON.stringify(o)); }

function saveDB(){ if(!currentUser) return; localStorage.setItem("db_"+currentUser, JSON.stringify(db)); }
function loadDB(){
  if(!currentUser) return;
  const raw=localStorage.getItem("db_"+currentUser);
  db = raw ? JSON.parse(raw) : { geocercas:[], personal:[], actividades:[], ubicaciones:[] };
  if(!Array.isArray(db.geocercas)) db.geocercas=[];
  if(!Array.isArray(db.personal)) db.personal=[];
  if(!Array.isArray(db.actividades)) db.actividades=[];
  if(!Array.isArray(db.ubicaciones)) db.ubicaciones=[];
}

/* ===== LOGIN/ROLES ===== */
function computeLevel(){ nivel = (loginEmail===OWNER_EMAIL)?1:(admins().includes(loginEmail)?2:0); }
function renderLevel(){
  document.getElementById("nivelLbl").textContent = nivel===1?"Dueño":(nivel===2?"Administrador":"Invitado");
  document.getElementById("ownerPanel").style.display = (nivel===1)?"":"none";
  const can=(nivel>=2);
  ["multiuser","geoCard","peopleCard","actCard","workerCard","repCard"].forEach(id=>{
    document.getElementById(id).classList.toggle("disabled", !can);
  });
}
function doLogin(){
  const v=document.getElementById("loginEmail").value.trim().toLowerCase();
  if(!v) return alert("Ingresa tu email.");
  loginEmail=v; localStorage.setItem("last_login_email", v);
  computeLevel(); renderLevel();
  if(nivel===0) alert("Acceso denegado. El email no es administrador.");
}

/* ===== INVITES (Dueño) ===== */
function createAdmin(){
  if(nivel!==1) return alert("Solo el dueño.");
  const email=document.getElementById("newAdminEmail").value.trim().toLowerCase();
  if(!/^[^@]+@[^@]+\.[^@]+$/.test(email)) return alert("Email inválido");
  const P=pend(); const tok=Math.random().toString(36).slice(2,10); P[email]=tok; setPend(P);
  const link=`${location.origin}${location.pathname}?activate=${encodeURIComponent(email)}&token=${tok}`;
  const box=document.getElementById("inviteBox");
  box.style.display="";
  box.innerHTML=`<div><b>Enlace de activación:</b></div>
  <div style="word-break:break-all">${link}</div>
  <div class="row" style="margin-top:.3rem">
    <button class="primary" onclick="navigator.clipboard.writeText('${link}');alert('Copiado');" style="flex:0 0 130px">Copiar</button>
    <a class="kbd" href="mailto:${email}?subject=Invitaci%C3%B3n%20Administrador&body=${encodeURIComponent(link)}">Enviar por correo</a>
  </div>`;
  renderAdmins();
}
function renderAdmins(){
  const ul=document.getElementById("adminsList"); ul.innerHTML="";
  const a=admins(); if(!a.length){ ul.innerHTML="<li>(sin administradores)</li>"; return; }
  a.forEach(e=>{
    const li=document.createElement("li");
    li.innerHTML=`${e} <button class="kbd" onclick="revokeAdmin('${e}')">Revocar</button>`;
    ul.appendChild(li);
  });
}
function revokeAdmin(email){ if(nivel!==1) return; setAdmins(admins().filter(x=>x!==email)); renderAdmins(); }
function tryActivate(){
  const p=new URLSearchParams(location.search); const e=(p.get("activate")||"").toLowerCase(); const t=p.get("token");
  if(!e||!t) return; const P=pend();
  if(P[e]===t){ const A=admins(); if(!A.includes(e)) A.push(e); setAdmins(A); delete P[e]; setPend(P); alert("✅ Ya eres administrador."); history.replaceState({}, "", location.pathname); }
  else alert("Enlace inválido.");
  renderAdmins();
}

/* ===== Multiusuario ===== */
function users(){ return JSON.parse(localStorage.getItem("usuarios")||"[]"); }
function setUsers(U){ localStorage.setItem("usuarios", JSON.stringify(U)); }
function initUsersUI(){
  const sel=document.getElementById("userSel"); const U=users(); sel.innerHTML=U.map(u=>`<option>${u}</option>`).join("");
  if(!currentUser && U[0]) currentUser=U[0]; if(currentUser) sel.value=currentUser;
  document.getElementById("userLbl").textContent=currentUser||"Ninguno";
}
function createUser(){
  const n=document.getElementById("newUserName").value.trim(); if(!n) return alert("Nombre de usuario");
  const U=users(); if(U.includes(n)) return alert("Ya existe."); U.push(n); setUsers(U);
  localStorage.setItem("db_"+n, JSON.stringify({geocercas:[],personal:[],actividades:[],ubicaciones:[]}));
  document.getElementById("newUserName").value=""; initUsersUI();
}
function changeUser(){ currentUser=document.getElementById("userSel").value; document.getElementById("userLbl").textContent=currentUser||"Ninguno"; loadDB(); redrawAll(); }

/* ===== Mapa / Geocercas ===== */
let map, layerGroup, isDrawing=false, tempCoords=[];
let fenceLayers=new Map(); let selectedFenceId=null;

function initMap(){
  map=L.map('map').setView([-1.718,-77.96],14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
  layerGroup=L.layerGroup().addTo(map);

  // Geoman (solo edición)
  map.pm.addControls({position:'topleft',drawMarker:false,drawCircle:false,drawPolyline:false,drawRectangle:false,drawCircleMarker:false,drawText:false,drawPolygon:false,dragMode:false,cutPolygon:false,rotateMode:false,removalMode:false});

  // Coordenadas en tiempo real
  const mouse = document.getElementById("mouse");
  const box = document.getElementById("coordBox");
  map.on("mousemove", (e)=>{
    const lat=e.latlng.lat.toFixed(6), lng=e.latlng.lng.toFixed(6);
    const p = map.latLngToContainerPoint(e.latlng);
    mouse.style.display="block";
    mouse.style.left = (p.x + 12) + "px";
    mouse.style.top  = (p.y - 18) + "px";
    mouse.textContent = `${lat}, ${lng}`;
    box.textContent = `Lat: ${lat}, Lng: ${lng}`;
  });
  map.getContainer().addEventListener("mouseleave", ()=>{ mouse.style.display="none"; });

  // Clics para dibujo
  map.on("click", (e)=>{
    if(!isDrawing || nivel<2) return;
    tempCoords.push([e.latlng.lat,e.latlng.lng]);
    drawTemp();
    document.getElementById("btnFenceFinish").disabled = tempCoords.length<3;
    document.getElementById("btnFenceCancel").disabled = tempCoords.length<1;
  });

  redrawAll();
}

function redrawAll(){
  layerGroup.clearLayers(); fenceLayers.clear();
  (db.geocercas||[]).forEach(f=>{
    const poly=L.polygon(f.coords,{color:"#10b981",weight:2,fillOpacity:.12}).addTo(layerGroup);
    poly.bindTooltip(f.nombre||("Geocerca "+f.id));
    poly.on("click",(ev)=>{
      if(isDrawing){
        L.DomEvent.stop(ev); // no cortar el trazado
        tempCoords.push([ev.latlng.lat,ev.latlng.lng]);
        drawTemp();
        document.getElementById("btnFenceFinish").disabled = tempCoords.length<3;
        document.getElementById("btnFenceCancel").disabled = tempCoords.length<1;
        return;
      }
      selectFence(f.id,true);
    });
    fenceLayers.set(f.id, poly);
  });
  renderFenceList();
  updatePersonalFenceLabel();
  refillSelects();
  renderPeople(); renderActs(); renderUbic();
}

function setDrawingUI(on){
  isDrawing=on;
  document.getElementById("map").classList.toggle("crosshair", on);
  document.getElementById("btnFenceFinish").disabled = on ? (tempCoords.length<3) : true;
  document.getElementById("btnFenceCancel").disabled = on ? (tempCoords.length<1) : true;
}

function drawTemp(){
  // re-pintar todo + polilínea temporal
  layerGroup.clearLayers();
  (db.geocercas||[]).forEach(f=>{ L.polygon(f.coords,{color:"#10b981",weight:2,fillOpacity:.12}).addTo(layerGroup); });
  if(tempCoords.length>=2){ L.polyline(tempCoords,{color:"#0ea5e9",dashArray:"3,4"}).addTo(layerGroup); }
}

function newFence(){
  if(nivel<2) return alert("Requiere rol Administrador.");
  tempCoords=[]; setDrawingUI(true);
}
function finishFence(){
  if(tempCoords.length<3) return;
  const id=Date.now().toString(36);
  const nombre=prompt("Nombre de geocerca","Geocerca "+(db.geocercas.length+1))||"Geocerca";
  db.geocercas.push({id,nombre,coords:tempCoords});
  saveDB();
  tempCoords=[]; setDrawingUI(false);
  redrawAll(); selectFence(id,true);
}
function cancelFence(){ tempCoords=[]; setDrawingUI(false); redrawAll(); }

function createFromCoords(){
  if(nivel<2) return alert("Requiere rol Administrador.");
  const txt=document.getElementById("txtCoords").value.trim(); if(!txt) return alert("Pega coordenadas (lat,lng)");
  const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const coords=[];
  for(const ln of lines){
    const m=ln.split(/[\s,;]+/); if(m.length<2) return alert("Formato inválido: "+ln);
    const lat=parseFloat(m[0]), lng=parseFloat(m[1]); if(isNaN(lat)||isNaN(lng)) return alert("Número inválido: "+ln);
    coords.push([lat,lng]);
  }
  if(coords.length<3) return alert("Se requieren al menos 3 puntos.");
  const id=Date.now().toString(36);
  const nombre=document.getElementById("nameCoords").value.trim() || "Geocerca "+(db.geocercas.length+1);
  db.geocercas.push({id,nombre,coords}); saveDB(); document.getElementById("nameCoords").value="";
  redrawAll(); selectFence(id,true);
  // entrar en edición automáticamente para permitir "Guardar"
  startEdit();
}

let editActive=false;
function selectFence(id,fromMap=false){
  selectedFenceId=id;
  document.getElementById("fenceSelLbl").textContent = (db.geocercas.find(f=>f.id===id)||{}).nombre || "Ninguna";
  document.querySelectorAll("#fenceList li").forEach(li=>li.classList.remove("hl"));
  const li=document.querySelector(`#fenceList li[data-id="${id}"]`); if(li) li.classList.add("hl");
  fenceLayers.forEach((lay,fid)=>lay.setStyle({weight: fid===id?4:2, color: fid===id?"#f59e0b":"#10b981"}));
  if(fromMap){ map.flyToBounds(fenceLayers.get(id).getBounds(),{maxZoom:17}); }
  updatePersonalFenceLabel(); refillActFence(); renderActs();
}
function startEdit(){
  if(!selectedFenceId) return alert("Selecciona una geocerca.");
  const lay=fenceLayers.get(selectedFenceId); if(!lay) return;
  lay.pm.enable({allowSelfIntersection:false,snappable:true});
  editActive=true;
  document.getElementById("btnFenceSave").disabled=false;
  document.getElementById("btnFenceAbort").disabled=false;
}
function saveEdit(){
  if(!selectedFenceId) return;
  const lay=fenceLayers.get(selectedFenceId); if(!lay) return;
  if(!editActive){ alert("Pulsa 'Editar vértices' antes de guardar."); return; }
  const latlngs=lay.getLatLngs()[0].map(ll=>[ll.lat,ll.lng]); if(latlngs.length<3) return alert("El polígono debe tener ≥3 puntos.");
  const f=db.geocercas.find(x=>x.id===selectedFenceId); if(!f) return;
  f.coords=latlngs; saveDB(); lay.pm.disable(); editActive=false;
  document.getElementById("btnFenceSave").disabled=true; document.getElementById("btnFenceAbort").disabled=true;
  redrawAll(); selectFence(f.id);
}
function abortEdit(){
  if(!selectedFenceId) return; const lay=fenceLayers.get(selectedFenceId); if(lay) lay.pm.disable();
  editActive=false; document.getElementById("btnFenceSave").disabled=true; document.getElementById("btnFenceAbort").disabled=true;
  redrawAll(); if(selectedFenceId) selectFence(selectedFenceId);
}

function renameFence(){
  if(!selectedFenceId) return alert("Selecciona una geocerca.");
  const f=db.geocercas.find(x=>x.id===selectedFenceId); if(!f) return;
  const n=prompt("Nuevo nombre",f.nombre); if(!n) return; f.nombre=n; saveDB(); redrawAll(); selectFence(f.id);
}
function deleteFence(){
  if(!selectedFenceId) return alert("Selecciona una geocerca.");
  if(!confirm("¿Eliminar geocerca seleccionada?")) return;
  const id=selectedFenceId;
  db.geocercas=db.geocercas.filter(f=>f.id!==id);
  db.personal=db.personal.filter(p=>p.fenceId!==id);
  db.actividades=db.actividades.filter(a=>a.fenceId!==id);
  db.ubicaciones=db.ubicaciones.filter(u=>u.fenceId!==id);
  selectedFenceId=null; saveDB(); redrawAll();
}

function exportFences(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(db.geocercas,null,2)],{type:"application/json"}));
  a.download="geocercas.json"; a.click(); URL.revokeObjectURL(a.href);
}
document.getElementById("fileImport").addEventListener("change", e=>{
  const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
  fr.onload=()=>{ try{ const arr=JSON.parse(fr.result); if(!Array.isArray(arr)) throw 0; db.geocercas=arr; saveDB(); redrawAll(); }catch{ alert("Archivo inválido"); } };
  fr.readAsText(f);
});
function renderFenceList(){
  const ul=document.getElementById("fenceList"); ul.innerHTML="";
  db.geocercas.forEach(f=>{
    const li=document.createElement("li"); li.dataset.id=f.id; li.textContent=`${f.nombre} (${f.coords.length} pts)`;
    li.onclick=()=>selectFence(f.id); ul.appendChild(li);
  });
  document.getElementById("fenceSelLbl").textContent = selectedFenceId ? (db.geocercas.find(x=>x.id===selectedFenceId)||{}).nombre : "Ninguna";
}

/* ===== Personal ===== */
function updatePersonalFenceLabel(){
  const first = db.geocercas[0]?.nombre || "Ninguna";
  const name = selectedFenceId ? (db.geocercas.find(x=>x.id===selectedFenceId)?.nombre || first) : first;
  document.getElementById("personalFenceLbl").textContent=name;
}
function addPerson(){
  if(nivel<2) return alert("Requiere rol Administrador.");
  const fenceId = selectedFenceId || db.geocercas[0]?.id; if(!fenceId) return alert("Crea una geocerca primero.");
  const nombre=document.getElementById("pNombre").value.trim();
  const rol=document.getElementById("pRol").value.trim();
  const tel=document.getElementById("pTel").value.trim();
  const tarifa=parseFloat(document.getElementById("pTarifa").value)||0;
  const estado=document.getElementById("pEstado").value;
  if(!nombre||!rol||!tel) return;
  db.personal.push({nombre,rol,tel,tarifa,estado,fenceId}); saveDB(); renderPeople(); document.querySelector("#peopleCard form").reset();
}
function renderPeople(){
  const ul=document.getElementById("peopleList"); ul.innerHTML="";
  db.personal.forEach(p=>{
    const f=db.geocercas.find(x=>x.id===p.fenceId);
    const li=document.createElement("li");
    li.innerHTML=`<b>${p.nombre}</b> — ${p.rol} — ${p.estado} — ${f?f.nombre:"(sin geocerca)"} — Tarifa $${(p.tarifa||0).toFixed(2)}
    <button class="kbd" onclick="editTarifa('${p.nombre}')">Tarifa</button>`;
    ul.appendChild(li);
  });
  refillActResp();
}
function editTarifa(nombre){
  const p=db.personal.find(x=>x.nombre===nombre); if(!p) return;
  const t=prompt("Nueva tarifa/hora",p.tarifa||0); if(t===null) return;
  const v=parseFloat(t); if(isNaN(v)||v<0) return alert("Valor inválido");
  p.tarifa=v; saveDB(); renderPeople();
}

/* ===== Actividades ===== */
function refillActFence(){
  const sel=document.getElementById("actFenceSel");
  sel.innerHTML=(db.geocercas||[]).map(f=>`<option value="${f.id}">${f.nombre}</option>`).join("");
  if(selectedFenceId) sel.value=selectedFenceId;
}
function refillActResp(){
  const sel=document.getElementById("actRespSel");
  const fid=document.getElementById("actFenceSel").value || db.geocercas[0]?.id || "";
  const arr=db.personal.filter(p=>p.fenceId===fid);
  sel.innerHTML=`<option value="">(sin responsable)</option>` + arr.map(p=>`<option>${p.nombre}</option>`).join("");
}
function addActivity(){
  if(nivel<2) return alert("Requiere rol Administrador.");
  const fid=document.getElementById("actFenceSel").value || db.geocercas[0]?.id || "";
  if(!fid) return alert("Crea una geocerca primero.");
  const nombre=document.getElementById("actNombre").value.trim(); if(!nombre) return alert("Nombre requerido");
  const responsable=document.getElementById("actRespSel").value||"";
  const presupuesto=parseFloat(document.getElementById("actPres").value)||0;
  const estado=document.getElementById("actEstado").value;
  db.actividades.push({id:Date.now().toString(36), fenceId:fid, nombre, estado, presupuesto, responsable});
  saveDB(); renderActs(); refillWorkerActs(); document.getElementById("actNombre").value=""; document.getElementById("actPres").value="";
}
function renderActs(){
  const ul=document.getElementById("actList"); ul.innerHTML="";
  const fid=document.getElementById("actFenceSel").value || db.geocercas[0]?.id || "";
  db.actividades.filter(a=>a.fenceId===fid).forEach(a=>{
    const li=document.createElement("li");
    li.innerHTML=`<b>${a.nombre}</b> — ${a.estado} — Resp: ${a.responsable||"-"} — Presup $${(a.presupuesto||0).toFixed(2)}
    <button class="kbd" onclick="toggleAct('${a.id}')">Estado</button>
    <button class="kbd" onclick="delAct('${a.id}')">Eliminar</button>`;
    ul.appendChild(li);
  });
}
function toggleAct(id){
  const a=db.actividades.find(x=>x.id===id); if(!a) return;
  a.estado=a.estado==="pendiente"?"progreso":(a.estado==="progreso"?"cerrada":"pendiente");
  saveDB(); renderActs(); refillWorkerActs();
}
function delAct(id){
  if(!confirm("¿Eliminar actividad?")) return;
  db.actividades=db.actividades.filter(a=>a.id!==id);
  db.ubicaciones.forEach(u=>{ if(u.actId===id) u.actId=null; });
  saveDB(); renderActs(); refillWorkerActs(); renderUbic();
}

/* ===== Tracking ===== */
let timer=null;
function refillWorkerFences(){
  const sel=document.getElementById("wFence"); sel.innerHTML="";
  db.geocercas.forEach(f=>{ const o=document.createElement("option"); o.value=f.id;o.textContent=f.nombre; sel.appendChild(o); });
  refillWorkerActs();
}
function refillWorkerActs(){
  const sel=document.getElementById("wAct"); sel.innerHTML="";
  const fid=document.getElementById("wFence").value || db.geocercas[0]?.id || "";
  const acts=db.actividades.filter(a=>a.fenceId===fid && a.estado!=="cerrada");
  sel.innerHTML=`<option value="">(sin actividad)</option>` + acts.map(a=>`<option value="${a.id}">${a.nombre}</option>`).join("");
}
document.getElementById("wFence").addEventListener("change", refillWorkerActs);

function startTrack(){
  if(nivel<2) return alert("Requiere rol Administrador.");
  const trabajador=document.getElementById("wNombre").value.trim(); if(!trabajador) return alert("Nombre trabajador");
  const fenceId=document.getElementById("wFence").value; const f=db.geocercas.find(x=>x.id===fenceId); if(!f) return;
  const actId=document.getElementById("wAct").value||null; const mins=parseInt(document.getElementById("wMin").value,10)||5;

  if(timer) clearInterval(timer);
  const info=document.getElementById("trackInfo");
  const tick=()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude,lng=pos.coords.longitude;
      const inside=inFence([lat,lng],f.coords);
      if(inside){
        db.ubicaciones.push({ts:Date.now(),trabajador,fenceId,actId,lat,lng,mins});
        saveDB(); renderUbic();
        info.innerHTML=`<span style="color:var(--ok)">Dentro</span> de ${f.nombre} — ${lat.toFixed(6)}, ${lng.toFixed(6)} — ${mins}m`;
      }else info.innerHTML=`<span style="color:var(--err)">Fuera</span> de ${f.nombre} — ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }, err=>{ info.textContent="Geo error: "+err.message; }, {enableHighAccuracy:true,timeout:15000,maximumAge:0});
  };
  tick(); timer=setInterval(tick, mins*60*1000);
}
function stopTrack(){ if(timer) clearInterval(timer); timer=null; document.getElementById("trackInfo").textContent="Detenido."; }
function inFence(pt,poly){ const p=turf.point([pt[1],pt[0]]); const g=turf.polygon([poly.map(c=>[c[1],c[0]])]); return turf.booleanPointInPolygon(p,g); }
function renderUbic(){
  const tb=document.querySelector("#tblUbic tbody"); tb.innerHTML="";
  db.ubicaciones.slice().reverse().slice(0,300).forEach(r=>{
    const f=db.geocercas.find(x=>x.id===r.fenceId); const a=r.actId?db.actividades.find(x=>x.id===r.actId):null;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${new Date(r.ts).toLocaleString()}</td><td>${r.trabajador}</td><td>${f?f.nombre:"(id:"+r.fenceId+")"}</td>
    <td>${a?a.nombre:"-"}</td><td>${r.lat.toFixed(6)}</td><td>${r.lng.toFixed(6)}</td><td>${r.mins||0}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== Reportes ===== */
function refillReportFences(){
  const sel=document.getElementById("repFenceSel");
  sel.innerHTML=(db.geocercas||[]).map(f=>`<option value="${f.id}">${f.nombre}</option>`).join("");
  if(selectedFenceId) sel.value=selectedFenceId;
}
function calcReport(){
  const fid=document.getElementById("repFenceSel").value || db.geocercas[0]?.id || "";
  if(!fid) return alert("Crea una geocerca.");
  const d=document.getElementById("repDesde").value, h=document.getElementById("repHasta").value;
  if(!d||!h) return alert("Indica fechas.");
  const from=new Date(d+" 00:00:00").getTime(), to=new Date(h+" 23:59:59").getTime();
  const reg=db.ubicaciones.filter(u=>u.fenceId===fid && u.ts>=from && u.ts<=to);

  const minsPers=new Map(), tarifa=new Map(); db.personal.filter(p=>p.fenceId===fid).forEach(p=>tarifa.set(p.nombre,parseFloat(p.tarifa||0)));
  const minsAct=new Map(), actName=new Map(); db.actividades.filter(a=>a.fenceId===fid).forEach(a=>actName.set(a.id,a.nombre));
  reg.forEach(r=>{ const m=parseInt(r.mins||0,10); minsPers.set(r.trabajador,(minsPers.get(r.trabajador)||0)+m); if(r.actId) minsAct.set(r.actId,(minsAct.get(r.actId)||0)+m); });

  const tbP=document.querySelector("#tblPers tbody"); tbP.innerHTML=""; let totP=0;
  for(const [nom,mins] of minsPers.entries()){
    const hrs=mins/60, t=tarifa.get(nom)||0, c=hrs*t; totP+=c;
    const tr=document.createElement("tr"); tr.innerHTML=`<td>${nom}</td><td>${hrs.toFixed(2)}</td><td>$${t.toFixed(2)}</td><td>$${c.toFixed(2)}</td>`; tbP.appendChild(tr);
  }
  document.getElementById("totPers").textContent="$"+totP.toFixed(2);

  const costAct=new Map(); reg.forEach(r=>{ if(!r.actId) return; const t=tarifa.get(r.trabajador)||0; costAct.set(r.actId,(costAct.get(r.actId)||0)+(r.mins||0)/60*t); });
  const tbA=document.querySelector("#tblAct tbody"); tbA.innerHTML=""; let totA=0;
  for(const [aid, mins] of minsAct.entries()){
    const hrs=mins/60, c=(costAct.get(aid)||0); totA+=c;
    const tr=document.createElement("tr"); tr.innerHTML=`<td>${actName.get(aid)||"(borrada)"}</td><td>${hrs.toFixed(2)}</td><td>$${c.toFixed(2)}</td>`; tbA.appendChild(tr);
  }
  document.getElementById("totAct").textContent="$"+totA.toFixed(2);
  document.getElementById("repInfo").textContent=`Registros: ${reg.length} · Rango: ${d} a ${h}`;
  document.getElementById("repTables").style.display="";
}
function csv(rows){ return rows.map(r=>r.map(s=>`"${String(s).replace(/"/g,'""')}"`).join(",")).join("\n"); }
function dl(name,txt){ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([txt],{type:"text/csv"})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function csvPers(){ const rows=[["Persona","Horas","Tarifa","Costo"]]; document.querySelectorAll("#tblPers tbody tr").forEach(tr=>rows.push([...tr.children].map(td=>td.textContent.replace(/^\$/,"")))); dl("costos_personas.csv", csv(rows)); }
function csvAct(){ const rows=[["Actividad","Horas","Costo"]]; document.querySelectorAll("#tblAct tbody tr").forEach(tr=>rows.push([...tr.children].map(td=>td.textContent.replace(/^\$/,"")))); dl("costos_actividades.csv", csv(rows)); }

/* ===== Selects y Boot ===== */
function refillSelects(){ refillWorkerFences(); refillActFence(); refillActResp(); refillReportFences(); }

function wire(){
  document.getElementById("btnLogin").onclick=doLogin;
  document.getElementById("btnCrearAdmin").onclick=createAdmin;
  document.getElementById("btnCrearUsuario").onclick=createUser;
  document.getElementById("btnCambiarUsuario").onclick=changeUser;

  document.getElementById("btnFenceNew").onclick=newFence;
  document.getElementById("btnFenceFinish").onclick=finishFence;
  document.getElementById("btnFenceCancel").onclick=cancelFence;

  document.getElementById("btnFromCoords").onclick=createFromCoords;

  document.getElementById("btnFenceEdit").onclick=startEdit;
  document.getElementById("btnFenceSave").onclick=saveEdit;
  document.getElementById("btnFenceAbort").onclick=abortEdit;

  document.getElementById("btnFenceRename").onclick=renameFence;
  document.getElementById("btnFenceDelete").onclick=deleteFence;
  document.getElementById("btnFenceExport").onclick=exportFences;

  document.getElementById("btnAddP").onclick=addPerson;

  document.getElementById("actFenceSel").addEventListener("change", ()=>{ refillActResp(); renderActs(); });
  document.getElementById("btnAddAct").onclick=addActivity;

  document.getElementById("btnStart").onclick=startTrack;
  document.getElementById("btnStop").onclick=stopTrack;

  document.getElementById("btnCalc").onclick=calcReport;
  document.getElementById("btnCsvPers").onclick=csvPers;
  document.getElementById("btnCsvAct").onclick=csvAct;
}

function boot(){
  tryActivate();
  wire();
  initUsersUI();
  const last=localStorage.getItem("last_login_email"); if(last) document.getElementById("loginEmail").value=last;
  if(users()[0] && !currentUser){ currentUser=users()[0]; }
  if(currentUser){ loadDB(); }
  renderAdmins();
  initMap();
  redrawAll();
  renderPeople(); renderActs(); renderUbic();
  refillSelects();
}
boot();
</script>
</body>
</html>
