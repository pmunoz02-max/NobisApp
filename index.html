<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nobis App • Administración</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#f7f7f9;
      --panel:#fff;
      --b:#e6e6ee;
      --brand:#2563eb;
      --accent:#ff9800;
      --ok:#10b981;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:#111;
    }
    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }
    @media (max-width: 1024px){
      .wrap{grid-template-columns: 1fr}
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--b);
      border-radius: 12px;
      padding: 14px;
    }
    h2{margin:6px 0 12px 0}
    h3{margin:12px 0 8px 0; font-size:1rem}

    #map{
      height: 56vh;
      min-height: 420px;
      border-radius:12px;
      border:1px solid var(--b);
      background:#fafafa;
    }

    .row{display:flex; gap:8px; align-items:center}
    .col{display:flex; flex-direction:column; gap:8px}
    input, textarea, select, button{font:inherit}
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid var(--b);
      border-radius:8px;
      padding:10px 12px;
      background:#fff;
    }
    textarea{height:120px; resize:vertical}
    .btn{
      padding:10px 12px;
      border:1px solid var(--b);
      border-radius:8px;
      background:#fff;
      cursor:pointer;
    }
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.warn{background:#fff7ed; border-color:#fed7aa}
    .btn.ok{background:#ecfdf5; border-color:#a7f3d0}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .list{
      border:1px solid var(--b);
      border-radius:8px;
      padding:8px;
      max-height:160px;
      overflow:auto;
      background:#fff
    }
    .item{padding:6px 8px;border-radius:6px;cursor:pointer}
    .item:hover{background:#f3f4f6}
    .item.active{background:#e8efff}

    .coordsCtl{
      background: #0f172a;
      color:#e2e8f0;
      padding:6px 10px;
      border-radius:8px;
      font-size:.9rem;
      border:1px solid rgba(255,255,255,.1);
      box-shadow: 0 4px 10px rgba(0,0,0,.15);
      user-select:none;
    }

    .help{font-size:.9rem; color:var(--muted)}
    .divider{height:1px;background:var(--b); margin:8px 0}

    .vertex-dot{
      width:12px; height:12px;
      background:#38bdf8;
      border:2px solid #0ea5e9;
      border-radius:50%;
      box-shadow: 0 0 0 2px rgba(255,255,255,.9);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Panel izquierdo -->
    <div class="panel">
      <h2>Administración</h2>
      <div class="help">Dueño: <strong>fenice.ecuador@gmail.com</strong></div>

      <h3>Geocercas</h3>
      <div class="row">
        <button id="btnNew" class="btn">Nueva (clic en mapa)</button>
        <button id="btnFinish" class="btn ok" disabled>Finalizar</button>
        <button id="btnCancel" class="btn" disabled>Cancelar</button>
      </div>

      <div class="col" style="margin-top:12px;">
        <div class="help" style="margin-bottom:4px;">Crear desde coordenadas (<code>lat,lng</code>), una por línea:</div>
        <textarea id="taCoords" placeholder="-1.7370, -77.9185&#10;-1.7315, -77.9104&#10;-1.7315, -77.9077"></textarea>
        <div class="row">
          <input id="inName" type="text" placeholder="Nombre de geocerca" />
          <button id="btnCreateFromCoords" class="btn">Crear por coordenadas</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button id="btnEdit" class="btn" disabled>Editar vértices</button>
        <button id="btnEditCancel" class="btn" disabled>Cancelar edición</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnSave" class="btn primary" disabled>Guardar</button>
        <button id="btnRename" class="btn" disabled>Renombrar</button>
        <button id="btnDelete" class="btn warn" disabled>Eliminar</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button id="btnExport" class="btn">Exportar JSON</button>
        <label class="btn" style="cursor:pointer;">
          Importar
          <input id="fileImport" type="file" accept="application/json" hidden />
        </label>
      </div>

      <h3 style="margin-top:16px;">Lista</h3>
      <div id="list" class="list" aria-live="polite"></div>
      <div class="help" style="margin-top:6px">Seleccionada: <strong id="selName">Ninguna</strong></div>
    </div>

    <!-- Panel derecho -->
    <div class="panel">
      <h2>Mapa de Geocercas</h2>
      <div id="map" role="region" aria-label="Mapa de geocercas"></div>

      <h3 style="margin-top:14px;">Histórico de ubicaciones</h3>
      <div class="help">Por ahora es un placeholder; se llenará cuando conectemos tracking.</div>
      <table style="width:100%; border-collapse:collapse; margin-top:6px; font-size:.95rem;">
        <thead>
          <tr style="background:#f3f4f6">
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">Fecha</th>
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">Trabajador</th>
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">Geocerca</th>
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">Actividad</th>
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">Lat</th>
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">Lng</th>
            <th style="text-align:left; padding:8px; border:1px solid var(--b);">mins</th>
          </tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>

<script>
/* =========================
   Estado y utilidades
========================= */
const $ = sel => document.querySelector(sel);
const storeKey = 'nobis_geofences_v2';

let geofences = [];        // {id, name, latlngs: [{lat,lng},...]}
let layers = new Map();    // id -> L.Polygon
let activeId = null;

let drawing = false;
let tempPoints = [];
let tempLine = null;
let tempPoly = null;

let editMarkers = [];      // L.marker draggable para edición

function uid(){ return 'g'+Math.random().toString(36).slice(2,8) }
function persist(){ localStorage.setItem(storeKey, JSON.stringify(geofences)) }
function load(){
  try{
    geofences = JSON.parse(localStorage.getItem(storeKey) || '[]');
    if(!Array.isArray(geofences)) geofences = [];
  }catch(e){ geofences = [] }
}

/* =========================
   Mapa Leaflet
========================= */
const map = L.map('map', {zoomControl:true}).setView([-1.731, -77.91], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

/* Control coordenadas en vivo */
const coordsCtl = L.control({position:'topright'});
coordsCtl.onAdd = function(){
  const d = L.DomUtil.create('div','coordsCtl');
  d.id = 'coordsCtl';
  d.textContent = 'Lat: –, Lng: –';
  return d;
};
coordsCtl.addTo(map);
map.on('mousemove', (e)=>{
  const el = $('#coordsCtl');
  if(el) el.textContent = `Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`;
});
setTimeout(()=> map.invalidateSize(), 200);

/* =========================
   Renderizado de geocercas
========================= */
function renderAll(){
  // limpiar capas
  layers.forEach(poly => map.removeLayer(poly));
  layers.clear();

  geofences.forEach(g=>{
    const poly = L.polygon(g.latlngs, {
      color: '#ff9800',
      weight: 4,
      fillColor: '#a7f3d0',
      fillOpacity: 0.35,
      bubblingMouseEvents: false
    }).addTo(map);

    // por si algún plugin habilita drag del path
    if (poly.dragging && typeof poly.dragging.disable === 'function') {
      poly.dragging.disable();
    }

    poly.on('click', () => selectGeofence(g.id));
    layers.set(g.id, poly);
  });

  renderList();
  setSelectedLabel();
}

function renderList(){
  const box = $('#list');
  box.innerHTML = '';
  geofences.forEach(g=>{
    const div = document.createElement('div');
    div.className = 'item' + (g.id===activeId?' active':'');
    div.textContent = `${g.name} (${g.latlngs.length} pts)`;
    div.onclick = ()=> selectGeofence(g.id);
    box.appendChild(div);
  });
}

function setSelectedLabel(){
  const g = geofences.find(x=>x.id===activeId);
  $('#selName').textContent = g ? g.name : 'Ninguna';
  const has = !!g;
  $('#btnEdit').disabled = !has;
  $('#btnRename').disabled = !has;
  $('#btnDelete').disabled = !has;
  $('#btnSave').disabled = !has;
}

/* Seleccionar geocerca por id */
function selectGeofence(id, fit=true){
  activeId = id;
  renderList();
  setSelectedLabel();
  const poly = layers.get(id);
  if(poly && fit){
    map.fitBounds(poly.getBounds(), {padding:[20,20]});
  }
  stopEditing(); // por si estaba editando
}

/* =========================
   Dibujo manual por clics
========================= */
function startDrawing(){
  if(drawing) return;
  drawing = true;
  tempPoints = [];
  if(tempLine){ map.removeLayer(tempLine); tempLine=null }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null }

  $('#btnNew').disabled = true;
  $('#btnFinish').disabled = false;
  $('#btnCancel').disabled = false;

  map.getContainer().style.cursor = 'crosshair';
  map.on('click', addTempPoint);
}
function addTempPoint(e){
  tempPoints.push(e.latlng);

  if(tempLine) map.removeLayer(tempLine);
  tempLine = L.polyline(tempPoints, {color:'#ff9800', weight:2, dashArray:'6,6'}).addTo(map);

  if(tempPoly) map.removeLayer(tempPoly);
  if(tempPoints.length>=3){
    tempPoly = L.polygon(tempPoints, {
      color:'#ff9800', weight:4,
      fillColor:'#a7f3d0', fillOpacity:.35
    }).addTo(map);
  }
}
function finishDrawing(){
  if(!drawing) return;
  if(tempPoints.length<3){ alert('Necesitas al menos 3 puntos.'); return; }
  const id = uid();
  const name = 'Geocerca ' + (geofences.length+1);
  geofences.push({id, name, latlngs: tempPoints.map(p=>({lat:p.lat, lng:p.lng}))});
  persist();

  map.off('click', addTempPoint);
  if(tempLine){ map.removeLayer(tempLine); tempLine=null }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null }
  drawing=false;
  map.getContainer().style.cursor = '';

  $('#btnNew').disabled = false;
  $('#btnFinish').disabled = true;
  $('#btnCancel').disabled = true;

  renderAll();
  selectGeofence(id);
}
function cancelDrawing(){
  if(!drawing) return;
  drawing=false;
  map.off('click', addTempPoint);
  if(tempLine){ map.removeLayer(tempLine); tempLine=null }
  if(tempPoly){ map.removeLayer(tempPoly); tempPoly=null }
  map.getContainer().style.cursor = '';
  $('#btnNew').disabled = false;
  $('#btnFinish').disabled = true;
  $('#btnCancel').disabled = true;
}

/* =========================
   Crear desde textarea
========================= */
function createFromTextarea(){
  const raw = $('#taCoords').value.trim();
  if(!raw){ alert('Pega coordenadas (lat,lng), una por línea.'); return; }
  const lines = raw.split(/\r?\n/);
  const pts = [];
  for(const ln of lines){
    const m = ln.split(',').map(x=>x.trim());
    if(m.length<2) continue;
    const lat = parseFloat(m[0]);
    const lng = parseFloat(m[1]);
    if(Number.isFinite(lat) && Number.isFinite(lng)) pts.push({lat, lng});
  }
  if(pts.length<3){ alert('Se requieren al menos 3 pares lat,lng.'); return; }
  const id = uid();
  const nm = ($('#inName').value.trim() || ('Geocerca '+(geofences.length+1)));
  geofences.push({id, name:nm, latlngs: pts});
  persist();
  renderAll();
  selectGeofence(id);
  $('#inName').value='';
}

/* =========================
   Edición de vértices (arrastrables) — FIX
========================= */
const vertexIcon = L.divIcon({ className:'vertex-dot', iconSize:[12,12], iconAnchor:[6,6] });

function startEditing(){
  const g = geofences.find(x=>x.id===activeId);
  if(!g) return;
  stopEditing(); // limpiar si ya había

  const poly = layers.get(g.id);
  if(!poly) return;

  // asegurar que el polígono NO sea arrastrable si existe plugin
  if (poly.dragging && typeof poly.dragging.disable === 'function') {
    poly.dragging.disable();
  }

  editMarkers = g.latlngs.map((p, idx)=>{
    const mk = L.marker([p.lat, p.lng], {
      draggable:true,
      icon:vertexIcon,
      autoPan:true,
      autoPanPadding:[60,60],
      autoPanSpeed: 10
    }).addTo(map);

    // Evitar que el mapa/PATH se arrastre mientras movemos el vértice
    mk.on('dragstart', () => {
      map.dragging.disable();
      map.doubleClickZoom.disable();
    });

    mk.on('drag', ev=>{
      const ll = ev.target.getLatLng();
      // Actualiza ÚNICAMENTE este vértice
      g.latlngs[idx] = {lat: ll.lat, lng: ll.lng};
      poly.setLatLngs(g.latlngs);
    });

    mk.on('dragend', () => {
      map.dragging.enable();
      map.doubleClickZoom.enable();
      persist();               // guarda cambio de forma
    });

    // Evita que el mousedown burbujee al mapa (algunos navegadores)
    mk.on('mousedown', (e)=>{
      if (e.originalEvent) {
        e.originalEvent.stopPropagation();
      }
    });

    return mk;
  });

  $('#btnEdit').disabled = true;
  $('#btnEditCancel').disabled = false;
}
function stopEditing(){
  editMarkers.forEach(m=> map.removeLayer(m));
  editMarkers = [];
  $('#btnEdit').disabled = !activeId;
  $('#btnEditCancel').disabled = true;
}

/* =========================
   Guardar / Renombrar / Eliminar
========================= */
function saveActive(){
  const g = geofences.find(x=>x.id===activeId);
  if(!g) return;
  persist();
  alert('Geocerca guardada.');
}
function renameActive(){
  const g = geofences.find(x=>x.id===activeId);
  if(!g) return;
  const nv = prompt('Nuevo nombre:', g.name);
  if(nv && nv.trim()){
    g.name = nv.trim();
    persist();
    renderAll();
    selectGeofence(g.id, false);
  }
}
function deleteActive(){
  const g = geofences.find(x=>x.id===activeId);
  if(!g) return;
  if(!confirm(`¿Eliminar "${g.name}"?`)) return;
  geofences = geofences.filter(x=>x.id!==g.id);
  persist();
  activeId = null;
  renderAll();
  setSelectedLabel();
}

/* =========================
   Exportar / Importar
========================= */
function exportJSON(){
  const blob = new Blob([JSON.stringify(geofences, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'geocercas.json';
  a.click();
  URL.revokeObjectURL(url);
}
$('#fileImport').addEventListener('change', (ev)=>{
  const f = ev.target.files?.[0];
  if(!f) return;
  const rd = new FileReader();
  rd.onload = ()=>{
    try{
      const arr = JSON.parse(rd.result);
      if(Array.isArray(arr)){
        geofences = arr.filter(x=>x && x.id && x.latlngs);
        persist();
        renderAll();
        activeId = null;
        setSelectedLabel();
        alert('Importado correctamente.');
      }else{
        alert('Archivo inválido.');
      }
    }catch(e){
      alert('No se pudo leer el JSON.');
    }
  };
  rd.readAsText(f);
  ev.target.value = '';
});

/* =========================
   Eventos UI
========================= */
$('#btnNew').onclick = startDrawing;
$('#btnFinish').onclick = finishDrawing;
$('#btnCancel').onclick = cancelDrawing;

$('#btnCreateFromCoords').onclick = createFromTextarea;

$('#btnEdit').onclick = startEditing;
$('#btnEditCancel').onclick = stopEditing;

$('#btnSave').onclick = saveActive;
$('#btnRename').onclick = renameActive;
$('#btnDelete').onclick = deleteActive;

$('#btnExport').onclick = exportJSON;

/* =========================
   Carga inicial
========================= */
load();
renderAll();
setSelectedLabel();
</script>
</body>
</html>
