<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Personal de Finca (Leaflet + Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f3f4f6;overflow-x:hidden}
    #map{height:55vh;border-radius:1rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    @media(max-width:768px){#map{height:45vh}}
    .farm-label{background:#fff;border:1px solid rgba(0,0,0,.2);padding:2px 6px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.15);font-size:12px}
    .mousepos-control{background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .error-message{color:#dc2626;font-size:14px;margin-top:6px;display:none}
    button,input,select{font-size:16px}
    .person-row:hover{background-color:#f9fafb;}
    .badge{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem;display:inline-block}
    .badge-green{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .badge-gray{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
    /* Reportes */
    .multiselect{min-height:42px}
    .scrollbox{max-height:12rem;overflow:auto}
    /* Mantener utilidad .hidden funcional para mostrar/ocultar modal/contenido */
    .hidden { display: none !important; }
  </style>
</head>
<body class="p-4 sm:p-8">
  <!-- Modal admin -->
  <div id="adminModal" class="fixed inset-0 bg-gray-900/75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input id="adminCodeInput" type="password" placeholder="Código de acceso" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2">
      <div id="errorMessage" class="error-message">Código incorrecto. Intenta con "admin123"</div>
      <button id="adminLoginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-3 rounded-lg">
        Acceder
      </button>
    </div>
  </div>

  <!-- Contenido -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">
    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Control de Personal y Geocercas</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Leaflet + Firestore (con caché local)</p>
    </header>
    
    <!-- Finca activa -->
    <div class="bg-white p-4 rounded-2xl shadow-lg">
      <label class="block text-sm font-medium text-gray-700">Finca activa</label>
      <select id="farmSelect" class="mt-1 w-full border rounded-md p-2"></select>
    </div>
    
    <!-- Mapa + barra -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa de Fincas</h2>
        <div class="ml-auto flex flex-wrap gap-2">
          <button id="startFenceBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="hidden bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg">Finalizar geocerca</button>
          <button id="cancelFenceBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          <button id="createFenceByCoordsBtn" class="bg-sky-700 hover:bg-sky-800 text-white font-semibold px-4 py-2 rounded-lg">Geocerca (Lat/Lngs)</button>
          <button id="createFarmBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca</button>
          <button id="createByCoordsBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca (Lat/Lng)</button>
          <button id="deleteFarmBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar finca</button>
          <button id="deleteFenceBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar geocerca</button>
          <button id="editFenceBtn" class="bg-violet-600 hover:bg-violet-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar cambios</button>
          <button id="cancelFenceEditBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar edición</button>
          <button id="exportGeoJSONBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-4 py-2 rounded-lg">Exportar GeoJSON</button>
          <label class="inline-flex items-center gap-2 bg-teal-50 hover:bg-teal-100 text-teal-700 font-semibold px-4 py-2 rounded-lg cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJSONInput" type="file" accept=".geojson,application/geo+json,application/json" class="hidden">
          </label>
        </div>
      </div>
      
      <!-- Panel nombre finca (Lat/Lng) -->
      <div id="coordsNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la nueva finca</label>
          <div class="flex gap-2">
            <input id="coordsNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Finca Palora Norte" />
            <button id="coordsNameSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="coordsNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="coordsNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>
      
      <!-- Panel nombre geocerca -->
      <div id="fenceNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex gap-2">
            <input id="fenceNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Geocerca Lote 1" />
            <button id="fenceNameSaveBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="fenceNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="fenceNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>
      
      <div id="map"></div>
      
      <!-- Explorador -->
      <div id="indexPanel" class="mt-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800">Explorador de elementos</h3>
          <span class="text-xs text-gray-500">Doble clic en un nombre para centrar/ajustar el mapa</span>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-2">
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Fincas</div>
            <ul id="farmList" class="divide-y divide-gray-100"></ul>
          </div>
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Geocercas</div>
            <ul id="fenceList" class="divide-y divide-gray-100"></ul>
          </div>
        </div>
      </div>
      <p id="statusMessage" class="mt-3 text-sm text-gray-600">
        Para geocercas: Nueva geocerca → clics en el mapa → Finalizar geocerca → asigna nombre y guarda.
      </p>
    </div>
    
    <!-- ===== Gestión de Personal ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Gestión de Personal</h2>
        <span class="text-xs text-gray-500">Doble clic sobre una fila para ir a su asignación</span>
      </div>
      <div class="grid md:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre</label>
          <input id="pFirstName" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Apellido</label>
          <input id="pLastName" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Cédula</label>
          <input id="pIdNumber" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Asignación</label>
          <select id="pAssignSelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 mb-1">
            <input id="pActive" type="checkbox" class="rounded" checked>
            <span class="text-sm font-medium text-gray-700">Activo</span>
          </label>
        </div>
      </div>
      <div class="mt-3">
        <button id="addPersonBtn" type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
          Agregar
        </button>
        <span id="pFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>
      
      <!-- Filtros -->
      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Buscar</label>
          <input id="pSearchInput" type="text" placeholder="Nombre, apellido o cédula" class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo asignación</label>
          <select id="pTypeFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
            <option value="farm">Fincas</option>
            <option value="fence">Geocercas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Finca/Geocerca</label>
          <select id="pEntityFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
      </div>
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">NOMBRE</th>
              <th class="px-3 py-2">APELLIDO</th>
              <th class="px-3 py-2">CÉDULA</th>
              <th class="px-3 py-2">ESTADO</th>
              <th class="px-3 py-2">ASIGNADO A</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="personnelTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ===== Gestión de Actividades ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Gestión de Actividades</h2>
        <span class="text-xs text-gray-500">Doble clic en una fila para ir a su finca/geocerca</span>
      </div>
      <!-- Form alta -->
      <div class="grid md:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">
            Actividad
            <button id="actManageBtn" type="button" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded">
              Editar lista
            </button>
          </label>
          <select id="actActivitySelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Persona</label>
          <select id="actPersonSelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Finca/Geocerca</label>
          <select id="actEntitySelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fecha inicio</label>
          <input id="actStartDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fecha fin</label>
          <input id="actEndDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
      </div>
      <div class="mt-3">
        <button id="addActivityBtn" type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
          Agregar actividad
        </button>
        <span id="actFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>
      
      <!-- Filtros -->
      <div class="mt-6 grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Persona</label>
          <select id="actFilterPerson" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Actividad</label>
          <select id="actFilterActivity" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Desde</label>
          <input id="actFilterFrom" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Hasta</label>
          <input id="actFilterTo" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
      </div>
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">ACTIVIDAD</th>
              <th class="px-3 py-2">PERSONA</th>
              <th class="px-3 py-2">ENTidad</th>
              <th class="px-3 py-2">FECHA INICIO</th>
              <th class="px-3 py-2">FECHA FIN</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="activityTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ===== Costos de mano de obra ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg" id="laborCostsModule">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Costos de mano de obra</h2>
        <span class="text-xs text-gray-500">Define el costo diario por persona y su rango de vigencia</span>
      </div>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Persona (activa)</label>
          <div class="flex gap-2">
            <input id="lcPersonDisplay" type="text" class="mt-1 w-full border rounded-md p-2" placeholder="Sin seleccionar" readonly>
            <button id="lcChoosePersonBtn" type="button" class="mt-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-3 py-2 rounded-lg">Elegir</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Costo por día</label>
          <input id="lcDailyCost" type="number" step="0.01" min="0" class="mt-1 w-full border rounded-md p-2" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Desde</label>
          <input id="lcStartDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Hasta</label>
          <input id="lcEndDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
      </div>
      <div class="mt-3">
        <button id="lcAddCostBtn" type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar costo</button>
        <span id="lcFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">PERSONA</th>
              <th class="px-3 py-2">COSTO/DÍA</th>
              <th class="px-3 py-2">DESDE</th>
              <th class="px-3 py-2">HASTA</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="laborCostTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ===== Reportes ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg" id="reportsModule">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Reportes</h2>
        <span class="text-xs text-gray-500">Tablas descargables y gráficos por persona, entidad, actividad y fechas</span>
      </div>
      <div class="grid md:grid-cols-6 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Personas (Ctrl/Cmd para multi)</label>
          <select id="repPersons" class="mt-1 w-full border rounded-md p-2 multiselect" multiple size="6"></select>
          <label class="inline-flex items-center gap-2 mt-2">
            <input id="repOnlyActive" type="checkbox" class="rounded" checked>
            <span class="text-sm text-gray-700">Solo activas</span>
          </label>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Fincas/Geocercas</label>
          <select id="repEntities" class="mt-1 w-full border rounded-md p-2 multiselect" multiple size="6"></select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Actividades</label>
          <select id="repActivities" class="mt-1 w-full border rounded-md p-2 multiselect" multiple size="6"></select>
          <div class="grid grid-cols-2 gap-2 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Desde</label>
              <input id="repFrom" type="date" class="mt-1 w-full border rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Hasta</label>
              <input id="repTo" type="date" class="mt-1 w-full border rounded-md p-2">
            </div>
          </div>
        </div>
      </div>
      <div class="grid md:grid-cols-5 gap-4 mt-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Agrupar por</label>
          <select id="repGroupBy" class="mt-1 w-full border rounded-md p-2">
            <option value="detalle">Detalle</option>
            <option value="persona">Persona</option>
            <option value="entidad">Entidad</option>
            <option value="actividad">Actividad</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Métrica (para gráficos)</label>
          <select id="repMetric" class="mt-1 w-full border rounded-md p-2">
            <option value="count">Actividades</option>
            <option value="days">Días</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo de gráfico</label>
          <select id="repChartType" class="mt-1 w-full border rounded-md p-2">
            <option value="bar">Barras</option>
            <option value="line">Líneas</option>
            <option value="doughnut">Pastel</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="repGenerateBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Generar</button>
        </div>
        <div class="flex items-end">
          <button id="repDownloadBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Descargar CSV (Excel)</button>
        </div>
      </div>
      <!-- Tabla -->
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left" id="repTable">
          <thead id="repTableHead"></thead>
          <tbody id="repTableBody" class="text-sm"></tbody>
        </table>
      </div>
      <!-- Gráfico -->
      <div class="mt-6 bg-white rounded-xl border border-gray-200 p-4">
        <canvas id="repChart" height="120"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Modal: elegir persona activa (costos) -->
  <div id="lcPersonModal" class="fixed inset-0 bg-gray-900/75 hidden items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Seleccionar persona (activa)</h3>
        <button id="lcModalClose" class="text-gray-600 hover:text-gray-900">✕</button>
      </div>
      <input id="lcModalSearch" type="text" placeholder="Buscar por nombre o cédula" class="w-full border rounded-md p-2 mb-3">
      <div id="lcModalList" class="max-h-80 overflow-auto divide-y divide-gray-100"></div>
      <div class="mt-4 text-right">
        <button id="lcModalCancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Scripts Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Chart.js (para los reportes) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE",
      authDomain: "demo-finca-app.firebaseapp.com",
      projectId: "demo-finca-app",
      storageBucket: "demo-finca-app.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    try {
      db.settings({
        experimentalForceLongPolling: true,
        experimentalAutoDetectLongPolling: true,
        useFetchStreams: false
      });
    } catch {}
    let authReady = false;
    firebase.auth().signInAnonymously().catch(console.error);
    firebase.auth().onAuthStateChanged(u => authReady = !!u);

    /* ---------- Estado y caché ---------- */
    let map;
    const fincaMarkers = {}, geofenceLayers = {};
    const LS_KEY='fincas_cache_v1', LS_GF='geofences_cache_v1', LS_PE='personnel_cache_v1', LS_AC='activities_cache_v1', LS_AD='activity_defs_v1', LS_LC='labor_costs_cache_v1';
    const save = (k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load = (k)=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return []}};
    const saveFarms=(v)=>save(LS_KEY,v), loadFarms=()=>load(LS_KEY);
    const saveFences=(v)=>save(LS_GF,v), loadFences=()=>load(LS_GF);
    const savePeople=(v)=>save(LS_PE,v), loadPeople=()=>load(LS_PE);
    const saveActs=(v)=>save(LS_AC,v), loadActs=()=>load(LS_AC);
    const saveLaborCosts=(v)=>save(LS_LC,v), loadLaborCosts=()=>load(LS_LC);
    const DEFAULT_ACTIVITY_OPTIONS = ['Siembra','Riego','Cosecha','Poda','Fertilización','Fumigación','Mantenimiento','Limpieza','Transporte','Supervisión'];
    const loadActivityDefs = () => {
      try {
        const val = JSON.parse(localStorage.getItem(LS_AD) || 'null');
        if (Array.isArray(val) && val.length) return val;
      } catch {}
      return DEFAULT_ACTIVITY_OPTIONS.slice();
    };
    const saveActivityDefs = (arr) => {
      try{ localStorage.setItem(LS_AD, JSON.stringify(arr)); }catch{}
    };
    let activityDefs = loadActivityDefs();
    let currentFarms=[], currentFences=[], currentPersonnel=[], currentActivities=[], currentLaborCosts=[];
    const GEOFENCE_STYLE={weight:2,fillOpacity:.15}, GEOFENCE_SELECTED_STYLE={weight:3,color:'#ef4444',fillOpacity:.2};
    let isDrawingFence=false, drawingCoords=[], drawingPolyline=null, drawingMarkers=[], pendingFenceCoords=null;
    let selectedFenceId=null, editGroup=null, editToolbar=null, isEditingFence=false, editBackupCoords=null;
    function waitAuthThen(fn){
      if(authReady) return fn();
      const t=setInterval(()=>{
        if(authReady){clearInterval(t); fn();}},120);
    }

    /* ---------- Mapa ---------- */
    function initMap(center){
      center=center||{lat:-0.1807,lng:-78.4678};
      
      // Asegurarse de que el contenedor del mapa existe y es visible
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.error('El contenedor del mapa no existe');
        return;
      }
      
      // Inicializar el mapa
      map=L.map('map',{center:[center.lat,center.lng],zoom:6});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      editGroup=new L.FeatureGroup();
      map.addLayer(editGroup);
      addMousePositionControl();
      renderFarmsFromCache();
      renderGeofencesFromCache();
      
      map.on('click', async e=>{
        if(isDrawingFence){
          addFenceVertex(e.latlng);
          return;
        }
        const name=prompt('Nombre de la nueva finca:');
        if(!name) return;
        try{
          await db.collection('farms').add({name,fincaLocation:{lat:e.latlng.lat,lng:e.latlng.lng}});
        } catch{
          const farms=loadFarms();
          farms.push({id:'local-'+Date.now(),name,fincaLocation:{lat:e.latlng.lat,lng:e.latlng.lng}});
          saveFarms(farms);
          renderFarmsFromCache();
        }
      });
      
      waitAuthThen(async()=>{
        startSubscriptions();
        await Promise.all([initialFetchFarms(),initialFetchGeofences(),initialFetchPersonnel(),initialFetchActivities(),initialFetchLaborCosts()]);
        syncLocalPendingToFirestore();
      });
    }

    function addMousePositionControl(){
      const MousePos=L.Control.extend({options:{position:'bottomleft'},onAdd:function(){const d=L.DomUtil.create('div','mousepos-control');d.innerHTML='Lat: — Lng: —';this._div=d;return d;},update:function(lat,lng){this._div.innerHTML=(lat!=null&&lng!=null)?`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`:'Lat: — Lng: —';}});
      const ctrl=new MousePos();
      ctrl.addTo(map);
      map.on('mousemove',e=>ctrl.update(e.latlng.lat,e.latlng.lng));
      map.on('mouseout',()=>ctrl.update(null,null));
    }

    function renderFarmsFromCache(){
      const farms=loadFarms();
      Object.values(fincaMarkers).forEach(m=>map.removeLayer(m));
      for(const k in fincaMarkers) delete fincaMarkers[k];
      farms.forEach(f=>{
        if(!f?.id||!f?.fincaLocation) return;
        const m=L.marker([f.fincaLocation.lat,f.fincaLocation.lng]).addTo(map);
        m.bindTooltip(f.name||'Finca',{permanent:true,direction:'right',offset:[10,0],className:'farm-label'});
        fincaMarkers[f.id]=m;});
      const sel=document.getElementById('farmSelect');
      if(sel){
        sel.innerHTML='';
        farms.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o);});
      }
      updateDeleteButtonState();
      currentFarms=farms||[];
      buildIndexList();
      buildAssignOptions();
      buildActivityFormOptions();
      buildReportFilterOptions();
    }

    function renderGeofencesFromCache(){
      Object.values(geofenceLayers).forEach(p=>map.removeLayer(p));
      for(const k in geofenceLayers) delete geofenceLayers[k];
      const fences=loadFences();
      fences.forEach(g=>{
        if(!g?.id||!Array.isArray(g.path)||g.path.length<3) return;
        const latlngs=g.path.map(p=>[p.lat,p.lng]);
        const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map);
        poly.bindTooltip(g.name||'Geocerca',{permanent:true,direction:'center',className:'farm-label'});
        geofenceLayers[g.id]=poly;
        poly.on('click',()=>selectFence(g.id));
        if(selectedFenceId===g.id) poly.setStyle(GEOFENCE_SELECTED_STYLE);
      });
      if(selectedFenceId && !geofenceLayers[selectedFenceId]) selectedFenceId=null;
      updateDeleteFenceButtonState();
      updateEditButtonsState();
      currentFences=fences||[];
      buildIndexList();
      buildAssignOptions();
      buildActivityFormOptions();
      buildReportFilterOptions();
    }

    /* ---------- Suscripciones ---------- */
    let unsubFarms=null,unsubGeofences=null,unsubPersonnel=null,unsubActivities=null,unsubLaborCosts=null,subsStarted=false;
    function startSubscriptions(){
      if(subsStarted) return;
      subsStarted=true;
      unsubFarms=db.collection('farms').onSnapshot(s=>{
        const farms=[];
        Object.values(fincaMarkers).forEach(m=>map.removeLayer(m));
        for(const k in fincaMarkers) delete fincaMarkers[k];
        s.forEach(doc=>{const d=doc.data(); farms.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation});
          if(d.fincaLocation){const m=L.marker([d.fincaLocation.lat,d.fincaLocation.lng]).addTo(map);
            m.bindTooltip(d.name||'Finca',{permanent:true,direction:'right',offset:[10,0],className:'farm-label'});
            fincaMarkers[doc.id]=m; }});
        if(farms.length){
          currentFarms=farms.slice();
          saveFarms(farms);
        } else {
          currentFarms=loadFarms();
          renderFarmsFromCache();
          return;
        }
        const sel=document.getElementById('farmSelect');
        if(sel){
          sel.innerHTML='';
          farms.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o);});
        }
        updateDeleteButtonState();
        buildIndexList();
        buildAssignOptions();
        buildActivityFormOptions();
        buildReportFilterOptions();
      },()=>renderFarmsFromCache());
      unsubGeofences=db.collection('geofences').onSnapshot(s=>{
        const fences=[];
        Object.values(geofenceLayers).forEach(p=>map.removeLayer(p));
        for(const k in geofenceLayers) delete geofenceLayers[k];
        s.forEach(doc=>{const d=doc.data();
          const g={id:doc.id,name:d.name,path:d.path||[]};
          fences.push(g);
          if(Array.isArray(g.path)&&g.path.length>=3){
            const latlngs=g.path.map(p=>[p.lat,p.lng]);
            const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map);
            poly.bindTooltip(g.name||'Geocerca',{permanent:true,direction:'center',className:'farm-label'});
            geofenceLayers[doc.id]=poly;
            poly.on('click',()=>selectFence(doc.id));
            if(selectedFenceId===doc.id) poly.setStyle(GEOFENCE_SELECTED_STYLE);
          }
        });
        if(fences.length){
          currentFences=fences.slice();
          saveFences(fences);
        } else {
          currentFences=loadFences();
          renderGeofencesFromCache();
          return;
        }
        if(selectedFenceId && !geofenceLayers[selectedFenceId]) selectedFenceId=null;
        updateDeleteFenceButtonState();
        updateEditButtonsState();
        buildIndexList();
        buildAssignOptions();
        buildActivityFormOptions();
        buildReportFilterOptions();
      },()=>renderGeofencesFromCache());
      unsubPersonnel=db.collection('personnel').onSnapshot(s=>{
        const list=[];
        s.forEach(doc=>{const d=doc.data();
          list.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||'',active:(d.active!==false)});});
        if(list.length){
          currentPersonnel=list.slice();
          savePeople(list);
        } else {
          currentPersonnel=loadPeople();
        }
        renderPersonnelList();
        buildActivityFormOptions();
        buildLaborCostPersonCache();
        buildReportFilterOptions();
      },()=>{
        currentPersonnel=loadPeople();
        renderPersonnelList();
        buildActivityFormOptions();
        buildLaborCostPersonCache();
        buildReportFilterOptions();
      });
      unsubActivities=db.collection('activities').onSnapshot(s=>{
        const list=[];
        s.forEach(doc=>{const d=doc.data();
          list.push({
            id:doc.id,
            activity:d.activity||'',
            personId:d.personId||'',
            personName:d.personName||'',
            assignType:d.assignType||'',
            assignId:d.assignId||'',
            entityName:d.entityName||'',
            startDate:d.startDate||'',
            endDate:d.endDate||''
          });});
        if(list.length){
          currentActivities=list.slice();
          saveActs(list);
        } else {
          currentActivities=loadActs();
        }
        renderActivityList();
        buildActivityFilterOptions();
        buildReportFilterOptions();
      },()=>{
        currentActivities=loadActs();
        renderActivityList();
        buildActivityFilterOptions();
        buildReportFilterOptions();
      });
      unsubLaborCosts=db.collection('labor_costs').onSnapshot(s=>{
        const list=[];
        s.forEach(doc=>{const d=doc.data();
          list.push({id:doc.id,personId:d.personId||'',personName:d.personName||'',dailyCost:+(d.dailyCost||0),startDate:d.startDate||'',endDate:d.endDate||''});});
        if(list.length){
          currentLaborCosts=list.slice();
          saveLaborCosts(list);
        } else {
          currentLaborCosts=loadLaborCosts();
        }
        renderLaborCostList();
      },()=>{
        currentLaborCosts=loadLaborCosts();
        renderLaborCostList();
      });
    }

    async function initialFetchFarms(){
      try{
        const s=await db.collection('farms').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation});});
        currentFarms=arr.length?arr.slice():loadFarms();
        if(arr.length) saveFarms(arr);
        renderFarmsFromCache();
      }catch{
        renderFarmsFromCache();
      }
    }

    async function initialFetchGeofences(){
      try{
        const s=await db.collection('geofences').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,name:d.name,path:d.path||[]});});
        currentFences=arr.length?arr.slice():loadFences();
        if(arr.length) saveFences(arr);
        renderGeofencesFromCache();
      }catch{
        renderGeofencesFromCache();
      }
    }

    async function initialFetchPersonnel(){
      try{
        const s=await db.collection('personnel').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||'',active:(d.active!==false)});});
        currentPersonnel=arr.length?arr.slice():loadPeople();
        if(arr.length) savePeople(arr);
        renderPersonnelList();
      }catch{
        currentPersonnel=loadPeople();
        renderPersonnelList();
      }
    }

    async function initialFetchActivities(){
      try{
        const s=await db.collection('activities').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,activity:d.activity||'',personId:d.personId||'',personName:d.personName||'',assignType:d.assignType||'',assignId:d.assignId||'',entityName:d.entityName||'',startDate:d.startDate||'',endDate:d.endDate||''});});
        currentActivities=arr.length?arr.slice():loadActs();
        if(arr.length) saveActs(arr);
        renderActivityList();
      }catch{
        currentActivities=loadActs();
        renderActivityList();
      }
    }

    async function initialFetchLaborCosts(){
      try{
        const s=await db.collection('labor_costs').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,personId:d.personId||'',personName:d.personName||'',dailyCost:+(d.dailyCost||0),startDate:d.startDate||'',endDate:d.endDate||''});});
        currentLaborCosts=arr.length?arr.slice():loadLaborCosts();
        if(arr.length) saveLaborCosts(arr);
        renderLaborCostList();
      }catch{
        currentLaborCosts=loadLaborCosts();
        renderLaborCostList();
      }
    }

    async function syncLocalPendingToFirestore(){
      try{
        const farms=loadFarms().filter(f=>String(f.id||'').startsWith('local-'));
        for(const f of farms){
          try{await db.collection('farms').add({name:f.name||'Finca',fincaLocation:f.fincaLocation||null});}catch{}
          saveFarms(loadFarms().filter(x=>x.id!==f.id));
        }
      }catch{}
      try{
        const fences=loadFences().filter(g=>String(g.id||'').startsWith('localgf-'));
        for(const g of fences){
          try{await db.collection('geofences').add({name:g.name||'Geocerca',path:Array.isArray(g.path)?g.path:[]});}catch{}
          saveFences(loadFences().filter(x=>x.id!==g.id));
        }
      }catch{}
      try{
        const ppl=loadPeople().filter(p=>String(p.id||'').startsWith('localp-'));
        for(const p of ppl){
          try{await db.collection('personnel').add({firstName:p.firstName||'',lastName:p.lastName||'',idNumber:p.idNumber||'',assignType:p.assignType||'',assignId:p.assignId||'',active:(p.active!==false)});
          }catch{}
          savePeople(loadPeople().filter(x=>x.id!==p.id));
        }
      }catch{}
      try{
        const acts=loadActs().filter(a=>String(a.id||'').startsWith('locala-'));
        for(const a of acts){
          try{await db.collection('activities').add({activity:a.activity,personId:a.personId,personName:a.personName,assignType:a.assignType,assignId:a.assignId,entityName:a.entityName,startDate:a.startDate,endDate:a.endDate});}catch{}
          saveActs(loadActs().filter(x=>x.id!==a.id));
        }
      }catch{}
      try{
        const lcs=loadLaborCosts().filter(c=>String(c.id||'').startsWith('localc-'));
        for(const c of lcs){
          try{await db.collection('labor_costs').add({personId:c.personId,personName:c.personName,dailyCost:c.dailyCost,startDate:c.startDate,endDate:c.endDate});}catch{}
          saveLaborCosts(loadLaborCosts().filter(x=>x.id!==c.id));
        }
      }catch{}
    }

    /* ---------- Geocercas (igual) ---------- */
    function selectFence(id){
      if(isEditingFence){
        alert('Estás editando una geocerca. Guarda o cancela antes.');
        return;
      }
      if(selectedFenceId&&geofenceLayers[selectedFenceId]) geofenceLayers[selectedFenceId].setStyle(GEOFENCE_STYLE);
      selectedFenceId=id;
      if(geofenceLayers[id]) geofenceLayers[id].setStyle(GEOFENCE_SELECTED_STYLE);
      updateDeleteFenceButtonState();
      updateEditButtonsState();
    }

    function updateDeleteButtonState(){
      const sel=document.getElementById('farmSelect'), btn=document.getElementById('deleteFarmBtn');
      if(btn) btn.disabled=!(sel&&sel.value);
    }

    function updateDeleteFenceButtonState(){
      const btn=document.getElementById('deleteFenceBtn');
      if(btn) btn.disabled=!selectedFenceId;
    }

    function updateEditButtonsState(){
      const btn=document.getElementById('editFenceBtn');
      if(btn) btn.disabled=!(selectedFenceId&&geofenceLayers[selectedFenceId]&&!isEditingFence);
      document.getElementById('saveFenceEditBtn')?.classList.toggle('hidden',!isEditingFence);
      document.getElementById('cancelFenceEditBtn')?.classList.toggle('hidden',!isEditingFence);
    }

    function addFenceVertex(latlng){
      drawingCoords.push({lat:latlng.lat,lng:latlng.lng});
      const m=L.circleMarker(latlng,{radius:4,weight:2}).addTo(map);
      drawingMarkers.push(m);
      const latlngs=drawingCoords.map(p=>[p.lat,p.lng]);
      if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;}
      if(latlngs.length>=3) drawingPolyline=L.polygon(latlngs,{dashArray:'4,4',weight:2,fillOpacity:.1}).addTo(map);
      else if(latlngs.length>=2) drawingPolyline=L.polyline(latlngs,{dashArray:'4,4',weight:2}).addTo(map);
    }

    function startFenceDraw(){
      if(isDrawingFence) return;
      isDrawingFence=true;
      drawingCoords=[];
      drawingMarkers.forEach(m=>map.removeLayer(m));
      drawingMarkers=[];
      if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;}
      document.getElementById('startFenceBtn').classList.add('hidden');
      document.getElementById('finishFenceBtn').classList.remove('hidden');
      document.getElementById('cancelFenceBtn').classList.remove('hidden');
    }

    function finishFenceDraw(){
      if(!isDrawingFence) return;
      if(drawingCoords.length<3){alert('La geocerca necesita al menos 3 puntos.');return;}
      pendingFenceCoords=drawingCoords.slice();
      document.getElementById('fenceNameHint').textContent=`Vértices: ${pendingFenceCoords.length} puntos`;
      const input=document.getElementById('fenceNameInput');
      input.value=`Geocerca ${new Date().toLocaleDateString()}`;
      document.getElementById('fenceNamePanel').classList.remove('hidden');
      input.focus();
      input.select();
    }

    function cancelFenceDraw(){
      isDrawingFence=false;
      drawingCoords=[];
      drawingMarkers.forEach(m=>map.removeLayer(m));
      drawingMarkers=[];
      if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;}
      document.getElementById('startFenceBtn').classList.remove('hidden');
      document.getElementById('finishFenceBtn').classList.add('hidden');
      document.getElementById('cancelFenceBtn').classList.add('hidden');
      document.getElementById('fenceNamePanel').classList.add('hidden');
      pendingFenceCoords=null;
    }

    async function saveFenceName(){
      const input=document.getElementById('fenceNameInput');
      const name=(input.value||'').trim()||'Geocerca';
      if(!pendingFenceCoords||pendingFenceCoords.length<3){alert('No hay geocerca lista.');return;}
      try{
        await db.collection('geofences').add({name,path:pendingFenceCoords});
      }catch{
        const fences=loadFences();
        fences.push({id:'localgf-'+Date.now(),name,path:pendingFenceCoords});
        saveFences(fences);
        renderGeofencesFromCache();
      }
      input.value='';
      pendingFenceCoords=null;
      document.getElementById('fenceNamePanel').classList.add('hidden');
      cancelFenceDraw();
    }

    /* ---------- Explorador ---------- */
    function buildIndexList(){
      const farmUl=document.getElementById('farmList'), fenceUl=document.getElementById('fenceList');
      if(!farmUl||!fenceUl) return;
      const farms=(currentFarms?.length?currentFarms:loadFarms()).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      const fences=(currentFences?.length?currentFences:loadFences()).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      farmUl.innerHTML = farms.length?
        farms.map(f=>`<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-type="farm" data-id="${f.id}"><div class="text-sm font-medium text-gray-800">${f.name||'Finca'}</div><div class="text-xs text-gray-500">${f?.fincaLocation?`Lat ${(+f.fincaLocation.lat).toFixed(5)}, Lng ${(+f.fincaLocation.lng).toFixed(5)}`:'—'}</div></div></li>`).join('')
        : `<li class="py-2 text-sm text-gray-500">No hay fincas registradas.</li>`;
      fenceUl.innerHTML = fences.length?
        fences.map(g=>`<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-type="fence" data-id="${g.id}"><div class="text-sm font-medium text-gray-800">${g.name||'Geocerca'}</div><div class="text-xs text-gray-500">${Array.isArray(g.path)?`${g.path.length} puntos`:'—'}</div></div></li>`).join('')
        : `<li class="py-2 text-sm text-gray-500">No hay geocercas registradas.</li>`;
    }

    function zoomToFarm(id){
      if(fincaMarkers[id]){
        map.setView(fincaMarkers[id].getLatLng(),Math.max(map.getZoom(),16));
        try{fincaMarkers[id].openTooltip();}catch{}
        return;
      }
      const f=loadFarms().find(x=>x.id===id);
      if(f?.fincaLocation) map.setView([f.fincaLocation.lat,f.fincaLocation.lng],Math.max(map.getZoom(),16));
      else alert('No se pudo localizar esa finca.');
    }

    function zoomToFence(id){
      if(geofenceLayers[id]){
        map.fitBounds(geofenceLayers[id].getBounds(),{padding:[20,20]});
        selectFence(id);
        return;
      }
      const g=loadFences().find(x=>x.id===id);
      if(g?.path?.length>=3){
        map.fitBounds(L.latLngBounds(g.path.map(p=>[p.lat,p.lng])),{padding:[20,20]});
        selectFence(id);
      } else alert('No se pudo localizar esa geocerca.');
    }

    /* ---------- Gestión de personal ---------- */
    function buildAssignOptions(){
      const sel=document.getElementById('pAssignSelect');
      if(!sel) return;
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const opts=[];
      if(farms.length){
        opts.push({value:'',label:'— Selecciona —'});
        farms.forEach(f=>opts.push({value:`farm:${f.id}`,label:`Finca: ${f.name||'Finca'}`}));
      }
      if(fences.length){
        if(!opts.length) opts.push({value:'',label:'— Selecciona —'});
        fences.forEach(g=>opts.push({value:`fence:${g.id}`,label:`Geocerca: ${g.name||'Geocerca'}`}));
      }
      if(!opts.length) opts.push({value:'',label:'No hay fincas/geocercas'});
      sel.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
      const filter=document.getElementById('pEntityFilter');
      if(filter){
        const items=[{value:'all',label:'Todas'}];
        farms.forEach(f=>items.push({value:`farm:${f.id}`,label:`Finca: ${f.name||'Finca'}`}));
        fences.forEach(g=>items.push({value:`fence:${g.id}`,label:`Geocerca: ${g.name||'Geocerca'}`}));
        filter.innerHTML = items.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
      }
    }

    function showPersonError(msg){
      const e=document.getElementById('pFormError');
      e.textContent=msg||'';
      e.classList.toggle('hidden',!msg);
    }

    async function addPerson(){
      try{
        const fn=(document.getElementById('pFirstName').value||'').trim();
        const ln=(document.getElementById('pLastName').value||'').trim();
        const idn=(document.getElementById('pIdNumber').value||'').trim();
        const asg=document.getElementById('pAssignSelect').value||'';
        const active=document.getElementById('pActive').checked;
        showPersonError('');
        if(!fn||!ln) return showPersonError('Nombre y apellido son obligatorios.');
        if(!/^[0-9]{6,15}$/.test(idn)) return showPersonError('Cédula: usar solo dígitos (6–15).');
        if(!asg) return showPersonError('Selecciona una asignación.');
        const [assignType,assignId]=asg.split(':');
        const tempId = 'localp-'+Date.now();
        const newDoc = {id: tempId, firstName: fn, lastName: ln, idNumber: idn, assignType, assignId, active};
        let cache = loadPeople();
        cache.push(newDoc);
        savePeople(cache);
        currentPersonnel = cache.slice();
        renderPersonnelList();
        try{
          const ref = await db.collection('personnel').add({firstName: fn, lastName: ln, idNumber: idn, assignType, assignId, active});
          cache = loadPeople().map(p => p.id === tempId ? ({...p, id: ref.id}) : p);
          savePeople(cache);
          currentPersonnel = cache.slice();
          renderPersonnelList();
        }catch{
          waitAuthThen(syncLocalPendingToFirestore);
        }
        document.getElementById('pFirstName').value='';
        document.getElementById('pLastName').value='';
        document.getElementById('pIdNumber').value='';
        document.getElementById('pAssignSelect').selectedIndex=0;
        document.getElementById('pActive').checked=true;
      }catch(e){
        console.error(e);
        showPersonError('No se pudo agregar.');
      }
    }
    window.addPerson = addPerson;

    function renderPersonnelList(){
      const tbody=document.getElementById('personnelTableBody');
      if(!tbody) return;
      const q=(document.getElementById('pSearchInput').value||'').trim().toLowerCase();
      const t=(document.getElementById('pTypeFilter').value||'all');
      const e=(document.getElementById('pEntityFilter').value||'all');
      let list=currentPersonnel?.length?currentPersonnel.slice():loadPeople();
      list=list.filter(p=>{
        let ok=true;
        if(q){
          ok=(`${p.firstName||''} ${p.lastName||''} ${p.idNumber||''}`.toLowerCase().includes(q));
        }
        if(ok&&t!=='all') ok=(p.assignType===t);
        if(ok&&e!=='all'){
          const [kind,id]=e.split(':');
          ok=(p.assignType===kind && p.assignId===id);
        }
        return ok;
      });
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const nameOf=p=> p.assignType==='farm' ? (farms.find(f=>f.id===p.assignId)?.name||'Finca') : p.assignType==='fence' ? (fences.find(g=>g.id===p.assignId)?.name||'Geocerca') : '—';
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML='<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No hay personal registrado.</td></tr>';
        return;
      }
      list.forEach(p=>{
        const tr=document.createElement('tr');
        tr.className='border-t hover:bg-gray-50 person-row';
        const badge = p.active!==false ? '<span class="badge badge-green">Activo</span>' : '<span class="badge badge-gray">Inactivo</span>';
        tr.innerHTML=`<td class="px-3 py-2">${p.firstName||''}</td>
          <td class="px-3 py-2">${p.lastName||''}</td>
          <td class="px-3 py-2">${p.idNumber||''}</td>
          <td class="px-3 py-2">${badge}</td>
          <td class="px-3 py-2">${p.assignType==='farm'?'Finca':'Geocerca'}: ${nameOf(p)}</td>
          <td class="px-3 py-2">
            <button class="text-indigo-600 hover:underline" onclick="openEditPerson('${p.id}')">Editar</button>
            <span class="mx-1 text-gray-300">|</span>
            <button class="text-rose-600 hover:underline" onclick="deletePerson('${p.id}')">Eliminar</button>
          </td>`;
        tr.addEventListener('dblclick',()=>{
          if(p.assignType==='farm') zoomToFarm(p.assignId);
          if(p.assignType==='fence') zoomToFence(p.assignId);
        });
        tbody.appendChild(tr);
      });
    }

    async function deletePerson(id){
      if(!id) return;
      let cache=loadPeople();
      const it=(currentPersonnel||[]).find(p=>p.id===id)||cache.find(p=>p.id===id);
      const label=it?`${it.firstName||''} ${it.lastName||''}`.trim():'esta persona';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{
        await db.collection('personnel').doc(id).delete();
      } catch{
        cache=cache.filter(p=>p.id!==id);
        savePeople(cache);
      }
      currentPersonnel=loadPeople();
      renderPersonnelList();
    }

    function openEditPerson(id){
      const src=currentPersonnel?.length?currentPersonnel:(loadPeople()||[]);
      const p=src.find(x=>x.id===id);
      if(!p){
        alert('No se encontró el registro.');
        return;
      }
      const fn=prompt('Nombre',p.firstName||'');
      if(fn===null) return;
      const ln=prompt('Apellido',p.lastName||'');
      if(ln===null) return;
      const idn=prompt('Cédula (solo dígitos 6–15)',p.idNumber||'');
      if(idn===null||!/^[0-9]{6,15}$/.test(idn)){
        alert('Cédula inválida.');
        return;
      }
      const actAns = prompt('¿Activo? (s/n)', (p.active!==false)?'s':'n');
      if(actAns===null) return;
      const active = String(actAns).toLowerCase().trim()==='s';
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const choices=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
      let pick=prompt('Asigne escribiendo el número:\n'+choices.map((c,i)=>`${i+1}. ${c.l}`).join('\n'));
      if(pick===null) return;
      pick=(+pick)-1;
      if(pick<0||pick>=choices.length){
        alert('Selección inválida.');
        return;
      }
      const [assignType,assignId]=choices[pick].v.split(':');
      const doc={firstName:fn,lastName:ln,idNumber:idn,assignType,assignId,active};
      (async()=>{
        try{
          await db.collection('personnel').doc(id).update(doc);
        } catch{
          const cache=loadPeople();
          const i=cache.findIndex(x=>x.id===id);
          if(i>=0){
            cache[i]={...cache[i],...doc};
            savePeople(cache);}
        }
        currentPersonnel=loadPeople();
        renderPersonnelList();
        buildActivityFormOptions();
        buildLaborCostPersonCache();
        buildReportFilterOptions();
      })();
    }

    /* ---------- GESTIÓN DE ACTIVIDADES ---------- */
    function showActError(msg){
      const e=document.getElementById('actFormError');
      e.textContent=msg||'';
      e.classList.toggle('hidden',!msg);
    }

    function buildActivityFormOptions(){
      const actSel=document.getElementById('actActivitySelect');
      const actFilter=document.getElementById('actFilterActivity');
      if(actSel){
        actSel.innerHTML = activityDefs.map(a=>`<option value="${a}">${a}</option>`).join('');
      }
      if(actFilter){
        actFilter.innerHTML = '<option value="all">Todas</option>' + activityDefs.map(a=>`<option value="${a}">${a}</option>`).join('');
      }
      const people=currentPersonnel?.length?currentPersonnel:loadPeople();
      const pSel=document.getElementById('actPersonSelect');
      const pFilter=document.getElementById('actFilterPerson');
      if(pSel){
        pSel.innerHTML = people.length?
          people.map(p=>`<option value="${p.id}">${p.firstName||''} ${p.lastName||''}${(p.active===false)?' (inactivo)':''}</option>`).join('')
          : '<option value="">No hay personal</option>';
      }
      if(pFilter){
        pFilter.innerHTML = '<option value="all">Todas</option>' + (people.map(p=>`<option value="${p.id}">${p.firstName||''} ${p.lastName||''}${(p.active===false)?' (inactivo)':''}</option>`).join(''));
      }
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const eSel=document.getElementById('actEntitySelect');
      if(eSel){
        const items=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
        eSel.innerHTML = items.length?
          items.map(i=>`<option value="${i.v}">${i.l}</option>`).join('')
          : '<option value="">No hay entidades</option>';
      }
    }

    function buildActivityFilterOptions(){
      buildActivityFormOptions();
    }

    function manageActivityList(){
      const op = prompt('Gestionar actividades:\n1) Agregar\n2) Eliminar\n\nEscribe 1 o 2');
      if(op===null) return;
      if(op==='1'){
        const name = (prompt('Nombre de la nueva actividad:')||'').trim();
        if(!name) return;
        if(activityDefs.some(a=>a.toLowerCase()===name.toLowerCase())){
          alert('Ya existe esa actividad.');
          return;
        }
        activityDefs.push(name);
        activityDefs.sort((a,b)=>a.localeCompare(b));
        saveActivityDefs(activityDefs);
        buildActivityFormOptions();
        buildReportFilterOptions();
        alert('Actividad agregada.');
      }else if(op==='2'){
        if(!activityDefs.length){
          alert('No hay actividades para eliminar.');
          return;
        }
        const pick = prompt('Escribe el número a eliminar:\n' + activityDefs.map((a,i)=>`${i+1}. ${a}`).join('\n'));
        if(pick===null) return;
        const idx=(+pick)-1;
        if(idx<0 || idx>=activityDefs.length){
          alert('Selección inválida.');
          return;
        }
        const removed = activityDefs.splice(idx,1)[0];
        saveActivityDefs(activityDefs);
        buildActivityFormOptions();
        buildReportFilterOptions();
        alert('Eliminada: '+removed);
      }
    }

    async function addActivity(){
      try{
        const activity=(document.getElementById('actActivitySelect').value||'').trim();
        const personId=(document.getElementById('actPersonSelect').value||'').trim();
        const entity=(document.getElementById('actEntitySelect').value||'').trim();
        const start=(document.getElementById('actStartDate').value||'').trim();
        const end=(document.getElementById('actEndDate').value||'').trim();
        showActError('');
        if(!activity) return showActError('Selecciona una actividad.');
        if(!personId) return showActError('Selecciona una persona.');
        if(!entity) return showActError('Selecciona una finca/geocerca.');
        if(!start||!end) return showActError('Selecciona el rango de fechas.');
        if(start>end) return showActError('La fecha inicio no puede ser mayor a la fecha fin.');
        const people=currentPersonnel?.length?currentPersonnel:loadPeople();
        const p=people.find(x=>x.id===personId);
        const personName = p ? `${p.firstName||''} ${p.lastName||''}`.trim() : '—';
        const [assignType,assignId]=entity.split(':');
        const farms=currentFarms?.length?currentFarms:loadFarms();
        const fences=currentFences?.length?currentFences:loadFences();
        const entityName = assignType==='farm' ? (farms.find(f=>f.id===assignId)?.name||'Finca') : assignType==='fence' ? (fences.find(g=>g.id===assignId)?.name||'Geocerca') : '—';
        const tempId='locala-'+Date.now();
        const record={
          id:tempId,
          activity,
          personId,
          personName,
          assignType,
          assignId,
          entityName,
          startDate:start,
          endDate:end
        };
        let cache=loadActs();
        cache.push(record);
        saveActs(cache);
        currentActivities=cache.slice();
        renderActivityList();
        try{
          const ref=await db.collection('activities').add({ activity, personId, personName, assignType, assignId, entityName, startDate:start, endDate:end });
          cache = loadActs().map(a=>a.id===tempId?({...a,id:ref.id}):a);
          saveActs(cache);
          currentActivities=cache.slice();
          renderActivityList();
        }catch{
          waitAuthThen(syncLocalPendingToFirestore);
        }
        document.getElementById('actStartDate').value='';
        document.getElementById('actEndDate').value='';
      }catch(e){
        console.error(e);
        showActError('No se pudo agregar la actividad.');
      }
    }
    window.addActivity = addActivity;

    function renderActivityList(){
      const tbody=document.getElementById('activityTableBody');
      if(!tbody) return;
      const fPerson=(document.getElementById('actFilterPerson').value||'all');
      const fAct=(document.getElementById('actFilterActivity').value||'all');
      const fFrom=(document.getElementById('actFilterFrom').value||'');
      const fTo=(document.getElementById('actFilterTo').value||'');
      let list=currentActivities?.length?currentActivities.slice():loadActs();
      list=list.filter(a=>{
        let ok=true;
        if(fPerson!=='all') ok=ok&&(a.personId===fPerson);
        if(ok&&fAct!=='all') ok=(a.activity===fAct);
        if(ok&&fFrom) ok=ok&&(a.endDate>=fFrom);
        if(ok&&fTo) ok=ok&&(a.startDate<=fTo);
        return ok;
      });
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML='<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No hay actividades registradas.</td></tr>';
        return;
      }
      list.sort((a,b)=>(a.startDate||'').localeCompare(b.startDate||''));
      list.forEach(a=>{
        const entityLabel = (a.assignType==='farm'?'Finca':'Geocerca')+': '+(a.entityName||'—');
        const tr=document.createElement('tr');
        tr.className='border-t hover:bg-gray-50';
        tr.innerHTML=`<td class="px-3 py-2">${a.activity}</td>
          <td class="px-3 py-2">${a.personName||'—'}</td>
          <td class="px-3 py-2">${entityLabel}</td>
          <td class="px-3 py-2">${a.startDate}</td>
          <td class="px-3 py-2">${a.endDate}</td>
          <td class="px-3 py-2">
            <button class="text-rose-600 hover:underline" onclick="deleteActivity('${a.id}')">Eliminar</button>
          </td>`;
        tr.addEventListener('dblclick',()=>{
          if(a.assignType==='farm') zoomToFarm(a.assignId);
          if(a.assignType==='fence') zoomToFence(a.assignId);
        });
        tbody.appendChild(tr);
      });
    }

    async function deleteActivity(id){
      if(!id) return;
      const it=(currentActivities||[]).find(x=>x.id===id)||(loadActs().find(x=>x.id===id));
      const label = it ? `${it.activity} - ${it.personName}` : 'esta actividad';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{
        await db.collection('activities').doc(id).delete();
      } catch{
        const cache=loadActs().filter(a=>a.id!==id);
        saveActs(cache);
      }
      currentActivities=loadActs();
      renderActivityList();
    }
    window.deleteActivity=deleteActivity;

    /* ---------- COSTOS DE MANO DE OBRA ---------- */
    let lcChosenPerson = { id:'', name:'' };
    function showLcError(msg){
      const e=document.getElementById('lcFormError');
      e.textContent=msg||'';
      e.classList.toggle('hidden',!msg);
    }

    function openLcModal(){
      const modal=document.getElementById('lcPersonModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      renderLcModalList();
      document.getElementById('lcModalSearch').value='';
      document.getElementById('lcModalSearch').focus();
    }

    function closeLcModal(){
      const modal=document.getElementById('lcPersonModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function buildLaborCostPersonCache(){
      /* no-op */
    }

    function renderLcModalList(){
      const cont=document.getElementById('lcModalList');
      const q=(document.getElementById('lcModalSearch').value||'').trim().toLowerCase();
      const people=(currentPersonnel?.length?currentPersonnel:loadPeople()).filter(p=>p.active!==false);
      let list=people;
      if(q){
        list = people.filter(p=>(`${p.firstName||''} ${p.lastName||''} ${p.idNumber||''}`.toLowerCase().includes(q)));
      }
      cont.innerHTML='';
      if(!list.length){
        cont.innerHTML='<div class="py-6 text-center text-gray-500">No hay personas activas.</div>';
        return;
      }
      list.forEach(p=>{
        const btn=document.createElement('button');
        btn.className='w-full text-left px-3 py-2 hover:bg-gray-100';
        btn.innerHTML=`<div class="font-medium text-gray-800">${p.firstName||''} ${p.lastName||''}</div><div class="text-xs text-gray-500">Cédula: ${p.idNumber||''}</div>`;
        btn.addEventListener('click', ()=>{
          lcChosenPerson={
            id:p.id,
            name:`${p.firstName||''} ${p.lastName||''}`.trim()
          };
          const display=document.getElementById('lcPersonDisplay');
          display.value=lcChosenPerson.name;
          display.dataset.personId = lcChosenPerson.id;
          closeLcModal();
        });
        cont.appendChild(btn);
      });
    }

    async function addLaborCost(){
      try{
        showLcError('');
        const display=document.getElementById('lcPersonDisplay');
        const personId = display.dataset.personId || '';
        const personName = display.value || '';
        const dailyCost = parseFloat(document.getElementById('lcDailyCost').value);
        const start = (document.getElementById('lcStartDate').value||'').trim();
        const end = (document.getElementById('lcEndDate').value||'').trim();
        if(!personId) return showLcError('Elige una persona activa.');
        if(!(dailyCost>=0)) return showLcError('Ingresa un costo válido.');
        if(!start || !end) return showLcError('Selecciona el rango de fechas.');
        if(start>end) return showLcError('La fecha inicio no puede ser mayor a la fecha fin.');
        const tempId='localc-'+Date.now();
        const rec={
          id:tempId,
          personId,
          personName,
          dailyCost:+dailyCost,
          startDate:start,
          endDate:end
        };
        let cache=loadLaborCosts();
        cache.push(rec);
        saveLaborCosts(cache);
        currentLaborCosts = cache.slice();
        renderLaborCostList();
        try{
          const ref = await db.collection('labor_costs').add({personId, personName, dailyCost:+dailyCost, startDate:start, endDate:end});
          cache = loadLaborCosts().map(x=>x.id===tempId?({...x,id:ref.id}):x);
          saveLaborCosts(cache);
          currentLaborCosts=cache.slice();
          renderLaborCostList();
        }catch{
          waitAuthThen(syncLocalPendingToFirestore);
        }
        // limpiar
        document.getElementById('lcPersonDisplay').value='';
        document.getElementById('lcPersonDisplay').dataset.personId='';
        document.getElementById('lcDailyCost').value='';
        document.getElementById('lcStartDate').value='';
        document.getElementById('lcEndDate').value='';
      }catch(e){
        console.error(e);
        showLcError('No se pudo guardar el costo.');
      }
    }
    window.addLaborCost = addLaborCost;

    function renderLaborCostList(){
      const tbody=document.getElementById('laborCostTableBody');
      if(!tbody) return;
      let list=currentLaborCosts?.length?currentLaborCosts.slice():loadLaborCosts();
      list.sort((a,b)=> (a.personName||'').localeCompare(b.personName||'') || (a.startDate||'').localeCompare(b.startDate||'') );
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML='<tr><td colspan="5" class="px-3 py-4 text-center text-gray-500">No hay costos registrados.</td></tr>';
        return;
      }
      list.forEach(c=>{
        const tr=document.createElement('tr');
        tr.className='border-t hover:bg-gray-50';
        tr.innerHTML=`<td class="px-3 py-2">${c.personName||'—'}</td>
          <td class="px-3 py-2">$${(c.dailyCost||0).toFixed(2)}</td>
          <td class="px-3 py-2">${c.startDate}</td>
          <td class="px-3 py-2">${c.endDate}</td>
          <td class="px-3 py-2">
            <button class="text-rose-600 hover:underline" onclick="deleteLaborCost('${c.id}')">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function deleteLaborCost(id){
      if(!id) return;
      const it=(currentLaborCosts||[]).find(x=>x.id===id)||(loadLaborCosts().find(x=>x.id===id));
      const label = it ? `${it.personName} ($${(it.dailyCost||0).toFixed(2)})` : 'este registro';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{
        await db.collection('labor_costs').doc(id).delete();
      } catch{
        const cache=loadLaborCosts().filter(x=>x.id!==id);
        saveLaborCosts(cache);
      }
      currentLaborCosts=loadLaborCosts();
      renderLaborCostList();
    }
    window.deleteLaborCost=deleteLaborCost;

    /* ---------- Reportes ---------- */
    let reportChart = null;
    let lastReportHeader = [];
    let lastReportRows = [];

    function setDefaultReportDates(){
      const today = new Date();
      const toY = today.getFullYear(), toM = String(today.getMonth()+1).padStart(2,'0'), toD = String(today.getDate()).padStart(2,'0');
      const to = `${toY}-${toM}-${toD}`;
      const past = new Date(today);
      past.setDate(past.getDate()-30);
      const fromY=past.getFullYear(), fromM=String(past.getMonth()+1).padStart(2,'0'), fromD=String(past.getDate()).padStart(2,'0');
      const from = `${fromY}-${fromM}-${fromD}`;
      if(document.getElementById('repFrom') && !document.getElementById('repFrom').value) document.getElementById('repFrom').value = from;
      if(document.getElementById('repTo') && !document.getElementById('repTo').value) document.getElementById('repTo').value = to;
    }

    function buildReportFilterOptions(){
      // Personas
      const people=currentPersonnel?.length?currentPersonnel:loadPeople();
      const pSel=document.getElementById('repPersons');
      if(pSel){
        pSel.innerHTML = people.map(p=>`<option value="${p.id}">${p.firstName||''} ${p.lastName||''}${(p.active===false)?' (inactivo)':''}</option>`).join('');
      }
      // Entidades
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const eSel=document.getElementById('repEntities');
      if(eSel){
        const items=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
        eSel.innerHTML = items.map(i=>`<option value="${i.v}">${i.l}</option>`).join('');
      }
      // Actividades
      const aSel=document.getElementById('repActivities');
      if(aSel){
        aSel.innerHTML = activityDefs.map(a=>`<option value="${a}">${a}</option>`).join('');
      }
      setDefaultReportDates();
    }

    function getMultiValues(selectEl){
      if(!selectEl) return [];
      return Array.from(selectEl.selectedOptions||[]).map(o=>o.value);
    }

    function overlap(aStart, aEnd, bStart, bEnd){
      return (!bStart || aEnd>=bStart) && (!bEnd || aStart<=bEnd);
    }

    function dateDiffDays(a,b){
      // inclusivo
      const d1=new Date(a+"T00:00:00"), d2=new Date(b+"T00:00:00");
      return Math.max(0, Math.floor((d2 - d1)/(24*3600*1000)) + 1);
    }

    function entityLabel(assignType, assignId){
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      if(assignType==='farm'){
        const n = farms.find(f=>f.id===assignId)?.name||'Finca';
        return `Finca: ${n}`;
      }
      if(assignType==='fence'){
        const n = fences.find(g=>g.id===assignId)?.name||'Geocerca';
        return `Geocerca: ${n}`;
      }
      return '—';
    }

    function renderReportTable(header, rows){
      lastReportHeader = header.slice();
      lastReportRows = rows.slice();
      const thead=document.getElementById('repTableHead');
      const tbody=document.getElementById('repTableBody');
      thead.innerHTML = `<tr class="text-gray-600 text-sm">${header.map(h=>`<th class="px-3 py-2">${h}</th>`).join('')}</tr>`;
      tbody.innerHTML = rows.length ?
        rows.map(r=>`<tr class="border-t hover:bg-gray-50">${r.map(c=>`<td class="px-3 py-2">${c}</td>`).join('')}</tr>`).join('')
        : `<tr><td colspan="${header.length}" class="px-3 py-4 text-center text-gray-500">Sin resultados para los filtros seleccionados.</td></tr>`;
    }

    function exportReportCSV(){
      if(!lastReportHeader.length){
        alert('Primero genera un reporte.');
        return;
      }
      const lines = [];
      const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
      lines.push(lastReportHeader.map(esc).join(','));
      lastReportRows.forEach(r=>lines.push(r.map(esc).join(',')));
      const blob = new Blob(["\uFEFF"+lines.join("\r\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function renderReportChart(labels, data, chartType, labelText){
      const ctx = document.getElementById('repChart').getContext('2d');
      if(reportChart){
        reportChart.destroy();
        reportChart=null;
      }
      reportChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels,
          datasets: [{
            label: labelText,
            data
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false
        }
      });
    }

    function generateReport(){
      const people=currentPersonnel?.length?currentPersonnel:loadPeople();
      const onlyActive = document.getElementById('repOnlyActive').checked;
      const selPeople = getMultiValues(document.getElementById('repPersons'));
      const selEntities = getMultiValues(document.getElementById('repEntities'));
      const selActs = getMultiValues(document.getElementById('repActivities'));
      const from = (document.getElementById('repFrom').value||'');
      const to = (document.getElementById('repTo').value||'');
      const groupBy = document.getElementById('repGroupBy').value;
      const metric = document.getElementById('repMetric').value;
      const chartType = document.getElementById('repChartType').value;

      // Filtro datos
      let list=currentActivities?.length?currentActivities.slice():loadActs();
      list=list.filter(a=>{
        const p = people.find(x=>x.id===a.personId);
        if(onlyActive && p && p.active===false) return false;
        if(selPeople.length && !selPeople.includes(a.personId)) return false;
        if(selEntities.length && !selEntities.includes(`${a.assignType}:${a.assignId}`)) return false;
        if(selActs.length && !selActs.includes(a.activity)) return false;
        if(!overlap(a.startDate, a.endDate, from, to)) return false;
        return true;
      });

      // Cálculo días intersecando con el filtro (para métrica "días")
      const calcDays = (a)=> {
        const s = from && a.startDate<from ? from : a.startDate;
        const e = to && a.endDate>to ? to : a.endDate;
        return dateDiffDays(s,e);
      };

      if(groupBy==='detalle'){
        const header=['Actividad','Persona','Entidad','Fecha inicio','Fecha fin','Días'];
        const rows=list.map(a=>[a.activity, a.personName||'—', entityLabel(a.assignType,a.assignId), a.startDate, a.endDate, calcDays(a)]);
        renderReportTable(header, rows);
        // Para gráfico, agregamos por actividad (métrica elegida)
        const map = new Map();
        list.forEach(a=>{
          const key=a.activity;
          const inc = (metric==='days'?calcDays(a):1);
          map.set(key, (map.get(key)||0)+inc);
        });
        const labels=[...map.keys()], data=[...map.values()];
        renderReportChart(labels, data, chartType, metric==='days'?'Días':'Actividades');
        return;
      }

      // Agrupaciones
      let keyFn, title, labelFn;
      if(groupBy==='persona'){
        keyFn=a=>a.personName||'—';
        title='Persona';
        labelFn=keyFn;
      }else if(groupBy==='entidad'){
        keyFn=a=>entityLabel(a.assignType,a.assignId);
        title='Entidad';
        labelFn=keyFn;
      }else{
        // actividad
        keyFn=a=>a.activity||'—';
        title='Actividad';
        labelFn=keyFn;
      }

      const agg = new Map();
      list.forEach(a=>{
        const k=keyFn(a);
        const cur = agg.get(k) || {count:0, days:0};
        cur.count += 1;
        cur.days += calcDays(a);
        agg.set(k, cur);
      });

      const header=[title,'Actividades','Días'];
      const rows=[...agg.entries()].sort((x,y)=>String(x[0]).localeCompare(String(y[0]))).map(([k,v])=>[k, v.count, v.days]);
      renderReportTable(header, rows);

      const labels = rows.map(r=>r[0]);
      const data = rows.map(r=> metric==='days' ? r[2] : r[1]);
      renderReportChart(labels, data, chartType, metric==='days'?'Días':'Actividades');
    }

    /* ---------- Entrada (LOGIN) ---------- */
    function handleAdminLogin(){
      // ocultar error previo en cada intento
      const err = document.getElementById('errorMessage');
      if (err) err.style.display = 'none';

      const val = (document.getElementById('adminCodeInput').value || '').trim().toLowerCase();
      const ok = (val === 'admin123');
      if(!ok){
        document.getElementById('errorMessage').style.display='block';
        return;
      }
      try{
        localStorage.setItem('admin_ok','1');
      }catch(e){
        console.error('Error saving to localStorage', e);
      }
      // Ocultar modal y mostrar app de forma explícita
      const modal = document.getElementById('adminModal');
      const app = document.getElementById('appContent');
      modal.classList.add('hidden');
      app.classList.remove('hidden');
      app.style.display = 'flex'; // asegurar visibilidad

      // Inicializar el mapa después de que el contenido sea visible
      setTimeout(() => {
        initMap();
        setTimeout(() => {
          if (map) {
            map.invalidateSize();
          }
        }, 100);
      }, 100);
    }

    // Fechas por defecto (actividades / costos)
    function setDefaultActivityDates(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      const val = `${y}-${m}-${d}`;
      const s = document.getElementById('actStartDate');
      const e = document.getElementById('actEndDate');
      if(s && !s.value) s.value = val;
      if(e && !e.value) e.value = val;
    }

    function setDefaultLaborCostDates(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      const val = `${y}-${m}-${d}`;
      const s = document.getElementById('lcStartDate');
      const e = document.getElementById('lcEndDate');
      if(s && !s.value) s.value = val;
      if(e && !e.value) e.value = val;
    }

    /* ---------- Listeners ---------- */
    document.addEventListener('DOMContentLoaded',()=>{
      // Verificación del estado de autenticación
      let already = false;
      try {
        already = localStorage.getItem('admin_ok') === '1';
      } catch (e) {
        console.error('Error accessing localStorage:', e);
      }
      
      const modal = document.getElementById('adminModal');
      const app = document.getElementById('appContent');

      if(already){
        modal.classList.add('hidden');
        app.classList.remove('hidden');
        app.style.display = 'flex'; // asegurar visibilidad
        // Inicializar el mapa después de que el contenido sea visible
        setTimeout(() => {
          initMap();
          setTimeout(() => {
            if (map) {
              map.invalidateSize();
            }
          }, 100);
        }, 100);
      }else{
        modal.classList.remove('hidden');
        app.classList.add('hidden');
        app.style.display = ''; // permitir que la clase hidden controle el display
      }

      document.getElementById('adminLoginBtn').addEventListener('click', handleAdminLogin);
      document.getElementById('adminCodeInput').addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          handleAdminLogin();
        }
      });

      // Mapa
      document.getElementById('farmSelect').addEventListener('change',updateDeleteButtonState);
      document.getElementById('startFenceBtn').addEventListener('click',startFenceDraw);
      document.getElementById('finishFenceBtn').addEventListener('click',finishFenceDraw);
      document.getElementById('cancelFenceBtn').addEventListener('click',cancelFenceDraw);
      document.getElementById('fenceNameSaveBtn').addEventListener('click',saveFenceName);
      document.getElementById('fenceNameCancelBtn').addEventListener('click',()=>document.getElementById('fenceNamePanel').classList.add('hidden'));
      document.getElementById('editFenceBtn').addEventListener('click',()=>{ /* enable edit si lo usas */ });
      document.getElementById('exportGeoJSONBtn').addEventListener('click',()=>{ /* export */ });

      // Listas dblclick
      document.getElementById('farmList').addEventListener('dblclick',e=>{const n=e.target.closest('[data-type="farm"][data-id]'); if(n) zoomToFarm(n.dataset.id);});
      document.getElementById('fenceList').addEventListener('dblclick',e=>{const n=e.target.closest('[data-type="fence"][data-id]'); if(n) zoomToFence(n.dataset.id);});

      // Personal
      document.getElementById('addPersonBtn').addEventListener('click', addPerson);
      ['pFirstName','pLastName','pIdNumber'].forEach(id=>{
        const el=document.getElementById(id);
        el.addEventListener('keydown', (ev)=>{
          if(ev.key==='Enter'){
            addPerson();
          }
        });
      });
      document.getElementById('pSearchInput').addEventListener('input',renderPersonnelList);
      document.getElementById('pTypeFilter').addEventListener('change',renderPersonnelList);
      document.getElementById('pEntityFilter').addEventListener('change',renderPersonnelList);

      // Actividades
      document.getElementById('addActivityBtn').addEventListener('click', addActivity);
      document.getElementById('actManageBtn').addEventListener('click', manageActivityList);
      document.getElementById('actFilterPerson').addEventListener('change', renderActivityList);
      document.getElementById('actFilterActivity').addEventListener('change', renderActivityList);
      document.getElementById('actFilterFrom').addEventListener('change', renderActivityList);
      document.getElementById('actFilterTo').addEventListener('change', renderActivityList);
      setDefaultActivityDates();

      // Costos
      document.getElementById('lcChoosePersonBtn').addEventListener('click', openLcModal);
      document.getElementById('lcModalClose').addEventListener('click', closeLcModal);
      document.getElementById('lcModalCancel').addEventListener('click', closeLcModal);
      document.getElementById('lcModalSearch').addEventListener('input', renderLcModalList);
      document.getElementById('lcAddCostBtn').addEventListener('click', addLaborCost);
      setDefaultLaborCostDates();

      // Reportes
      buildReportFilterOptions();
      document.getElementById('repGenerateBtn').addEventListener('click', generateReport);
      document.getElementById('repDownloadBtn').addEventListener('click', exportReportCSV);

      // Primer pintado
      buildIndexList();
      buildAssignOptions();
      buildActivityFormOptions();
      buildActivityFilterOptions();
      updateDeleteButtonState();
      updateDeleteFenceButtonState();
      updateEditButtonsState();
      renderLaborCostList();
    });
  </script>
</body>
</html>





You said:
El ingreso a la app está corregido, pero ahora después de ingresar la pantalla queda en blanco. Corrige solo eso por favor, el resto no toques. Una vez corregido pásame el codigo completo


ChatGPT said:

Thought for 1m 25s
html
Copy code
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Personal de Finca (Leaflet + Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f3f4f6;overflow-x:hidden}
    #map{height:55vh;border-radius:1rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    @media(max-width:768px){#map{height:45vh}}
    .farm-label{background:#fff;border:1px solid rgba(0,0,0,.2);padding:2px 6px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.15);font-size:12px}
    .mousepos-control{background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .error-message{color:#dc2626;font-size:14px;margin-top:6px;display:none}
    button,input,select{font-size:16px}
    .person-row:hover{background-color:#f9fafb;}
    .badge{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem;display:inline-block}
    .badge-green{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .badge-gray{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
    /* Reportes */
    .multiselect{min-height:42px}
    .scrollbox{max-height:12rem;overflow:auto}
    /* Mantener utilidad .hidden funcional para mostrar/ocultar modal/contenido */
    .hidden { display: none !important; }
    /* ✅ Evita pantalla en blanco: cuando no está .hidden, asegúrate de que el contenedor se muestre como flex */
    #appContent:not(.hidden){ display:flex !important; }
  </style>
</head>
<body class="p-4 sm:p-8">
  <!-- Modal admin -->
  <div id="adminModal" class="fixed inset-0 bg-gray-900/75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input id="adminCodeInput" type="password" placeholder="Código de acceso" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2">
      <div id="errorMessage" class="error-message">Código incorrecto. Intenta con "admin123"</div>
      <button id="adminLoginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-3 rounded-lg">
        Acceder
      </button>
    </div>
  </div>

  <!-- Contenido -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">
    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Control de Personal y Geocercas</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Leaflet + Firestore (con caché local)</p>
    </header>
    
    <!-- Finca activa -->
    <div class="bg-white p-4 rounded-2xl shadow-lg">
      <label class="block text-sm font-medium text-gray-700">Finca activa</label>
      <select id="farmSelect" class="mt-1 w-full border rounded-md p-2"></select>
    </div>
    
    <!-- Mapa + barra -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa de Fincas</h2>
        <div class="ml-auto flex flex-wrap gap-2">
          <button id="startFenceBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Nueva geocerca</button>
          <button id="finishFenceBtn" class="hidden bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg">Finalizar geocerca</button>
          <button id="cancelFenceBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          <button id="createFenceByCoordsBtn" class="bg-sky-700 hover:bg-sky-800 text-white font-semibold px-4 py-2 rounded-lg">Geocerca (Lat/Lngs)</button>
          <button id="createFarmBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca</button>
          <button id="createByCoordsBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Crear finca (Lat/Lng)</button>
          <button id="deleteFarmBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar finca</button>
          <button id="deleteFenceBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Eliminar geocerca</button>
          <button id="editFenceBtn" class="bg-violet-600 hover:bg-violet-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Editar geocerca</button>
          <button id="saveFenceEditBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar cambios</button>
          <button id="cancelFenceEditBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar edición</button>
          <button id="exportGeoJSONBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-4 py-2 rounded-lg">Exportar GeoJSON</button>
          <label class="inline-flex items-center gap-2 bg-teal-50 hover:bg-teal-100 text-teal-700 font-semibold px-4 py-2 rounded-lg cursor-pointer">
            Importar GeoJSON
            <input id="importGeoJSONInput" type="file" accept=".geojson,application/geo+json,application/json" class="hidden">
          </label>
        </div>
      </div>
      
      <!-- Panel nombre finca (Lat/Lng) -->
      <div id="coordsNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la nueva finca</label>
          <div class="flex gap-2">
            <input id="coordsNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Finca Palora Norte" />
            <button id="coordsNameSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="coordsNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="coordsNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>
      
      <!-- Panel nombre geocerca -->
      <div id="fenceNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex gap-2">
            <input id="fenceNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Geocerca Lote 1" />
            <button id="fenceNameSaveBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="fenceNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="fenceNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>
      
      <div id="map"></div>
      
      <!-- Explorador -->
      <div id="indexPanel" class="mt-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800">Explorador de elementos</h3>
          <span class="text-xs text-gray-500">Doble clic en un nombre para centrar/ajustar el mapa</span>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-2">
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Fincas</div>
            <ul id="farmList" class="divide-y divide-gray-100"></ul>
          </div>
          <div class="bg-white/60 border border-gray-200 rounded-xl p-3 max-h-64 overflow-auto">
            <div class="font-medium text-gray-700 mb-2">Geocercas</div>
            <ul id="fenceList" class="divide-y divide-gray-100"></ul>
          </div>
        </div>
      </div>
      <p id="statusMessage" class="mt-3 text-sm text-gray-600">
        Para geocercas: Nueva geocerca → clics en el mapa → Finalizar geocerca → asigna nombre y guarda.
      </p>
    </div>
    
    <!-- ===== Gestión de Personal ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Gestión de Personal</h2>
        <span class="text-xs text-gray-500">Doble clic sobre una fila para ir a su asignación</span>
      </div>
      <div class="grid md:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre</label>
          <input id="pFirstName" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Apellido</label>
          <input id="pLastName" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Cédula</label>
          <input id="pIdNumber" type="text" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Asignación</label>
          <select id="pAssignSelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 mb-1">
            <input id="pActive" type="checkbox" class="rounded" checked>
            <span class="text-sm font-medium text-gray-700">Activo</span>
          </label>
        </div>
      </div>
      <div class="mt-3">
        <button id="addPersonBtn" type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
          Agregar
        </button>
        <span id="pFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>
      
      <!-- Filtros -->
      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Buscar</label>
          <input id="pSearchInput" type="text" placeholder="Nombre, apellido o cédula" class="mt-1 w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo asignación</label>
          <select id="pTypeFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
            <option value="farm">Fincas</option>
            <option value="fence">Geocercas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Finca/Geocerca</label>
          <select id="pEntityFilter" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
      </div>
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">NOMBRE</th>
              <th class="px-3 py-2">APELLIDO</th>
              <th class="px-3 py-2">CÉDULA</th>
              <th class="px-3 py-2">ESTADO</th>
              <th class="px-3 py-2">ASIGNADO A</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="personnelTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ===== Gestión de Actividades ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Gestión de Actividades</h2>
        <span class="text-xs text-gray-500">Doble clic en una fila para ir a su finca/geocerca</span>
      </div>
      <!-- Form alta -->
      <div class="grid md:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">
            Actividad
            <button id="actManageBtn" type="button" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded">
              Editar lista
            </button>
          </label>
          <select id="actActivitySelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Persona</label>
          <select id="actPersonSelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Finca/Geocerca</label>
          <select id="actEntitySelect" class="mt-1 w-full border rounded-md p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fecha inicio</label>
          <input id="actStartDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fecha fin</label>
          <input id="actEndDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
      </div>
      <div class="mt-3">
        <button id="addActivityBtn" type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
          Agregar actividad
        </button>
        <span id="actFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>
      
      <!-- Filtros -->
      <div class="mt-6 grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Persona</label>
          <select id="actFilterPerson" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Actividad</label>
          <select id="actFilterActivity" class="mt-1 w-full border rounded-md p-2">
            <option value="all">Todas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Desde</label>
          <input id="actFilterFrom" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Hasta</label>
          <input id="actFilterTo" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
      </div>
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">ACTIVIDAD</th>
              <th class="px-3 py-2">PERSONA</th>
              <th class="px-3 py-2">ENTidad</th>
              <th class="px-3 py-2">FECHA INICIO</th>
              <th class="px-3 py-2">FECHA FIN</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="activityTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ===== Costos de mano de obra ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg" id="laborCostsModule">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Costos de mano de obra</h2>
        <span class="text-xs text-gray-500">Define el costo diario por persona y su rango de vigencia</span>
      </div>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Persona (activa)</label>
          <div class="flex gap-2">
            <input id="lcPersonDisplay" type="text" class="mt-1 w-full border rounded-md p-2" placeholder="Sin seleccionar" readonly>
            <button id="lcChoosePersonBtn" type="button" class="mt-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-3 py-2 rounded-lg">Elegir</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Costo por día</label>
          <input id="lcDailyCost" type="number" step="0.01" min="0" class="mt-1 w-full border rounded-md p-2" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Desde</label>
          <input id="lcStartDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Hasta</label>
          <input id="lcEndDate" type="date" class="mt-1 w-full border rounded-md p-2">
        </div>
      </div>
      <div class="mt-3">
        <button id="lcAddCostBtn" type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar costo</button>
        <span id="lcFormError" class="text-sm text-red-600 ml-3 hidden"></span>
      </div>
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr class="text-gray-600 text-sm">
              <th class="px-3 py-2">PERSONA</th>
              <th class="px-3 py-2">COSTO/DÍA</th>
              <th class="px-3 py-2">DESDE</th>
              <th class="px-3 py-2">HASTA</th>
              <th class="px-3 py-2">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="laborCostTableBody" class="text-sm"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ===== Reportes ===== -->
    <div class="bg-white p-6 rounded-2xl shadow-lg" id="reportsModule">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Reportes</h2>
        <span class="text-xs text-gray-500">Tablas descargables y gráficos por persona, entidad, actividad y fechas</span>
      </div>
      <div class="grid md:grid-cols-6 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Personas (Ctrl/Cmd para multi)</label>
          <select id="repPersons" class="mt-1 w-full border rounded-md p-2 multiselect" multiple size="6"></select>
          <label class="inline-flex items-center gap-2 mt-2">
            <input id="repOnlyActive" type="checkbox" class="rounded" checked>
            <span class="text-sm text-gray-700">Solo activas</span>
          </label>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Fincas/Geocercas</label>
          <select id="repEntities" class="mt-1 w-full border rounded-md p-2 multiselect" multiple size="6"></select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Actividades</label>
          <select id="repActivities" class="mt-1 w-full border rounded-md p-2 multiselect" multiple size="6"></select>
          <div class="grid grid-cols-2 gap-2 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Desde</label>
              <input id="repFrom" type="date" class="mt-1 w-full border rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Hasta</label>
              <input id="repTo" type="date" class="mt-1 w-full border rounded-md p-2">
            </div>
          </div>
        </div>
      </div>
      <div class="grid md:grid-cols-5 gap-4 mt-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Agrupar por</label>
          <select id="repGroupBy" class="mt-1 w-full border rounded-md p-2">
            <option value="detalle">Detalle</option>
            <option value="persona">Persona</option>
            <option value="entidad">Entidad</option>
            <option value="actividad">Actividad</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Métrica (para gráficos)</label>
          <select id="repMetric" class="mt-1 w-full border rounded-md p-2">
            <option value="count">Actividades</option>
            <option value="days">Días</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo de gráfico</label>
          <select id="repChartType" class="mt-1 w-full border rounded-md p-2">
            <option value="bar">Barras</option>
            <option value="line">Líneas</option>
            <option value="doughnut">Pastel</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="repGenerateBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Generar</button>
        </div>
        <div class="flex items-end">
          <button id="repDownloadBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Descargar CSV (Excel)</button>
        </div>
      </div>
      <!-- Tabla -->
      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-left" id="repTable">
          <thead id="repTableHead"></thead>
          <tbody id="repTableBody" class="text-sm"></tbody>
        </table>
      </div>
      <!-- Gráfico -->
      <div class="mt-6 bg-white rounded-xl border border-gray-200 p-4">
        <canvas id="repChart" height="120"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Modal: elegir persona activa (costos) -->
  <div id="lcPersonModal" class="fixed inset-0 bg-gray-900/75 hidden items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Seleccionar persona (activa)</h3>
        <button id="lcModalClose" class="text-gray-600 hover:text-gray-900">✕</button>
      </div>
      <input id="lcModalSearch" type="text" placeholder="Buscar por nombre o cédula" class="w-full border rounded-md p-2 mb-3">
      <div id="lcModalList" class="max-h-80 overflow-auto divide-y divide-gray-100"></div>
      <div class="mt-4 text-right">
        <button id="lcModalCancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Scripts Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Chart.js (para los reportes) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE",
      authDomain: "demo-finca-app.firebaseapp.com",
      projectId: "demo-finca-app",
      storageBucket: "demo-finca-app.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    try {
      db.settings({
        experimentalForceLongPolling: true,
        experimentalAutoDetectLongPolling: true,
        useFetchStreams: false
      });
    } catch {}
    let authReady = false;
    firebase.auth().signInAnonymously().catch(console.error);
    firebase.auth().onAuthStateChanged(u => authReady = !!u);

    /* ---------- Estado y caché ---------- */
    let map;
    const fincaMarkers = {}, geofenceLayers = {};
    const LS_KEY='fincas_cache_v1', LS_GF='geofences_cache_v1', LS_PE='personnel_cache_v1', LS_AC='activities_cache_v1', LS_AD='activity_defs_v1', LS_LC='labor_costs_cache_v1';
    const save = (k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load = (k)=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return []}};
    const saveFarms=(v)=>save(LS_KEY,v), loadFarms=()=>load(LS_KEY);
    const saveFences=(v)=>save(LS_GF,v), loadFences=()=>load(LS_GF);
    const savePeople=(v)=>save(LS_PE,v), loadPeople=()=>load(LS_PE);
    const saveActs=(v)=>save(LS_AC,v), loadActs=()=>load(LS_AC);
    const saveLaborCosts=(v)=>save(LS_LC,v), loadLaborCosts=()=>load(LS_LC);
    const DEFAULT_ACTIVITY_OPTIONS = ['Siembra','Riego','Cosecha','Poda','Fertilización','Fumigación','Mantenimiento','Limpieza','Transporte','Supervisión'];
    const loadActivityDefs = () => {
      try {
        const val = JSON.parse(localStorage.getItem(LS_AD) || 'null');
        if (Array.isArray(val) && val.length) return val;
      } catch {}
      return DEFAULT_ACTIVITY_OPTIONS.slice();
    };
    const saveActivityDefs = (arr) => {
      try{ localStorage.setItem(LS_AD, JSON.stringify(arr)); }catch{}
    };
    let activityDefs = loadActivityDefs();
    let currentFarms=[], currentFences=[], currentPersonnel=[], currentActivities=[], currentLaborCosts=[];
    const GEOFENCE_STYLE={weight:2,fillOpacity:.15}, GEOFENCE_SELECTED_STYLE={weight:3,color:'#ef4444',fillOpacity:.2};
    let isDrawingFence=false, drawingCoords=[], drawingPolyline=null, drawingMarkers=[], pendingFenceCoords=null;
    let selectedFenceId=null, editGroup=null, editToolbar=null, isEditingFence=false, editBackupCoords=null;
    function waitAuthThen(fn){
      if(authReady) return fn();
      const t=setInterval(()=>{
        if(authReady){clearInterval(t); fn();}},120);
    }

    /* ---------- Mapa ---------- */
    function initMap(center){
      center=center||{lat:-0.1807,lng:-78.4678};
      
      // Asegurarse de que el contenedor del mapa existe y es visible
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.error('El contenedor del mapa no existe');
        return;
      }
      
      // Inicializar el mapa
      map=L.map('map',{center:[center.lat,center.lng],zoom:6});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      editGroup=new L.FeatureGroup();
      map.addLayer(editGroup);
      addMousePositionControl();
      renderFarmsFromCache();
      renderGeofencesFromCache();
      
      map.on('click', async e=>{
        if(isDrawingFence){
          addFenceVertex(e.latlng);
          return;
        }
        const name=prompt('Nombre de la nueva finca:');
        if(!name) return;
        try{
          await db.collection('farms').add({name,fincaLocation:{lat:e.latlng.lat,lng:e.latlng.lng}});
        } catch{
          const farms=loadFarms();
          farms.push({id:'local-'+Date.now(),name,fincaLocation:{lat:e.latlng.lat,lng:e.latlng.lng}});
          saveFarms(farms);
          renderFarmsFromCache();
        }
      });
      
      waitAuthThen(async()=>{
        startSubscriptions();
        await Promise.all([initialFetchFarms(),initialFetchGeofences(),initialFetchPersonnel(),initialFetchActivities(),initialFetchLaborCosts()]);
        syncLocalPendingToFirestore();
      });
    }

    function addMousePositionControl(){
      const MousePos=L.Control.extend({options:{position:'bottomleft'},onAdd:function(){const d=L.DomUtil.create('div','mousepos-control');d.innerHTML='Lat: — Lng: —';this._div=d;return d;},update:function(lat,lng){this._div.innerHTML=(lat!=null&&lng!=null)?`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`:'Lat: — Lng: —';}});
      const ctrl=new MousePos();
      ctrl.addTo(map);
      map.on('mousemove',e=>ctrl.update(e.latlng.lat,e.latlng.lng));
      map.on('mouseout',()=>ctrl.update(null,null));
    }

    function renderFarmsFromCache(){
      const farms=loadFarms();
      Object.values(fincaMarkers).forEach(m=>map.removeLayer(m));
      for(const k in fincaMarkers) delete fincaMarkers[k];
      farms.forEach(f=>{
        if(!f?.id||!f?.fincaLocation) return;
        const m=L.marker([f.fincaLocation.lat,f.fincaLocation.lng]).addTo(map);
        m.bindTooltip(f.name||'Finca',{permanent:true,direction:'right',offset:[10,0],className:'farm-label'});
        fincaMarkers[f.id]=m;});
      const sel=document.getElementById('farmSelect');
      if(sel){
        sel.innerHTML='';
        farms.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o);});
      }
      updateDeleteButtonState();
      currentFarms=farms||[];
      buildIndexList();
      buildAssignOptions();
      buildActivityFormOptions();
      buildReportFilterOptions();
    }

    function renderGeofencesFromCache(){
      Object.values(geofenceLayers).forEach(p=>map.removeLayer(p));
      for(const k in geofenceLayers) delete geofenceLayers[k];
      const fences=loadFences();
      fences.forEach(g=>{
        if(!g?.id||!Array.isArray(g.path)||g.path.length<3) return;
        const latlngs=g.path.map(p=>[p.lat,p.lng]);
        const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map);
        poly.bindTooltip(g.name||'Geocerca',{permanent:true,direction:'center',className:'farm-label'});
        geofenceLayers[g.id]=poly;
        poly.on('click',()=>selectFence(g.id));
        if(selectedFenceId===g.id) poly.setStyle(GEOFENCE_SELECTED_STYLE);
      });
      if(selectedFenceId && !geofenceLayers[selectedFenceId]) selectedFenceId=null;
      updateDeleteFenceButtonState();
      updateEditButtonsState();
      currentFences=fences||[];
      buildIndexList();
      buildAssignOptions();
      buildActivityFormOptions();
      buildReportFilterOptions();
    }

    /* ---------- Suscripciones ---------- */
    let unsubFarms=null,unsubGeofences=null,unsubPersonnel=null,unsubActivities=null,unsubLaborCosts=null,subsStarted=false;
    function startSubscriptions(){
      if(subsStarted) return;
      subsStarted=true;
      unsubFarms=db.collection('farms').onSnapshot(s=>{
        const farms=[];
        Object.values(fincaMarkers).forEach(m=>map.removeLayer(m));
        for(const k in fincaMarkers) delete fincaMarkers[k];
        s.forEach(doc=>{const d=doc.data(); farms.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation});
          if(d.fincaLocation){const m=L.marker([d.fincaLocation.lat,d.fincaLocation.lng]).addTo(map);
            m.bindTooltip(d.name||'Finca',{permanent:true,direction:'right',offset:[10,0],className:'farm-label'});
            fincaMarkers[doc.id]=m; }});
        if(farms.length){
          currentFarms=farms.slice();
          saveFarms(farms);
        } else {
          currentFarms=loadFarms();
          renderFarmsFromCache();
          return;
        }
        const sel=document.getElementById('farmSelect');
        if(sel){
          sel.innerHTML='';
          farms.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.name||'Finca'; sel.appendChild(o);});
        }
        updateDeleteButtonState();
        buildIndexList();
        buildAssignOptions();
        buildActivityFormOptions();
        buildReportFilterOptions();
      },()=>renderFarmsFromCache());
      unsubGeofences=db.collection('geofences').onSnapshot(s=>{
        const fences=[];
        Object.values(geofenceLayers).forEach(p=>map.removeLayer(p));
        for(const k in geofenceLayers) delete geofenceLayers[k];
        s.forEach(doc=>{const d=doc.data();
          const g={id:doc.id,name:d.name,path:d.path||[]};
          fences.push(g);
          if(Array.isArray(g.path)&&g.path.length>=3){
            const latlngs=g.path.map(p=>[p.lat,p.lng]);
            const poly=L.polygon(latlngs,GEOFENCE_STYLE).addTo(map);
            poly.bindTooltip(g.name||'Geocerca',{permanent:true,direction:'center',className:'farm-label'});
            geofenceLayers[doc.id]=poly;
            poly.on('click',()=>selectFence(doc.id));
            if(selectedFenceId===doc.id) poly.setStyle(GEOFENCE_SELECTED_STYLE);
          }
        });
        if(fences.length){
          currentFences=fences.slice();
          saveFences(fences);
        } else {
          currentFences=loadFences();
          renderGeofencesFromCache();
          return;
        }
        if(selectedFenceId && !geofenceLayers[selectedFenceId]) selectedFenceId=null;
        updateDeleteFenceButtonState();
        updateEditButtonsState();
        buildIndexList();
        buildAssignOptions();
        buildActivityFormOptions();
        buildReportFilterOptions();
      },()=>renderGeofencesFromCache());
      unsubPersonnel=db.collection('personnel').onSnapshot(s=>{
        const list=[];
        s.forEach(doc=>{const d=doc.data();
          list.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||'',active:(d.active!==false)});});
        if(list.length){
          currentPersonnel=list.slice();
          savePeople(list);
        } else {
          currentPersonnel=loadPeople();
        }
        renderPersonnelList();
        buildActivityFormOptions();
        buildLaborCostPersonCache();
        buildReportFilterOptions();
      },()=>{
        currentPersonnel=loadPeople();
        renderPersonnelList();
        buildActivityFormOptions();
        buildLaborCostPersonCache();
        buildReportFilterOptions();
      });
      unsubActivities=db.collection('activities').onSnapshot(s=>{
        const list=[];
        s.forEach(doc=>{const d=doc.data();
          list.push({
            id:doc.id,
            activity:d.activity||'',
            personId:d.personId||'',
            personName:d.personName||'',
            assignType:d.assignType||'',
            assignId:d.assignId||'',
            entityName:d.entityName||'',
            startDate:d.startDate||'',
            endDate:d.endDate||''
          });});
        if(list.length){
          currentActivities=list.slice();
          saveActs(list);
        } else {
          currentActivities=loadActs();
        }
        renderActivityList();
        buildActivityFilterOptions();
        buildReportFilterOptions();
      },()=>{
        currentActivities=loadActs();
        renderActivityList();
        buildActivityFilterOptions();
        buildReportFilterOptions();
      });
      unsubLaborCosts=db.collection('labor_costs').onSnapshot(s=>{
        const list=[];
        s.forEach(doc=>{const d=doc.data();
          list.push({id:doc.id,personId:d.personId||'',personName:d.personName||'',dailyCost:+(d.dailyCost||0),startDate:d.startDate||'',endDate:d.endDate||''});});
        if(list.length){
          currentLaborCosts=list.slice();
          saveLaborCosts(list);
        } else {
          currentLaborCosts=loadLaborCosts();
        }
        renderLaborCostList();
      },()=>{
        currentLaborCosts=loadLaborCosts();
        renderLaborCostList();
      });
    }

    async function initialFetchFarms(){
      try{
        const s=await db.collection('farms').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,name:d.name,fincaLocation:d.fincaLocation});});
        currentFarms=arr.length?arr.slice():loadFarms();
        if(arr.length) saveFarms(arr);
        renderFarmsFromCache();
      }catch{
        renderFarmsFromCache();
      }
    }

    async function initialFetchGeofences(){
      try{
        const s=await db.collection('geofences').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,name:d.name,path:d.path||[]});});
        currentFences=arr.length?arr.slice():loadFences();
        if(arr.length) saveFences(arr);
        renderGeofencesFromCache();
      }catch{
        renderGeofencesFromCache();
      }
    }

    async function initialFetchPersonnel(){
      try{
        const s=await db.collection('personnel').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,firstName:d.firstName||'',lastName:d.lastName||'',idNumber:d.idNumber||'',assignType:d.assignType||'',assignId:d.assignId||'',active:(d.active!==false)});});
        currentPersonnel=arr.length?arr.slice():loadPeople();
        if(arr.length) savePeople(arr);
        renderPersonnelList();
      }catch{
        currentPersonnel=loadPeople();
        renderPersonnelList();
      }
    }

    async function initialFetchActivities(){
      try{
        const s=await db.collection('activities').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,activity:d.activity||'',personId:d.personId||'',personName:d.personName||'',assignType:d.assignType||'',assignId:d.assignId||'',entityName:d.entityName||'',startDate:d.startDate||'',endDate:d.endDate||''});});
        currentActivities=arr.length?arr.slice():loadActs();
        if(arr.length) saveActs(arr);
        renderActivityList();
      }catch{
        currentActivities=loadActs();
        renderActivityList();
      }
    }

    async function initialFetchLaborCosts(){
      try{
        const s=await db.collection('labor_costs').get();
        const arr=[];
        s.forEach(doc=>{const d=doc.data(); arr.push({id:doc.id,personId:d.personId||'',personName:d.personName||'',dailyCost:+(d.dailyCost||0),startDate:d.startDate||'',endDate:d.endDate||''});});
        currentLaborCosts=arr.length?arr.slice():loadLaborCosts();
        if(arr.length) saveLaborCosts(arr);
        renderLaborCostList();
      }catch{
        currentLaborCosts=loadLaborCosts();
        renderLaborCostList();
      }
    }

    async function syncLocalPendingToFirestore(){
      try{
        const farms=loadFarms().filter(f=>String(f.id||'').startsWith('local-'));
        for(const f of farms){
          try{await db.collection('farms').add({name:f.name||'Finca',fincaLocation:f.fincaLocation||null});}catch{}
          saveFarms(loadFarms().filter(x=>x.id!==f.id));
        }
      }catch{}
      try{
        const fences=loadFences().filter(g=>String(g.id||'').startsWith('localgf-'));
        for(const g of fences){
          try{await db.collection('geofences').add({name:g.name||'Geocerca',path:Array.isArray(g.path)?g.path:[]});}catch{}
          saveFences(loadFences().filter(x=>x.id!==g.id));
        }
      }catch{}
      try{
        const ppl=loadPeople().filter(p=>String(p.id||'').startsWith('localp-'));
        for(const p of ppl){
          try{await db.collection('personnel').add({firstName:p.firstName||'',lastName:p.lastName||'',idNumber:p.idNumber||'',assignType:p.assignType||'',assignId:p.assignId||'',active:(p.active!==false)});
          }catch{}
          savePeople(loadPeople().filter(x=>x.id!==p.id));
        }
      }catch{}
      try{
        const acts=loadActs().filter(a=>String(a.id||'').startsWith('locala-'));
        for(const a of acts){
          try{await db.collection('activities').add({activity:a.activity,personId:a.personId,personName:a.personName,assignType:a.assignType,assignId:a.assignId,entityName:a.entityName,startDate:a.startDate,endDate:a.endDate});}catch{}
          saveActs(loadActs().filter(x=>x.id!==a.id));
        }
      }catch{}
      try{
        const lcs=loadLaborCosts().filter(c=>String(c.id||'').startsWith('localc-'));
        for(const c of lcs){
          try{await db.collection('labor_costs').add({personId:c.personId,personName:c.personName,dailyCost:c.dailyCost,startDate:c.startDate,endDate:c.endDate});}catch{}
          saveLaborCosts(loadLaborCosts().filter(x=>x.id!==c.id));
        }
      }catch{}
    }

    /* ---------- Geocercas (igual) ---------- */
    function selectFence(id){
      if(isEditingFence){
        alert('Estás editando una geocerca. Guarda o cancela antes.');
        return;
      }
      if(selectedFenceId&&geofenceLayers[selectedFenceId]) geofenceLayers[selectedFenceId].setStyle(GEOFENCE_STYLE);
      selectedFenceId=id;
      if(geofenceLayers[id]) geofenceLayers[id].setStyle(GEOFENCE_SELECTED_STYLE);
      updateDeleteFenceButtonState();
      updateEditButtonsState();
    }

    function updateDeleteButtonState(){
      const sel=document.getElementById('farmSelect'), btn=document.getElementById('deleteFarmBtn');
      if(btn) btn.disabled=!(sel&&sel.value);
    }

    function updateDeleteFenceButtonState(){
      const btn=document.getElementById('deleteFenceBtn');
      if(btn) btn.disabled=!selectedFenceId;
    }

    function updateEditButtonsState(){
      const btn=document.getElementById('editFenceBtn');
      if(btn) btn.disabled=!(selectedFenceId&&geofenceLayers[selectedFenceId]&&!isEditingFence);
      document.getElementById('saveFenceEditBtn')?.classList.toggle('hidden',!isEditingFence);
      document.getElementById('cancelFenceEditBtn')?.classList.toggle('hidden',!isEditingFence);
    }

    function addFenceVertex(latlng){
      drawingCoords.push({lat:latlng.lat,lng:latlng.lng});
      const m=L.circleMarker(latlng,{radius:4,weight:2}).addTo(map);
      drawingMarkers.push(m);
      const latlngs=drawingCoords.map(p=>[p.lat,p.lng]);
      if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;}
      if(latlngs.length>=3) drawingPolyline=L.polygon(latlngs,{dashArray:'4,4',weight:2,fillOpacity:.1}).addTo(map);
      else if(latlngs.length>=2) drawingPolyline=L.polyline(latlngs,{dashArray:'4,4',weight:2}).addTo(map);
    }

    function startFenceDraw(){
      if(isDrawingFence) return;
      isDrawingFence=true;
      drawingCoords=[];
      drawingMarkers.forEach(m=>map.removeLayer(m));
      drawingMarkers=[];
      if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;}
      document.getElementById('startFenceBtn').classList.add('hidden');
      document.getElementById('finishFenceBtn').classList.remove('hidden');
      document.getElementById('cancelFenceBtn').classList.remove('hidden');
    }

    function finishFenceDraw(){
      if(!isDrawingFence) return;
      if(drawingCoords.length<3){alert('La geocerca necesita al menos 3 puntos.');return;}
      pendingFenceCoords=drawingCoords.slice();
      document.getElementById('fenceNameHint').textContent=`Vértices: ${pendingFenceCoords.length} puntos`;
      const input=document.getElementById('fenceNameInput');
      input.value=`Geocerca ${new Date().toLocaleDateString()}`;
      document.getElementById('fenceNamePanel').classList.remove('hidden');
      input.focus();
      input.select();
    }

    function cancelFenceDraw(){
      isDrawingFence=false;
      drawingCoords=[];
      drawingMarkers.forEach(m=>map.removeLayer(m));
      drawingMarkers=[];
      if(drawingPolyline){map.removeLayer(drawingPolyline);drawingPolyline=null;}
      document.getElementById('startFenceBtn').classList.remove('hidden');
      document.getElementById('finishFenceBtn').classList.add('hidden');
      document.getElementById('cancelFenceBtn').classList.add('hidden');
      document.getElementById('fenceNamePanel').classList.add('hidden');
      pendingFenceCoords=null;
    }

    async function saveFenceName(){
      const input=document.getElementById('fenceNameInput');
      const name=(input.value||'').trim()||'Geocerca';
      if(!pendingFenceCoords||pendingFenceCoords.length<3){alert('No hay geocerca lista.');return;}
      try{
        await db.collection('geofences').add({name,path:pendingFenceCoords});
      }catch{
        const fences=loadFences();
        fences.push({id:'localgf-'+Date.now(),name,path:pendingFenceCoords});
        saveFences(fences);
        renderGeofencesFromCache();
      }
      input.value='';
      pendingFenceCoords=null;
      document.getElementById('fenceNamePanel').classList.add('hidden');
      cancelFenceDraw();
    }

    /* ---------- Explorador ---------- */
    function buildIndexList(){
      const farmUl=document.getElementById('farmList'), fenceUl=document.getElementById('fenceList');
      if(!farmUl||!fenceUl) return;
      const farms=(currentFarms?.length?currentFarms:loadFarms()).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      const fences=(currentFences?.length?currentFences:loadFences()).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||''));
      farmUl.innerHTML = farms.length?
        farms.map(f=>`<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-type="farm" data-id="${f.id}"><div class="text-sm font-medium text-gray-800">${f.name||'Finca'}</div><div class="text-xs text-gray-500">${f?.fincaLocation?`Lat ${(+f.fincaLocation.lat).toFixed(5)}, Lng ${(+f.fincaLocation.lng).toFixed(5)}`:'—'}</div></div></li>`).join('')
        : `<li class="py-2 text-sm text-gray-500">No hay fincas registradas.</li>`;
      fenceUl.innerHTML = fences.length?
        fences.map(g=>`<li class="py-2"><div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-type="fence" data-id="${g.id}"><div class="text-sm font-medium text-gray-800">${g.name||'Geocerca'}</div><div class="text-xs text-gray-500">${Array.isArray(g.path)?`${g.path.length} puntos`:'—'}</div></div></li>`).join('')
        : `<li class="py-2 text-sm text-gray-500">No hay geocercas registradas.</li>`;
    }

    function zoomToFarm(id){
      if(fincaMarkers[id]){
        map.setView(fincaMarkers[id].getLatLng(),Math.max(map.getZoom(),16));
        try{fincaMarkers[id].openTooltip();}catch{}
        return;
      }
      const f=loadFarms().find(x=>x.id===id);
      if(f?.fincaLocation) map.setView([f.fincaLocation.lat,f.fincaLocation.lng],Math.max(map.getZoom(),16));
      else alert('No se pudo localizar esa finca.');
    }

    function zoomToFence(id){
      if(geofenceLayers[id]){
        map.fitBounds(geofenceLayers[id].getBounds(),{padding:[20,20]});
        selectFence(id);
        return;
      }
      const g=loadFences().find(x=>x.id===id);
      if(g?.path?.length>=3){
        map.fitBounds(L.latLngBounds(g.path.map(p=>[p.lat,p.lng])),{padding:[20,20]});
        selectFence(id);
      } else alert('No se pudo localizar esa geocerca.');
    }

    /* ---------- Gestión de personal ---------- */
    function buildAssignOptions(){
      const sel=document.getElementById('pAssignSelect');
      if(!sel) return;
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const opts=[];
      if(farms.length){
        opts.push({value:'',label:'— Selecciona —'});
        farms.forEach(f=>opts.push({value:`farm:${f.id}`,label:`Finca: ${f.name||'Finca'}`}));
      }
      if(fences.length){
        if(!opts.length) opts.push({value:'',label:'— Selecciona —'});
        fences.forEach(g=>opts.push({value:`fence:${g.id}`,label:`Geocerca: ${g.name||'Geocerca'}`}));
      }
      if(!opts.length) opts.push({value:'',label:'No hay fincas/geocercas'});
      sel.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
      const filter=document.getElementById('pEntityFilter');
      if(filter){
        const items=[{value:'all',label:'Todas'}];
        farms.forEach(f=>items.push({value:`farm:${f.id}`,label:`Finca: ${f.name||'Finca'}`}));
        fences.forEach(g=>items.push({value:`fence:${g.id}`,label:`Geocerca: ${g.name||'Geocerca'}`}));
        filter.innerHTML = items.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
      }
    }

    function showPersonError(msg){
      const e=document.getElementById('pFormError');
      e.textContent=msg||'';
      e.classList.toggle('hidden',!msg);
    }

    async function addPerson(){
      try{
        const fn=(document.getElementById('pFirstName').value||'').trim();
        const ln=(document.getElementById('pLastName').value||'').trim();
        const idn=(document.getElementById('pIdNumber').value||'').trim();
        const asg=document.getElementById('pAssignSelect').value||'';
        const active=document.getElementById('pActive').checked;
        showPersonError('');
        if(!fn||!ln) return showPersonError('Nombre y apellido son obligatorios.');
        if(!/^[0-9]{6,15}$/.test(idn)) return showPersonError('Cédula: usar solo dígitos (6–15).');
        if(!asg) return showPersonError('Selecciona una asignación.');
        const [assignType,assignId]=asg.split(':');
        const tempId = 'localp-'+Date.now();
        const newDoc = {id: tempId, firstName: fn, lastName: ln, idNumber: idn, assignType, assignId, active};
        let cache = loadPeople();
        cache.push(newDoc);
        savePeople(cache);
        currentPersonnel = cache.slice();
        renderPersonnelList();
        try{
          const ref = await db.collection('personnel').add({firstName: fn, lastName: ln, idNumber: idn, assignType, assignId, active});
          cache = loadPeople().map(p => p.id === tempId ? ({...p, id: ref.id}) : p);
          savePeople(cache);
          currentPersonnel = cache.slice();
          renderPersonnelList();
        }catch{
          waitAuthThen(syncLocalPendingToFirestore);
        }
        document.getElementById('pFirstName').value='';
        document.getElementById('pLastName').value='';
        document.getElementById('pIdNumber').value='';
        document.getElementById('pAssignSelect').selectedIndex=0;
        document.getElementById('pActive').checked=true;
      }catch(e){
        console.error(e);
        showPersonError('No se pudo agregar.');
      }
    }
    window.addPerson = addPerson;

    function renderPersonnelList(){
      const tbody=document.getElementById('personnelTableBody');
      if(!tbody) return;
      const q=(document.getElementById('pSearchInput').value||'').trim().toLowerCase();
      const t=(document.getElementById('pTypeFilter').value||'all');
      const e=(document.getElementById('pEntityFilter').value||'all');
      let list=currentPersonnel?.length?currentPersonnel.slice():loadPeople();
      list=list.filter(p=>{
        let ok=true;
        if(q){
          ok=(`${p.firstName||''} ${p.lastName||''} ${p.idNumber||''}`.toLowerCase().includes(q));
        }
        if(ok&&t!=='all') ok=(p.assignType===t);
        if(ok&&e!=='all'){
          const [kind,id]=e.split(':');
          ok=(p.assignType===kind && p.assignId===id);
        }
        return ok;
      });
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const nameOf=p=> p.assignType==='farm' ? (farms.find(f=>f.id===p.assignId)?.name||'Finca') : p.assignType==='fence' ? (fences.find(g=>g.id===p.assignId)?.name||'Geocerca') : '—';
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML='<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No hay personal registrado.</td></tr>';
        return;
      }
      list.forEach(p=>{
        const tr=document.createElement('tr');
        tr.className='border-t hover:bg-gray-50 person-row';
        const badge = p.active!==false ? '<span class="badge badge-green">Activo</span>' : '<span class="badge badge-gray">Inactivo</span>';
        tr.innerHTML=`<td class="px-3 py-2">${p.firstName||''}</td>
          <td class="px-3 py-2">${p.lastName||''}</td>
          <td class="px-3 py-2">${p.idNumber||''}</td>
          <td class="px-3 py-2">${badge}</td>
          <td class="px-3 py-2">${p.assignType==='farm'?'Finca':'Geocerca'}: ${nameOf(p)}</td>
          <td class="px-3 py-2">
            <button class="text-indigo-600 hover:underline" onclick="openEditPerson('${p.id}')">Editar</button>
            <span class="mx-1 text-gray-300">|</span>
            <button class="text-rose-600 hover:underline" onclick="deletePerson('${p.id}')">Eliminar</button>
          </td>`;
        tr.addEventListener('dblclick',()=>{
          if(p.assignType==='farm') zoomToFarm(p.assignId);
          if(p.assignType==='fence') zoomToFence(p.assignId);
        });
        tbody.appendChild(tr);
      });
    }

    async function deletePerson(id){
      if(!id) return;
      let cache=loadPeople();
      const it=(currentPersonnel||[]).find(p=>p.id===id)||cache.find(p=>p.id===id);
      const label=it?`${it.firstName||''} ${it.lastName||''}`.trim():'esta persona';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{
        await db.collection('personnel').doc(id).delete();
      } catch{
        cache=cache.filter(p=>p.id!==id);
        savePeople(cache);
      }
      currentPersonnel=loadPeople();
      renderPersonnelList();
    }

    function openEditPerson(id){
      const src=currentPersonnel?.length?currentPersonnel:(loadPeople()||[]);
      const p=src.find(x=>x.id===id);
      if(!p){
        alert('No se encontró el registro.');
        return;
      }
      const fn=prompt('Nombre',p.firstName||'');
      if(fn===null) return;
      const ln=prompt('Apellido',p.lastName||'');
      if(ln===null) return;
      const idn=prompt('Cédula (solo dígitos 6–15)',p.idNumber||'');
      if(idn===null||!/^[0-9]{6,15}$/.test(idn)){
        alert('Cédula inválida.');
        return;
      }
      const actAns = prompt('¿Activo? (s/n)', (p.active!==false)?'s':'n');
      if(actAns===null) return;
      const active = String(actAns).toLowerCase().trim()==='s';
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const choices=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
      let pick=prompt('Asigne escribiendo el número:\n'+choices.map((c,i)=>`${i+1}. ${c.l}`).join('\n'));
      if(pick===null) return;
      pick=(+pick)-1;
      if(pick<0||pick>=choices.length){
        alert('Selección inválida.');
        return;
      }
      const [assignType,assignId]=choices[pick].v.split(':');
      const doc={firstName:fn,lastName:ln,idNumber:idn,assignType,assignId,active};
      (async()=>{
        try{
          await db.collection('personnel').doc(id).update(doc);
        } catch{
          const cache=loadPeople();
          const i=cache.findIndex(x=>x.id===id);
          if(i>=0){
            cache[i]={...cache[i],...doc};
            savePeople(cache);}
        }
        currentPersonnel=loadPeople();
        renderPersonnelList();
        buildActivityFormOptions();
        buildLaborCostPersonCache();
        buildReportFilterOptions();
      })();
    }

    /* ---------- GESTIÓN DE ACTIVIDADES ---------- */
    function showActError(msg){
      const e=document.getElementById('actFormError');
      e.textContent=msg||'';
      e.classList.toggle('hidden',!msg);
    }

    function buildActivityFormOptions(){
      const actSel=document.getElementById('actActivitySelect');
      const actFilter=document.getElementById('actFilterActivity');
      if(actSel){
        actSel.innerHTML = activityDefs.map(a=>`<option value="${a}">${a}</option>`).join('');
      }
      if(actFilter){
        actFilter.innerHTML = '<option value="all">Todas</option>' + activityDefs.map(a=>`<option value="${a}">${a}</option>`).join('');
      }
      const people=currentPersonnel?.length?currentPersonnel:loadPeople();
      const pSel=document.getElementById('actPersonSelect');
      const pFilter=document.getElementById('actFilterPerson');
      if(pSel){
        pSel.innerHTML = people.length?
          people.map(p=>`<option value="${p.id}">${p.firstName||''} ${p.lastName||''}${(p.active===false)?' (inactivo)':''}</option>`).join('')
          : '<option value="">No hay personal</option>';
      }
      if(pFilter){
        pFilter.innerHTML = '<option value="all">Todas</option>' + (people.map(p=>`<option value="${p.id}">${p.firstName||''} ${p.lastName||''}${(p.active===false)?' (inactivo)':''}</option>`).join(''));
      }
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const eSel=document.getElementById('actEntitySelect');
      if(eSel){
        const items=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
        eSel.innerHTML = items.length?
          items.map(i=>`<option value="${i.v}">${i.l}</option>`).join('')
          : '<option value="">No hay entidades</option>';
      }
    }

    function buildActivityFilterOptions(){
      buildActivityFormOptions();
    }

    function manageActivityList(){
      const op = prompt('Gestionar actividades:\n1) Agregar\n2) Eliminar\n\nEscribe 1 o 2');
      if(op===null) return;
      if(op==='1'){
        const name = (prompt('Nombre de la nueva actividad:')||'').trim();
        if(!name) return;
        if(activityDefs.some(a=>a.toLowerCase()===name.toLowerCase())){
          alert('Ya existe esa actividad.');
          return;
        }
        activityDefs.push(name);
        activityDefs.sort((a,b)=>a.localeCompare(b));
        saveActivityDefs(activityDefs);
        buildActivityFormOptions();
        buildReportFilterOptions();
        alert('Actividad agregada.');
      }else if(op==='2'){
        if(!activityDefs.length){
          alert('No hay actividades para eliminar.');
          return;
        }
        const pick = prompt('Escribe el número a eliminar:\n' + activityDefs.map((a,i)=>`${i+1}. ${a}`).join('\n'));
        if(pick===null) return;
        const idx=(+pick)-1;
        if(idx<0 || idx>=activityDefs.length){
          alert('Selección inválida.');
          return;
        }
        const removed = activityDefs.splice(idx,1)[0];
        saveActivityDefs(activityDefs);
        buildActivityFormOptions();
        buildReportFilterOptions();
        alert('Eliminada: '+removed);
      }
    }

    async function addActivity(){
      try{
        const activity=(document.getElementById('actActivitySelect').value||'').trim();
        const personId=(document.getElementById('actPersonSelect').value||'').trim();
        const entity=(document.getElementById('actEntitySelect').value||'').trim();
        const start=(document.getElementById('actStartDate').value||'').trim();
        const end=(document.getElementById('actEndDate').value||'').trim();
        showActError('');
        if(!activity) return showActError('Selecciona una actividad.');
        if(!personId) return showActError('Selecciona una persona.');
        if(!entity) return showActError('Selecciona una finca/geocerca.');
        if(!start||!end) return showActError('Selecciona el rango de fechas.');
        if(start>end) return showActError('La fecha inicio no puede ser mayor a la fecha fin.');
        const people=currentPersonnel?.length?currentPersonnel:loadPeople();
        const p=people.find(x=>x.id===personId);
        const personName = p ? `${p.firstName||''} ${p.lastName||''}`.trim() : '—';
        const [assignType,assignId]=entity.split(':');
        const farms=currentFarms?.length?currentFarms:loadFarms();
        const fences=currentFences?.length?currentFences:loadFences();
        const entityName = assignType==='farm' ? (farms.find(f=>f.id===assignId)?.name||'Finca') : assignType==='fence' ? (fences.find(g=>g.id===assignId)?.name||'Geocerca') : '—';
        const tempId='locala-'+Date.now();
        const record={
          id:tempId,
          activity,
          personId,
          personName,
          assignType,
          assignId,
          entityName,
          startDate:start,
          endDate:end
        };
        let cache=loadActs();
        cache.push(record);
        saveActs(cache);
        currentActivities=cache.slice();
        renderActivityList();
        try{
          const ref=await db.collection('activities').add({ activity, personId, personName, assignType, assignId, entityName, startDate:start, endDate:end });
          cache = loadActs().map(a=>a.id===tempId?({...a,id:ref.id}):a);
          saveActs(cache);
          currentActivities=cache.slice();
          renderActivityList();
        }catch{
          waitAuthThen(syncLocalPendingToFirestore);
        }
        document.getElementById('actStartDate').value='';
        document.getElementById('actEndDate').value='';
      }catch(e){
        console.error(e);
        showActError('No se pudo agregar la actividad.');
      }
    }
    window.addActivity = addActivity;

    function renderActivityList(){
      const tbody=document.getElementById('activityTableBody');
      if(!tbody) return;
      const fPerson=(document.getElementById('actFilterPerson').value||'all');
      const fAct=(document.getElementById('actFilterActivity').value||'all');
      const fFrom=(document.getElementById('actFilterFrom').value||'');
      const fTo=(document.getElementById('actFilterTo').value||'');
      let list=currentActivities?.length?currentActivities.slice():loadActs();
      list=list.filter(a=>{
        let ok=true;
        if(fPerson!=='all') ok=ok&&(a.personId===fPerson);
        if(ok&&fAct!=='all') ok=(a.activity===fAct);
        if(ok&&fFrom) ok=ok&&(a.endDate>=fFrom);
        if(ok&&fTo) ok=ok&&(a.startDate<=fTo);
        return ok;
      });
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML='<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No hay actividades registradas.</td></tr>';
        return;
      }
      list.sort((a,b)=>(a.startDate||'').localeCompare(b.startDate||''));
      list.forEach(a=>{
        const entityLabel = (a.assignType==='farm'?'Finca':'Geocerca')+': '+(a.entityName||'—');
        const tr=document.createElement('tr');
        tr.className='border-t hover:bg-gray-50';
        tr.innerHTML=`<td class="px-3 py-2">${a.activity}</td>
          <td class="px-3 py-2">${a.personName||'—'}</td>
          <td class="px-3 py-2">${entityLabel}</td>
          <td class="px-3 py-2">${a.startDate}</td>
          <td class="px-3 py-2">${a.endDate}</td>
          <td class="px-3 py-2">
            <button class="text-rose-600 hover:underline" onclick="deleteActivity('${a.id}')">Eliminar</button>
          </td>`;
        tr.addEventListener('dblclick',()=>{
          if(a.assignType==='farm') zoomToFarm(a.assignId);
          if(a.assignType==='fence') zoomToFence(a.assignId);
        });
        tbody.appendChild(tr);
      });
    }

    async function deleteActivity(id){
      if(!id) return;
      const it=(currentActivities||[]).find(x=>x.id===id)||(loadActs().find(x=>x.id===id));
      const label = it ? `${it.activity} - ${it.personName}` : 'esta actividad';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{
        await db.collection('activities').doc(id).delete();
      } catch{
        const cache=loadActs().filter(a=>a.id!==id);
        saveActs(cache);
      }
      currentActivities=loadActs();
      renderActivityList();
    }
    window.deleteActivity=deleteActivity;

    /* ---------- COSTOS DE MANO DE OBRA ---------- */
    let lcChosenPerson = { id:'', name:'' };
    function showLcError(msg){
      const e=document.getElementById('lcFormError');
      e.textContent=msg||'';
      e.classList.toggle('hidden',!msg);
    }

    function openLcModal(){
      const modal=document.getElementById('lcPersonModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      renderLcModalList();
      document.getElementById('lcModalSearch').value='';
      document.getElementById('lcModalSearch').focus();
    }

    function closeLcModal(){
      const modal=document.getElementById('lcPersonModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function buildLaborCostPersonCache(){
      /* no-op */
    }

    function renderLcModalList(){
      const cont=document.getElementById('lcModalList');
      const q=(document.getElementById('lcModalSearch').value||'').trim().toLowerCase();
      const people=(currentPersonnel?.length?currentPersonnel:loadPeople()).filter(p=>p.active!==false);
      let list=people;
      if(q){
        list = people.filter(p=>(`${p.firstName||''} ${p.lastName||''} ${p.idNumber||''}`.toLowerCase().includes(q)));
      }
      cont.innerHTML='';
      if(!list.length){
        cont.innerHTML='<div class="py-6 text-center text-gray-500">No hay personas activas.</div>';
        return;
      }
      list.forEach(p=>{
        const btn=document.createElement('button');
        btn.className='w-full text-left px-3 py-2 hover:bg-gray-100';
        btn.innerHTML=`<div class="font-medium text-gray-800">${p.firstName||''} ${p.lastName||''}</div><div class="text-xs text-gray-500">Cédula: ${p.idNumber||''}</div>`;
        btn.addEventListener('click', ()=>{
          lcChosenPerson={
            id:p.id,
            name:`${p.firstName||''} ${p.lastName||''}`.trim()
          };
          const display=document.getElementById('lcPersonDisplay');
          display.value=lcChosenPerson.name;
          display.dataset.personId = lcChosenPerson.id;
          closeLcModal();
        });
        cont.appendChild(btn);
      });
    }

    async function addLaborCost(){
      try{
        showLcError('');
        const display=document.getElementById('lcPersonDisplay');
        const personId = display.dataset.personId || '';
        const personName = display.value || '';
        const dailyCost = parseFloat(document.getElementById('lcDailyCost').value);
        const start = (document.getElementById('lcStartDate').value||'').trim();
        const end = (document.getElementById('lcEndDate').value||'').trim();
        if(!personId) return showLcError('Elige una persona activa.');
        if(!(dailyCost>=0)) return showLcError('Ingresa un costo válido.');
        if(!start || !end) return showLcError('Selecciona el rango de fechas.');
        if(start>end) return showLcError('La fecha inicio no puede ser mayor a la fecha fin.');
        const tempId='localc-'+Date.now();
        const rec={
          id:tempId,
          personId,
          personName,
          dailyCost:+dailyCost,
          startDate:start,
          endDate:end
        };
        let cache=loadLaborCosts();
        cache.push(rec);
        saveLaborCosts(cache);
        currentLaborCosts = cache.slice();
        renderLaborCostList();
        try{
          const ref = await db.collection('labor_costs').add({personId, personName, dailyCost:+dailyCost, startDate:start, endDate:end});
          cache = loadLaborCosts().map(x=>x.id===tempId?({...x,id:ref.id}):x);
          saveLaborCosts(cache);
          currentLaborCosts=cache.slice();
          renderLaborCostList();
        }catch{
          waitAuthThen(syncLocalPendingToFirestore);
        }
        // limpiar
        document.getElementById('lcPersonDisplay').value='';
        document.getElementById('lcPersonDisplay').dataset.personId='';
        document.getElementById('lcDailyCost').value='';
        document.getElementById('lcStartDate').value='';
        document.getElementById('lcEndDate').value='';
      }catch(e){
        console.error(e);
        showLcError('No se pudo guardar el costo.');
      }
    }
    window.addLaborCost = addLaborCost;

    function renderLaborCostList(){
      const tbody=document.getElementById('laborCostTableBody');
      if(!tbody) return;
      let list=currentLaborCosts?.length?currentLaborCosts.slice():loadLaborCosts();
      list.sort((a,b)=> (a.personName||'').localeCompare(b.personName||'') || (a.startDate||'').localeCompare(b.startDate||'') );
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML='<tr><td colspan="5" class="px-3 py-4 text-center text-gray-500">No hay costos registrados.</td></tr>';
        return;
      }
      list.forEach(c=>{
        const tr=document.createElement('tr');
        tr.className='border-t hover:bg-gray-50';
        tr.innerHTML=`<td class="px-3 py-2">${c.personName||'—'}</td>
          <td class="px-3 py-2">$${(c.dailyCost||0).toFixed(2)}</td>
          <td class="px-3 py-2">${c.startDate}</td>
          <td class="px-3 py-2">${c.endDate}</td>
          <td class="px-3 py-2">
            <button class="text-rose-600 hover:underline" onclick="deleteLaborCost('${c.id}')">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function deleteLaborCost(id){
      if(!id) return;
      const it=(currentLaborCosts||[]).find(x=>x.id===id)||(loadLaborCosts().find(x=>x.id===id));
      const label = it ? `${it.personName} ($${(it.dailyCost||0).toFixed(2)})` : 'este registro';
      if(!confirm(`¿Eliminar ${label}?`)) return;
      try{
        await db.collection('labor_costs').doc(id).delete();
      } catch{
        const cache=loadLaborCosts().filter(x=>x.id!==id);
        saveLaborCosts(cache);
      }
      currentLaborCosts=loadLaborCosts();
      renderLaborCostList();
    }
    window.deleteLaborCost=deleteLaborCost;

    /* ---------- Reportes ---------- */
    let reportChart = null;
    let lastReportHeader = [];
    let lastReportRows = [];

    function setDefaultReportDates(){
      const today = new Date();
      const toY = today.getFullYear(), toM = String(today.getMonth()+1).padStart(2,'0'), toD = String(today.getDate()).padStart(2,'0');
      const to = `${toY}-${toM}-${toD}`;
      const past = new Date(today);
      past.setDate(past.getDate()-30);
      const fromY=past.getFullYear(), fromM=String(past.getMonth()+1).padStart(2,'0'), fromD=String(past.getDate()).padStart(2,'0');
      const from = `${fromY}-${fromM}-${fromD}`;
      if(document.getElementById('repFrom') && !document.getElementById('repFrom').value) document.getElementById('repFrom').value = from;
      if(document.getElementById('repTo') && !document.getElementById('repTo').value) document.getElementById('repTo').value = to;
    }

    function buildReportFilterOptions(){
      // Personas
      const people=currentPersonnel?.length?currentPersonnel:loadPeople();
      const pSel=document.getElementById('repPersons');
      if(pSel){
        pSel.innerHTML = people.map(p=>`<option value="${p.id}">${p.firstName||''} ${p.lastName||''}${(p.active===false)?' (inactivo)':''}</option>`).join('');
      }
      // Entidades
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      const eSel=document.getElementById('repEntities');
      if(eSel){
        const items=[...farms.map(f=>({v:`farm:${f.id}`,l:`Finca: ${f.name||'Finca'}`})), ...fences.map(g=>({v:`fence:${g.id}`,l:`Geocerca: ${g.name||'Geocerca'}`}))];
        eSel.innerHTML = items.map(i=>`<option value="${i.v}">${i.l}</option>`).join('');
      }
      // Actividades
      const aSel=document.getElementById('repActivities');
      if(aSel){
        aSel.innerHTML = activityDefs.map(a=>`<option value="${a}">${a}</option>`).join('');
      }
      setDefaultReportDates();
    }

    function getMultiValues(selectEl){
      if(!selectEl) return [];
      return Array.from(selectEl.selectedOptions||[]).map(o=>o.value);
    }

    function overlap(aStart, aEnd, bStart, bEnd){
      return (!bStart || aEnd>=bStart) && (!bEnd || aStart<=bEnd);
    }

    function dateDiffDays(a,b){
      // inclusivo
      const d1=new Date(a+"T00:00:00"), d2=new Date(b+"T00:00:00");
      return Math.max(0, Math.floor((d2 - d1)/(24*3600*1000)) + 1);
    }

    function entityLabel(assignType, assignId){
      const farms=currentFarms?.length?currentFarms:loadFarms();
      const fences=currentFences?.length?currentFences:loadFences();
      if(assignType==='farm'){
        const n = farms.find(f=>f.id===assignId)?.name||'Finca';
        return `Finca: ${n}`;
      }
      if(assignType==='fence'){
        const n = fences.find(g=>g.id===assignId)?.name||'Geocerca';
        return `Geocerca: ${n}`;
      }
      return '—';
    }

    function renderReportTable(header, rows){
      lastReportHeader = header.slice();
      lastReportRows = rows.slice();
      const thead=document.getElementById('repTableHead');
      const tbody=document.getElementById('repTableBody');
      thead.innerHTML = `<tr class="text-gray-600 text-sm">${header.map(h=>`<th class="px-3 py-2">${h}</th>`).join('')}</tr>`;
      tbody.innerHTML = rows.length ?
        rows.map(r=>`<tr class="border-t hover:bg-gray-50">${r.map(c=>`<td class="px-3 py-2">${c}</td>`).join('')}</tr>`).join('')
        : `<tr><td colspan="${header.length}" class="px-3 py-4 text-center text-gray-500">Sin resultados para los filtros seleccionados.</td></tr>`;
    }
    function exportReportCSV(){
      if(!lastReportHeader.length){
        alert('Primero genera un reporte.');
        return;
      }
      const lines = [];
      const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
      lines.push(lastReportHeader.map(esc).join(','));
      lastReportRows.forEach(r=>lines.push(r.map(esc).join(',')));
      const blob = new Blob(["\uFEFF"+lines.join("\r\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function renderReportChart(labels, data, chartType, labelText){
      const ctx = document.getElementById('repChart').getContext('2d');
      if(reportChart){
        reportChart.destroy();
        reportChart=null;
      }
      reportChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels,
          datasets: [{
            label: labelText,
            data
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false
        }
      });
    }

    function generateReport(){
      const people=currentPersonnel?.length?currentPersonnel:loadPeople();
      const onlyActive = document.getElementById('repOnlyActive').checked;
      const selPeople = getMultiValues(document.getElementById('repPersons'));
      const selEntities = getMultiValues(document.getElementById('repEntities'));
      const selActs = getMultiValues(document.getElementById('repActivities'));
      const from = (document.getElementById('repFrom').value||'');
      const to = (document.getElementById('repTo').value||'');
      const groupBy = document.getElementById('repGroupBy').value;
      const metric = document.getElementById('repMetric').value;
      const chartType = document.getElementById('repChartType').value;

      // Filtro datos
      let list=currentActivities?.length?currentActivities.slice():loadActs();
      list=list.filter(a=>{
        const p = people.find(x=>x.id===a.personId);
        if(onlyActive && p && p.active===false) return false;
        if(selPeople.length && !selPeople.includes(a.personId)) return false;
        if(selEntities.length && !selEntities.includes(`${a.assignType}:${a.assignId}`)) return false;
        if(selActs.length && !selActs.includes(a.activity)) return false;
        if(!overlap(a.startDate, a.endDate, from, to)) return false;
        return true;
      });

      // Cálculo días intersecando con el filtro (para métrica "días")
      const calcDays = (a)=> {
        const s = from && a.startDate<from ? from : a.startDate;
        const e = to && a.endDate>to ? to : a.endDate;
        return dateDiffDays(s,e);
      };

      if(groupBy==='detalle'){
        const header=['Actividad','Persona','Entidad','Fecha inicio','Fecha fin','Días'];
        const rows=list.map(a=>[a.activity, a.personName||'—', entityLabel(a.assignType,a.assignId), a.startDate, a.endDate, calcDays(a)]);
        renderReportTable(header, rows);
        // Para gráfico, agregamos por actividad (métrica elegida)
        const map = new Map();
        list.forEach(a=>{
          const key=a.activity;
          const inc = (metric==='days'?calcDays(a):1);
          map.set(key, (map.get(key)||0)+inc);
        });
        const labels=[...map.keys()], data=[...map.values()];
        renderReportChart(labels, data, chartType, metric==='days'?'Días':'Actividades');
        return;
      }

      // Agrupaciones
      let keyFn, title, labelFn;
      if(groupBy==='persona'){
        keyFn=a=>a.personName||'—';
        title='Persona';
        labelFn=keyFn;
      }else if(groupBy==='entidad'){
        keyFn=a=>entityLabel(a.assignType,a.assignId);
        title='Entidad';
        labelFn=keyFn;
      }else{
        // actividad
        keyFn=a=>a.activity||'—';
        title='Actividad';
        labelFn=keyFn;
      }

      const agg = new Map();
      list.forEach(a=>{
        const k=keyFn(a);
        const cur = agg.get(k) || {count:0, days:0};
        cur.count += 1;
        cur.days += calcDays(a);
        agg.set(k, cur);
      });

      const header=[title,'Actividades','Días'];
      const rows=[...agg.entries()].sort((x,y)=>String(x[0]).localeCompare(String(y[0]))).map(([k,v])=>[k, v.count, v.days]);
      renderReportTable(header, rows);

      const labels = rows.map(r=>r[0]);
      const data = rows.map(r=> metric==='days' ? r[2] : r[1]);
      renderReportChart(labels, data, chartType, metric==='days'?'Días':'Actividades');
    }

    /* ---------- Entrada (LOGIN) ---------- */
    function handleAdminLogin(){
      // ocultar error previo en cada intento
      const err = document.getElementById('errorMessage');
      if (err) err.style.display = 'none';

      const val = (document.getElementById('adminCodeInput').value || '').trim().toLowerCase();
      const ok = (val === 'admin123');
      if(!ok){
        document.getElementById('errorMessage').style.display='block';
        return;
      }
      try{
        localStorage.setItem('admin_ok','1');
      }catch(e){
        console.error('Error saving to localStorage', e);
      }
      // Ocultar modal y mostrar app de forma explícita
      const modal = document.getElementById('adminModal');
      const app = document.getElementById('appContent');
      modal.classList.add('hidden');
      app.classList.remove('hidden');
      app.style.display = 'flex'; // asegurar visibilidad

      // Inicializar el mapa después de que el contenido sea visible
      setTimeout(() => {
        initMap();
        setTimeout(() => {
          if (map) {
            map.invalidateSize();
          }
        }, 100);
      }, 100);
    }

    // Fechas por defecto (actividades / costos)
    function setDefaultActivityDates(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      const val = `${y}-${m}-${d}`;
      const s = document.getElementById('actStartDate');
      const e = document.getElementById('actEndDate');
      if(s && !s.value) s.value = val;
      if(e && !e.value) e.value = val;
    }

    function setDefaultLaborCostDates(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      const val = `${y}-${m}-${d}`;
      const s = document.getElementById('lcStartDate');
      const e = document.getElementById('lcEndDate');
      if(s && !s.value) s.value = val;
      if(e && !e.value) e.value = val;
    }

    /* ---------- Listeners ---------- */
    document.addEventListener('DOMContentLoaded',()=>{
      // Verificación del estado de autenticación
      let already = false;
      try {
        already = localStorage.getItem('admin_ok') === '1';
      } catch (e) {
        console.error('Error accessing localStorage:', e);
      }
      
      const modal = document.getElementById('adminModal');
      const app = document.getElementById('appContent');

      if(already){
        modal.classList.add('hidden');
        app.classList.remove('hidden');
        app.style.display = 'flex'; // asegurar visibilidad
        // Inicializar el mapa después de que el contenido sea visible
        setTimeout(() => {
          initMap();
          setTimeout(() => {
            if (map) {
              map.invalidateSize();
            }
          }, 100);
        }, 100);
      }else{
        modal.classList.remove('hidden');
        app.classList.add('hidden');
        app.style.display = ''; // permitir que la clase hidden controle el display
      }

      document.getElementById('adminLoginBtn').addEventListener('click', handleAdminLogin);
      document.getElementById('adminCodeInput').addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          handleAdminLogin();
        }
      });

      // Mapa
      document.getElementById('farmSelect').addEventListener('change',updateDeleteButtonState);
      document.getElementById('startFenceBtn').addEventListener('click',startFenceDraw);
      document.getElementById('finishFenceBtn').addEventListener('click',finishFenceDraw);
      document.getElementById('cancelFenceBtn').addEventListener('click',cancelFenceDraw);
      document.getElementById('fenceNameSaveBtn').addEventListener('click',saveFenceName);
      document.getElementById('fenceNameCancelBtn').addEventListener('click',()=>document.getElementById('fenceNamePanel').classList.add('hidden'));
      document.getElementById('editFenceBtn').addEventListener('click',()=>{ /* enable edit si lo usas */ });
      document.getElementById('exportGeoJSONBtn').addEventListener('click',()=>{ /* export */ });

      // Listas dblclick
      document.getElementById('farmList').addEventListener('dblclick',e=>{const n=e.target.closest('[data-type="farm"][data-id]'); if(n) zoomToFarm(n.dataset.id);});
      document.getElementById('fenceList').addEventListener('dblclick',e=>{const n=e.target.closest('[data-type="fence"][data-id]'); if(n) zoomToFence(n.dataset.id);});

      // Personal
      document.getElementById('addPersonBtn').addEventListener('click', addPerson);
      ['pFirstName','pLastName','pIdNumber'].forEach(id=>{
        const el=document.getElementById(id);
        el.addEventListener('keydown', (ev)=>{
          if(ev.key==='Enter'){
            addPerson();
          }
        });
      });
      document.getElementById('pSearchInput').addEventListener('input',renderPersonnelList);
      document.getElementById('pTypeFilter').addEventListener('change',renderPersonnelList);
      document.getElementById('pEntityFilter').addEventListener('change',renderPersonnelList);

      // Actividades
      document.getElementById('addActivityBtn').addEventListener('click', addActivity);
      document.getElementById('actManageBtn').addEventListener('click', manageActivityList);
      document.getElementById('actFilterPerson').addEventListener('change', renderActivityList);
      document.getElementById('actFilterActivity').addEventListener('change', renderActivityList);
      document.getElementById('actFilterFrom').addEventListener('change', renderActivityList);
      document.getElementById('actFilterTo').addEventListener('change', renderActivityList);
      setDefaultActivityDates();

      // Costos
      document.getElementById('lcChoosePersonBtn').addEventListener('click', openLcModal);
      document.getElementById('lcModalClose').addEventListener('click', closeLcModal);
      document.getElementById('lcModalCancel').addEventListener('click', closeLcModal);
      document.getElementById('lcModalSearch').addEventListener('input', renderLcModalList);
      document.getElementById('lcAddCostBtn').addEventListener('click', addLaborCost);
      setDefaultLaborCostDates();

      // Reportes
      buildReportFilterOptions();
      document.getElementById('repGenerateBtn').addEventListener('click', generateReport);
      document.getElementById('repDownloadBtn').addEventListener('click', exportReportCSV);

      // Primer pintado
      buildIndexList();
      buildAssignOptions();
      buildActivityFormOptions();
      buildActivityFilterOptions();
      updateDeleteButtonState();
      updateDeleteFenceButtonState();
      updateEditButtonsState();
      renderLaborCostList();
    });
  </script>
</body>
</html>
