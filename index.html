<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Personal de Finca (Leaflet + Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; overflow-x: hidden; }
    #map { height: 55vh; width: 100%; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,.1); z-index: 1; }
    @media (max-width: 768px) { #map { height: 45vh; } body { padding: 12px; } }
    #adminModal { z-index: 10000; }
    button, input, select, textarea { font-size: 16px; }
    .error-message { color: #dc2626; font-size: 14px; margin-top: 6px; display: none; }
    .farm-label { background: #ffffff; border: 1px solid rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); font-size: 12px; }
    .mousepos-control { background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.5rem;padding:.25rem .5rem;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.1); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 overflow-x-hidden">

  <!-- Modal admin -->
  <div id="adminModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">Acceso de Administrador</h1>
      <p class="text-gray-600 mb-6">Introduce tu código de administrador.</p>
      <input type="password" id="adminCodeInput" placeholder="Código de acceso" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center mb-2">
      <div id="errorMessage" class="error-message">Código incorrecto. Intenta con "admin123"</div>
      <button id="adminLoginBtn"
              onclick="doAdminLogin()"
              class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 transition font-bold">
        Acceder
      </button>
    </div>
  </div>

  <!-- Contenido de la app -->
  <div id="appContent" class="max-w-7xl mx-auto flex flex-col space-y-6 hidden">
    <header class="text-center my-4">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Control de Personal y Geocercas</h1>
      <p class="text-md sm:text-lg text-gray-600 mt-2">Sincronizado con Firebase (Firestore) + respaldo local</p>
    </header>

    <!-- Selección de finca -->
    <div class="bg-white p-4 rounded-2xl shadow-lg">
      <div>
        <label class="block text-sm font-medium text-gray-700">Finca activa</label>
        <select id="farmSelect" class="mt-1 w-full border rounded-md p-2"></select>
      </div>
    </div>

    <!-- Mapa -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="text-2xl font-semibold text-gray-700">Mapa de Fincas</h2>
        <div class="ml-auto flex flex-wrap gap-2">
          <!-- Geocerca (dibujo) -->
          <button id="startFenceBtn"
            class="inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Iniciar dibujo de geocerca">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/>
            </svg>
            Nueva geocerca
          </button>
          <button id="finishFenceBtn"
            class="hidden inline-flex items-center gap-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Finalizar geocerca">
            Finalizar geocerca
          </button>
          <button id="cancelFenceBtn"
            class="hidden inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg"
            title="Cancelar dibujo">
            Cancelar
          </button>

          <!-- Geocerca por coordenadas -->
          <button id="createFenceByCoordsBtn"
            class="inline-flex items-center gap-2 bg-sky-700 hover:bg-sky-800 text-white font-semibold px-4 py-2 rounded-lg"
            title="Crear geocerca ingresando una lista de coordenadas">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/>
            </svg>
            Geocerca (Lat/Lngs)
          </button>

          <!-- Fincas -->
          <button id="createFarmBtn"
            class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Crear finca en el centro del mapa">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Crear finca
          </button>
          <button id="createByCoordsBtn"
            class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg"
            title="Crear finca ingresando Lat/Lng">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4l3-3 4 8 3-5H22M3 19h18"/></svg>
            Crear finca (Lat/Lng)
          </button>
          <button id="deleteFarmBtn"
            class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
            title="Eliminar la finca seleccionada">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Eliminar finca
          </button>
        </div>
      </div>

      <!-- Panel nombre para Crear finca (Lat/Lng) -->
      <div id="coordsNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label for="coordsNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la nueva finca</label>
          <div class="flex gap-2">
            <input id="coordsNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Finca Palora Norte" />
            <button id="coordsNameSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="coordsNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="coordsNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <!-- Panel nombre para geocerca -->
      <div id="fenceNamePanel" class="hidden mb-3">
        <div class="rounded-xl border border-gray-200 p-3">
          <label for="fenceNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la geocerca</label>
          <div class="flex gap-2">
            <input id="fenceNameInput" type="text" class="border rounded-md p-2 w-full" placeholder="Ej.: Geocerca Lote 1" />
            <button id="fenceNameSaveBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
            <button id="fenceNameCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg">Cancelar</button>
          </div>
          <p id="fenceNameHint" class="text-xs text-gray-500 mt-2"></p>
        </div>
      </div>

      <div id="map"></div>
      <p id="statusMessage" class="mt-3 text-sm text-gray-600">
        Haz clic en el mapa para crear una nueva finca. También puedes usar <strong>Crear finca</strong> (centro del mapa) o <strong>Crear finca (Lat/Lng)</strong>.
        Para geocercas: <strong>Nueva geocerca</strong> → clics en el mapa para vértices → <strong>Finalizar geocerca</strong> → asigna nombre y guarda.
      </p>
    </div>
  </div>

  <!-- Leaflet & Firebase -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-0Vq8yG1lCFM3I8fE4FzP3pE5v1j6KqE",
      authDomain: "demo-finca-app.firebaseapp.com",
      projectId: "demo-finca-app",
      storageBucket: "demo-finca-app.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
    firebase.auth().signInAnonymously().catch(console.error);

    let map;
    const fincaMarkers = {};
    const LS_KEY = 'fincas_cache_v1';

    // Geocercas
    const geofenceLayers = {}; // id -> L.Polygon
    const LS_GF = 'geofences_cache_v1';

    // Dibujo interactivo
    let isDrawingFence = false;
    let drawingCoords = [];        // [{lat,lng}, ...]
    let drawingPolyline = null;    // L.Polyline temporal
    let drawingMarkers = [];       // pequeños marcadores de vértices
    let pendingFenceCoords = null; // coords a guardar cuando se nombra

    // Preview geocerca por lista
    let previewFenceLayer = null;

    // ===== Persistencia local =====
    function saveCache(farms){ try{ localStorage.setItem(LS_KEY, JSON.stringify(farms)); }catch{} }
    function loadCache(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }

    function saveFenceCache(fences){ try{ localStorage.setItem(LS_GF, JSON.stringify(fences)); }catch{} }
    function loadFenceCache(){ try{ return JSON.parse(localStorage.getItem(LS_GF)||'[]'); }catch{ return []; } }

    function renderFarmsFromCache(){
      const farms = loadCache();
      Object.values(fincaMarkers).forEach(m=> map.removeLayer(m));
      for(const k in fincaMarkers) delete fincaMarkers[k];

      farms.forEach(f=>{
        if(!f || !f.id || !f.fincaLocation) return;
        const marker = L.marker([f.fincaLocation.lat, f.fincaLocation.lng]).addTo(map);
        marker.bindTooltip(f.name || 'Finca',{permanent:true, direction:'right', offset:[10,0], className:'farm-label'});
        fincaMarkers[f.id] = marker;
      });

      const sel = document.getElementById('farmSelect');
      if (sel){
        sel.innerHTML = '';
        farms.forEach(f=>{
          const opt = document.createElement('option');
          opt.value = f.id; opt.textContent = f.name || 'Finca';
          sel.appendChild(opt);
        });
      }
      updateDeleteButtonState();
    }

    function renderGeofencesFromCache(){
      Object.values(geofenceLayers).forEach(p=> map.removeLayer(p));
      for(const k in geofenceLayers) delete geofenceLayers[k];

      const fences = loadFenceCache();
      fences.forEach(g=>{
        if(!g || !g.id || !Array.isArray(g.path) || g.path.length<3) return;
        const latlngs = g.path.map(pt=> [pt.lat, pt.lng]);
        const poly = L.polygon(latlngs, {weight:2, fillOpacity:0.15}).addTo(map);
        poly.bindTooltip(g.name || 'Geocerca',{permanent:true, direction:'center', className:'farm-label'});
        geofenceLayers[g.id] = poly;
      });
    }

    function initMap(center={lat:-0.1807, lng:-78.4678}, zoom=6){
      map = L.map('map',{center:[center.lat,center.lng],zoom});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

      addMousePositionControl();
      renderFarmsFromCache();
      renderGeofencesFromCache();

      map.on('click', async e=>{
        if(isDrawingFence){
          addFenceVertex(e.latlng);
          return;
        }
        const name = prompt("Nombre de la nueva finca:");
        if(!name) return;
        try{
          await db.collection('farms').add({ name, fincaLocation:{lat:e.latlng.lat, lng:e.latlng.lng} });
        }catch{
          const farms = loadCache();
          farms.push({ id: 'local-'+Date.now(), name, fincaLocation:{lat:e.latlng.lat, lng:e.latlng.lng} });
          saveCache(farms); renderFarmsFromCache();
        }
      });

      subscribeFarms();
      subscribeGeofences();
    }

    function subscribeFarms(){
      db.collection('farms').onSnapshot(snap=>{
        const farms = [];
        Object.values(fincaMarkers).forEach(m=> map.removeLayer(m));
        for(const k in fincaMarkers) delete fincaMarkers[k];

        snap.forEach(doc=>{
          const d = doc.data();
          const farm = { id: doc.id, name: d.name, fincaLocation: d.fincaLocation };
          farms.push(farm);
          if(d.fincaLocation){
            const marker = L.marker([d.fincaLocation.lat, d.fincaLocation.lng]).addTo(map);
            marker.bindTooltip(d.name || 'Finca',{permanent:true, direction:'right', offset:[10,0], className:'farm-label'});
            fincaMarkers[doc.id]=marker;
          }
        });

        saveCache(farms);
        const sel = document.getElementById('farmSelect');
        if (sel){
          sel.innerHTML = '';
          farms.forEach(f=>{
            const opt = document.createElement('option'); opt.value = f.id; opt.textContent = f.name || 'Finca'; sel.appendChild(opt);
          });
        }
        updateDeleteButtonState();
      }, ()=>{ renderFarmsFromCache(); });
    }

    function subscribeGeofences(){
      db.collection('geofences').onSnapshot(snap=>{
        const fences = [];
        Object.values(geofenceLayers).forEach(p=> map.removeLayer(p));
        for(const k in geofenceLayers) delete geofenceLayers[k];

        snap.forEach(doc=>{
          const d = doc.data();
          const g = { id: doc.id, name: d.name, path: d.path || [] };
          fences.push(g);
          if(Array.isArray(g.path) && g.path.length>=3){
            const latlngs = g.path.map(pt=> [pt.lat, pt.lng]);
            const poly = L.polygon(latlngs, {weight:2, fillOpacity:0.15}).addTo(map);
            poly.bindTooltip(g.name || 'Geocerca',{permanent:true, direction:'center', className:'farm-label'});
            geofenceLayers[doc.id]=poly;
          }
        });

        saveFenceCache(fences);
      }, ()=>{ renderGeofencesFromCache(); });
    }

    // Helpers coords
    function normDec(s){ return String(s||'').trim().replace(',', '.'); }
    function parseCoord(s){ const v=parseFloat(normDec(s)); return Number.isFinite(v)?v:NaN; }
    function validLat(v){ return v>=-90 && v<=90; }
    function validLng(v){ return v>=-180 && v<=180; }

    // Fincas
    let pendingLat = null, pendingLng = null;
    async function createFarmAtCenter(){
      if(!map){ alert('Mapa no listo aún.'); return; }
      const name = prompt("Nombre de la nueva finca:"); if(!name) return;
      const c = map.getCenter();
      try{ await db.collection('farms').add({ name, fincaLocation:{lat:c.lat, lng:c.lng} }); }
      catch{ const farms=loadCache(); farms.push({ id:'local-'+Date.now(), name, fincaLocation:{lat:c.lat, lng:c.lng} }); saveCache(farms); renderFarmsFromCache(); }
    }
    async function createFarmByCoords(){
      const latStr = prompt("Latitud (decimal, -90 a 90). Puedes usar coma o punto:"); if(latStr===null) return;
      const lngStr = prompt("Longitud (decimal, -180 a 180). Puedes usar coma o punto:"); if(lngStr===null) return;
      const lat = parseCoord(latStr), lng = parseCoord(lngStr);
      if(!Number.isFinite(lat) || !validLat(lat)){ alert('Latitud inválida o fuera de rango (-90 a 90).'); return; }
      if(!Number.isFinite(lng) || !validLng(lng)){ alert('Longitud inválida o fuera de rango (-180 a 180).'); return; }
      pendingLat = lat; pendingLng = lng;

      document.getElementById('coordsNameHint').textContent = `Coordenadas: Lat ${lat.toFixed(5)}, Lng ${lng.toFixed(5)}`;
      const input = document.getElementById('coordsNameInput');
      input.value = `Finca ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      document.getElementById('coordsNamePanel').classList.remove('hidden');
      input.focus(); input.select();

      if(map){ map.setView([lat, lng], Math.max(map.getZoom(), 12)); }
    }
    async function saveCoordsName(){
      if(pendingLat==null || pendingLng==null) { cancelCoordsName(); return; }
      const input = document.getElementById('coordsNameInput');
      const name = (input.value||'').trim() || `Finca ${pendingLat.toFixed(5)}, ${pendingLng.toFixed(5)}`;
      try{ await db.collection('farms').add({ name, fincaLocation:{lat: pendingLat, lng: pendingLng} }); }
      catch{ const farms=loadCache(); farms.push({ id:'local-'+Date.now(), name, fincaLocation:{lat:pendingLat, lng:pendingLng} }); saveCache(farms); renderFarmsFromCache(); }
      pendingLat=null; pendingLng=null; input.value=''; document.getElementById('coordsNamePanel').classList.add('hidden');
    }
    function cancelCoordsName(){ pendingLat=null; pendingLng=null; document.getElementById('coordsNameInput').value=''; document.getElementById('coordsNamePanel').classList.add('hidden'); }

    // Geocercas (dibujo)
    function addFenceVertex(latlng){
      drawingCoords.push({lat: latlng.lat, lng: latlng.lng});
      const m = L.circleMarker(latlng, {radius:4, weight:2}).addTo(map);
      drawingMarkers.push(m);
      updateFencePreview();
    }
    function updateFencePreview(){
      const latlngs = drawingCoords.map(p=> [p.lat, p.lng]);
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }
      if(latlngs.length>=3){
        drawingPolyline = L.polygon(latlngs, {dashArray:'4,4', weight:2, fillOpacity:0.1}).addTo(map);
      }else if(latlngs.length>=2){
        drawingPolyline = L.polyline(latlngs, {dashArray:'4,4', weight:2}).addTo(map);
      }
    }
    function startFenceDraw(){
      if(isDrawingFence) return;
      isDrawingFence = true;
      drawingCoords = [];
      drawingMarkers.forEach(m=> map.removeLayer(m)); drawingMarkers=[];
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }

      document.getElementById('startFenceBtn').classList.add('hidden');
      document.getElementById('finishFenceBtn').classList.remove('hidden');
      document.getElementById('cancelFenceBtn').classList.remove('hidden');
    }
    function finishFenceDraw(){
      if(!isDrawingFence) return;
      if(drawingCoords.length < 3){ alert('La geocerca necesita al menos 3 puntos.'); return; }
      pendingFenceCoords = drawingCoords.slice();
      const hint = document.getElementById('fenceNameHint');
      hint.textContent = `Vértices: ${pendingFenceCoords.length} puntos`;
      const input = document.getElementById('fenceNameInput');
      input.value = `Geocerca ${new Date().toLocaleDateString()}`;
      document.getElementById('fenceNamePanel').classList.remove('hidden');
      input.focus(); input.select();
    }
    function cancelFenceDraw(){
      isDrawingFence = false;
      drawingCoords = [];
      drawingMarkers.forEach(m=> map.removeLayer(m)); drawingMarkers=[];
      if(drawingPolyline){ map.removeLayer(drawingPolyline); drawingPolyline=null; }
      document.getElementById('startFenceBtn').classList.remove('hidden');
      document.getElementById('finishFenceBtn').classList.add('hidden');
      document.getElementById('cancelFenceBtn').classList.add('hidden');
      document.getElementById('fenceNamePanel').classList.add('hidden');
      pendingFenceCoords = null;
    }
    async function saveFenceName(){
      const input = document.getElementById('fenceNameInput');
      const name = (input.value||'').trim() || 'Geocerca';
      if(!pendingFenceCoords || pendingFenceCoords.length<3){ alert('No hay geocerca lista para guardar.'); return; }

      try{
        await db.collection('geofences').add({ name, path: pendingFenceCoords });
      }catch(err){
        console.error('No se pudo guardar en Firestore. Guardando localmente:', err);
        const fences = loadFenceCache();
        fences.push({ id: 'localgf-'+Date.now(), name, path: pendingFenceCoords });
        saveFenceCache(fences);
        renderGeofencesFromCache();
      }

      input.value='';
      pendingFenceCoords=null;
      document.getElementById('fenceNamePanel').classList.add('hidden');
      cancelFenceDraw();
      removePreviewFence(); // limpiar preview si venía de coords
    }
    function cancelFenceName(){
      document.getElementById('fenceNameInput').value='';
      document.getElementById('fenceNamePanel').classList.add('hidden');
      removePreviewFence();
    }

    // Geocerca por lista de coordenadas
    function parseLatLngList(texto){
      const items = String(texto || '')
        .split(/[\n;]+/)
        .map(s => s.trim())
        .filter(Boolean);

      const puntos = [];
      for(const it of items){
        const parts = it.split(/[,\s]+/).map(t => t.trim()).filter(Boolean);
        if(parts.length < 2) continue;
        const lat = parseCoord(parts[0]);
        const lng = parseCoord(parts[1]);
        if(Number.isFinite(lat) && Number.isFinite(lng) && validLat(lat) && validLng(lng)){
          puntos.push({lat, lng});
        }
      }
      return puntos;
    }
    function createFenceByCoords(){
      if (isDrawingFence){
        alert('Finaliza o cancela el dibujo de geocerca antes de crear por coordenadas.');
        return;
      }

      const ejemplo = "-1.2345,-78.5678; -1.2350,-78.5684; -1.2362,-78.5690";
      const raw = prompt(
        "Ingresa puntos en formato lat,lng separados por ';' o por saltos de línea.\n" +
        "Ejemplo:\n" + ejemplo
      );
      if(raw === null) return;

      const pts = parseLatLngList(raw);
      if(pts.length < 3){
        alert('Se requieren al menos 3 puntos válidos (lat,lng).');
        return;
      }

      pendingFenceCoords = pts;

      if(map){
        if(previewFenceLayer){ map.removeLayer(previewFenceLayer); previewFenceLayer = null; }
        previewFenceLayer = L.polygon(pts.map(p => [p.lat, p.lng]), { dashArray: '4,4', weight: 2, fillOpacity: 0.1 }).addTo(map);
        try { map.fitBounds(previewFenceLayer.getBounds(), { padding: [20,20] }); } catch {}
      }

      const hint = document.getElementById('fenceNameHint');
      if (hint) hint.textContent = `Vértices: ${pts.length} puntos`;

      const input = document.getElementById('fenceNameInput');
      if (input) {
        input.value = `Geocerca ${new Date().toLocaleDateString()}`;
        document.getElementById('fenceNamePanel')?.classList.remove('hidden');
        input.focus(); input.select();
      }
    }
    function removePreviewFence(){
      if(previewFenceLayer){
        map.removeLayer(previewFenceLayer);
        previewFenceLayer = null;
      }
    }

    // Eliminar finca
    async function deleteSelectedFarm(){
      const sel=document.getElementById('farmSelect'); const id=sel&&sel.value;
      if(!id){ alert('No hay finca seleccionada.'); return; }
      const farmsCache = loadCache();
      const farm = farmsCache.find(f=>f.id===id); const name=(farm&&farm.name)||'Finca';
      if(!confirm(`¿Eliminar "${name}"? Esta acción no se puede deshacer.`)) return;

      if(id.startsWith('local-')){
        const updated=farmsCache.filter(f=>f.id!==id); saveCache(updated); renderFarmsFromCache(); return;
      }
      try{ await db.collection('farms').doc(id).delete(); }
      catch{ const updated=farmsCache.filter(f=>f.id!==id); saveCache(updated); renderFarmsFromCache(); }
    }

    function updateDeleteButtonState(){
      const sel=document.getElementById('farmSelect'); const btn=document.getElementById('deleteFarmBtn');
      if(!btn) return; btn.disabled = !(sel && sel.value);
    }

    // Control coordenadas del mouse
    function addMousePositionControl(){
      const MousePos=L.Control.extend({
        options:{position:'bottomleft'},
        onAdd:function(){ const d=L.DomUtil.create('div','mousepos-control'); d.innerHTML='Lat: — Lng: —'; this._div=d; return d; },
        update:function(lat,lng){ if(this._div){ this._div.innerHTML = (lat!=null&&lng!=null)?`Lat: ${lat.toFixed(5)} &nbsp; Lng: ${lng.toFixed(5)}`:'Lat: — Lng: —'; } }
      });
      const ctrl = new MousePos(); ctrl.addTo(map);
      map.on('mousemove', e=>ctrl.update(e.latlng.lat, e.latlng.lng));
      map.on('mouseout', ()=>ctrl.update(null,null));
    }

    // LOGIN ADMIN (robusto)
    const ADMIN_CODE = "admin123";
    function normalizeAdminInput(str){
      const s = (str ?? "").toString().trim();
      const safe = (typeof s.normalize === "function") ? s.normalize("NFKC") : s;
      return safe.replace(/["'“”\s]/g, "").toLowerCase();
    }
    function doAdminLogin(){
      try{
        const raw = document.getElementById('adminCodeInput')?.value ?? "";
        if(normalizeAdminInput(raw)===normalizeAdminInput(ADMIN_CODE)){
          document.getElementById('adminModal')?.classList.add("hidden");
          document.getElementById('appContent')?.classList.remove("hidden");
          setTimeout(() => { initMap(); setTimeout(()=>map.invalidateSize(),100); }, 100);
        }else{
          const em = document.getElementById('errorMessage');
          if(em) em.style.display="block";
        }
      }catch(e){
        console.error(e);
      }
    }

    // Listeners
    document.addEventListener("DOMContentLoaded",()=>{
      // mostrar modal (por si tenía "hidden" desde una versión anterior)
      document.getElementById('adminModal')?.classList.remove("hidden");

      document.getElementById('adminLoginBtn')?.addEventListener("click", doAdminLogin);
      document.getElementById('adminCodeInput')?.addEventListener("keypress", e=>{ if(e.key==="Enter") doAdminLogin(); });
      document.getElementById('adminCodeInput')?.addEventListener("keydown",  e=>{ if(e.key==="Enter") doAdminLogin(); });

      const sel=document.getElementById('farmSelect');
      sel?.addEventListener('change', updateDeleteButtonState);

      document.getElementById('createFarmBtn')?.addEventListener('click', createFarmAtCenter);
      document.getElementById('deleteFarmBtn')?.addEventListener('click', deleteSelectedFarm);
      document.getElementById('createByCoordsBtn')?.addEventListener('click', createFarmByCoords);

      // Geocercas (dibujo)
      document.getElementById('startFenceBtn')?.addEventListener('click', startFenceDraw);
      document.getElementById('finishFenceBtn')?.addEventListener('click', finishFenceDraw);
      document.getElementById('cancelFenceBtn')?.addEventListener('click', cancelFenceDraw);
      document.getElementById('fenceNameSaveBtn')?.addEventListener('click', saveFenceName);
      document.getElementById('fenceNameCancelBtn')?.addEventListener('click', cancelFenceName);
      document.getElementById('fenceNameInput')?.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveFenceName(); } });

      // Geocerca por coordenadas
      document.getElementById('createFenceByCoordsBtn')?.addEventListener('click', createFenceByCoords);
      document.getElementById('fenceNameSaveBtn')?.addEventListener('click', removePreviewFence);
      document.getElementById('fenceNameCancelBtn')?.addEventListener('click', removePreviewFence);

      updateDeleteButtonState();
    });
  </script>
</body>
</html>

