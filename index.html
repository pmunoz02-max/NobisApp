<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NobisApp – Geocercas</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px rgba(15,23,42,.06)}
  .label-in-map{background:transparent;border:none;box-shadow:none;color:#1f2937;font-weight:600;text-shadow:0 0 3px #ffffffc7}
  .vertex-handle{width:12px;height:12px;background:#fff;border:2px solid #2563eb;border-radius:50%;box-shadow:0 0 0 2px #ffffffa8}
  .leaflet-container{background:#f3f4f6}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .role-badge{font-size:.72rem;padding:.15rem .4rem;border-radius:.5rem}
  .role-owner{background:#1e293b;color:#fff}
  .role-admin{background:#0ea5e9;color:#fff}
  .role-staff{background:#10b981;color:#0b3b2e}
</style>
</head>
<body class="bg-gray-100 text-gray-900">
<div class="max-w-6xl mx-auto p-4">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-2xl font-bold">Gestión de Geocercas</h1>
    <div class="text-xs text-gray-600">Estado: <span id="statusDot" class="font-semibold">inicial</span></div>
  </div>

  <!-- ===== Usuario / Geocercas (igual que antes) ===== -->
  <div class="grid md:grid-cols-3 gap-4">
    <div class="card p-4">
      <label class="block text-sm font-medium mb-1">Usuario</label>
      <div class="flex gap-2">
        <select id="userSelect" class="min-w-0 flex-1 border rounded-md p-2"></select>
        <button id="newUserBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Nuevo</button>
        <button id="renameUserBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Renombrar</button>
        <button id="deleteUserBtn" class="px-3 py-2 rounded-lg bg-rose-600 text-white">Eliminar</button>
      </div>

      <label class="block text-sm font-medium mt-4">Geocerca activa</label>
      <select id="geofenceSelect" class="w-full border rounded-md p-2 mt-1"></select>
    </div>

    <div class="card p-4">
      <div class="flex flex-wrap gap-2">
        <button id="newFenceBtn" class="btn px-3 py-2 bg-indigo-600 text-white rounded-lg">Nueva geocerca</button>
        <button id="finishFenceBtn" class="btn px-3 py-2 bg-green-600 text-white rounded-lg" disabled>Finalizar</button>
        <button id="cancelFenceBtn" class="btn px-3 py-2 bg-gray-600 text-white rounded-lg" disabled>Cancelar</button>
      </div>

      <div id="nameBar" class="hidden mt-3 p-3 border rounded-xl bg-indigo-50">
        <label class="text-sm font-medium">Nombre de la geocerca</label>
        <div class="mt-1 flex gap-2">
          <input id="nameField" class="flex-1 border rounded-md p-2" placeholder="Ej. Lote Norte">
          <button id="saveNameBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Guardar nombre</button>
          <button id="cancelNameBtn" class="px-3 py-2 rounded-lg bg-gray-200">Seguir dibujando</button>
        </div>
        <p class="text-xs text-gray-600 mt-2">Tip: Enter también guarda.</p>
      </div>

      <div class="flex flex-wrap gap-2 mt-3">
        <button id="createFenceByCoordsBtn" class="btn px-3 py-2 bg-teal-600 text-white rounded-lg">Geocerca (Lat/Lng)</button>
        <button id="editFenceBtn" class="btn px-3 py-2 bg-amber-500 text-white rounded-lg" disabled>Editar geocerca</button>
        <button id="saveFenceEditBtn" class="btn px-3 py-2 bg-emerald-600 text-white rounded-lg" disabled>Guardar cambios</button>
        <button id="cancelFenceEditBtn" class="btn px-3 py-2 bg-stone-500 text-white rounded-lg" disabled>Cancelar edición</button>
        <button id="renameFenceBtn" class="btn px-3 py-2 bg-sky-600 text-white rounded-lg" disabled>Renombrar</button>
      </div>

      <div id="renameBar" class="hidden mt-3 p-3 border rounded-xl bg-sky-50">
        <label class="block text-sm font-medium mb-1">Nuevo nombre</label>
        <div class="flex gap-2">
          <input id="renameField" class="flex-1 border rounded-md p-2">
          <button id="renameSaveBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Guardar</button>
          <button id="renameCancelBtn" class="px-3 py-2 rounded-lg bg-gray-200">Cancelar</button>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-2">
        <button id="deleteFenceBtn" class="btn px-3 py-2 bg-rose-600 text-white rounded-lg" disabled>Eliminar geocerca</button>
        <button id="exportGeoJsonBtn" class="btn px-3 py-2 bg-cyan-700 text-white rounded-lg">Exportar GeoJSON</button>
        <label class="btn px-3 py-2 bg-slate-700 text-white rounded-lg cursor-pointer">
          Importar GeoJSON
          <input id="importGeoJsonInput" type="file" accept=".json,.geojson,application/geo+json,application/json" class="hidden">
        </label>
      </div>
    </div>

    <div class="card p-4 text-sm">
      <p><b>Dibujo:</b> Nueva geocerca → clics/toques → <i>Finalizar</i> (o doble clic / clic en el 1º punto).</p>
      <p class="mt-1"><b>Edición:</b> Selecciona una geocerca → <b>Editar</b> → arrastra vértices → <b>Guardar cambios</b>.</p>
      <p class="mt-1">También puedes crear por <b>Lat/Lng</b> (una línea <code>lat,lng</code> por vértice).</p>
    </div>
  </div>

  <!-- ===== Mapa principal ===== -->
  <div class="mt-4 card overflow-hidden">
    <div class="px-4 py-3 border-b"><h2 class="text-lg font-semibold">Mapa</h2></div>
    <div id="map" style="height:520px;min-height:380px;"></div>
  </div>

  <!-- Lista de geocercas -->
  <div class="mt-4 card">
    <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Geocercas</h3></div>
    <ul id="fenceList" class="p-3 divide-y"></ul>
  </div>

  <!-- ===== Reportes (AQUÍ VA EL NUEVO MAPA) ===== -->
  <div id="reportsModule" class="mt-6 card">
    <div class="px-4 py-3 border-b"><h3 class="text-lg font-semibold">Reportes</h3></div>
    <div class="p-4 grid md:grid-cols-5 gap-3" id="repSummary"></div>
    <div class="px-4 pb-3">
      <div class="flex gap-2">
        <button id="exportChecksBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Exportar Check-ins CSV</button>
        <button id="exportActsBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Exportar Actividades CSV</button>
      </div>
    </div>
    <div class="border-t px-4 py-3"><h4 class="font-semibold">Mapa de reportes</h4></div>
    <!-- Altura fija + mínima para evitar 0px -->
    <div id="repMap" style="height:420px;min-height:320px;"></div>
  </div>

  <!-- ===== Administración mínima (botonera que ya usas) ===== -->
  <div id="adminModule" class="mt-6 card">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">Administración de usuarios</h3>
      <div>
        <button id="createAdminBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white mr-2">Crear administrador</button>
        <button id="createStaffBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Crear personal</button>
      </div>
    </div>
    <div class="p-4" id="usersTable"></div>
  </div>
</div>

<script>
/* ====== Constantes / storage ====== */
const APP='NobisApp';
const USERS_KEY=APP+'_users';
const CURR_USER_KEY=APP+'_current_user';
const GEOFENCE_PREFIX=APP+'_geofences_';
const CHECKS_PREFIX=APP+'_checkins_';
const ACTCAT_PREFIX=APP+'_actcat_';
const ACTLOG_PREFIX=APP+'_actlog_';

const $=id=>document.getElementById(id);
const S=t=>{const n=$('statusDot'); if(n) n.textContent=t;};
const uid=()=>('u_'+Math.random().toString(36).slice(2,10));

/* ====== Usuarios ====== */
const getUsers=()=>{try{const r=localStorage.getItem(USERS_KEY); const a=r?JSON.parse(r):[]; return Array.isArray(a)?a:[]}catch{ return [] }};
const saveUsers=a=>localStorage.setItem(USERS_KEY,JSON.stringify(a||[]));
const getCurrentUser=()=>localStorage.getItem(CURR_USER_KEY)||'';
const setCurrentUser=id=>localStorage.setItem(CURR_USER_KEY,id||'');
const userById=id=>getUsers().find(u=>u.id===id)||null;
const roleOf=id=>(userById(id)?.role)||'admin';
const userKey=id=>GEOFENCE_PREFIX+id;
const catKey=id=>ACTCAT_PREFIX+id;
const logKey=id=>ACTLOG_PREFIX+id;

function ensureUsersBootstrap(){
  let users=getUsers();
  if(!users.length){
    const first=uid();
    users=[{id:first,name:'Usuario 1',role:'owner'}];
    saveUsers(users); setCurrentUser(first);
    localStorage.setItem(userKey(first), JSON.stringify([]));
  }else{
    let mod=false;
    users=users.map((u,i)=>({...u,role:u.role|| (i===0?'owner':'admin')}));
    saveUsers(users);
    if(!getCurrentUser()) setCurrentUser(users[0].id);
    const cur=getCurrentUser();
    if(!localStorage.getItem(userKey(cur))) localStorage.setItem(userKey(cur),JSON.stringify([]));
  }
}
function createUserWithRole(name,role){
  const users=getUsers(); const id=uid();
  users.push({id,name:(name||'').trim()|| (role==='staff'?'Personal '+users.length:'Usuario '+users.length),role});
  saveUsers(users); localStorage.setItem(userKey(id),JSON.stringify([])); setCurrentUser(id); return id;
}
function renameUser(id,newName){const users=getUsers(); const i=users.findIndex(u=>u.id===id); if(i<0) return; users[i].name=(newName||'').trim()||users[i].name; saveUsers(users);}
function deleteUser(id){
  const users=getUsers(); const u=users.find(x=>x.id===id); if(!u) return; if(u.role==='owner'){alert('No se puede eliminar al dueño'); return;}
  localStorage.removeItem(userKey(id));
  localStorage.removeItem(CHECKS_PREFIX+id);
  localStorage.removeItem(catKey(id));
  localStorage.removeItem(logKey(id));
  saveUsers(users.filter(x=>x.id!==id));
  if(getCurrentUser()===id){ const left=getUsers(); setCurrentUser(left.length?left[0].id:createUserWithRole('Usuario 1','owner'));}
}

/* ====== Geocercas ====== */
let CURRENT_USER_ID='';
const loadF=()=>{try{const t=localStorage.getItem(userKey(CURRENT_USER_ID)); const a=t?JSON.parse(t):[]; return Array.isArray(a)?a:[]}catch{return[]}};
const saveF=arr=>localStorage.setItem(userKey(CURRENT_USER_ID),JSON.stringify(arr||[]));
function nextDefaultName(){const fs=loadF(); let max=0; fs.forEach(f=>{const m=String(f.name||'').match(/geocerca\s+(\d+)/i); const n=m?+m[1]:0; if(n>max) max=n;}); return 'Geocerca '+(max?max+1:fs.length+1);}

/* ====== Leaflet helpers (tiles cascade + fallback) ====== */
function addBaseLayerCascade(m) {
  const urls=[
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
    'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png'
  ];
  const Gray = L.GridLayer.extend({
    createTile: function(coords){
      const c=document.createElement('canvas'); c.width=256; c.height=256;
      const ctx=c.getContext('2d'); ctx.fillStyle='#eef2ff'; ctx.fillRect(0,0,256,256);
      ctx.strokeStyle='#dbeafe'; ctx.lineWidth=1;
      for(let i=0;i<=256;i+=64){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,256);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(256,i);ctx.stroke();}
      return c;
    }
  });
  let layer; let k=0;
  const use=(i)=>{
    if(layer){ try{m.removeLayer(layer)}catch{} }
    if(i>=urls.length){ new Gray().addTo(m); return; }
    layer=L.tileLayer(urls[i],{maxZoom:19,attribution:'© OpenStreetMap'});
    layer.on('tileerror', ()=>use(i+1));
    layer.addTo(m);
  };
  use(k);
}

/* ====== Mapas ====== */
let map, repMap, selectedId=null, layers={};
const STYLE={color:'#6d28d9',weight:3,fillColor:'#a78bfa',fillOpacity:.20};
const STYLESEL={color:'#7c3aed',weight:4,fillColor:'#c4b5fd',fillOpacity:.26};
const STYLEEDIT={color:'#0ea5e9',weight:3,fillColor:'#7dd3fc',fillOpacity:.18};

function reflow(m){ try{m && m.invalidateSize(true);}catch{} }
function ensureMap(){
  const el=$('map'); if(el && (!el.style.height || el.clientHeight===0)){ el.style.height='520px'; }
  map=L.map('map',{preferCanvas:true});
  addBaseLayerCascade(map);
  map.setView([-1.5,-78.5],9);
  reflow(map); setTimeout(()=>reflow(map),300); setTimeout(()=>reflow(map),1200);
  if('ResizeObserver' in window){ new ResizeObserver(()=>reflow(map)).observe(el); }
}
function ensureRepMap(){
  const el=$('repMap'); if(el && (!el.style.height || el.clientHeight===0)){ el.style.height='420px'; }
  repMap=L.map('repMap',{preferCanvas:true});
  addBaseLayerCascade(repMap);
  repMap.setView([-1.5,-78.5],8);
  reflow(repMap); setTimeout(()=>reflow(repMap),300); setTimeout(()=>reflow(repMap),1200);
  if('ResizeObserver' in window){ new ResizeObserver(()=>reflow(repMap)).observe(el); }
}

/* ====== Render principal ====== */
function renderUserUI(){
  const users=getUsers(), sel=$('userSelect'), cur=getCurrentUser();
  sel.innerHTML=users.map(u=>`<option value="${u.id}">${u.name} [${u.role}]</option>`).join('');
  if(users.length) sel.value=cur||users[0].id;

  $('newUserBtn').onclick=()=>{const r=prompt('Rol (admin/staff)','admin'); if(!r) return; const name=prompt('Nombre:')||''; const id=createUserWithRole(name,r.toLowerCase()==='staff'?'staff':'admin'); CURRENT_USER_ID=id; selectedId=null; renderAll('usuario creado');};
  $('renameUserBtn').onclick=()=>{const id=sel.value; const u=userById(id); if(!u) return; const nm=prompt('Nuevo nombre',u.name); if(nm===null) return; renameUser(id,nm); renderAll('usuario renombrado')};
  $('deleteUserBtn').onclick=()=>{const id=sel.value; const u=userById(id); if(!u) return; if(u.role==='owner'){alert('No puedes eliminar al dueño'); return;} if(!confirm('Eliminar "'+u.name+'"?')) return; deleteUser(id); CURRENT_USER_ID=getCurrentUser(); selectedId=null; renderAll('usuario eliminado');};
  sel.onchange=e=>{setCurrentUser(e.target.value); CURRENT_USER_ID=e.target.value; selectedId=null; renderAll('usuario cambiado');};
}
function renderAll(msg){
  if(msg) S(msg);
  // limpiar capas
  Object.values(layers).forEach(l=>{try{map.removeLayer(l)}catch{}});
  layers={};

  // pintar geocercas
  const fs=loadF();
  fs.forEach(f=>{
    if(!f.path || f.path.length<3) return;
    const latlngs=f.path.map(p=>[p.lat,p.lng]);
    const poly=L.polygon(latlngs,STYLE).addTo(map);
    poly.bindTooltip((f.name||'Geocerca'),{permanent:true,direction:'center',className:'label-in-map'});
    poly.on('click',()=>selectFence(f.id));
    layers[f.id]=poly;
  });

  // select
  if(!selectedId && fs.length){ selectedId=fs[0].id; }
  paintSel(); rebuildList(); fillSelect();
  updateEditBtns();

  // reportes (resumen + mapa)
  renderReports();
}

/* ====== Geocercas: UI de lista y select ====== */
function selectFence(id){selectedId=id; paintSel(); updateEditBtns(); const s=$('geofenceSelect'); if(s) s.value=id||''; S('geocerca seleccionada');}
function paintSel(){ Object.entries(layers).forEach(([id,l])=>l.setStyle(id===selectedId?STYLESEL:STYLE)); }
function rebuildList(){
  const ul=$('fenceList'); const fs=loadF().slice().sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
  if(!fs.length){ ul.innerHTML='<li class="py-6 text-center text-gray-500">No hay geocercas.</li>'; return; }
  ul.innerHTML=fs.map(f=>`
    <li class="py-2">
      <div class="px-3 py-2 rounded hover:bg-gray-100 cursor-pointer" data-id="${f.id}">
        <div class="text-sm font-medium">${f.name||'Geocerca'}</div>
        <div class="text-xs text-gray-500">${(f.path||[]).length} puntos</div>
      </div>
    </li>`).join('');
  ul.querySelectorAll('[data-id]').forEach(n=>{
    n.addEventListener('click',()=>selectFence(n.getAttribute('data-id')));
    n.addEventListener('dblclick',()=>zoomTo(n.getAttribute('data-id')));
  });
}
function fillSelect(){
  const fs=loadF(), s=$('geofenceSelect'); const cur=s.value;
  s.innerHTML=fs.map(f=>`<option value="${f.id}">${f.name||'Geocerca'}</option>`).join('');
  if(!cur && fs.length) s.value=selectedId||fs[0].id; else if(fs.some(f=>f.id===cur)) s.value=cur;
  s.onchange=e=>zoomTo(e.target.value);
}
function zoomTo(id){
  const f=loadF().find(x=>x.id===id); if(!f) return;
  const p=L.polygon(f.path.map(pp=>[pp.lat,pp.lng])); map.fitBounds(p.getBounds(),{padding:[20,20]}); selectFence(id);
}

/* ====== Dibujo / edición (igual lógica, reducido) ====== */
let drawing=false,temp=[],tempPoly=null,firstPt=null,onClick=null,onDbl=null,pendingCoords=null;
let editing=false,backup=null,editHandles=[];
const handleIcon=L.divIcon({className:'vertex-handle',iconSize:[12,12]});

function disableMap(){map.dragging.disable();map.scrollWheelZoom.disable();map.doubleClickZoom.disable();}
function enableMap(){map.dragging.enable();map.scrollWheelZoom.enable();map.doubleClickZoom.enable();}
function getRing(layer){const ll=layer.getLatLngs(); return Array.isArray(ll[0])?ll[0]:ll}

function startDraw(){
  if(editing){alert('Termina/cancela edición.');return}
  drawing=true; temp=[]; disableMap();
  onClick=e=>{if(!drawing) return; addVertex(e.latlng)};
  onDbl=()=>{if(temp.length>=3) finishDraw()};
  map.on('mousedown',onClick); map.on('dblclick',onDbl);
  $('newFenceBtn').disabled=true; $('cancelFenceBtn').disabled=false; $('finishFenceBtn').disabled=true; S('modo dibujo');
}
function addVertex(ll){
  temp.push(ll);
  const ring=temp.length>1?temp.concat([temp[0]]):temp.slice();
  if(tempPoly) map.removeLayer(tempPoly);
  tempPoly=L.polygon(ring,{color:'#059669',weight:2,fillColor:'#34d399',fillOpacity:.15,dashArray:'4 6'}).addTo(map);
  if(!firstPt){
    firstPt=L.circleMarker(ll,{radius:6,color:'#111827',weight:2,fillColor:'#f59e0b',fillOpacity:.9}).addTo(map).bindTooltip('Cerrar').on('click',()=>{if(drawing&&temp.length>=3) finishDraw()});
  }
  $('finishFenceBtn').disabled=(temp.length<3);
}
function finishDraw(){ if(temp.length<3){alert('Agrega al menos 3 puntos'); return} pendingCoords=temp.slice(); showNameBar(nextDefaultName()); }
function cancelDraw(){ clearTemp(); enableMap(); }
function clearTemp(){
  drawing=false; temp=[]; pendingCoords=null;
  if(tempPoly){map.removeLayer(tempPoly); tempPoly=null}
  if(firstPt){map.removeLayer(firstPt); firstPt=null}
  if(onClick){map.off('mousedown',onClick); onClick=null}
  if(onDbl){map.off('dblclick',onDbl); onDbl=null}
  $('newFenceBtn').disabled=false; $('finishFenceBtn').disabled=true; $('cancelFenceBtn').disabled=true; $('nameBar').classList.add('hidden');
}
function showNameBar(def){$('nameBar').classList.remove('hidden'); $('nameField').value=(def||''); $('nameField').focus();}
$('nameField')?.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault(); saveNameFromBar();}});
$('saveNameBtn').onclick=saveNameFromBar;
$('cancelNameBtn').onclick=()=>{$('nameBar').classList.add('hidden')};
function saveNameFromBar(){
  const name=String($('nameField').value||'').trim()||nextDefaultName();
  const coords=pendingCoords||temp.slice(); if(!coords||coords.length<3){alert('No hay coordenadas.');return}
  const id='f_'+Math.random().toString(36).slice(2,10);
  const path=coords.map(p=>({lat:p.lat,lng:p.lng}));
  const fences=loadF(); fences.push({id,name,path}); saveF(fences);
  clearTemp(); enableMap(); renderAll('geocerca creada: '+name); zoomTo(id);
}
function updateEditBtns(){
  $('editFenceBtn').disabled=!selectedId || editing;
  $('deleteFenceBtn').disabled=!selectedId || editing;
  $('saveFenceEditBtn').disabled=!editing;
  $('cancelFenceEditBtn').disabled=!editing;
  $('renameFenceBtn').disabled=!selectedId || editing;
}
function createHandles(layer){
  clearHandles(); const ring=getRing(layer);
  ring.forEach((pt,idx)=>{
    const m=L.marker(pt,{draggable:true,icon:handleIcon,zIndexOffset:1000}).addTo(map);
    m.on('drag',()=>{const r=getRing(layer).slice(); r[idx]=m.getLatLng(); layer.setLatLngs([r])});
    editHandles.push(m);
  });
}
function clearHandles(){ editHandles.forEach(m=>{try{map.removeLayer(m)}catch{}}); editHandles=[]; }
$('editFenceBtn').onclick=beginEdit;
$('saveFenceEditBtn').onclick=saveEdit;
$('cancelFenceEditBtn').onclick=cancelEdit;
function beginEdit(){
  if(!selectedId){alert('Selecciona una geocerca'); return}
  const layer=layers[selectedId]; if(!layer) return;
  backup=getRing(layer).map(p=>L.latLng(p.lat,p.lng));
  layer.setStyle(STYLEEDIT); createHandles(layer); editing=true; updateEditBtns();
}
function saveEdit(){
  const layer=layers[selectedId]; if(!layer) return;
  const ring=getRing(layer); if(ring.length<3){alert('Mínimo 3 puntos'); return}
  const fs=loadF(); const i=fs.findIndex(f=>f.id===selectedId); if(i<0) return;
  fs[i].path=ring.map(p=>({lat:p.lat,lng:p.lng})); saveF(fs);
  clearHandles(); editing=false; backup=null; renderAll('edición guardada'); selectFence(selectedId);
}
function cancelEdit(){
  const layer=layers[selectedId]; if(!layer) return;
  if(backup) layer.setLatLngs([backup]);
  clearHandles(); editing=false; backup=null; paintSel(); updateEditBtns();
}
$('deleteFenceBtn').onclick=()=>{ if(!selectedId) return; if(!confirm('¿Eliminar geocerca?')) return; saveF(loadF().filter(f=>f.id!==selectedId)); selectedId=null; renderAll('geocerca eliminada'); };
$('renameFenceBtn').onclick=()=>{ if(!selectedId) return; const fs=loadF(); const f=fs.find(x=>x.id===selectedId); const nm=prompt('Nuevo nombre', f?.name||''); if(nm===null) return; f.name=(nm||'').trim()||f.name; saveF(fs); renderAll('nombre actualizado'); selectFence(selectedId); };

$('exportGeoJsonBtn').onclick=()=>{
  const fs=loadF(); const feats=fs.map(f=>({type:'Feature',properties:{id:f.id,name:f.name},geometry:{type:'Polygon',coordinates:[f.path.concat([f.path[0]]).map(p=>[p.lng,p.lat])]}}));
  const blob=new Blob([JSON.stringify({type:'FeatureCollection',features:feats},null,2)],{type:'application/geo+json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='geocercas.geojson'; a.click(); URL.revokeObjectURL(url);
};
$('importGeoJsonInput').onchange=e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{try{
    const fc=JSON.parse(r.result); if(fc.type!=='FeatureCollection') throw new Error('No FC');
    const fs=loadF();
    (fc.features||[]).forEach(ft=>{
      const ring=(ft.geometry?.coordinates?.[0]||[]).map(c=>({lat:c[1],lng:c[0]}));
      if(ring.length>=3) fs.push({id:ft.properties?.id||('f_'+Math.random().toString(36).slice(2,10)), name:ft.properties?.name||nextDefaultName(), path:ring});
    });
    saveF(fs); renderAll('GeoJSON importado');
  }catch(err){alert('Archivo inválido: '+err.message)}};
  r.readAsText(f);
};

$('newFenceBtn').onclick=startDraw;
$('finishFenceBtn').onclick=finishDraw;
$('cancelFenceBtn').onclick=cancelDraw;
$('createFenceByCoordsBtn').onclick=()=>{
  const raw=prompt('Una línea por vértice en formato lat,lng'); if(!raw) return;
  const pts=raw.split(/\n+/).map(s=>s.trim()).filter(Boolean).map(s=>s.split(',')).map(p=>({lat:+p[0],lng:+p[1]})).filter(p=>isFinite(p.lat)&&isFinite(p.lng));
  if(pts.length<3){alert('Se requieren 3+ vértices');return}
  const id='f_'+Math.random().toString(36).slice(2,10), name=prompt('Nombre',nextDefaultName())||nextDefaultName();
  const fs=loadF(); fs.push({id,name,path:pts}); saveF(fs); renderAll('geocerca creada'); zoomTo(id);
};

/* ====== Reportes ====== */
function renderReports(){
  const users=getUsers(); const staff=users.filter(u=>u.role==='staff');
  const geos=loadF().length;
  const asign=staff.filter(s=>localStorage.getItem(CHECKS_PREFIX+s.id) || true).length; // placeholder simple
  const acts=(JSON.parse(localStorage.getItem(logKey(CURRENT_USER_ID))||'[]')).length;
  let checks=0; staff.forEach(s=>{ const arr=JSON.parse(localStorage.getItem(CHECKS_PREFIX+s.id)||'[]'); checks+=arr.length; });
  const cards=[{t:'Geocercas',v:geos},{t:'Personal',v:staff.length},{t:'Actividades',v:acts},{t:'Check-ins',v:checks},{t:'Asignaciones',v:staff.length}];
  $('repSummary').innerHTML=cards.map(c=>`<div class="p-4 rounded-xl bg-slate-50 border text-center"><div class="text-2xl font-bold">${c.v}</div><div class="text-xs text-slate-600">${c.t}</div></div>`).join('');

  // Mapa de reportes
  if(!repMap) ensureRepMap();
  // limpiar capas
  repMap.eachLayer(l=>{ if(!(l instanceof L.TileLayer)) repMap.removeLayer(l); });

  // pintar geocercas del usuario actual
  loadF().forEach(f=>{
    if(!f.path || f.path.length<3) return;
    L.polygon(f.path.map(p=>[p.lat,p.lng]),{color:'#7c3aed',weight:2,fillColor:'#c4b5fd',fillOpacity:.18}).addTo(repMap)
      .bindTooltip(f.name||'Geocerca',{permanent:true,direction:'center',className:'label-in-map'});
  });

  // pintar check-ins disponibles de todo el staff
  staff.forEach(s=>{
    const arr=JSON.parse(localStorage.getItem(CHECKS_PREFIX+s.id)||'[]').slice(0,200);
    arr.forEach(r=>{
      if(typeof r.lat==='number' && typeof r.lng==='number'){
        L.circleMarker([r.lat,r.lng],{radius:5,color:r.ok?'#059669':'#dc2626',weight:2,fillColor:r.ok?'#34d399':'#fecaca',fillOpacity:.9})
         .addTo(repMap).bindTooltip(`${s.name} — ${r.ok?'Dentro':'Fuera'} — ${new Date(r.ts).toLocaleString()}`);
      }
    });
  });

  // centrar si hay algo
  const anyFence=loadF().find(f=>(f.path||[]).length>=3);
  if(anyFence){
    const p=L.polygon(anyFence.path.map(pp=>[pp.lat,pp.lng]));
    repMap.fitBounds(p.getBounds(),{padding:[20,20]});
  }else{
    repMap.setView([-1.5,-78.5],8);
  }

  // exportadores
  $('exportChecksBtn').onclick=()=>{
    const rows=[['Fecha','Personal','DentroGeocerca','Lat','Lng']];
    staff.forEach(s=>{
      const arr=JSON.parse(localStorage.getItem(CHECKS_PREFIX+s.id)||'[]');
      arr.forEach(r=>rows.push([new Date(r.ts).toISOString(), s.name, r.ok===true?'DENTRO':(r.ok===false?'FUERA':''), r.lat||'', r.lng||'']));
    });
    const csv=rows.map(a=>a.map(x=>{x=(x==null?'':String(x)); return /[",\n]/.test(x)?'"'+x.replace(/"/g,'""')+'"':x;}).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='checkins.csv'; a.click(); URL.revokeObjectURL(url);
  };
  $('exportActsBtn').onclick=()=>{
    const logs=JSON.parse(localStorage.getItem(logKey(CURRENT_USER_ID))||'[]');
    const rows=[['Fecha','Personal','Actividad','DentroGeocerca','Lat','Lng','Nota']];
    logs.forEach(r=>{const u=userById(r.staffId); rows.push([new Date(r.ts).toISOString(), u?u.name:'', r.actName||'', r.ok===true?'DENTRO':(r.ok===false?'FUERA':''), r.lat||'', r.lng||'', r.note||''])});
    const csv=rows.map(a=>a.map(x=>{x=(x==null?'':String(x)); return /[",\n]/.test(x)?'"'+x.replace(/"/g,'""')+'"':x;}).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='actividades.csv'; a.click(); URL.revokeObjectURL(url);
  };

  reflow(repMap); setTimeout(()=>reflow(repMap),300);
}

/* ====== Inicio ====== */
window.addEventListener('load', ()=>{
  ensureUsersBootstrap();
  CURRENT_USER_ID=getCurrentUser();
  renderUserUI();
  ensureMap();
  renderAll('mapas listos');
});
</script>
</body>
</html>
